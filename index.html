<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aprova Ai | Gestão Inteligente</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; color: #334155; overflow-x: hidden; }
        .font-heading { font-family: 'Plus Jakarta Sans', sans-serif; }

        /* Animações */
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .anim-entry { animation: fadeInUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; opacity: 0; }

        /* Login Rotativo */
        .ideal-para-container { display: flex; align-items: center; justify-content: center; font-family: 'Plus Jakarta Sans', sans-serif; font-size: 1.25rem; color: #94a3b8; margin-bottom: 3rem; margin-top: 1rem; }
        @media (min-width: 1024px) { .ideal-para-container { justify-content: flex-start; } }
        .rotating-wrapper { position: relative; height: 1.5em; width: 350px; overflow: hidden; margin-left: 0.5rem; display: inline-block; vertical-align: middle; text-align: left; }
        .rotate-word { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; font-weight: 700; color: #ffffff; opacity: 0; transform: translateY(100%); transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .rotate-word.active { opacity: 1; transform: translateY(0); } .rotate-word.exit { opacity: 0; transform: translateY(-100%); }

        /* Layout */
        .split-screen { display: flex; min-height: 100vh; width: 100%; position: absolute; top: 0; left: 0; z-index: 50; background: white; }
        .left-area { width: 60%; background: radial-gradient(circle at top left, #1e1b4b, #0f172a), linear-gradient(135deg, #172554 0%, #1e3a8a 100%); color: white; display: flex; flex-direction: column; justify-content: center; padding: 5rem 6rem; position: relative; overflow: hidden; }
        .glow-orb { position: absolute; border-radius: 50%; filter: blur(90px); opacity: 0.35; }
        .orb-1 { width: 600px; height: 600px; background: #3b82f6; top: -15%; left: -15%; animation: float 10s ease-in-out infinite; }
        .orb-2 { width: 500px; height: 500px; background: #8b5cf6; bottom: -15%; right: -15%; animation: float 12s ease-in-out infinite reverse; }
        .benefit-item { display: flex; align-items: start; gap: 1.25rem; padding: 1.25rem; margin-bottom: 1.25rem; background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.06); border-radius: 16px; backdrop-filter: blur(12px); transition: all 0.3s ease; }
        .benefit-item:hover { background: rgba(255, 255, 255, 0.08); transform: translateX(8px); border-color: rgba(255, 255, 255, 0.2); }
        .icon-circle { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; flex-shrink: 0; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .right-area { width: 40%; background: #F8FAFC; display: flex; align-items: center; justify-content: center; position: relative; }
        .login-card { background: white; width: 100%; max-width: 420px; padding: 3.5rem 2.5rem; border-radius: 24px; box-shadow: 0 25px 60px -15px rgba(15, 23, 42, 0.08); border: 1px solid #f1f5f9; text-align: center; }
        .input-pro { width: 100%; padding: 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; font-size: 1rem; color: #1e293b; text-align: center; transition: all 0.2s; margin-bottom: 1.5rem; outline: none; }
        .input-pro:focus { background: white; border-color: #3b82f6; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }
        .btn-pro { width: 100%; padding: 16px; border-radius: 12px; font-weight: 700; color: white; background: linear-gradient(135deg, #1e3a8a 0%, #172554 100%); border: none; cursor: pointer; transition: all 0.3s; font-size: 1rem; box-shadow: 0 10px 25px -5px rgba(30, 58, 138, 0.25); }
        .btn-pro:hover { transform: translateY(-2px); box-shadow: 0 15px 30px -5px rgba(30, 58, 138, 0.35); }
        .btn-pro:disabled { opacity: 0.7; cursor: not-allowed; }

        @media (max-width: 1024px) { .split-screen { flex-direction: column; position: relative; height: auto; } .left-area { width: 100%; padding: 3rem 2rem; min-height: auto; text-align: center; } .ideal-para-container { justify-content: center; } .right-area { width: 100%; padding: 2rem; background: white; } .login-card { box-shadow: none; border: none; padding: 0; } .benefit-item { flex-direction: column; align-items: center; text-align: center; } .glow-orb { display: none; } }

        /* Dashboard & Editor */
        #system-loader { position: fixed; inset: 0; background: #0F172A; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; transition: opacity 0.5s; }
        .loader-spin { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        .app-header { background: #fff; border-bottom: 1px solid #e2e8f0; height: 70px; display: flex; align-items: center; padding: 0 32px; justify-content: space-between; position: sticky; top: 0; z-index: 40; }
        .kpi-card { background: white; padding: 1.5rem; border-radius: 16px; border: 1px solid #e2e8f0; box-shadow: 0 2px 10px rgba(0,0,0,0.02); display: flex; flex-direction: column; justify-content: space-between; transition: transform 0.2s; }
        .kpi-card:hover { transform: translateY(-2px); }
        .status-badge { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; padding: 4px 10px; border-radius: 999px; letter-spacing: 0.05em; }
        .st-draft { background: #e0f2fe; color: #0284c7; } 
        .st-sent { background: #dbeafe; color: #1e40af; } 
        .st-negotiating { background: #ffedd5; color: #c2410c; } 
        .st-approved { background: #dcfce7; color: #166534; } 
        .st-canceled { background: #fee2e2; color: #991b1b; }
        
        .timeline-item { position: relative; padding-left: 2rem; border-left: 2px solid #e2e8f0; padding-bottom: 1.5rem; }
        .timeline-item::before { content: ''; position: absolute; left: -5px; top: 0; width: 8px; height: 8px; border-radius: 50%; background: #94a3b8; }
        .timeline-item:last-child { border-left: transparent; }
        .timeline-desc { font-size: 0.85rem; color: #334155; margin-top: 6px; background: #fff7ed; padding: 12px; border-radius: 8px; border: 1px solid #fed7aa; font-style: italic; }
        .timeline-desc.system { background: #f8fafc; border-color: #f1f5f9; font-style: normal; }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(15,23,42,0.6); backdrop-filter: blur(4px); z-index: 60; display: none; align-items: center; justify-content: center; }
        .modal-box { background: white; width: 90%; max-width: 500px; padding: 2rem; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); animation: fadeInUp 0.3s ease-out; }
        #fatal-error { display: none; position: fixed; inset: 0; background: #FFF1F2; z-index: 10000; padding: 40px; align-items: center; justify-content: center; flex-direction: column; text-align: center; }
        
        .panel-grid { display: grid; grid-template-columns: 1fr 400px; gap: 24px; max-width: 1600px; margin: 24px auto; padding: 0 24px; height: calc(100vh - 112px); }
        .editor-section { background: white; border: 1px solid #E2E8F0; border-radius: 8px; overflow: hidden; margin-bottom: 24px; }
        .editor-header { background: #F8FAFC; padding: 12px 20px; border-bottom: 1px solid #E2E8F0; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #475569; display: flex; align-items: center; gap: 8px; }
        .editor-body { padding: 20px; }
        .input-group { margin-bottom: 16px; }
        .input-label { display: block; font-size: 0.75rem; font-weight: 600; color: #475569; margin-bottom: 6px; }
        .input-field { width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.875rem; background: white; outline: none; transition: border-color 0.2s; }
        .input-field:focus { border-color: #3b82f6; }
        .btn { padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: #0f172a; color: white; border: none; }
        .btn-primary:hover { background: #1e293b; }
        .btn-secondary { background: white; color: #475569; border: 1px solid #e2e8f0; }
        .btn-secondary:hover { background: #f8fafc; border-color: #cbd5e1; }

        /* Estilos Item Opcional e Diff */
        .diff-box { background-color: #fff7ed; border: 1px dashed #f97316; border-radius: 6px; padding: 8px; margin-top: 8px; font-size: 0.75rem; color: #9a3412; display: flex; align-items: center; gap: 8px; }
        .diff-tag { background: #f97316; color: white; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.65rem; text-transform: uppercase; }
        .old-val { text-decoration: line-through; color: #ef4444; margin-right: 4px; }
        .new-val { color: #16a34a; font-weight: bold; }
        .item-modified { border-left: 4px solid #f59e0b !important; }
        .item-new { border-left: 4px solid #10b981 !important; }
        
        /* ITEM OPCIONAL ESTILO */
        .item-optional { border: 2px dashed #94a3b8 !important; opacity: 0.9; background-color: #f8fafc; }
        .optional-badge { background: #64748b; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; font-weight: bold; text-transform: uppercase; margin-left: 8px; }

        /* Estilo para Canvas de Assinatura */
        #signature-pad { border: 2px dashed #cbd5e1; border-radius: 12px; background: #f8fafc; cursor: crosshair; touch-action: none; width: 100%; height: 200px; }
        
        @media (max-width: 1024px) { .panel-grid { grid-template-columns: 1fr; height: auto; } }
        @media print { .no-print { display: none !important; } body { background: white; } }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <div id="system-loader">
        <div class="loader-spin"></div>
        <img src="logo.png" alt="Aprova Ai" class="h-12 mb-2">
        <p class="text-xs text-slate-400 mt-2">Carregando CRM...</p>
    </div>
    
    <div id="fatal-error"><i class="fas fa-exclamation-triangle text-4xl text-amber-500 mb-4"></i><h2 class="text-2xl font-bold text-slate-800">Ops! Algo deu errado.</h2><p id="error-msg" class="text-slate-600 mt-2 mb-6 max-w-md">...</p><button onclick="localStorage.clear(); window.location.reload()" class="px-6 py-3 bg-slate-900 text-white rounded font-bold">Recarregar</button></div>

    <script>
        console.log("Aprova Ai iniciando...");

        function safeVal(id) { const el = document.getElementById(id); return el ? el.value : ''; }
        function safeText(id, val) { const el = document.getElementById(id); if (el) el.innerText = val || ''; }
        function setHTML(id, val) { const el = document.getElementById(id); if (el) el.innerHTML = val || ''; }
        function setVal(id, val) { const el = document.getElementById(id); if (el) el.value = val || ''; }
        function safeShow(id) { const el = document.getElementById(id); if(el) el.classList.remove('hidden'); }
        function safeHide(id) { const el = document.getElementById(id); if(el) el.classList.add('hidden'); }

        window.onerror = function(msg) {
            console.error("Erro detectado:", msg);
            if (msg && (msg.includes('null') || msg.includes('undefined'))) return true;
            document.getElementById('system-loader').style.display = 'none';
            return false;
        };

        const SUPABASE_URL = 'https://outasfgohiiyndsjciau.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im91dGFzZmdvaGlpeW5kc2pjaWF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4MTk4ODIsImV4cCI6MjA4NTM5NTg4Mn0.4yvGfYbQYf806FJcs34yPGkuU_kVTYHW8mBtbU3JD80';
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);

        let state = { user: null, project: null, version: null, projectsCache: [], data: { client: {}, items: [], terms: {}, settings: {}, history: [], signature: null }, previousData: null };
        let signaturePad = null;
        let isDrawing = false;

        function normalizeData(dbData) {
            const schema = { 
                client: { name: '', doc: '', email: '', phone: '', address: '' }, 
                location: { address: '', sameAsClient: true }, 
                items: [], 
                terms: { paymentMode: 'custom', paymentText: '', deadline: '', validity: '10 dias', obs: '' }, 
                settings: { myPhone: '', serviceType: 'Outros', providerName: '', providerDoc: '', providerAddr: '', providerPhone: '' }, 
                history: [],
                signature: null 
            };
            
            if (!dbData) return schema;
            let rawItems = Array.isArray(dbData.items) ? dbData.items : (dbData.scope || []);
            
            const cleanItems = rawItems.map(i => ({ 
                id: i.id || 'item_' + Math.random().toString(36).substr(2, 9), 
                name: i.name || '', 
                description: i.description || '', 
                qty: parseFloat(i.qty) || 1, 
                price: parseFloat(i.price) || 0, 
                type: i.type || 'original',
                optional: i.optional || false,
                publicSelected: i.publicSelected || false 
            }));
            
            return { 
                client: { ...schema.client, ...(dbData.client || {}) }, 
                location: { ...schema.location, ...(dbData.location || {}) }, 
                items: cleanItems, 
                terms: { ...schema.terms, ...(dbData.terms || {}) }, 
                settings: { ...schema.settings, ...(dbData.settings || {}) }, 
                history: Array.isArray(dbData.history) ? dbData.history : [],
                signature: dbData.signature || null
            };
        }

        function logHistory(action, user, detail) {
            if (!state.data.history) state.data.history = [];
            state.data.history.push({ date: new Date().toISOString(), action: action, user: user, detail: detail || '' });
        }

        async function init() {
            try {
                const params = new URLSearchParams(window.location.search);
                const view = params.get('view') || 'login';
                const id = params.get('id');
                document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
                
                const { data: { session } } = await db.auth.getSession();
                state.user = session?.user;

                if (view === 'public') {
                    if(!id) throw new Error("Link inválido.");
                    await loadPublicProposal(id);
                    safeShow('view-public');
                } else if (!state.user && view !== 'login') {
                    window.history.replaceState(null, '', '?view=login');
                    safeShow('view-login');
                    initRotator();
                } else if (state.user && view === 'login') {
                    goTo('dashboard');
                } else {
                    if(view === 'dashboard') await loadDashboard();
                    if(view === 'editor' && id) await loadEditor(id);
                    if(view !== 'login') safeShow(`view-${view}`);
                    else { safeShow('view-login'); initRotator(); }
                }
                setTimeout(() => { const l = document.getElementById('system-loader'); if(l) l.style.display = 'none'; }, 500);
            } catch (e) { 
                const l = document.getElementById('system-loader'); if(l) l.style.display = 'none';
                const f = document.getElementById('fatal-error'); if(f) f.style.display = 'flex';
                safeText('error-msg', e.message);
            }
        }

        function initRotator() {
            const words = ["Prestadores","Técnicos", "Mecânicos", "Fotógrafos"];
            let idx = 0; const el = document.getElementById('rotator'); if(!el) return;
            el.innerHTML = '';
            words.forEach((w, i) => { const s = document.createElement('span'); s.className = `rotate-word ${i===0?'active':''}`; s.innerText = w; el.appendChild(s); });
            setInterval(() => {
                const spans = el.querySelectorAll('.rotate-word');
                if(!spans.length) return;
                spans[idx].classList.remove('active'); spans[idx].classList.add('exit');
                idx = (idx + 1) % words.length;
                spans[idx].classList.remove('exit'); spans[idx].classList.add('active');
            }, 3000);
        }

        async function handleLogin() {
            const email = safeVal('email');
            const btn = document.getElementById('btn-login');
            if(!email) return alert("Digite o e-mail");
            if(btn) { btn.innerHTML = 'Enviando...'; btn.disabled = true; }
            const { error } = await db.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.href }});
            if(error) { alert(error.message); if(btn) { btn.innerText = 'Tentar Novamente'; btn.disabled = false; } }
            else { if(btn) btn.innerText = 'Enviado!'; alert('Verifique seu e-mail.'); }
        }

        function goTo(view, id = null) { window.history.pushState(null, '', id ? `?view=${view}&id=${id}` : `?view=${view}`); init(); }

        async function loadDashboard() {
            setHTML('project-list', '<div class="col-span-full text-center py-10 text-slate-400">Carregando dados...</div>');
            const { data: projects, error } = await db.from('projects').select('*, versions(status, total_value, version_number)').eq('user_id', state.user.id).order('created_at', { ascending: false });
            if(error) return setHTML('project-list', 'Erro ao carregar.');
            state.projectsCache = projects || [];
            renderDashboardList();
        }

        function renderDashboardList() {
            const list = document.getElementById('project-list');
            if(!list) return;
            const search = safeVal('dash-search').toLowerCase();
            const filterStatus = safeVal('dash-filter');
            let totalRev = 0, totalAprov = 0, countAprov = 0, countNegoc = 0, countOpen = 0;

            const filtered = state.projectsCache.filter(p => {
                const v = p.versions?.[0] || { status: 'draft', total_value: 0 };
                const matchSearch = p.name.toLowerCase().includes(search) || (p.client_name||'').toLowerCase().includes(search);
                const matchStatus = filterStatus === 'all' || !filterStatus || v.status === filterStatus;
                return matchSearch && matchStatus;
            });

            state.projectsCache.forEach(p => {
                const v = p.versions?.[0] || { status: 'draft', total_value: 0 };
                const val = parseFloat(v.total_value) || 0;
                totalRev += val; 
                if(v.status === 'approved') { totalAprov += val; countAprov++; }
                if(v.status === 'negotiating' || v.status === 'sent') countNegoc++;
                if(v.status === 'draft') countOpen++;
            });

            safeText('kpi-total-est', totalRev.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}));
            safeText('kpi-total-apr', totalAprov.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}));
            safeText('kpi-count-neg', countNegoc);
            safeText('kpi-count-apr', countAprov);
            safeText('kpi-count-open', countOpen);

            let html = '';
            if(filtered.length === 0) html = '<div class="col-span-full text-center py-20 text-slate-400 border-2 border-dashed border-slate-200 rounded-xl">Nenhum orçamento encontrado.</div>';
            else {
                filtered.forEach(p => {
                    const v = p.versions?.[0] || { total_value: 0, status: 'draft', version_number: 1 };
                    const val = parseFloat(v.total_value) || 0;
                    let badgeClass = 'st-draft'; let statusLabel = 'Em Aberto';
                    if(v.status === 'sent') { badgeClass = 'st-sent'; statusLabel = 'Enviado'; }
                    if(v.status === 'negotiating') { badgeClass = 'st-negotiating'; statusLabel = 'Em Negociação'; }
                    if(v.status === 'approved') { badgeClass = 'st-approved'; statusLabel = 'Aprovado'; }
                    if(v.status === 'canceled') { badgeClass = 'st-canceled'; statusLabel = 'Cancelado'; }

                    html += `<div onclick="goTo('editor', '${p.id}')" class="bg-white border border-slate-200 rounded-xl p-5 hover:border-blue-400 hover:shadow-md transition-all cursor-pointer group relative">
                        <div class="flex justify-between items-start mb-3">
                            <div><h3 class="font-bold text-slate-800 group-hover:text-blue-600 transition-colors">${p.name}</h3><p class="text-xs text-slate-500 mt-1"><i class="far fa-user mr-1"></i> ${p.client_name || 'Novo Cliente'}</p></div>
                            <span class="status-badge ${badgeClass}">${statusLabel}</span>
                        </div>
                        <div class="border-t border-slate-100 pt-3 flex justify-between items-end">
                            <div class="text-xs text-slate-400">V${v.version_number} • ${new Date(p.created_at).toLocaleDateString()}</div>
                            <div class="flex items-center gap-3">
                                <div class="text-lg font-bold text-slate-900">${val.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</div>
                                <button onclick="deleteProject('${p.id}', event)" class="text-slate-300 hover:text-red-500 transition-colors p-1 opacity-0 group-hover:opacity-100" title="Excluir"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>
                    </div>`;
                });
            }
            setHTML('project-list', html);
        }

        async function deleteProject(id, event) {
            event.stopPropagation(); 
            if(!confirm("Tem certeza que deseja EXCLUIR este orçamento permanentemente?")) return;
            const { error } = await db.from('projects').delete().eq('id', id);
            if(error) alert("Erro ao excluir: " + error.message);
            else { state.projectsCache = state.projectsCache.filter(p => p.id !== id); renderDashboardList(); }
        }

        async function createProject() {
            const name = prompt("Nome do Orçamento:"); if(!name) return;
            const { data: p, error } = await db.from('projects').insert({ name, user_id: state.user.id, client_name: 'Novo Cliente' }).select().single();
            const d = normalizeData(null); 
            d.settings.myPhone = localStorage.getItem('escopo_phone') || '';
            d.settings.providerName = localStorage.getItem('prov_name') || '';
            d.settings.providerDoc = localStorage.getItem('prov_doc') || '';
            d.settings.providerAddr = localStorage.getItem('prov_addr') || '';
            d.settings.providerPhone = localStorage.getItem('prov_phone') || '';

            logHistory('created', 'provider', 'Orçamento criado via painel.', d); 
            await db.from('versions').insert({ project_id: p.id, version_number: 1, items: d, total_value: 0, status: 'draft' });
            goTo('editor', p.id);
        }

        async function loadEditor(id) {
            safeHide('editor-content');
            safeShow('editor-loading');
            const { data: proj } = await db.from('projects').select('*').eq('id', id).single();
            state.project = proj;
            const { data: vers } = await db.from('versions').select('*').eq('project_id', id).order('version_number', { ascending: true });
            state.version = vers[vers.length - 1];
            state.data = normalizeData(state.version.items);
            state.previousData = null;
            if (state.version.version_number > 1 && vers[vers.length - 2]) {
                state.previousData = normalizeData(vers[vers.length - 2].items);
            }
            if(state.version.notes && !state.data.terms.obs) state.data.terms.obs = state.version.notes;
            if(!state.data.settings.myPhone) state.data.settings.myPhone = localStorage.getItem('escopo_phone') || '';
            renderEditor();
            safeHide('editor-loading');
            safeShow('editor-content');
        }

        function renderEditor() {
            const d = state.data; 
            const isLocked = state.version.status === 'approved' || state.version.status === 'canceled';
            safeText('ed-title', state.project.name);
            safeText('ed-ver', `V${state.version.version_number}`);
            
            const badge = document.getElementById('ed-status-badge');
            if(badge) {
                badge.className = `status-badge ml-2 ${state.version.status === 'approved' ? 'st-approved' : state.version.status === 'canceled' ? 'st-canceled' : 'st-draft'}`;
                badge.innerText = state.version.status === 'draft' ? 'EM ABERTO' : state.version.status.toUpperCase();
            }
            
            setVal('p-name', d.settings.providerName); setVal('p-doc', d.settings.providerDoc);
            setVal('p-addr', d.settings.providerAddr); setVal('p-phone', d.settings.providerPhone);
            setVal('c-name', d.client.name); setVal('c-doc', d.client.doc); setVal('c-phone', d.client.phone); setVal('c-email', d.client.email); setVal('c-addr', d.client.address); setVal('in-s-myphone', d.settings.myPhone);
            const svc = document.getElementById('s-type'); if(svc) svc.value = d.settings.serviceType || 'Outros';
            
            setVal('t-deadline', d.terms.deadline); 
            setVal('t-val', d.terms.validity); setVal('t-obs', d.terms.obs);

            let html = ''; 
            let total = 0;
            const items = Array.isArray(d.items) ? d.items : [];
            
            items.forEach((i, x) => {
                const t = (i.qty||0)*(i.price||0); 
                if(!i.optional) total += t;

                let diffHtml = '';
                let cardClass = i.optional ? 'item-optional' : '';
                
                if (state.previousData) {
                    const oldItem = state.previousData.items.find(old => old.id === i.id);
                    if (!oldItem) {
                        cardClass += ' item-new';
                        diffHtml = `<div class="diff-box"><span class="diff-tag">NOVO</span> Este item foi adicionado.</div>`;
                    } else {
                        let changes = [];
                        if (oldItem.price !== i.price) changes.push(`Preço: <span class="old-val">R$${oldItem.price}</span> <i class="fas fa-arrow-right text-xs"></i> <span class="new-val">R$${i.price}</span>`);
                        if (oldItem.qty !== i.qty) changes.push(`Qtd: <span class="old-val">${oldItem.qty}</span> <i class="fas fa-arrow-right text-xs"></i> <span class="new-val">${i.qty}</span>`);
                        if (changes.length > 0) {
                            cardClass += ' item-modified';
                            diffHtml = `<div class="diff-box"><span class="diff-tag">ALTERADO</span> <span>${changes.join(' &bull; ')}</span></div>`;
                        }
                    }
                }

                html += `
                <div class="bg-white border p-4 rounded-lg mb-2 relative group transition-all ${cardClass}">
                    ${!isLocked ? `<button onclick="rmItem(${x})" class="absolute top-2 right-2 text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100"><i class="fas fa-trash"></i></button>` : ''}
                    <div class="grid grid-cols-12 gap-2 mb-2">
                        <div class="col-span-8">
                            <label class="text-[10px] uppercase font-bold text-slate-400 flex items-center">
                                Item 
                                ${i.optional ? '<span class="optional-badge">Opcional</span>' : ''}
                            </label>
                            <input class="w-full font-bold bg-transparent outline-none" value="${i.name}" onchange="upItem(${x},'name',this.value)" ${isLocked?'disabled':''}>
                        </div>
                        <div class="col-span-2">
                            <label class="text-[10px] uppercase font-bold text-slate-400 text-center block">Qtd</label>
                            <input type="number" class="w-full text-center bg-slate-50 rounded" value="${i.qty}" onchange="upItem(${x},'qty',this.value)" ${isLocked?'disabled':''}>
                        </div>
                        <div class="col-span-2">
                            <label class="text-[10px] uppercase font-bold text-slate-400 text-right block">$$</label>
                            <input type="number" class="w-full text-right bg-slate-50 rounded" value="${i.price}" onchange="upItem(${x},'price',this.value)" ${isLocked?'disabled':''}>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                         <textarea class="w-full text-xs text-slate-500 bg-transparent outline-none resize-none" rows="1" onchange="upItem(${x},'description',this.value)" placeholder="Descrição técnica..." ${isLocked?'disabled':''}>${i.description||''}</textarea>
                         ${!isLocked ? `
                            <button onclick="toggleOpt(${x})" class="text-[10px] font-bold px-2 py-1 rounded border ${i.optional ? 'bg-slate-600 text-white border-slate-600' : 'text-slate-400 border-slate-200 hover:border-slate-400'}" title="Marcar como opcional (não soma no total automaticamente)">
                                ${i.optional ? 'OPCIONAL' : 'Opcional?'}
                            </button>
                         ` : ''}
                    </div>
                    ${diffHtml}
                </div>`;
            });
            
            setHTML('ed-items', html);
            const totalOpt = items.reduce((acc, i) => i.optional ? acc + (i.qty * i.price) : acc, 0);
            
            let totalDisplay = total.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
            if (totalOpt > 0) {
                totalDisplay += `<div class="text-xs text-slate-400 font-normal mt-1">+ ${totalOpt.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})} em opcionais</div>`;
            }
            setHTML('ed-total', totalDisplay);

            let histHtml = '';
            if(d.history && d.history.length > 0) {
                d.history.slice().reverse().forEach(h => {
                    const date = new Date(h.date).toLocaleString('pt-BR');
                    let icon = h.action === 'approved' ? 'check text-green-500' : h.action === 'change_request' ? 'comment-dots text-amber-500' : h.action === 'canceled' ? 'times text-red-500' : 'info-circle text-blue-400';
                    let actionLabel = h.action === 'created' ? 'Criou o orçamento' : h.action === 'change_request' ? 'Solicitou alteração' : h.action === 'approved' ? 'Aprovou' : h.action === 'canceled' ? 'Recusou/Cancelou' : 'Visualizou';
                    histHtml += `<div class="timeline-item"><div class="timeline-date">${date} • ${h.user === 'provider' ? 'Você' : 'Cliente'}</div><div class="timeline-title flex items-center gap-2"><i class="fas fa-${icon}"></i> ${actionLabel}</div>${h.detail ? `<div class="timeline-desc ${h.action.includes('request')?'':'system'}">${h.detail}</div>` : ''}</div>`;
                });
            } else { histHtml = '<div class="text-xs text-slate-400 italic">Sem histórico registrado.</div>'; }
            setHTML('ed-history', histHtml);

            const actions = document.getElementById('ed-actions');
            if (actions) {
                if (isLocked) { actions.innerHTML = `<button onclick="createAddon()" class="w-full py-3 bg-amber-500 hover:bg-amber-600 text-white font-bold rounded-lg mb-2 shadow-lg"><i class="fas fa-copy mr-2"></i> Criar Revisão (V${state.version.version_number + 1})</button>`; } 
                else { actions.innerHTML = `<button onclick="save()" class="w-full py-3 bg-slate-900 hover:bg-slate-800 text-white font-bold rounded-lg mb-2 shadow-lg"><i class="fas fa-save mr-2"></i> Salvar Alterações</button><button onclick="changeStatus('canceled')" class="w-full py-2 border border-red-200 text-red-500 hover:bg-red-50 rounded-lg text-sm font-bold">Cancelar Orçamento</button>`; }
            }
        }

        function upVal(k,v) { if(k.startsWith('c-')) state.data.client[k.substring(2)] = v; else if(k.startsWith('t-')) state.data.terms[k.substring(2)] = v; else if(k==='s-phone') { state.data.settings.myPhone=v; localStorage.setItem('escopo_phone',v); } else if(k==='s-type') { state.data.settings.serviceType = v; } }
        function upSettings(k,v) { state.data.settings[k] = v; if(['providerName','providerDoc','providerAddr','providerPhone'].includes(k)) localStorage.setItem(k.replace('provider','prov_').toLowerCase(), v); }

        function upItem(i,f,v) { const it=state.data.items[i]; if(f==='qty'||f==='price') it[f]=parseFloat(v)||0; else it[f]=v; renderEditor(); }
        
        function toggleOpt(i) {
            state.data.items[i].optional = !state.data.items[i].optional;
            renderEditor();
        }

        function addItem() { 
            if(!Array.isArray(state.data.items)) state.data.items = [];
            state.data.items.push({ id: 'item_' + Date.now(), name: 'Novo Item', description: '', qty: 1, price: 0, type: state.version?.version_number > 1 ? 'addon' : 'original', optional: false }); 
            renderEditor(); 
        }
        function rmItem(i) { if(confirm("Remover este item?")) { state.data.items.splice(i, 1); renderEditor(); } }
        
        function generatePayment() {
            const total = state.data.items.reduce((acc, i) => (!i.optional ? acc + (i.qty * i.price) : acc), 0);
            if(total === 0) return alert("Adicione valores (não opcionais) primeiro.");
            const mode = document.getElementById('pay-mode').value;
            let text = "";
            if(mode === 'entry_installments') {
                const entryP = prompt("Porcentagem de Entrada? (Ex: 30)", "30");
                const inst = prompt("Restante em quantas vezes?", "2");
                if(!entryP || !inst) return;
                const entryVal = total * (parseInt(entryP)/100);
                const restVal = (total - entryVal) / parseInt(inst);
                text = `CRONOGRAMA:\n1. Entrada: ${entryVal.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}\n`;
                for(let i=1; i<=parseInt(inst); i++) text += `${i+1}. Parcela (30d): ${restVal.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}\n`;
            } else text = `Pagamento Único: ${total.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}`;
            state.data.terms.paymentText = text;
            renderEditor(); 
            setVal('t-obs', text);
        }

        async function save() {
            const t = state.data.items.reduce((a,b)=> (!b.optional ? a+(b.qty*b.price) : a),0);
            if(state.data.client.name) await db.from('projects').update({client_name:state.data.client.name}).eq('id',state.project.id);
            await db.from('versions').update({items:state.data, total_value:t, notes:state.data.terms.obs}).eq('id',state.version.id);
            alert("Salvo com sucesso!");
        }

        async function createAddon() {
            if(!confirm("Criar nova versão (Aditivo)?")) return;
            const t = state.data.items.reduce((a,b)=> (!b.optional ? a+(b.qty*b.price) : a),0);
            logHistory('created', 'provider', 'Criou nova versão/aditivo.'); 
            await db.from('versions').insert({project_id:state.project.id, version_number:state.version.version_number+1, items:state.data, total_value:t, status:'draft'});
            loadEditor(state.project.id);
        }

        async function changeStatus(newStatus) {
            if(!confirm(`Mudar status para ${newStatus}?`)) return;
            await db.from('versions').update({status: newStatus}).eq('id',state.version.id);
            logHistory(newStatus, 'provider', 'Alteração manual de status.');
            save(); loadEditor(state.project.id);
        }

        async function share() {
            await save();
            if (!state.version?.id) return alert("Erro ao salvar.");
            const url = `${window.location.origin}${window.location.pathname}?view=public&id=${state.version.id}`;
            try {
                await navigator.clipboard.writeText(url);
                alert("✅ Link copiado! Envie para o cliente.");
            } catch (err) {
                const textArea = document.createElement('textarea'); textArea.value = url;
                document.body.appendChild(textArea); textArea.select(); document.execCommand('copy'); document.body.removeChild(textArea);
                alert("✅ Link copiado!");
            }
        }

        // --- PUBLIC INTERACTION FLOW ---
        async function loadPublicProposal(id) {
            try {
                safeShow('public-loading');
                const { data: v, error } = await db.from('versions').select('*, projects(name)').eq('id', id).maybeSingle();
                if (error || !v) throw new Error("Orçamento não encontrado.");
                state.version = v; 
                state.data = normalizeData(v.items);
                const d = state.data;
                
                if(v.status === 'approved') document.getElementById('stamp-approved').style.display = 'block';

                if(d.settings.providerName) {
                    setHTML('doc-provider-info', `<div class="mb-4 pb-4 border-b border-slate-700"><h2 class="text-xl font-bold">${d.settings.providerName}</h2><p class="text-slate-400 text-sm">${d.settings.providerDoc || ''} • ${d.settings.providerPhone || ''}</p><p class="text-slate-400 text-xs">${d.settings.providerAddr || ''}</p></div>`);
                }

                safeText('doc-title', v.projects?.name);
                safeText('doc-id', `#${v.project_id ? v.project_id.substr(0,4).toUpperCase() : 'XXXX'}-${v.version_number}`);
                safeText('doc-c-name', d.client.name);
                safeText('doc-c-doc', d.client.doc);
                safeText('doc-c-addr', d.client.address);
                
                renderPublicItems(); 

                safeText('doc-payment', d.terms.paymentText); 
                safeText('doc-deadline', d.terms.deadline); 
                safeText('doc-validity', d.terms.validity); 
                safeText('doc-obs', d.terms.obs);

                if (d.signature) {
                    setHTML('doc-signature-area', `<div class="mt-8 border-t border-dashed pt-4 w-64 text-center"><img src="${d.signature}" class="mx-auto h-16 mb-2" alt="Assinatura"><p class="text-xs text-slate-500 uppercase font-bold">Assinado Digitalmente</p></div>`);
                }

                const actions = document.getElementById('doc-actions');
                if(actions) {
                    if(v.status === 'approved' || v.status === 'canceled') {
                        showSuccessScreen(v.status);
                    } else {
                        actions.innerHTML = `
                            <button onclick="openModal('approve')" class="w-full bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-green-700 mb-3 transition-transform hover:scale-[1.01]">APROVAR PROPOSTA</button>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="openModal('change')" class="bg-amber-100 text-amber-700 font-bold py-3 rounded-xl hover:bg-amber-200">Solicitar Alteração</button>
                                <button onclick="openModal('cancel')" class="bg-red-50 text-red-600 font-bold py-3 rounded-xl hover:bg-red-100">Recusar</button>
                            </div>
                        `;
                    }
                }
                safeHide('public-loading');
                safeShow('view-public');
                safeShow('public-content');
            } catch(e) { 
                safeHide('public-loading');
                safeText('error-msg', `Erro: ${e.message}`);
                safeShow('fatal-error');
            }
        }

        function renderPublicItems() {
            let html = '';
            let total = 0;
            const items = state.data.items;
            const isFrozen = state.version.status !== 'sent' && state.version.status !== 'negotiating' && state.version.status !== 'draft';

            items.forEach((i, idx) => {
                let isActive = !i.optional; 
                if (i.optional && i.publicSelected) isActive = true; 
                
                if(i.optional && typeof i.publicSelected === 'undefined') i.publicSelected = false;

                if (!i.optional || i.publicSelected) {
                    total += (i.qty * i.price);
                }

                html += `<tr class="border-b border-slate-100 ${i.optional ? 'bg-slate-50' : ''}">
                    <td class="py-4 pl-4">
                        <div class="flex items-start gap-3">
                            ${i.optional && !isFrozen ? `<input type="checkbox" onchange="togglePublicOpt(${idx})" ${i.publicSelected ? 'checked' : ''} class="mt-1 w-5 h-5 cursor-pointer accent-green-600">` : ''}
                            ${i.optional && isFrozen ? (i.publicSelected ? '<i class="fas fa-check-square text-green-600 mt-1"></i>' : '<i class="far fa-square text-slate-400 mt-1"></i>') : ''}
                            <div>
                                <div class="font-bold text-slate-800 ${i.optional ? 'text-slate-600' : ''}">
                                    ${i.name} ${i.optional ? '<span class="text-[10px] bg-slate-200 text-slate-600 px-1 rounded uppercase ml-2">Opcional</span>' : ''}
                                </div>
                                <span class="font-normal text-xs text-slate-500">${i.description}</span>
                            </div>
                        </div>
                    </td>
                    <td class="text-center text-sm">${i.qty}</td>
                    <td class="text-right pr-4 font-bold text-sm ${i.optional && !i.publicSelected ? 'text-slate-400 decoration-slate-400 line-through' : 'text-slate-800'}">
                        R$ ${(i.qty*i.price).toLocaleString('pt-BR',{minimumFractionDigits:2})}
                    </td>
                </tr>`; 
            });
            setHTML('doc-items-body', html);
            safeText('doc-total', total.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'}));
        }

        function togglePublicOpt(idx) {
            state.data.items[idx].publicSelected = !state.data.items[idx].publicSelected;
            renderPublicItems();
        }

        function downloadPDF() {
            const element = document.getElementById('public-content');
            const btn = document.getElementById('btn-download-pdf');
            if(btn) btn.innerText = "Gerando PDF...";
            const stamp = document.getElementById('stamp-approved');
            const originalDisplay = stamp.style.display;
            stamp.style.display = 'block';
            document.querySelectorAll('.no-print').forEach(el => el.style.display = 'none');
            const opt = { margin: 0, filename: `Comprovante_${state.project?.name}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
            html2pdf().set(opt).from(element).save().then(() => {
                 if(btn) btn.innerText = "Baixar Comprovante PDF";
                 document.querySelectorAll('.no-print').forEach(el => el.style.display = '');
                 stamp.style.display = originalDisplay;
            });
        }

        function showSuccessScreen(type) {
            safeHide('view-public');
            safeShow('view-success');
            const icon = document.getElementById('success-icon');
            const title = document.getElementById('success-title');
            const desc = document.getElementById('success-desc');
            const actions = document.getElementById('success-actions');
            actions.innerHTML = ''; 

            if(type === 'approved' || type === 'approve') {
                if(icon) icon.className = "fas fa-check-circle text-6xl text-green-500 mb-4";
                if(title) title.innerText = "Orçamento Aprovado!";
                if(desc) desc.innerText = "Obrigado pela confiança. O comprovante foi gerado.";
                actions.innerHTML = `<button id="btn-download-pdf" onclick="loadPublicProposal('${state.version.id}').then(() => setTimeout(downloadPDF, 1000))" class="px-6 py-3 bg-slate-800 text-white rounded-lg font-bold shadow hover:bg-slate-700"><i class="fas fa-file-pdf mr-2"></i> Baixar Comprovante PDF</button>`;
            } else if (type === 'negotiating' || type === 'change_request') {
                if(icon) icon.className = "fas fa-clock text-6xl text-amber-500 mb-4";
                if(title) title.innerText = "Solicitação Enviada";
                if(desc) desc.innerText = "Aguarde o retorno.";
            } else {
                if(icon) icon.className = "fas fa-times-circle text-6xl text-slate-400 mb-4";
                if(title) title.innerText = "Orçamento Recusado";
                if(desc) desc.innerText = "O orçamento foi marcado como recusado.";
            }
        }

        function initSignaturePad() {
            const canvas = document.getElementById('signature-pad');
            const ctx = canvas.getContext('2d');
            function resizeCanvas() {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                ctx.scale(ratio, ratio);
            }
            resizeCanvas();
            let painting = false;
            function startPosition(e) { painting = true; draw(e); }
            function endPosition() { painting = false; ctx.beginPath(); }
            function draw(e) {
                if (!painting) return;
                e.preventDefault(); 
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;
                ctx.lineWidth = 2; ctx.lineCap = 'round'; ctx.strokeStyle = '#0f172a';
                ctx.lineTo(x, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y);
            }
            canvas.addEventListener('mousedown', startPosition); canvas.addEventListener('mouseup', endPosition); canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('touchstart', startPosition); canvas.addEventListener('touchend', endPosition); canvas.addEventListener('touchmove', draw);
            document.getElementById('clear-sig').onclick = () => { ctx.clearRect(0, 0, canvas.width, canvas.height); };
        }

        function openModal(type) {
            const modal = document.getElementById('interaction-modal');
            const title = document.getElementById('modal-title');
            const desc = document.getElementById('modal-desc');
            const input = document.getElementById('modal-input');
            const sigArea = document.getElementById('modal-sig-area');
            const btn = document.getElementById('modal-btn');
            
            modal.style.display = 'flex';
            input.value = '';
            input.style.display = 'none';
            sigArea.style.display = 'none';
            
            if(type === 'approve') {
                title.innerText = 'Assinar e Aprovar';
                desc.innerText = 'Por favor, assine abaixo para confirmar a aprovação.';
                sigArea.style.display = 'block';
                btn.innerText = 'Confirmar Aprovação';
                btn.className = "w-full py-3 bg-green-600 text-white rounded font-bold hover:bg-green-700";
                btn.onclick = () => executeAction('approve');
                setTimeout(initSignaturePad, 100); 
            } else if(type === 'change') {
                title.innerText = 'O que deseja alterar?';
                desc.innerText = 'Descreva as mudanças desejadas:';
                input.style.display = 'block';
                btn.innerText = 'Enviar Solicitação';
                btn.className = "w-full py-3 bg-amber-600 text-white rounded font-bold hover:bg-amber-700";
                btn.onclick = () => executeAction('change');
            } else if(type === 'cancel') {
                title.innerText = 'Recusar Orçamento';
                desc.innerText = 'Motivo (Opcional):';
                input.style.display = 'block';
                btn.innerText = 'Confirmar Recusa';
                btn.className = "w-full py-3 bg-red-600 text-white rounded font-bold hover:bg-red-700";
                btn.onclick = () => executeAction('cancel');
            }
        }

        async function executeAction(type) {
            const inputVal = safeVal('modal-input');
            const btn = document.getElementById('modal-btn');
            btn.innerText = "Processando...";
            btn.disabled = true;

            if (type === 'approve') {
                const canvas = document.getElementById('signature-pad');
                const signatureData = canvas.toDataURL();
                state.data.signature = signatureData;
                await approveLogic();
            } else if (type === 'change') {
                if(!inputVal) { alert("Escreva o que deseja alterar."); btn.disabled = false; btn.innerText = "Enviar"; return; }
                await sendLogic('change_request', 'negotiating', inputVal);
            } else if (type === 'cancel') {
                await sendLogic('canceled', 'canceled', inputVal || 'Recusado pelo cliente');
            }
        }

        async function sendLogic(action, newStatus, text) {
            logHistory(action, 'client', text);
            await db.from('versions').update({ status: newStatus, items: state.data }).eq('id', state.version.id);
            document.getElementById('interaction-modal').style.display = 'none';
            showSuccessScreen(action);
        }

        async function approveLogic() {
            let ip = 'IP'; try { const r = await fetch('https://api.ipify.org?format=json'); const j = await r.json(); ip = j.ip; } catch(e){}
            logHistory('approved', 'client', 'Aprovado via link com assinatura');
            const items = state.data.items;
            const finalTotal = items.reduce((acc, i) => (!i.optional || i.publicSelected ? acc + (i.qty * i.price) : acc), 0);
            await db.from('versions').update({ status: 'approved', approved_at: new Date(), approved_by_ip: ip, items: state.data, total_value: finalTotal }).eq('id', state.version.id);
            const phone = state.data.settings?.myPhone;
            if(phone) {
                const msg = `✅ O cliente APROVOU o orçamento ${state.version.projects.name}!`;
                window.open(`https://wa.me/${phone.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`, '_blank');
            }
            document.getElementById('interaction-modal').style.display = 'none';
            showSuccessScreen('approved');
        }

        window.onload = init;
        window.onpopstate = init;
    </script>

    <section id="view-success" class="hidden min-h-screen bg-white flex flex-col items-center justify-center p-8 text-center">
        <div class="max-w-md w-full">
            <i id="success-icon" class="fas fa-check-circle text-6xl text-green-500 mb-6 anim-entry"></i>
            <h2 id="success-title" class="text-3xl font-bold text-slate-900 mb-4 anim-entry delay-100">Tudo Certo!</h2>
            <p id="success-desc" class="text-slate-600 text-lg anim-entry delay-200">Sua resposta foi registrada com sucesso.</p>
            <div id="success-actions" class="mt-8 anim-entry delay-300"></div>
            <div class="mt-8 text-xs text-slate-400">Pode fechar esta janela.</div>
        </div>
    </section>

    <section id="view-login" class="hidden split-screen">
        <div class="left-area">
            <div class="glow-orb orb-1"></div><div class="glow-orb orb-2"></div>
            <div class="relative z-10 anim-entry">
                <div class="mb-4">
                    <img src="logo.png" alt="Aprova Ai" class="h-16">
                </div>
                <h1 class="text-5xl font-extrabold leading-tight mb-2 font-heading">Orçamentos que <br><span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-300">Garantem sua segurança</span></h1>
                <div class="ideal-para-container"><span>Ideal para:</span><span id="rotator" class="rotating-wrapper"></span></div>
                <div class="space-y-4">
                    <div class="benefit-item delay-100"><div class="icon-circle bg-blue-600 text-white"><i class="fas fa-shield-alt"></i></div><div><h3 class="font-bold text-lg">Evite prejuízos</h3><p class="text-sm text-indigo-100 opacity-80">Registre mudanças de escopo.</p></div></div>
                    <div class="benefit-item delay-200"><div class="icon-circle bg-emerald-500 text-white"><i class="fas fa-check"></i></div><div><h3 class="font-bold text-lg">Aprovação</h3><p class="text-sm text-indigo-100 opacity-80">Link direto e histórico.</p></div></div>
                    <div class="benefit-item delay-300"><div class="icon-circle bg-purple-500 text-white"><i class="fas fa-file-contract"></i></div><div><h3 class="font-bold text-lg">Sem discussão</h3><p class="text-sm text-indigo-100 opacity-80">Tudo documentado.</p></div></div>
                </div>
            </div>
        </div>
        <div class="right-area">
            <div class="login-card anim-entry delay-300">
                <div class="avatar-circle flex justify-center mb-4">
                    <img src="logo.png" alt="Logo" class="h-12">
                </div>
                <h2 class="text-2xl font-bold text-slate-900 mb-2 font-heading">Acesse sua conta</h2>
                <p class="text-slate-500 mb-8 text-sm">Digite seu e-mail para entrar.</p>
                <input type="email" id="email" placeholder="E-mail" class="input-pro">
                <button onclick="handleLogin()" id="btn-login" class="btn-pro">Enviar link de acesso</button>
            </div>
        </div>
    </section>

    <section id="view-dashboard" class="hidden flex-1">
        <div class="app-header bg-slate-900">
            <img src="logo.png" alt="Aprova Ai" class="h-10">
            <div class="flex gap-3">
                <button onclick="createProject()" class="btn btn-primary bg-white text-slate-900 hover:bg-slate-100 text-xs border-white"><i class="fas fa-plus"></i> Novo Projeto</button>
                <button onclick="db.auth.signOut().then(()=>window.location.reload())" class="text-slate-400 hover:text-white px-2"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
        <div class="max-w-6xl mx-auto p-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
                <div class="kpi-card border-emerald-200"><div class="text-emerald-600 font-bold uppercase text-xs">Faturamento Aprovado</div><div class="text-3xl font-bold" id="kpi-total-apr">R$ 0,00</div></div>
                <div class="kpi-card border-amber-200"><div class="text-amber-600 font-bold uppercase text-xs">Pipeline</div><div class="text-3xl font-bold" id="kpi-total-est">R$ 0,00</div></div>
            </div>
            <div class="flex gap-4 mb-4">
                <div class="kpi-card bg-amber-50 border-amber-200 flex-1"><div class="kpi-label text-amber-700">Em Negociação</div><div class="kpi-value text-amber-700" id="kpi-count-neg">0</div></div>
                <div class="kpi-card bg-emerald-50 border-emerald-200 flex-1"><div class="kpi-label text-emerald-700">Aprovados</div><div class="kpi-value text-emerald-700" id="kpi-count-apr">0</div></div>
                <div class="kpi-card bg-blue-50 border-blue-200 flex-1"><div class="kpi-label text-blue-700">Em Aberto</div><div class="kpi-value text-blue-700" id="kpi-count-open">0</div></div>
            </div>
            <div class="flex flex-col md:flex-row gap-4 mb-6 items-center bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                <div class="flex-1 w-full relative"><i class="fas fa-search absolute left-3 top-3 text-slate-400"></i><input id="dash-search" onkeyup="renderDashboardList()" class="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none focus:border-blue-500" placeholder="Buscar cliente ou projeto..."></div>
                <select id="dash-filter" onchange="renderDashboardList()" class="p-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none"><option value="all">Todos os Status</option><option value="draft">Em Aberto</option><option value="sent">Enviados</option><option value="negotiating">Em Negociação</option><option value="approved">Aprovados</option><option value="canceled">Cancelados</option></select>
            </div>
            <div id="project-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>
    </section>

    <section id="view-editor" class="hidden flex-1 bg-slate-50 h-screen flex flex-col">
        <div id="editor-loading" class="flex-1 flex items-center justify-center bg-slate-50"><div class="loader-spin"></div></div>
        <div id="editor-content" class="hidden flex flex-col h-full">
            <div class="app-header bg-slate-900 justify-between">
                <div class="flex items-center gap-4">
                    <button onclick="goTo('dashboard')" class="text-slate-400 hover:text-white"><i class="fas fa-arrow-left"></i></button>
                    <div><h2 id="ed-title" class="font-bold leading-none text-lg text-white">...</h2><span id="ed-ver" class="text-[10px] text-slate-400 uppercase font-bold">V1</span><span id="ed-status-badge" class="ml-2 text-[10px] uppercase font-bold bg-white text-slate-900 px-2 py-1 rounded"></span></div>
                </div>
                <button onclick="share()" class="btn btn-secondary bg-slate-800 border-slate-700 text-white hover:bg-slate-700 text-xs"><i class="fas fa-link"></i> Link Cliente</button>
            </div>
            <div class="panel-grid overflow-hidden">
                <div class="overflow-y-auto pr-2 pb-20 no-scrollbar">
                    <div class="editor-section">
                        <div class="editor-header bg-slate-100 text-blue-700"><i class="fas fa-id-card"></i> Seus Dados (Prestador)</div>
                        <div class="editor-body">
                            <div class="input-group"><label class="input-label">Nome / Razão Social</label><input id="p-name" class="w-full border p-3 rounded-lg bg-slate-50 text-sm" placeholder="Nome da sua empresa" onchange="upSettings('providerName',this.value)"></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="input-group"><label class="input-label">CNPJ / CPF</label><input id="p-doc" class="border p-3 rounded-lg bg-slate-50 text-sm" placeholder="000.000.000-00" onchange="upSettings('providerDoc',this.value)"></div>
                                <div class="input-group"><label class="input-label">Telefone</label><input id="p-phone" class="border p-3 rounded-lg bg-slate-50 text-sm" placeholder="(00) 00000-0000" onchange="upSettings('providerPhone',this.value)"></div>
                            </div>
                            <div class="input-group"><label class="input-label">Endereço</label><input id="p-addr" class="w-full border p-3 rounded-lg bg-slate-50 text-sm" placeholder="Endereço da sua empresa" onchange="upSettings('providerAddr',this.value)"></div>
                        </div>
                    </div>
                    <div class="editor-section">
                        <div class="editor-header"><i class="fas fa-user-tie"></i> Dados do Cliente</div>
                        <div class="editor-body">
                            <div class="input-group"><label class="input-label">Nome</label><input id="c-name" class="w-full border p-3 rounded-lg bg-slate-50 text-sm" placeholder="Nome do Cliente / Empresa" onchange="upVal('c-name',this.value)"></div>
                            <div class="grid grid-cols-2 gap-4"><div class="input-group"><label class="input-label">Doc</label><input id="c-doc" class="border p-3 rounded-lg bg-slate-50 text-sm" placeholder="CPF/CNPJ" onchange="upVal('c-doc',this.value)"></div><div class="input-group"><label class="input-label">Tel</label><input id="c-phone" class="border p-3 rounded-lg bg-slate-50 text-sm" placeholder="Telefone" onchange="upVal('c-phone',this.value)"></div></div>
                            <div class="input-group"><label class="input-label">Email</label><input id="c-email" class="w-full border p-3 rounded-lg bg-slate-50 text-sm" placeholder="E-mail" onchange="upVal('c-email',this.value)"></div>
                            <div class="input-group"><label class="input-label">Endereço</label><input id="c-addr" class="w-full border p-3 rounded-lg bg-slate-50 text-sm" placeholder="Endereço Completo" onchange="upVal('c-addr',this.value)"></div>
                            <div class="mt-4 pt-4 border-t"><label class="input-label text-blue-600">Seu WhatsApp (Para Notificações)</label><input id="in-s-myphone" onchange="upSettings('myPhone', this.value)" class="input-field bg-blue-50 border-blue-200"></div>
                        </div>
                    </div>
                    <div class="editor-section">
                        <div class="editor-header justify-between"><span><i class="fas fa-list-ol"></i> Escopo</span><button id="btn-add-item" onclick="addItem()" class="btn btn-primary text-xs py-1 px-3 bg-slate-800 border-none">+ Item</button></div>
                        <div class="editor-body bg-slate-50 min-h-[300px]"><div id="ed-items"></div></div>
                    </div>
                </div>
                <div class="overflow-y-auto pb-20 no-scrollbar">
                    <div class="editor-section sticky top-0 shadow-lg">
                        <div class="editor-header"><i class="fas fa-coins"></i> Financeiro</div>
                        <div class="editor-body">
                            <div class="bg-slate-900 text-white p-6 rounded-lg text-center mb-6"><div class="text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-1">Total Global</div><div id="ed-total" class="text-3xl font-bold">R$ 0,00</div></div>
                            <div class="input-group"><div class="flex gap-2 mb-2"><select id="pay-mode" class="input-field"><option value="entry_installments">Entrada + Parcelas</option><option value="single">Único</option></select><button onclick="generatePayment()" class="btn btn-secondary px-3"><i class="fas fa-calculator"></i></button></div><div id="payment-display" class="text-xs bg-slate-50 p-3 rounded border border-slate-200 text-slate-600 whitespace-pre-line min-h-[60px]">...</div></div>
                            
                            <div class="grid grid-cols-2 gap-4"><div class="input-group"><label class="input-label">Entrega</label><input id="t-deadline" class="border p-2 rounded text-sm" placeholder="Prazo" onchange="upVal('t-deadline',this.value)"></div><div class="input-group"><label class="input-label">Validade</label><input id="t-val" class="border p-2 rounded text-sm" placeholder="Validade" onchange="upVal('t-val',this.value)"></div></div>
                            
                            <div class="input-group"><label class="input-label">Obs</label><textarea id="t-obs" class="w-full border p-2 rounded text-sm h-20 mb-4 bg-slate-50" placeholder="Condições de pagamento..." onchange="upVal('t-obs',this.value)"></textarea></div>
                            <div id="ed-actions" class="mt-6"></div>
                        </div>
                    </div>
                    <div class="editor-section"><div class="editor-header"><i class="fas fa-history"></i> Histórico</div><div id="ed-history" class="p-4 space-y-4"></div></div>
                </div>
            </div>
        </div>
    </section>

    <section id="view-public" class="hidden min-h-screen bg-slate-200 p-4 md:py-10 overflow-y-auto print:p-0">
        <div id="public-loading" class="flex justify-center mt-20"><div class="spinner border-slate-900"></div></div>
        <div id="public-content" class="hidden max-w-4xl mx-auto bg-white shadow-2xl min-h-[297mm] relative flex flex-col">
            <div id="stamp-approved" class="hidden absolute top-10 right-10 border-4 border-emerald-600 text-emerald-600 font-bold text-3xl px-6 py-2 uppercase opacity-30 transform -rotate-12 z-20">APROVADO</div>
            <div class="bg-slate-900 text-white p-12 print:bg-white print:text-black print:border-b-2">
                <div id="doc-provider-info"></div>
                <div class="flex justify-between items-start mt-4">
                    <div><h1 id="doc-title" class="text-3xl font-bold mb-2">Projeto</h1><p class="text-xs uppercase tracking-widest text-slate-400">Proposta Técnica</p></div>
                    <div class="text-right"><div id="doc-id" class="font-bold text-lg">#REF</div><div id="doc-date" class="text-sm opacity-70">--/--/--</div></div>
                </div>
            </div>
            <div class="p-12 flex-1">
                <div class="flex gap-12 mb-12 text-sm"><div class="flex-1"><h3 class="font-bold text-xs uppercase text-slate-400 mb-2 border-b pb-1">Contratante</h3><div id="doc-c-name" class="font-bold text-lg text-slate-800"></div><div id="doc-c-doc" class="text-slate-500"></div></div><div class="flex-1"><h3 class="font-bold text-xs uppercase text-slate-400 mb-2 border-b pb-1">Local</h3><div id="doc-c-addr" class="text-slate-600"></div></div></div>
                <div class="mb-12"><h3 class="font-bold text-xs uppercase text-slate-400 mb-4 tracking-wider">Escopo</h3><table class="w-full"><tbody id="doc-items-body"></tbody></table></div>
                <div class="bg-slate-50 border border-slate-100 rounded-lg p-8 mb-12 flex gap-12">
                    <div class="flex-1"><h4 class="font-bold text-xs uppercase text-slate-400 mb-2">Pagamento</h4><div id="doc-payment" class="text-sm font-mono text-slate-700 whitespace-pre-line"></div><div class="mt-4 flex gap-6 text-sm"><div><span class="font-bold text-xs uppercase text-slate-400 block">Entrega</span><span id="doc-deadline"></span></div><div><span class="font-bold text-xs uppercase text-slate-400 block">Validade</span><span id="doc-validity"></span></div></div></div>
                    <div class="text-right"><h4 class="font-bold text-xs uppercase text-slate-400 mb-1">Total</h4><div id="doc-total" class="text-3xl font-bold text-slate-900">R$ 0,00</div></div>
                </div>
                <div id="doc-obs" class="text-xs text-slate-500 italic text-justify"></div>
                <div id="doc-signature-area"></div>
                <div id="doc-actions" class="no-print mt-12"></div>
            </div>
            <div class="bg-slate-50 p-4 text-center border-t no-print"><button onclick="window.print()" class="text-xs font-bold text-slate-400 uppercase hover:text-slate-600"><i class="fas fa-print"></i> PDF</button></div>
        </div>
    </section>

    <div id="interaction-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="modal-title" class="text-xl font-bold mb-2 text-slate-800"></h3>
            <p id="modal-desc" class="text-sm text-slate-500 mb-4"></p>
            <textarea id="modal-input" class="w-full border p-3 rounded-lg mb-4 h-24 text-sm bg-slate-50" placeholder="Digite aqui..."></textarea>
            
            <div id="modal-sig-area" class="mb-4 hidden">
                <canvas id="signature-pad"></canvas>
                <div class="text-right mt-1"><button id="clear-sig" class="text-xs text-red-500 underline">Limpar Assinatura</button></div>
            </div>

            <div class="flex gap-3"><button onclick="document.getElementById('interaction-modal').style.display='none'" class="flex-1 py-3 border rounded text-slate-500 font-bold hover:bg-slate-50">Cancelar</button><button id="modal-btn" class="flex-1 py-3 rounded text-white font-bold"></button></div>
        </div>
    </div>

</body>
</html>
