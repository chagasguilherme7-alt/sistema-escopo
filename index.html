<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MeOrçamentos | Gestão Inteligente</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F3F4F6; color: #1F2937; }
        
        /* Sidebar e Layout */
        .sidebar { width: 260px; background: white; height: 100vh; position: fixed; left: 0; top: 0; border-right: 1px solid #E5E7EB; display: flex; flex-direction: column; z-index: 50; transition: transform 0.3s; }
        .main-content { margin-left: 260px; padding: 2rem; min-height: 100vh; transition: margin 0.3s; }
        
        .nav-item { display: flex; align-items: center; padding: 12px 24px; color: #4B5563; font-weight: 500; transition: all 0.2s; cursor: pointer; border-left: 3px solid transparent; }
        .nav-item:hover, .nav-item.active { background: #EFF6FF; color: #3B82F6; border-left-color: #3B82F6; }
        .nav-item i { width: 24px; margin-right: 10px; }
        
        .btn-new { background: #3B82F6; color: white; border-radius: 8px; padding: 12px; margin: 20px; text-align: center; font-weight: 600; cursor: pointer; transition: bg 0.2s; display: block; }
        .btn-new:hover { background: #2563EB; }

        /* Cards do Dashboard */
        .kpi-card-clean { background: white; padding: 24px; border-radius: 12px; border: 1px solid #E5E7EB; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .kpi-title { font-size: 0.875rem; color: #6B7280; font-weight: 500; margin-bottom: 8px; }
        .kpi-value { font-size: 1.875rem; font-weight: 700; color: #3B82F6; }
        
        /* Tabelas */
        .table-container { background: white; border-radius: 12px; border: 1px solid #E5E7EB; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .custom-table { w-full; width: 100%; text-align: left; border-collapse: collapse; }
        .custom-table th { padding: 16px 24px; background: #F9FAFB; color: #6B7280; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; border-bottom: 1px solid #E5E7EB; }
        .custom-table td { padding: 16px 24px; border-bottom: 1px solid #E5E7EB; color: #374151; font-size: 0.875rem; }
        .custom-table tr:last-child td { border-bottom: none; }
        .custom-table tr:hover { background-color: #F9FAFB; cursor: pointer; }

        /* Status Badges (Bolinhas) */
        .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .st-draft .status-dot { background: #9CA3AF; } /* Cinza */
        .st-sent .status-dot { background: #3B82F6; } /* Azul */
        .st-negotiating .status-dot { background: #F59E0B; } /* Laranja */
        .st-approved .status-dot { background: #10B981; } /* Verde */
        .st-canceled .status-dot { background: #EF4444; } /* Vermelho */
        
        .status-text { font-size: 0.85rem; font-weight: 500; }
        .st-draft .status-text { color: #6B7280; }
        .st-sent .status-text { color: #2563EB; }
        .st-negotiating .status-text { color: #D97706; }
        .st-approved .status-text { color: #059669; }
        .st-canceled .status-text { color: #DC2626; }

        /* Mobile */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); width: 100%; max-width: 300px; }
            .sidebar.open { transform: translateX(0); box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
            .main-content { margin-left: 0; padding: 1rem; }
            .mobile-header { display: flex !important; }
        }
        .mobile-header { display: none; justify-content: space-between; align-items: center; padding: 1rem; background: white; border-bottom: 1px solid #E5E7EB; margin-bottom: 1rem; border-radius: 8px; }

        /* Utilities */
        .hidden { display: none !important; }
        .loader-spin { width: 30px; height: 30px; border: 3px solid #E5E7EB; border-top-color: #3B82F6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Assinatura */
        #signature-pad { border: 2px dashed #cbd5e1; border-radius: 12px; background: #f8fafc; cursor: crosshair; touch-action: none; width: 100%; height: 200px; }
    </style>
</head>
<body>

    <div id="system-loader" style="position:fixed; inset:0; background:white; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <div class="loader-spin mb-4"></div>
        <p class="text-sm text-gray-500 font-medium">Carregando MeOrçamentos...</p>
    </div>

    <section id="view-login" class="hidden min-h-screen flex items-center justify-center bg-gray-50 p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-gray-100">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">MeOrçamentos</h1>
                <p class="text-gray-500">Gestão inteligente e segura.</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email de acesso</label>
                    <input type="email" id="email" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="seu@email.com">
                </div>
                <button onclick="handleLogin()" id="btn-login" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition shadow-lg shadow-blue-200">Entrar no Sistema</button>
            </div>
        </div>
    </section>

    <div id="app-layout" class="hidden">
        
        <div class="mobile-header">
            <span class="font-bold text-lg text-blue-600">MeOrçamentos</span>
            <button onclick="document.querySelector('.sidebar').classList.toggle('open')" class="text-gray-600"><i class="fas fa-bars text-xl"></i></button>
        </div>

        <aside class="sidebar">
            <div class="p-6 flex items-center gap-2 border-b border-gray-100">
                <i class="fas fa-file-invoice-dollar text-2xl text-blue-600"></i>
                <span class="font-bold text-xl tracking-tight text-gray-800">MeOrçamentos</span>
            </div>

            <div onclick="createProject()" class="btn-new shadow-lg shadow-blue-200">
                <i class="fas fa-plus mr-2"></i> Novo Orçamento
            </div>

            <nav class="flex-1 overflow-y-auto py-2">
                <div onclick="switchTab('dashboard')" class="nav-item active" id="nav-dashboard">
                    <i class="fas fa-home"></i> Visão geral
                </div>
                <div onclick="switchTab('projects')" class="nav-item" id="nav-projects">
                    <i class="fas fa-file-alt"></i> Orçamentos
                </div>
                
                <div class="px-6 py-4 mt-2">
                    <p class="text-xs font-bold text-gray-400 uppercase mb-2">Status</p>
                    <div onclick="filterProjects('draft')" class="flex items-center text-sm text-gray-600 py-1 cursor-pointer hover:text-blue-600"><span class="h-2 w-2 rounded-full bg-gray-400 mr-2"></span> Rascunhos</div>
                    <div onclick="filterProjects('sent')" class="flex items-center text-sm text-gray-600 py-1 cursor-pointer hover:text-blue-600"><span class="h-2 w-2 rounded-full bg-blue-500 mr-2"></span> Enviados</div>
                    <div onclick="filterProjects('approved')" class="flex items-center text-sm text-gray-600 py-1 cursor-pointer hover:text-blue-600"><span class="h-2 w-2 rounded-full bg-green-500 mr-2"></span> Aprovados</div>
                    <div onclick="filterProjects('canceled')" class="flex items-center text-sm text-gray-600 py-1 cursor-pointer hover:text-blue-600"><span class="h-2 w-2 rounded-full bg-red-500 mr-2"></span> Rejeitados</div>
                </div>

                <div onclick="switchTab('clients')" class="nav-item" id="nav-clients">
                    <i class="fas fa-users"></i> Clientes
                </div>
                <div class="nav-item opacity-50 cursor-not-allowed">
                    <i class="fas fa-tags"></i> Catálogo <span class="text-[10px] bg-gray-200 px-1 rounded ml-auto">Em breve</span>
                </div>
                <div class="nav-item opacity-50 cursor-not-allowed">
                    <i class="fas fa-cog"></i> Preferências
                </div>
            </nav>

            <div class="p-4 border-t border-gray-100">
                <button onclick="logout()" class="flex items-center text-sm text-red-500 font-medium hover:text-red-700 w-full px-4 py-2">
                    <i class="fas fa-sign-out-alt mr-3"></i> Sair
                </button>
            </div>
        </aside>

        <main class="main-content">
            
            <section id="view-dashboard" class="space-y-6">
                <h2 class="text-2xl font-bold text-gray-800">Visão geral</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="kpi-card-clean">
                        <div class="kpi-title">Orçamentos este mês</div>
                        <div class="kpi-value" id="kpi-month-count">0</div>
                    </div>
                    <div class="kpi-card-clean">
                        <div class="kpi-title">Total em reais este mês</div>
                        <div class="kpi-value text-green-600" id="kpi-month-total">R$ 0,00</div>
                    </div>
                    <div class="kpi-card-clean">
                        <div class="kpi-title">Total Orçamentos</div>
                        <div class="kpi-value text-gray-800" id="kpi-all-count">0</div>
                    </div>
                    <div class="kpi-card-clean">
                        <div class="kpi-title">Clientes Ativos</div>
                        <div class="kpi-value text-indigo-600" id="kpi-client-count">0</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white p-6 rounded-12 border border-gray-200 rounded-xl shadow-sm">
                        <h3 class="font-bold text-gray-700 mb-4">Orçamentos por dia (Últimos 30 dias)</h3>
                        <div style="height: 300px;">
                            <canvas id="dashboardChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-12 border border-gray-200 rounded-xl shadow-sm">
                        <h3 class="font-bold text-gray-700 mb-4">Últimos Orçamentos</h3>
                        <div id="mini-project-list" class="space-y-3">
                            </div>
                    </div>
                </div>
            </section>

            <section id="view-projects" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">Orçamentos</h2>
                    <button onclick="createProject()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700">+ Novo</button>
                </div>

                <div class="bg-white p-4 rounded-xl border border-gray-200 flex flex-col md:flex-row gap-4">
                    <div class="flex-1 relative">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        <input id="search-input" onkeyup="renderProjectTable()" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg outline-none focus:border-blue-500" placeholder="Buscar por número, cliente...">
                    </div>
                    <select id="status-filter" onchange="renderProjectTable()" class="p-2 border border-gray-300 rounded-lg outline-none bg-white">
                        <option value="all">Todos os status</option>
                        <option value="draft">Rascunhos</option>
                        <option value="sent">Enviados</option>
                        <option value="approved">Aprovados</option>
                        <option value="canceled">Cancelados</option>
                    </select>
                </div>

                <div class="table-container">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Número</th>
                                <th>Cliente</th>
                                <th>Data</th>
                                <th class="text-right">Total</th>
                                <th class="text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="project-table-body">
                            </tbody>
                    </table>
                </div>
            </section>

            <section id="view-clients" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">Clientes</h2>
                    <button onclick="alert('Funcionalidade em desenvolvimento: Adicionar Cliente Direto')" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700">+ Novo Cliente</button>
                </div>
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                    <p class="text-sm text-gray-500 mb-4">Lista baseada nos orçamentos cadastrados.</p>
                    <div class="table-container">
                        <table class="custom-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Documento</th>
                                    <th>Email</th>
                                    <th>Orçamentos</th>
                                </tr>
                            </thead>
                            <tbody id="client-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="view-editor" class="hidden pb-20">
                 <div class="flex items-center gap-4 mb-6">
                    <button onclick="switchTab('projects')" class="text-gray-400 hover:text-gray-800"><i class="fas fa-arrow-left text-xl"></i></button>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                            <span id="ed-title">Carregando...</span>
                            <span id="ed-status-badge-editor" class="text-xs px-2 py-1 rounded bg-gray-200 text-gray-600">DRAFT</span>
                        </h2>
                        <p class="text-sm text-gray-500" id="ed-subtitle">V1 • Editando</p>
                    </div>
                    <div class="ml-auto flex gap-2">
                        <button onclick="save()" class="bg-gray-800 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-gray-900"><i class="fas fa-save mr-2"></i> Salvar</button>
                        <button onclick="openShareModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700 shadow-lg shadow-blue-200"><i class="fas fa-share-alt mr-2"></i> Enviar</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                    <div class="xl:col-span-2 space-y-6">
                        
                        <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                            <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Dados do Cliente</h3>
                            <div class="flex gap-2 mb-4 bg-gray-50 p-1 rounded-lg inline-flex" id="cl-type-btns">
                                </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="text-xs font-bold text-gray-500 uppercase">Nome</label><input id="c-name" onchange="upVal('c-name',this.value)" class="w-full p-2 border rounded bg-gray-50"></div>
                                <div><label class="text-xs font-bold text-gray-500 uppercase">Doc (CPF/CNPJ)</label><input id="c-doc" onchange="upVal('c-doc',this.value)" class="w-full p-2 border rounded bg-gray-50"></div>
                                <div><label class="text-xs font-bold text-gray-500 uppercase">Telefone</label><input id="c-phone" onchange="upVal('c-phone',this.value)" class="w-full p-2 border rounded bg-gray-50"></div>
                                <div><label class="text-xs font-bold text-gray-500 uppercase">Email</label><input id="c-email" onchange="upVal('c-email',this.value)" class="w-full p-2 border rounded bg-gray-50"></div>
                                <div class="md:col-span-2"><label class="text-xs font-bold text-gray-500 uppercase">Endereço</label><input id="c-addr" onchange="upVal('c-addr',this.value)" class="w-full p-2 border rounded bg-gray-50"></div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                            <div class="flex justify-between items-center mb-4 border-b pb-2">
                                <h3 class="text-lg font-bold text-gray-800">Itens do Orçamento</h3>
                                <button onclick="addItem()" class="text-blue-600 font-bold text-sm hover:underline">+ Adicionar Item</button>
                            </div>
                            <div id="ed-items" class="space-y-3">
                                </div>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div class="bg-gray-900 text-white p-6 rounded-xl shadow-lg">
                            <p class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-1">Valor Total</p>
                            <div id="ed-total" class="text-3xl font-bold">R$ 0,00</div>
                        </div>

                        <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                            <h3 class="text-sm font-bold text-gray-800 mb-4 uppercase">Condições</h3>
                            <div class="space-y-3">
                                <div><label class="text-xs text-gray-500">Forma de Pagamento</label>
                                <select id="pay-mode" class="w-full p-2 border rounded text-sm"><option value="single">À Vista</option><option value="entry_installments">Entrada + Parcelas</option></select>
                                <button onclick="generatePayment()" class="w-full mt-2 bg-gray-100 text-gray-600 text-xs font-bold py-2 rounded hover:bg-gray-200">Gerar Texto Pagamento</button>
                                </div>
                                <div><label class="text-xs text-gray-500">Prazo Entrega</label><input id="t-deadline" onchange="upVal('t-deadline',this.value)" class="w-full p-2 border rounded text-sm"></div>
                                <div><label class="text-xs text-gray-500">Validade Proposta</label><input id="t-val" onchange="upVal('t-val',this.value)" class="w-full p-2 border rounded text-sm"></div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                            <h3 class="text-sm font-bold text-gray-800 mb-4 uppercase">Anexos</h3>
                            <div id="ed-attachments-list" class="mb-3"></div>
                            <label class="block w-full text-center border-2 border-dashed border-gray-300 p-2 rounded cursor-pointer hover:bg-gray-50 text-xs text-gray-500">
                                <i class="fas fa-upload mr-1"></i> Upload Arquivo
                                <input type="file" class="hidden" onchange="handleUpload(event)">
                            </label>
                        </div>
                         <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                             <h3 class="text-sm font-bold text-gray-800 mb-4 uppercase">Meus Dados (Prestador)</h3>
                             <div class="space-y-2">
                                <input id="p-name" placeholder="Meu Nome/Empresa" class="w-full text-xs p-2 border rounded" onchange="upSettings('providerName',this.value)">
                                <input id="p-doc" placeholder="Meu CNPJ/CPF" class="w-full text-xs p-2 border rounded" onchange="upSettings('providerDoc',this.value)">
                                <input id="p-phone" placeholder="Meu Telefone" class="w-full text-xs p-2 border rounded" onchange="upSettings('providerPhone',this.value)">
                             </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm max-h-60 overflow-y-auto">
                            <h3 class="text-sm font-bold text-gray-800 mb-4 uppercase">Histórico</h3>
                            <div id="ed-history" class="text-xs space-y-2 text-gray-500"></div>
                         </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <section id="view-public" class="hidden min-h-screen bg-gray-100 p-4 md:py-10">
        <div id="public-content" class="max-w-4xl mx-auto bg-white shadow-xl min-h-[297mm] p-10 relative">
             <div id="stamp-approved" class="hidden absolute top-10 right-10 border-4 border-green-600 text-green-600 font-bold text-3xl px-6 py-2 uppercase opacity-30 transform -rotate-12 z-20">APROVADO</div>
             
             <div class="flex justify-between border-b pb-8 mb-8">
                <div id="doc-provider-info"></div>
                <div class="text-right">
                    <h1 class="text-2xl font-bold text-gray-800">Proposta Comercial</h1>
                    <div id="doc-id" class="text-gray-500 text-sm">#000</div>
                    <div id="doc-date" class="text-gray-400 text-xs mt-1"></div>
                </div>
             </div>

             <div class="bg-gray-50 p-6 rounded-lg mb-8 flex justify-between">
                <div>
                    <span class="text-xs font-bold text-gray-400 uppercase">Cliente</span>
                    <div id="doc-c-name" class="font-bold text-lg text-gray-800"></div>
                    <div id="doc-c-doc" class="text-sm text-gray-500"></div>
                </div>
                <div class="text-right">
                     <span class="text-xs font-bold text-gray-400 uppercase">Local</span>
                     <div id="doc-c-addr" class="text-sm text-gray-600 max-w-xs ml-auto"></div>
                </div>
             </div>

             <table class="w-full mb-8">
                <thead>
                    <tr class="border-b border-gray-200 text-left text-xs uppercase text-gray-400">
                        <th class="pb-2">Descrição</th>
                        <th class="pb-2 text-center">Qtd</th>
                        <th class="pb-2 text-right">Total</th>
                    </tr>
                </thead>
                <tbody id="doc-items-body" class="text-sm text-gray-700"></tbody>
             </table>

             <div id="doc-attachments-section" class="mb-8 hidden">
                <h4 class="text-sm font-bold text-gray-800 mb-2">Anexos</h4>
                <div id="doc-attachments-grid" class="grid grid-cols-2 gap-4"></div>
             </div>

             <div class="flex flex-col md:flex-row gap-8 border-t pt-8">
                <div class="flex-1">
                    <h4 class="font-bold text-sm text-gray-800 mb-2">Condições de Pagamento</h4>
                    <p id="doc-payment" class="text-sm text-gray-600 whitespace-pre-line mb-4"></p>
                    <div class="flex gap-4 text-xs text-gray-500">
                        <div><span class="font-bold block">Prazo:</span> <span id="doc-deadline"></span></div>
                        <div><span class="font-bold block">Validade:</span> <span id="doc-validity"></span></div>
                    </div>
                </div>
                <div class="text-right">
                    <span class="text-xs font-bold text-gray-400 uppercase">Total Final</span>
                    <div id="doc-total" class="text-3xl font-bold text-gray-900">R$ 0,00</div>
                </div>
             </div>

             <div id="doc-signature-area" class="mt-8"></div>

             <div id="doc-actions" class="mt-12 no-print flex gap-4 justify-end"></div>
        </div>
    </section>

    <div id="interaction-modal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md p-6 rounded-xl shadow-2xl animate-[fadeInUp_0.3s]">
            <h3 id="modal-title" class="text-xl font-bold mb-2"></h3>
            <p id="modal-desc" class="text-sm text-gray-500 mb-4"></p>
            <textarea id="modal-input" class="w-full border p-3 rounded mb-4 h-24 text-sm" placeholder="Digite aqui..."></textarea>
            <div id="modal-sig-area" class="hidden mb-4">
                <canvas id="signature-pad"></canvas>
                <button id="clear-sig" class="text-xs text-red-500 underline mt-1 float-right">Limpar</button>
            </div>
            <div class="flex gap-2 mt-4">
                <button onclick="document.getElementById('interaction-modal').classList.add('hidden')" class="flex-1 py-3 border rounded font-bold text-gray-500">Cancelar</button>
                <button id="modal-btn" class="flex-1 py-3 bg-gray-900 text-white rounded font-bold"></button>
            </div>
        </div>
    </div>

    <div id="share-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl w-full max-w-sm text-center">
            <h3 class="font-bold text-lg mb-4">Enviar Proposta</h3>
            <button id="btn-share-wa" class="w-full bg-green-500 text-white py-3 rounded-lg font-bold mb-3 flex items-center justify-center gap-2"><i class="fab fa-whatsapp"></i> WhatsApp</button>
            <button id="btn-share-copy" class="w-full bg-gray-100 text-gray-700 py-3 rounded-lg font-bold mb-3">Copiar Link</button>
            <button onclick="document.getElementById('share-modal').classList.add('hidden')" class="text-sm text-gray-400 underline">Fechar</button>
        </div>
    </div>

    <script>
        // CONFIGURAÇÃO DO SUPABASE (MANTIDA SUA CHAVE)
        const SUPABASE_URL = 'https://outasfgohiiyndsjciau.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im91dGFzZmdvaGlpeW5kc2pjaWF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4MTk4ODIsImV4cCI6MjA4NTM5NTg4Mn0.4yvGfYbQYf806FJcs34yPGkuU_kVTYHW8mBtbU3JD80';
        
        let db = null;
        let state = { user: null, projectsCache: [], project: null, version: null, data: normalizeData(null), snapshot: [] };
        let chartInstance = null;

        function normalizeData(dbData) {
            const schema = { 
                client: { name: '', doc: '', email: '', phone: '', address: '', type: 'pj' }, 
                location: { address: '', sameAsClient: true }, 
                items: [], 
                terms: { paymentMode: 'custom', paymentText: '', deadline: '', validity: '10 dias', obs: '' }, 
                settings: { myPhone: '', serviceType: 'Outros', providerName: '', providerDoc: '', providerAddr: '', providerPhone: '' }, 
                history: [], attachments: [], signature: null 
            };
            if (!dbData) return schema;
            return { 
                client: { ...schema.client, ...(dbData.client || {}) }, 
                location: { ...schema.location, ...(dbData.location || {}) }, 
                items: (Array.isArray(dbData.items) ? dbData.items : []).map(i => ({...i, id: i.id || 'item_'+Math.random()})), 
                terms: { ...schema.terms, ...(dbData.terms || {}) }, 
                settings: { ...schema.settings, ...(dbData.settings || {}) }, 
                history: Array.isArray(dbData.history) ? dbData.history : [],
                attachments: Array.isArray(dbData.attachments) ? dbData.attachments : [],
                signature: dbData.signature || null
            };
        }

        async function init() {
            const { createClient } = supabase;
            db = createClient(SUPABASE_URL, SUPABASE_KEY);
            
            const params = new URLSearchParams(window.location.search);
            const view = params.get('view') || 'login';
            const id = params.get('id');

            // Autenticação Check
            const { data: { session } } = await db.auth.getSession();
            state.user = session?.user;

            // Roteamento
            document.getElementById('system-loader').style.display = 'none';
            document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
            document.getElementById('app-layout').classList.add('hidden');

            if (view === 'public' && id) {
                await loadPublicProposal(id);
            } else if (!state.user) {
                document.getElementById('view-login').classList.remove('hidden');
            } else {
                document.getElementById('app-layout').classList.remove('hidden');
                // Carrega dados globais
                await loadProjects(); 
                
                if (view === 'editor' && id) {
                    await loadEditor(id);
                    switchTab('editor', false); // false = não mudar URL, já estamos lá
                } else if (view === 'clients') {
                    switchTab('clients');
                } else if (view === 'projects') {
                    switchTab('projects');
                } else {
                    switchTab('dashboard');
                }
            }
        }

        async function handleLogin() {
            const email = document.getElementById('email').value;
            if(!email) return alert("Digite o email");
            document.getElementById('btn-login').innerText = "Enviando...";
            const { error } = await db.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.href }});
            if(error) alert(error.message);
            else alert("Link enviado para o seu e-mail!");
            document.getElementById('btn-login').innerText = "Entrar";
        }

        async function logout() {
            await db.auth.signOut();
            window.location.href = window.location.pathname;
        }

        function switchTab(tabName, updateUrl = true) {
            // Esconde todas as seções internas do main
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-projects').classList.add('hidden');
            document.getElementById('view-clients').classList.add('hidden');
            document.getElementById('view-editor').classList.add('hidden');
            
            // Remove active da sidebar
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

            if(tabName === 'dashboard') {
                document.getElementById('view-dashboard').classList.remove('hidden');
                document.getElementById('nav-dashboard').classList.add('active');
                renderDashboardCharts();
            } else if (tabName === 'projects') {
                document.getElementById('view-projects').classList.remove('hidden');
                document.getElementById('nav-projects').classList.add('active');
                renderProjectTable();
            } else if (tabName === 'clients') {
                document.getElementById('view-clients').classList.remove('hidden');
                document.getElementById('nav-clients').classList.add('active');
                renderClientTable();
            } else if (tabName === 'editor') {
                document.getElementById('view-editor').classList.remove('hidden');
            }

            // Fecha sidebar no mobile
            document.querySelector('.sidebar').classList.remove('open');
            
            if(updateUrl) {
                const url = tabName === 'dashboard' ? '?' : `?view=${tabName}`;
                window.history.pushState(null, '', url);
            }
        }

        async function loadProjects() {
            const { data, error } = await db.from('projects').select('*, versions(status, total_value, version_number)').eq('user_id', state.user.id).order('created_at', { ascending: false });
            if(data) {
                // Prepara cache simplificado
                state.projectsCache = data.map(p => {
                    const lastVer = p.versions?.sort((a,b)=>b.version_number - a.version_number)[0] || {status:'draft', total_value:0};
                    return { ...p, status: lastVer.status, total: lastVer.total_value, verId: lastVer.id }; // simplificando acesso
                });
            }
        }

        // --- DASHBOARD ---
        function renderDashboardCharts() {
            // KPIs
            const now = new Date();
            const thisMonth = state.projectsCache.filter(p => new Date(p.created_at).getMonth() === now.getMonth());
            document.getElementById('kpi-month-count').innerText = thisMonth.length;
            document.getElementById('kpi-month-total').innerText = thisMonth.reduce((acc, p) => acc + (p.total||0), 0).toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            document.getElementById('kpi-all-count').innerText = state.projectsCache.length;
            
            // Contagem Clientes Únicos
            const clients = new Set(state.projectsCache.map(p => p.client_name).filter(Boolean));
            document.getElementById('kpi-client-count').innerText = clients.size;

            // Lista Mini
            const miniList = document.getElementById('mini-project-list');
            miniList.innerHTML = state.projectsCache.slice(0,5).map(p => `
                <div class="flex justify-between items-center border-b border-gray-100 pb-2">
                    <div>
                        <div class="font-bold text-sm text-gray-700">${p.name}</div>
                        <div class="text-xs text-gray-500">${p.client_name || 'Sem cliente'}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-blue-600 text-sm">${(p.total||0).toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</div>
                        <div class="text-[10px] uppercase font-bold text-gray-400">${getStatusLabel(p.status).label}</div>
                    </div>
                </div>
            `).join('');

            // Gráfico Chart.js
            const ctx = document.getElementById('dashboardChart');
            if(chartInstance) chartInstance.destroy();
            
            // Agrupar por dia
            const days = {};
            for(let i=29; i>=0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const key = d.toLocaleDateString('pt-BR').slice(0,5); // DD/MM
                days[key] = 0;
            }
            state.projectsCache.forEach(p => {
                const d = new Date(p.created_at).toLocaleDateString('pt-BR').slice(0,5);
                if(days[d] !== undefined) days[d]++;
            });

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Object.keys(days),
                    datasets: [{
                        label: 'Orçamentos',
                        data: Object.values(days),
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false} } }
            });
        }

        // --- LISTA PROJETOS ---
        function renderProjectTable() {
            const tbody = document.getElementById('project-table-body');
            const term = document.getElementById('search-input').value.toLowerCase();
            const filter = document.getElementById('status-filter').value;
            
            const filtered = state.projectsCache.filter(p => {
                const matchTerm = (p.name+p.client_name).toLowerCase().includes(term);
                const matchStatus = filter === 'all' || p.status === filter;
                return matchTerm && matchStatus;
            });

            tbody.innerHTML = filtered.map(p => {
                const st = getStatusLabel(p.status);
                return `
                <tr onclick="openProject('${p.id}')">
                    <td><div class="status-text ${st.class}"><span class="status-dot"></span>${st.label}</div></td>
                    <td>#${p.id.substr(0,6).toUpperCase()}</td>
                    <td class="font-bold">${p.client_name || 'Novo'}</td>
                    <td>${new Date(p.created_at).toLocaleDateString()}</td>
                    <td class="text-right font-bold">${(p.total||0).toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</td>
                    <td class="text-center text-gray-400"><i class="fas fa-chevron-right"></i></td>
                </tr>`;
            }).join('') || '<tr><td colspan="6" class="text-center py-8 text-gray-400">Nenhum orçamento encontrado.</td></tr>';
        }

        function getStatusLabel(status) {
            const map = {
                'draft': { label: 'Rascunho', class: 'st-draft' },
                'sent': { label: 'Enviado', class: 'st-sent' },
                'negotiating': { label: 'Em Negoc.', class: 'st-negotiating' },
                'approved': { label: 'Aprovado', class: 'st-approved' },
                'canceled': { label: 'Recusado', class: 'st-canceled' }
            };
            return map[status] || map['draft'];
        }

        function filterProjects(status) {
            switchTab('projects');
            document.getElementById('status-filter').value = status;
            renderProjectTable();
        }

        // --- CLIENTES (Lógica Simulada) ---
        function renderClientTable() {
            const tbody = document.getElementById('client-table-body');
            // Extrai clientes únicos dos projetos
            const clientsMap = {};
            state.projectsCache.forEach(p => {
                if(p.client_name && p.client_name !== 'Novo Cliente') {
                    if(!clientsMap[p.client_name]) clientsMap[p.client_name] = { count: 0, last: p.created_at };
                    clientsMap[p.client_name].count++;
                }
            });

            tbody.innerHTML = Object.keys(clientsMap).map(name => `
                <tr>
                    <td class="font-bold">${name}</td>
                    <td class="text-gray-500">-</td>
                    <td class="text-gray-500">-</td>
                    <td><span class="bg-blue-100 text-blue-800 py-1 px-3 rounded-full text-xs font-bold">${clientsMap[name].count} Orçamentos</span></td>
                </tr>
            `).join('') || '<tr><td colspan="4" class="text-center py-8">Nenhum cliente identificado nos orçamentos.</td></tr>';
        }

        // --- EDITOR LOGIC ---
        async function createProject() {
            const name = prompt("Nome do Projeto:");
            if(!name) return;
            const { data, error } = await db.from('projects').insert({ name, user_id: state.user.id, client_name: 'Novo Cliente' }).select().single();
            if(data) {
                // Cria versão inicial
                await db.from('versions').insert({ project_id: data.id, version_number: 1, items: normalizeData(null), total_value: 0, status: 'draft' });
                await loadProjects(); // recarrega cache
                openProject(data.id);
            }
        }

        function openProject(id) {
            const url = `?view=editor&id=${id}`;
            window.history.pushState(null, '', url);
            loadEditor(id).then(() => switchTab('editor', false));
        }

        async function loadEditor(id) {
            const { data: proj } = await db.from('projects').select('*').eq('id', id).single();
            const { data: vers } = await db.from('versions').select('*').eq('project_id', id).order('version_number', { ascending: true });
            state.project = proj;
            state.version = vers[vers.length - 1];
            state.data = normalizeData(state.version.items);
            state.snapshot = JSON.parse(JSON.stringify(state.data.items));

            // Populate Fields
            document.getElementById('ed-title').innerText = proj.name;
            const st = getStatusLabel(state.version.status);
            const badge = document.getElementById('ed-status-badge-editor');
            badge.innerText = st.label;
            badge.className = `text-xs px-2 py-1 rounded font-bold uppercase ml-2 ${st.class.replace('st-', 'bg-').replace('text', 'bg')}-100 text-${st.class.replace('st-', 'text-')}-600`; // Hack css rapido

            // Carrega inputs
            const d = state.data;
            setVal('p-name', d.settings.providerName); setVal('p-doc', d.settings.providerDoc); setVal('p-phone', d.settings.providerPhone);
            setVal('c-name', d.client.name); setVal('c-doc', d.client.doc); setVal('c-email', d.client.email); setVal('c-phone', d.client.phone); setVal('c-addr', d.client.address);
            setVal('t-deadline', d.terms.deadline); setVal('t-val', d.terms.validity);
            
            // Render Items
            renderItems();
            renderAttachments();
            renderHistory();
            updateTotal();
        }

        function setVal(id, v) { const el = document.getElementById(id); if(el) el.value = v || ''; }
        function upVal(k, v) { 
            if(k.startsWith('c-')) state.data.client[k.substring(2)] = v;
            if(k.startsWith('t-')) state.data.terms[k.substring(2)] = v;
        }
        function upSettings(k, v) { state.data.settings[k] = v; }

        function renderItems() {
            const container = document.getElementById('ed-items');
            container.innerHTML = state.data.items.map((item, idx) => `
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 relative group">
                    <button onclick="rmItem(${idx})" class="absolute top-2 right-2 text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-trash"></i></button>
                    <div class="grid grid-cols-12 gap-2 mb-2">
                        <div class="col-span-8">
                            <input class="w-full bg-transparent font-bold text-gray-700 outline-none" value="${item.name}" placeholder="Nome do item" oninput="upItem(${idx}, 'name', this.value)">
                        </div>
                        <div class="col-span-2">
                            <input type="number" class="w-full bg-white border rounded p-1 text-center text-xs" value="${item.qty}" onchange="upItem(${idx}, 'qty', this.value)">
                        </div>
                        <div class="col-span-2">
                             <input type="number" class="w-full bg-white border rounded p-1 text-right text-xs" value="${item.price}" onchange="upItem(${idx}, 'price', this.value)">
                        </div>
                    </div>
                    <textarea class="w-full bg-transparent text-xs text-gray-500 resize-none outline-none" rows="1" placeholder="Descrição..." oninput="upItem(${idx}, 'description', this.value)">${item.description || ''}</textarea>
                </div>
            `).join('');
        }

        function upItem(idx, field, val) {
            state.data.items[idx][field] = field === 'qty' || field === 'price' ? parseFloat(val) : val;
            if(field === 'qty' || field === 'price') updateTotal();
        }
        function addItem() {
            state.data.items.push({ id: Date.now(), name: '', qty: 1, price: 0 });
            renderItems();
        }
        function rmItem(idx) {
            if(confirm('Remover item?')) { state.data.items.splice(idx, 1); renderItems(); updateTotal(); }
        }

        function updateTotal() {
            const total = state.data.items.reduce((acc, i) => acc + (i.qty * i.price), 0);
            document.getElementById('ed-total').innerText = total.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
        }

        async function save() {
            const total = state.data.items.reduce((acc, i) => acc + (i.qty * i.price), 0);
            
            // Log History se mudou algo (simplificado)
            if(JSON.stringify(state.snapshot) !== JSON.stringify(state.data.items)) {
                state.data.history.push({ date: new Date(), action: 'edited', user: 'provider', detail: 'Alterou itens' });
                state.snapshot = JSON.parse(JSON.stringify(state.data.items));
            }

            if(state.data.client.name) await db.from('projects').update({client_name: state.data.client.name}).eq('id', state.project.id);
            await db.from('versions').update({ items: state.data, total_value: total }).eq('id', state.version.id);
            renderHistory();
            alert("Salvo com sucesso!");
        }

        // --- ANEXOS ---
        async function handleUpload(e) {
            const file = e.target.files[0];
            if(!file) return;
            const path = `${state.project.id}/${Date.now()}_${file.name}`;
            const { data, error } = await db.storage.from('attachments').upload(path, file);
            if(!error) {
                const { data: pub } = db.storage.from('attachments').getPublicUrl(path);
                state.data.attachments.push({ name: file.name, url: pub.publicUrl, type: 'file' });
                save(); renderAttachments();
            } else alert("Erro upload");
        }

        function renderAttachments() {
            const html = state.data.attachments.map(a => `<div class="flex justify-between text-xs bg-gray-50 p-2 rounded mb-1"><a href="${a.url}" target="_blank" class="text-blue-600 truncate">${a.name}</a></div>`).join('');
            document.getElementById('ed-attachments-list').innerHTML = html;
        }

        function renderHistory() {
            const h = document.getElementById('ed-history');
            h.innerHTML = state.data.history.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(x => `
                <div class="pl-2 border-l-2 border-gray-300">
                    <div class="font-bold">${x.action}</div>
                    <div>${new Date(x.date).toLocaleDateString()} - ${x.detail || ''}</div>
                </div>
            `).join('');
        }

        // --- PUBLIC & SHARE ---
        function openShareModal() {
            save().then(() => {
                const url = `${window.location.origin}${window.location.pathname}?view=public&id=${state.version.id}`;
                document.getElementById('share-modal').classList.remove('hidden');
                
                document.getElementById('btn-share-copy').onclick = () => {
                    navigator.clipboard.writeText(url);
                    alert("Link copiado!");
                };
                
                document.getElementById('btn-share-wa').onclick = () => {
                    const phone = (state.data.client.phone||'').replace(/\D/g,'');
                    window.open(`https://wa.me/${phone}?text=${encodeURIComponent('Olá, segue o orçamento: ' + url)}`);
                };
            });
        }

        async function loadPublicProposal(id) {
            document.getElementById('view-public').classList.remove('hidden');
            const { data: v } = await db.from('versions').select('*, projects(name)').eq('id', id).single();
            state.version = v;
            state.data = normalizeData(v.items);
            const d = state.data;

            if(v.status === 'approved') document.getElementById('stamp-approved').classList.remove('hidden');

            document.getElementById('doc-c-name').innerText = d.client.name;
            document.getElementById('doc-c-doc').innerText = d.client.doc;
            document.getElementById('doc-c-addr').innerText = d.client.address;
            document.getElementById('doc-id').innerText = `#${v.project_id.substr(0,4)}`;
            document.getElementById('doc-date').innerText = new Date(v.created_at).toLocaleDateString();
            document.getElementById('doc-total').innerText = (v.total_value||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
            document.getElementById('doc-payment').innerText = d.terms.paymentText || 'A combinar';

            // Itens Públicos
            document.getElementById('doc-items-body').innerHTML = d.items.map(i => `
                <tr class="border-b border-gray-100">
                    <td class="py-3 pr-2">
                        <div class="font-bold text-gray-700">${i.name}</div>
                        <div class="text-xs text-gray-500">${i.description||''}</div>
                    </td>
                    <td class="text-center text-gray-600">${i.qty}</td>
                    <td class="text-right font-bold text-gray-800">${(i.qty*i.price).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</td>
                </tr>
            `).join('');

            // Ações Públicas
            const actions = document.getElementById('doc-actions');
            if(v.status === 'sent' || v.status === 'negotiating') {
                actions.innerHTML = `
                    <button onclick="openInteraction('approve')" class="bg-green-600 text-white px-6 py-3 rounded-lg font-bold shadow-lg hover:bg-green-700 transition transform hover:scale-105">APROVAR PROPOSTA</button>
                    <button onclick="openInteraction('refuse')" class="bg-red-50 text-red-600 border border-red-200 px-6 py-3 rounded-lg font-bold hover:bg-red-100">Recusar / Pedir Ajuste</button>
                `;
            }
        }

        // --- INTERAÇÃO CLIENTE (ASSINATURA) ---
        function openInteraction(type) {
            const modal = document.getElementById('interaction-modal');
            const title = document.getElementById('modal-title');
            const btn = document.getElementById('modal-btn');
            const sig = document.getElementById('modal-sig-area');
            const input = document.getElementById('modal-input');
            
            modal.classList.remove('hidden');
            
            if(type === 'approve') {
                title.innerText = "Assinar e Aprovar";
                input.classList.add('hidden');
                sig.classList.remove('hidden');
                btn.innerText = "Confirmar Aprovação";
                btn.classList.add('bg-green-600');
                btn.onclick = () => submitInteraction('approved');
                setTimeout(initSignaturePad, 100);
            } else {
                title.innerText = "Motivo da Recusa ou Ajuste";
                input.classList.remove('hidden');
                sig.classList.add('hidden');
                btn.innerText = "Enviar";
                btn.classList.add('bg-red-600');
                btn.onclick = () => submitInteraction('negotiating');
            }
        }

        function initSignaturePad() {
            const canvas = document.getElementById('signature-pad');
            const ctx = canvas.getContext('2d');
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio; canvas.height = canvas.offsetHeight * ratio;
            ctx.scale(ratio, ratio);
            
            let painting = false;
            function draw(e) {
                if(!painting) return;
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX||e.touches[0].clientX) - rect.left;
                const y = (e.clientY||e.touches[0].clientY) - rect.top;
                ctx.lineWidth = 2; ctx.lineCap = 'round'; ctx.lineTo(x, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y);
            }
            canvas.onmousedown = (e)=>{ painting=true; draw(e); };
            canvas.onmouseup = ()=>{ painting=false; ctx.beginPath(); };
            canvas.onmousemove = draw;
            document.getElementById('clear-sig').onclick = ()=> ctx.clearRect(0,0,canvas.width,canvas.height);
        }

        async function submitInteraction(status) {
            const canvas = document.getElementById('signature-pad');
            if(status === 'approved') state.data.signature = canvas.toDataURL();
            
            const detail = status === 'approved' ? 'Cliente aprovou via link' : document.getElementById('modal-input').value;
            state.data.history.push({ date: new Date(), action: status, user: 'client', detail });
            
            await db.from('versions').update({ status, items: state.data }).eq('id', state.version.id);
            alert("Registrado com sucesso!");
            window.location.reload();
        }

        window.onload = init;
    </script>
</body>
</html>
