<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aprovado | Gestão Inteligente</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        /* ... (mantenha todos os estilos existentes) ... */
        
        /* NOVOS ESTILOS PARA CONTROLE DE ALTERAÇÕES */
        .item-original { border-left: 4px solid #3b82f6; background-color: #f0f9ff; }
        .item-altered { border-left: 4px solid #f59e0b; background-color: #fffbeb; }
        .item-added { border-left: 4px solid #10b981; background-color: #f0fdf4; }
        .item-removed { border-left: 4px solid #ef4444; background-color: #fef2f2; opacity: 0.7; }
        .item-change-badge { font-size: 0.6rem; padding: 2px 6px; border-radius: 10px; margin-left: 8px; }
        .change-highlight { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { background-color: transparent; } 50% { background-color: #fef3c7; } 100% { background-color: transparent; } }
        
        /* Modal de comparação */
        .comparison-modal { max-width: 900px; max-height: 80vh; }
        .comparison-old { background: #fef2f2; }
        .comparison-new { background: #f0fdf4; }
        .diff-added { background: #bbf7d0; text-decoration: line-through; }
        .diff-removed { background: #fecaca; }
        .diff-changed { background: #fed7aa; }
        
        /* Abas no editor */
        .tab-button { padding: 10px 20px; border: none; background: #f1f5f9; border-radius: 8px 8px 0 0; cursor: pointer; }
        .tab-button.active { background: white; border-bottom: 2px solid #3b82f6; font-weight: bold; }
        .tab-content { display: none; padding: 20px; background: white; border-radius: 0 0 8px 8px; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- ... (mantenha todo o HTML existente até a seção view-editor) ... -->

    <section id="view-editor" class="hidden flex-1 bg-slate-50 h-screen flex flex-col">
        <div id="editor-loading" class="flex-1 flex items-center justify-center bg-slate-50"><div class="loader-spin"></div></div>
        <div id="editor-content" class="hidden flex flex-col h-full">
            <div class="app-header justify-between">
                <div class="flex items-center gap-4">
                    <button onclick="goTo('dashboard')" class="text-slate-400 hover:text-white"><i class="fas fa-arrow-left"></i></button>
                    <div>
                        <h2 id="ed-title" class="font-bold leading-none text-lg text-white">...</h2>
                        <span id="ed-ver" class="text-[10px] text-slate-400 uppercase font-bold">V1</span>
                        <span id="ed-status-badge" class="status-badge ml-2">RASCUNHO</span>
                        <span id="ed-change-indicator" class="ml-2 text-xs bg-amber-500 text-white px-2 py-1 rounded hidden"><i class="fas fa-edit mr-1"></i>Alterações pendentes</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="showComparison()" class="btn btn-secondary bg-blue-600 border-blue-700 text-white hover:bg-blue-700 text-xs"><i class="fas fa-exchange-alt mr-1"></i> Ver Alterações</button>
                    <button onclick="share()" class="btn btn-secondary bg-slate-800 border-slate-700 text-white hover:bg-slate-700 text-xs"><i class="fas fa-link mr-1"></i> Link Cliente</button>
                </div>
            </div>
            
            <!-- NOVO: Abas para controle de alterações -->
            <div class="bg-white border-b px-6">
                <div class="flex gap-1">
                    <button id="tab-scope" class="tab-button active" onclick="switchTab('scope')"><i class="fas fa-list-ol mr-2"></i> Escopo Atual</button>
                    <button id="tab-changes" class="tab-button" onclick="switchTab('changes')"><i class="fas fa-history mr-2"></i> Histórico de Alterações</button>
                    <button id="tab-pending" class="tab-button" onclick="switchTab('pending')">
                        <i class="fas fa-clock mr-2"></i> Alterações Pendentes
                        <span id="pending-count" class="ml-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
                    </button>
                </div>
            </div>
            
            <div class="panel-grid overflow-hidden">
                <div class="overflow-y-auto pr-2 pb-20 no-scrollbar">
                    <!-- ABA: ESCOPO ATUAL -->
                    <div id="tab-scope-content" class="tab-content active">
                        <div class="editor-section">
                            <div class="editor-header"><i class="fas fa-user-tie"></i> Dados do Cliente</div>
                            <div class="editor-body">
                                <!-- ... (dados do cliente mantidos) ... -->
                            </div>
                        </div>
                        <div class="editor-section">
                            <div class="editor-header justify-between">
                                <span><i class="fas fa-list-ol"></i> Escopo</span>
                                <button onclick="addItem()" class="btn btn-primary text-xs py-1 px-3 bg-slate-800 border-none">+ Item</button>
                            </div>
                            <div class="editor-body bg-slate-50 min-h-[300px]">
                                <div id="ed-items"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ABA: HISTÓRICO DE ALTERAÇÕES -->
                    <div id="tab-changes-content" class="tab-content">
                        <div class="editor-section">
                            <div class="editor-header"><i class="fas fa-history"></i> Histórico Completo</div>
                            <div class="editor-body">
                                <div id="change-history" class="space-y-4">
                                    <!-- Histórico será carregado aqui -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ABA: ALTERAÇÕES PENDENTES -->
                    <div id="tab-pending-content" class="tab-content">
                        <div class="editor-section">
                            <div class="editor-header justify-between">
                                <span><i class="fas fa-clock"></i> Alterações Solicitadas pelo Cliente</span>
                                <div class="flex gap-2">
                                    <button onclick="acceptAllChanges()" class="btn btn-primary text-xs py-1 px-3 bg-green-600 border-none"><i class="fas fa-check mr-1"></i>Aceitar Todas</button>
                                    <button onclick="rejectAllChanges()" class="btn btn-primary text-xs py-1 px-3 bg-red-600 border-none"><i class="fas fa-times mr-1"></i>Rejeitar Todas</button>
                                </div>
                            </div>
                            <div class="editor-body">
                                <div id="pending-changes" class="space-y-4">
                                    <!-- Alterações pendentes serão carregadas aqui -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Painel direito mantido -->
                <div class="overflow-y-auto pb-20 no-scrollbar">
                    <!-- ... (financeiro e histórico mantidos) ... -->
                </div>
            </div>
        </div>
    </section>

    <!-- ... (restante do HTML mantido) ... -->

    <!-- NOVO MODAL PARA COMPARAÇÃO DE ALTERAÇÕES -->
    <div id="comparison-modal" class="modal-overlay">
        <div class="modal-box comparison-modal">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-800"><i class="fas fa-exchange-alt mr-2"></i> Comparação de Alterações</h3>
                <button onclick="closeComparison()" class="text-slate-400 hover:text-slate-700"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="grid grid-cols-2 gap-6 mb-6">
                <div>
                    <h4 class="font-bold text-slate-700 mb-2 bg-slate-100 p-2 rounded"><i class="fas fa-file-alt mr-2"></i> Versão Anterior</h4>
                    <div id="comparison-old" class="space-y-3 max-h-[400px] overflow-y-auto p-2"></div>
                </div>
                <div>
                    <h4 class="font-bold text-slate-700 mb-2 bg-slate-100 p-2 rounded"><i class="fas fa-edit mr-2"></i> Versão Atual (com alterações)</h4>
                    <div id="comparison-new" class="space-y-3 max-h-[400px] overflow-y-auto p-2"></div>
                </div>
            </div>
            
            <div class="border-t pt-4">
                <h4 class="font-bold text-slate-700 mb-2">Legenda:</h4>
                <div class="flex gap-4 text-xs">
                    <div class="flex items-center"><div class="w-3 h-3 bg-blue-500 mr-1"></div> Item original</div>
                    <div class="flex items-center"><div class="w-3 h-3 bg-amber-500 mr-1"></div> Item alterado</div>
                    <div class="flex items-center"><div class="w-3 h-3 bg-green-500 mr-1"></div> Item adicionado</div>
                    <div class="flex items-center"><div class="w-3 h-3 bg-red-500 mr-1"></div> Item removido</div>
                </div>
            </div>
            
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="closeComparison()" class="px-4 py-2 border rounded text-slate-600">Fechar</button>
                <button onclick="applyComparisonChanges()" class="px-4 py-2 bg-blue-600 text-white rounded">Aplicar Alterações</button>
            </div>
        </div>
    </div>

    <script>
        console.log("Aprovado.app com controle de alterações iniciando...");
        
        // --- ESTRUTURA DE DADOS APRIMORADA ---
        let state = { 
            user: null, 
            project: null, 
            version: null, 
            projectsCache: [], 
            data: { 
                client: {}, 
                location: {}, 
                items: [], 
                terms: {}, 
                settings: {}, 
                history: [],
                // NOVO: Controle de alterações
                changeLog: [],        // Histórico de todas as alterações
                pendingChanges: [],   // Alterações solicitadas pelo cliente ainda não revisadas
                originalItems: []     // Cópia dos itens originais para comparação
            } 
        };
        
        // NOVO: Sistema de controle de versões por item
        function enhanceItem(item, index, status = 'original') {
            return {
                ...item,
                id: item.id || `item_${Date.now()}_${index}`,
                status: status,
                history: item.history || [],
                created: item.created || new Date().toISOString(),
                lastModified: new Date().toISOString(),
                modifiedBy: state.user ? 'provider' : 'client',
                version: state.version?.version_number || 1
            };
        }
        
        // NOVO: Registrar alteração em um item
        function logItemChange(itemId, field, oldValue, newValue, reason = '') {
            const change = {
                id: `change_${Date.now()}`,
                itemId: itemId,
                field: field,
                oldValue: oldValue,
                newValue: newValue,
                timestamp: new Date().toISOString(),
                user: state.user ? 'provider' : 'client',
                reason: reason,
                status: 'pending', // pending, accepted, rejected
                reviewedBy: null,
                reviewedAt: null
            };
            
            state.data.changeLog.push(change);
            
            // Se for alteração do cliente, adicionar às pendentes
            if (!state.user && state.version.status === 'negotiating') {
                state.data.pendingChanges.push(change);
                updatePendingCount();
            }
            
            return change;
        }
        
        // NOVO: Atualizar contador de pendências
        function updatePendingCount() {
            const pending = state.data.pendingChanges.filter(c => c.status === 'pending').length;
            document.getElementById('pending-count').textContent = pending;
            
            if (pending > 0) {
                document.getElementById('ed-change-indicator').classList.remove('hidden');
                document.getElementById('tab-pending').classList.add('change-highlight');
            } else {
                document.getElementById('ed-change-indicator').classList.add('hidden');
                document.getElementById('tab-pending').classList.remove('change-highlight');
            }
        }
        
        // NOVO: Trocar abas
        function switchTab(tabName) {
            // Atualizar botões
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Atualizar conteúdo
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`tab-${tabName}-content`).classList.add('active');
            
            // Carregar conteúdo específico se necessário
            if (tabName === 'changes') {
                renderChangeHistory();
            } else if (tabName === 'pending') {
                renderPendingChanges();
            }
        }
        
        // NOVO: Renderizar histórico de alterações
        function renderChangeHistory() {
            const container = document.getElementById('change-history');
            if (!container) return;
            
            let html = '';
            
            if (state.data.changeLog.length === 0) {
                html = '<div class="text-center py-10 text-slate-400">Nenhuma alteração registrada ainda.</div>';
            } else {
                // Agrupar por item
                const changesByItem = {};
                state.data.changeLog.forEach(change => {
                    if (!changesByItem[change.itemId]) {
                        changesByItem[change.itemId] = [];
                    }
                    changesByItem[change.itemId].push(change);
                });
                
                // Ordenar por timestamp (mais recente primeiro)
                const sortedItems = Object.keys(changesByItem).sort((a, b) => {
                    const lastChangeA = Math.max(...changesByItem[a].map(c => new Date(c.timestamp)));
                    const lastChangeB = Math.max(...changesByItem[b].map(c => new Date(c.timestamp)));
                    return lastChangeB - lastChangeA;
                });
                
                sortedItems.forEach(itemId => {
                    const itemChanges = changesByItem[itemId];
                    const item = state.data.items.find(i => i.id === itemId);
                    const itemName = item ? item.name : `Item (ID: ${itemId.substring(0,8)}...)`;
                    
                    html += `<div class="border rounded-lg p-4 mb-4 bg-white">
                        <div class="font-bold text-slate-800 mb-2 flex items-center">
                            <i class="fas fa-cube mr-2"></i> ${itemName}
                            <span class="text-xs font-normal ml-2 text-slate-500">(${itemChanges.length} alterações)</span>
                        </div>
                        <div class="space-y-2">`;
                    
                    // Ordenar alterações deste item (mais recente primeiro)
                    itemChanges.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    itemChanges.forEach(change => {
                        const date = new Date(change.timestamp).toLocaleString('pt-BR');
                        const userLabel = change.user === 'provider' ? 'Você' : 'Cliente';
                        const statusBadge = change.status === 'accepted' ? 
                            '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded ml-2">Aceita</span>' :
                            change.status === 'rejected' ?
                            '<span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded ml-2">Rejeitada</span>' :
                            '<span class="bg-amber-100 text-amber-800 text-xs px-2 py-1 rounded ml-2">Pendente</span>';
                        
                        html += `<div class="border-l-2 border-slate-200 pl-3 py-2">
                            <div class="text-xs text-slate-500">${date} • ${userLabel} ${statusBadge}</div>
                            <div class="text-sm">
                                <span class="font-medium">${getFieldLabel(change.field)}:</span> 
                                <span class="text-red-500 line-through mr-1">${change.oldValue || '(vazio)'}</span>
                                <i class="fas fa-arrow-right text-xs text-slate-400 mx-1"></i>
                                <span class="text-green-600 font-medium">${change.newValue || '(vazio)'}</span>
                            </div>
                            ${change.reason ? `<div class="text-xs text-slate-600 mt-1 bg-slate-50 p-2 rounded"><i class="fas fa-comment mr-1"></i> ${change.reason}</div>` : ''}
                        </div>`;
                    });
                    
                    html += `</div></div>`;
                });
            }
            
            container.innerHTML = html;
        }
        
        // NOVO: Renderizar alterações pendentes
        function renderPendingChanges() {
            const container = document.getElementById('pending-changes');
            if (!container) return;
            
            const pending = state.data.pendingChanges.filter(c => c.status === 'pending');
            
            if (pending.length === 0) {
                container.innerHTML = '<div class="text-center py-10 text-slate-400">Nenhuma alteração pendente para revisão.</div>';
                return;
            }
            
            let html = '';
            
            // Agrupar por item
            const changesByItem = {};
            pending.forEach(change => {
                if (!changesByItem[change.itemId]) {
                    changesByItem[change.itemId] = [];
                }
                changesByItem[change.itemId].push(change);
            });
            
            Object.keys(changesByItem).forEach(itemId => {
                const itemChanges = changesByItem[itemId];
                const item = state.data.items.find(i => i.id === itemId);
                const itemName = item ? item.name : `Item (ID: ${itemId.substring(0,8)}...)`;
                
                html += `<div class="border border-amber-200 rounded-lg p-4 mb-4 bg-amber-50">
                    <div class="font-bold text-amber-800 mb-3 flex items-center">
                        <i class="fas fa-exclamation-circle mr-2"></i> ${itemName}
                        <div class="ml-auto flex gap-2">
                            <button onclick="acceptItemChanges('${itemId}')" class="text-xs bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">
                                <i class="fas fa-check mr-1"></i>Aceitar
                            </button>
                            <button onclick="rejectItemChanges('${itemId}')" class="text-xs bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">
                                <i class="fas fa-times mr-1"></i>Rejeitar
                            </button>
                        </div>
                    </div>`;
                
                itemChanges.forEach(change => {
                    html += `<div class="border-l-2 border-amber-300 pl-3 py-2 mb-2 bg-white rounded">
                        <div class="text-xs text-amber-600 mb-1">
                            <i class="fas fa-edit mr-1"></i> ${getFieldLabel(change.field)}
                        </div>
                        <div class="flex items-center text-sm">
                            <div class="flex-1">
                                <span class="text-red-500 line-through mr-2">${change.oldValue || '(vazio)'}</span>
                                <i class="fas fa-arrow-right text-xs text-slate-400 mx-1"></i>
                                <span class="text-green-600 font-medium">${change.newValue || '(vazio)'}</span>
                            </div>
                        </div>
                        ${change.reason ? `<div class="text-xs text-slate-600 mt-2 p-2 bg-slate-50 rounded"><i class="fas fa-comment mr-1"></i> <strong>Motivo:</strong> ${change.reason}</div>` : ''}
                    </div>`;
                });
                
                html += `</div>`;
            });
            
            container.innerHTML = html;
        }
        
        // NOVO: Funções para aceitar/rejeitar alterações
        function acceptItemChanges(itemId) {
            if (!confirm("Aceitar todas as alterações deste item?")) return;
            
            state.data.pendingChanges.forEach(change => {
                if (change.itemId === itemId && change.status === 'pending') {
                    change.status = 'accepted';
                    change.reviewedBy = state.user?.id || 'provider';
                    change.reviewedAt = new Date().toISOString();
                    
                    // Aplicar a alteração ao item
                    const item = state.data.items.find(i => i.id === itemId);
                    if (item) {
                        item[change.field] = change.newValue;
                        item.lastModified = new Date().toISOString();
                        item.modifiedBy = 'provider';
                    }
                }
            });
            
            logHistory('changes_accepted', 'provider', `Alterações no item ${itemId} foram aceitas.`);
            updatePendingCount();
            renderPendingChanges();
            renderEditor();
        }
        
        function rejectItemChanges(itemId) {
            if (!confirm("Rejeitar todas as alterações deste item?")) return;
            
            state.data.pendingChanges.forEach(change => {
                if (change.itemId === itemId && change.status === 'pending') {
                    change.status = 'rejected';
                    change.reviewedBy = state.user?.id || 'provider';
                    change.reviewedAt = new Date().toISOString();
                    
                    // Reverter para o valor original
                    const item = state.data.items.find(i => i.id === itemId);
                    if (item && change.field in item) {
                        item[change.field] = change.oldValue;
                    }
                }
            });
            
            logHistory('changes_rejected', 'provider', `Alterações no item ${itemId} foram rejeitadas.`);
            updatePendingCount();
            renderPendingChanges();
            renderEditor();
        }
        
        function acceptAllChanges() {
            if (!confirm("Aceitar TODAS as alterações pendentes?")) return;
            
            state.data.pendingChanges.forEach(change => {
                if (change.status === 'pending') {
                    change.status = 'accepted';
                    change.reviewedBy = state.user?.id || 'provider';
                    change.reviewedAt = new Date().toISOString();
                    
                    const item = state.data.items.find(i => i.id === change.itemId);
                    if (item) {
                        item[change.field] = change.newValue;
                        item.lastModified = new Date().toISOString();
                        item.modifiedBy = 'provider';
                    }
                }
            });
            
            logHistory('all_changes_accepted', 'provider', 'Todas as alterações pendentes foram aceitas.');
            updatePendingCount();
            renderPendingChanges();
            renderEditor();
            alert("Todas as alterações foram aceitas!");
        }
        
        function rejectAllChanges() {
            if (!confirm("Rejeitar TODAS as alterações pendentes?")) return;
            
            state.data.pendingChanges.forEach(change => {
                if (change.status === 'pending') {
                    change.status = 'rejected';
                    change.reviewedBy = state.user?.id || 'provider';
                    change.reviewedAt = new Date().toISOString();
                    
                    const item = state.data.items.find(i => i.id === change.itemId);
                    if (item && change.field in item) {
                        item[change.field] = change.oldValue;
                    }
                }
            });
            
            logHistory('all_changes_rejected', 'provider', 'Todas as alterações pendentes foram rejeitadas.');
            updatePendingCount();
            renderPendingChanges();
            renderEditor();
            alert("Todas as alterações foram rejeitadas!");
        }
        
        // NOVO: Modal de comparação
        function showComparison() {
            // Salvar cópia atual como referência
            if (!state.data.originalItems || state.data.originalItems.length === 0) {
                state.data.originalItems = JSON.parse(JSON.stringify(state.data.items));
            }
            
            const modal = document.getElementById('comparison-modal');
            const oldContainer = document.getElementById('comparison-old');
            const newContainer = document.getElementById('comparison-new');
            
            // Renderizar versão antiga
            let oldHtml = '';
            state.data.originalItems.forEach((item, index) => {
                oldHtml += `<div class="p-3 border rounded bg-white ${item.status === 'removed' ? 'item-removed' : 'item-original'}">
                    <div class="font-bold text-slate-800">${item.name || 'Item sem nome'}</div>
                    <div class="text-xs text-slate-500">${item.description || 'Sem descrição'}</div>
                    <div class="flex justify-between mt-2 text-sm">
                        <span>Qtd: ${item.qty}</span>
                        <span class="font-bold">R$ ${(item.qty * item.price).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                    </div>
                </div>`;
            });
            oldContainer.innerHTML = oldHtml || '<div class="text-slate-400 text-center p-4">Nenhum item na versão anterior</div>';
            
            // Renderizar versão atual
            let newHtml = '';
            state.data.items.forEach((item, index) => {
                let itemClass = 'item-original';
                if (item.status === 'altered') itemClass = 'item-altered';
                if (item.status === 'added') itemClass = 'item-added';
                
                newHtml += `<div class="p-3 border rounded bg-white ${itemClass}">
                    <div class="font-bold text-slate-800">${item.name || 'Item sem nome'}</div>
                    <div class="text-xs text-slate-500">${item.description || 'Sem descrição'}</div>
                    <div class="flex justify-between mt-2 text-sm">
                        <span>Qtd: ${item.qty}</span>
                        <span class="font-bold">R$ ${(item.qty * item.price).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                    </div>
                    ${item.status !== 'original' ? `<div class="text-xs mt-1 ${item.status === 'added' ? 'text-green-600' : item.status === 'altered' ? 'text-amber-600' : 'text-blue-600'}">
                        <i class="fas fa-info-circle mr-1"></i> ${getStatusLabel(item.status)}
                    </div>` : ''}
                </div>`;
            });
            newContainer.innerHTML = newHtml || '<div class="text-slate-400 text-center p-4">Nenhum item na versão atual</div>';
            
            modal.style.display = 'flex';
        }
        
        function closeComparison() {
            document.getElementById('comparison-modal').style.display = 'none';
        }
        
        function applyComparisonChanges() {
            // Atualizar itens originais para a versão atual
            state.data.originalItems = JSON.parse(JSON.stringify(state.data.items));
            closeComparison();
            alert("Referência de comparação atualizada!");
        }
        
        // NOVO: Helper para labels de campos
        function getFieldLabel(field) {
            const labels = {
                'name': 'Nome do Item',
                'description': 'Descrição',
                'qty': 'Quantidade',
                'price': 'Preço Unitário',
                'type': 'Tipo'
            };
            return labels[field] || field;
        }
        
        // NOVO: Helper para labels de status
        function getStatusLabel(status) {
            const labels = {
                'original': 'Item original',
                'altered': 'Item alterado',
                'added': 'Item adicionado',
                'removed': 'Item removido'
            };
            return labels[status] || status;
        }
        
        // --- MODIFICAÇÕES NAS FUNÇÕES EXISTENTES ---
        
        // Modificar a função addItem para usar o sistema aprimorado
        function addItem() { 
            console.log("Adicionando item...");
            if(!Array.isArray(state.data.items)) state.data.items = [];
            
            const newItem = enhanceItem({
                name: 'Novo Item',
                description: '',
                qty: 1,
                price: 0,
                type: state.version?.version_number > 1 ? 'addon' : 'original'
            }, state.data.items.length, 'added');
            
            state.data.items.push(newItem);
            
            // Registrar criação do item
            logItemChange(newItem.id, 'name', '', 'Novo Item', 'Item criado');
            logItemChange(newItem.id, 'qty', '', '1', 'Item criado');
            logItemChange(newItem.id, 'price', '', '0', 'Item criado');
            
            console.log("Itens após adicionar:", state.data.items.length);
            renderEditor(); 
        }
        
        // Modificar upItem para registrar alterações
        function upItem(i, field, value) { 
            const item = state.data.items[i];
            if (!item) return;
            
            const oldValue = item[field];
            item[field] = (field === 'qty' || field === 'price') ? parseFloat(value) || 0 : value;
            item.lastModified = new Date().toISOString();
            item.modifiedBy = state.user ? 'provider' : 'client';
            
            // Se o valor realmente mudou, registrar a alteração
            if (oldValue !== value) {
                item.status = item.status === 'original' || item.status === 'added' ? 'altered' : item.status;
                
                // Para cliente: registrar motivo se estiver em modo de negociação
                let reason = '';
                if (!state.user && state.version.status === 'negotiating') {
                    reason = prompt(`Por que você está alterando ${getFieldLabel(field)}? (opcional)`, '') || '';
                }
                
                logItemChange(item.id, field, oldValue, value, reason);
            }
            
            renderEditor(); 
        }
        
        // Modificar rmItem para registrar remoção
        function rmItem(i) { 
            const item = state.data.items[i];
            if (!item) return;
            
            if(confirm("Remover este item?")) {
                // Registrar remoção
                logItemChange(item.id, 'status', item.status, 'removed', 'Item removido');
                item.status = 'removed';
                
                // Se for cliente em negociação, manter no array mas marcado como removido
                if (!state.user && state.version.status === 'negotiating') {
                    renderEditor();
                } else {
                    // Para provedor, remover completamente
                    state.data.items.splice(i, 1);
                    renderEditor(); 
                }
            }
        }
        
        // Modificar normalizeData para incluir o novo sistema
        function normalizeData(dbData) {
            const schema = { 
                client: { name: '', doc: '', email: '', phone: '', address: '' }, 
                location: { address: '', sameAsClient: true }, 
                items: [], 
                terms: { paymentMode: 'custom', paymentText: '', deadline: '', validity: '10 dias', obs: '' }, 
                settings: { myPhone: '', serviceType: 'Outros' }, 
                history: [],
                changeLog: [],
                pendingChanges: [],
                originalItems: []
            };
            
            if (!dbData) return schema;

            let rawItems = [];
            if (Array.isArray(dbData.items)) { rawItems = dbData.items; }
            else if (dbData.scope && Array.isArray(dbData.scope)) { rawItems = dbData.scope; }

            // Processar itens com sistema aprimorado
            const cleanItems = rawItems.map((i, index) => {
                const enhanced = enhanceItem({
                    name: i.name || '',
                    description: i.description || '',
                    qty: parseFloat(i.qty) || 1,
                    price: parseFloat(i.price) || 0,
                    type: i.type || 'original',
                    id: i.id || `item_${Date.now()}_${index}`,
                    status: i.status || 'original',
                    history: i.history || []
                }, index, i.status || 'original');
                return enhanced;
            });
            
            return { 
                client: { ...schema.client, ...(dbData.client || {}) }, 
                location: { ...schema.location, ...(dbData.location || {}) }, 
                items: cleanItems, 
                terms: { ...schema.terms, ...(dbData.terms || {}) }, 
                settings: { ...schema.settings, ...(dbData.settings || {}) }, 
                history: Array.isArray(dbData.history) ? dbData.history : [],
                changeLog: Array.isArray(dbData.changeLog) ? dbData.changeLog : [],
                pendingChanges: Array.isArray(dbData.pendingChanges) ? dbData.pendingChanges : [],
                originalItems: Array.isArray(dbData.originalItems) ? dbData.originalItems : cleanItems
            };
        }
        
        // Modificar renderEditor para mostrar status dos itens
        function renderEditor() {
            const d = state.data; 
            const isLocked = state.version.status === 'approved' || state.version.status === 'canceled';
            const isNegotiating = state.version.status === 'negotiating' && !state.user; // Cliente visualizando
            
            safeText('ed-title', state.project.name);
            safeText('ed-ver', `V${state.version.version_number}`);
            
            const badge = document.getElementById('ed-status-badge');
            if(badge) {
                let badgeClass = 'st-draft';
                if (state.version.status === 'sent') badgeClass = 'st-sent';
                if (state.version.status === 'negotiating') badgeClass = 'st-negotiating';
                if (state.version.status === 'approved') badgeClass = 'st-approved';
                if (state.version.status === 'canceled') badgeClass = 'st-canceled';
                
                badge.className = `status-badge ml-2 ${badgeClass}`;
                badge.innerText = state.version.status === 'negotiating' ? 'EM NEGOCIAÇÃO' : state.version.status.toUpperCase();
            }
            
            // Atualizar contador de pendências
            updatePendingCount();
            
            // Renderizar itens com status
            let html = ''; 
            let total = 0;
            const items = Array.isArray(d.items) ? d.items : [];
            
            items.forEach((item, index) => {
                if (item.status === 'removed' && !isNegotiating) {
                    // Não mostrar itens removidos para o provedor
                    return;
                }
                
                const t = (item.qty||0)*(item.price||0); 
                total+=t;
                
                // Determinar classe CSS baseada no status
                let itemClass = '';
                let statusBadge = '';
                
                if (item.status === 'altered') {
                    itemClass = 'item-altered';
                    statusBadge = '<span class="item-change-badge bg-amber-100 text-amber-800"><i class="fas fa-edit mr-1"></i>Alterado</span>';
                } else if (item.status === 'added') {
                    itemClass = 'item-added';
                    statusBadge = '<span class="item-change-badge bg-green-100 text-green-800"><i class="fas fa-plus mr-1"></i>Novo</span>';
                } else if (item.status === 'removed') {
                    itemClass = 'item-removed';
                    statusBadge = '<span class="item-change-badge bg-red-100 text-red-800"><i class="fas fa-trash mr-1"></i>Removido</span>';
                } else {
                    itemClass = 'item-original';
                }
                
                html += `<div class="${itemClass} bg-white border p-4 rounded-lg mb-2 relative group">
                    <div class="flex justify-between items-start mb-1">
                        <div class="font-bold text-slate-800">${statusBadge}</div>
                        ${!isLocked && item.status !== 'removed' ? 
                            `<button onclick="rmItem(${index})" class="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100">
                                <i class="fas fa-trash"></i>
                            </button>` : 
                            ''
                        }
                    </div>
                    
                    <div class="grid grid-cols-12 gap-2 mb-2">
                        <div class="col-span-8">
                            <label class="text-[10px] uppercase font-bold text-slate-400">Item</label>
                            <input class="w-full font-bold bg-transparent outline-none" 
                                   value="${item.name}" 
                                   onchange="upItem(${index},'name',this.value)" 
                                   ${isLocked || item.status === 'removed' ? 'disabled' : ''}>
                        </div>
                        <div class="col-span-2">
                            <label class="text-[10px] uppercase font-bold text-slate-400 text-center block">Qtd</label>
                            <input type="number" class="w-full text-center bg-slate-50 rounded" 
                                   value="${item.qty}" 
                                   onchange="upItem(${index},'qty',this.value)" 
                                   ${isLocked || item.status === 'removed' ? 'disabled' : ''}>
                        </div>
                        <div class="col-span-2">
                            <label class="text-[10px] uppercase font-bold text-slate-400 text-right block">$$</label>
                            <input type="number" class="w-full text-right bg-slate-50 rounded" 
                                   value="${item.price}" 
                                   onchange="upItem(${index},'price',this.value)" 
                                   ${isLocked || item.status === 'removed' ? 'disabled' : ''}>
                        </div>
                    </div>
                    
                    <textarea class="w-full text-xs text-slate-500 bg-transparent outline-none resize-none" 
                              rows="1" 
                              onchange="upItem(${index},'description',this.value)" 
                              placeholder="Descrição técnica..." 
                              ${isLocked || item.status === 'removed' ? 'disabled' : ''}>${item.description||''}</textarea>
                    
                    ${item.lastModified ? `
                    <div class="text-[10px] text-slate-400 mt-2">
                        <i class="fas fa-history mr-1"></i> 
                        Última alteração: ${new Date(item.lastModified).toLocaleDateString('pt-BR')}
                        ${item.modifiedBy === 'client' ? ' (pelo cliente)' : ''}
                    </div>` : ''}
                </div>`;
            });
            
            setHTML('ed-items', html);
            safeText('ed-total', total.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}));
            
            // ... (resto do renderEditor mantido)
        }
        
        // Inicializar sistema quando o cliente solicita alteração
        async function sendLogic(action, newStatus, text) {
            logHistory(action, 'client', text);
            
            // Quando cliente solicita alteração, marcar todos os itens como referência original
            if (action === 'change_request') {
                state.data.originalItems = JSON.parse(JSON.stringify(state.data.items));
                
                // Marcar itens alterados pelo cliente
                state.data.items.forEach(item => {
                    if (item.modifiedBy === 'client') {
                        item.status = 'altered';
                    }
                });
            }
            
            await db.from('versions').update({ 
                status: newStatus, 
                items: state.data 
            }).eq('id', state.version.id);
            
            const modal = document.getElementById('interaction-modal'); 
            if(modal) modal.style.display = 'none';
            showSuccessScreen(action);
        }
        
        // Inicializar
        window.onload = init;
        window.onpopstate = init;
        
        // ... (restante do código JavaScript mantido)
        
    </script>

</body>
</html>
