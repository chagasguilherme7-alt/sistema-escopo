<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aprovado | Acesso</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; color: #334155; }
        h1, h2, h3, .brand-font { font-family: 'Outfit', sans-serif; }

        /* --- ANIMAÇÕES DE FUNDO (O "Mover" que você pediu) --- */
        @keyframes float { 0% { transform: translate(0px, 0px) scale(1); } 33% { transform: translate(30px, -50px) scale(1.1); } 66% { transform: translate(-20px, 20px) scale(0.9); } 100% { transform: translate(0px, 0px) scale(1); } }
        @keyframes float-delay { 0% { transform: translate(0px, 0px) scale(1); } 33% { transform: translate(-30px, 50px) scale(1.2); } 66% { transform: translate(20px, -20px) scale(0.8); } 100% { transform: translate(0px, 0px) scale(1); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Layout de Login */
        .login-wrapper { display: flex; min-height: 100vh; overflow: hidden; }
        
        /* Lado Esquerdo (Visual) */
        .login-visual { 
            position: relative; width: 50%; background: #0f172a; color: white; 
            display: flex; flex-direction: column; justify-content: center; padding: 6vw; 
            overflow: hidden; z-index: 1;
        }
        
        /* As "Luzes" Flutuantes */
        .blob { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.4; z-index: -1; }
        .blob-1 { top: -10%; left: -10%; width: 500px; height: 500px; background: #10B981; animation: float 10s ease-in-out infinite; }
        .blob-2 { bottom: -10%; right: -10%; width: 600px; height: 600px; background: #3B82F6; animation: float-delay 12s ease-in-out infinite; }

        /* Conteúdo Animado */
        .anim-entry { animation: fadeInUp 0.8s ease-out forwards; opacity: 0; }
        .delay-100 { animation-delay: 0.1s; }
        .delay-200 { animation-delay: 0.2s; }
        .delay-300 { animation-delay: 0.3s; }

        .feature-box { 
            background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(10px); padding: 20px; border-radius: 16px; margin-bottom: 16px; 
            display: flex; align-items: center; gap: 16px; transition: transform 0.3s;
        }
        .feature-box:hover { transform: translateX(10px); background: rgba(255, 255, 255, 0.1); border-color: #10B981; }
        .feature-icon { 
            width: 48px; height: 48px; background: linear-gradient(135deg, #10B981 0%, #059669 100%); 
            border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; 
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        /* Lado Direito (Form) */
        .login-form-side { width: 50%; background: white; display: flex; align-items: center; justify-content: center; padding: 2rem; position: relative; }
        .form-container { width: 100%; max-width: 400px; }
        
        .input-modern { 
            width: 100%; padding: 16px; background: #F1F5F9; border: 2px solid transparent; 
            border-radius: 12px; font-size: 1rem; color: #334155; transition: all 0.3s; outline: none; text-align: center;
        }
        .input-modern:focus { background: white; border-color: #10B981; box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1); }
        
        .btn-modern { 
            width: 100%; padding: 16px; background: #0F172A; color: white; font-weight: 700; 
            border-radius: 12px; font-size: 1rem; margin-top: 16px; transition: all 0.3s; 
            box-shadow: 0 10px 20px -5px rgba(15, 23, 42, 0.15); cursor: pointer; border: none;
        }
        .btn-modern:hover { transform: translateY(-2px); box-shadow: 0 20px 25px -5px rgba(15, 23, 42, 0.2); background: #1E293B; }

        /* Mobile */
        @media (max-width: 1024px) { 
            .login-visual { display: none; } 
            .login-form-side { width: 100%; background: #F8FAFC; } 
            .form-container { background: white; padding: 40px; border-radius: 24px; box-shadow: 0 20px 40px -10px rgba(0,0,0,0.05); }
        }

        /* Resto do Sistema (Dashboard/Editor) */
        .app-header { background: #FFFFFF; border-bottom: 1px solid #E2E8F0; height: 70px; display: flex; align-items: center; padding: 0 32px; justify-content: space-between; position: sticky; top: 0; z-index: 50; }
        .panel-grid { display: grid; grid-template-columns: 1fr 380px; gap: 24px; max-width: 1600px; margin: 32px auto; padding: 0 24px; height: calc(100vh - 130px); }
        
        .project-item { background: white; border: 1px solid #E2E8F0; border-radius: 16px; padding: 24px; transition: all 0.2s; cursor: pointer; position: relative; overflow: hidden; }
        .project-item:hover { transform: translateY(-4px); box-shadow: 0 15px 30px -5px rgba(0,0,0,0.05); border-color: #10B981; }
        
        .editor-section { background: white; border: 1px solid #E2E8F0; border-radius: 16px; overflow: hidden; margin-bottom: 24px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .editor-header { background: #F8FAFC; padding: 16px 24px; border-bottom: 1px solid #E2E8F0; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; color: #64748B; letter-spacing: 0.05em; display: flex; align-items: center; gap: 8px; }
        .input-field { width: 100%; background: #fff; border: 1px solid #CBD5E1; border-radius: 8px; padding: 10px; font-size: 0.9rem; transition: all 0.2s; }
        .input-field:focus { border-color: #10B981; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); outline: none; }
        
        /* Loading Overlay */
        #system-loader { position: fixed; inset: 0; background: #0F172A; z-index: 9999; display: flex; flex-col: column; align-items: center; justify-content: center; color: white; transition: opacity 0.5s; }
        @media print { body { background: white; } .no-print { display: none !important; } }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <div id="system-loader">
        <div class="loader-spin"></div>
        <h2 class="text-2xl font-bold tracking-widest text-emerald-400 brand-font mt-4">APROVADO</h2>
    </div>

    <script>
        // =================================================================
        // ⚠️ SUAS CHAVES DO SUPABASE
        // =================================================================
        const SUPABASE_URL = 'https://outasfgohiiyndsjciau.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im91dGFzZmdvaGlpeW5kc2pjaWF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4MTk4ODIsImV4cCI6MjA4NTM5NTg4Mn0.4yvGfYbQYf806FJcs34yPGkuU_kVTYHW8mBtbU3JD80';
        // =================================================================

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);

        let state = { user: null, project: null, version: null, data: { items: [], client: {}, terms: {}, location: {} } };

        // --- LÓGICA DE DADOS ---
        function normalizeData(dbData) {
            const schema = { client: { name: '', doc: '', email: '', phone: '', address: '' }, location: { address: '', sameAsClient: true }, items: [], terms: { paymentMode: 'custom', paymentText: '', deadline: '', validity: '10 dias', obs: '' }, settings: { myPhone: '' } };
            if (!dbData) return schema;
            const items = (Array.isArray(dbData) ? dbData : (dbData.items || dbData.scope || [])).map(i => ({
                name: i.name || '', description: i.description || '', qty: parseFloat(i.qty)||1, price: parseFloat(i.price)||0, type: i.type || 'original'
            }));
            return {
                client: { ...schema.client, ...(dbData.client || {}) },
                location: { ...schema.location, ...(dbData.location || {}) },
                items: items,
                terms: { ...schema.terms, ...(dbData.terms || {}) },
                settings: { ...schema.settings, ...(dbData.settings || {}) }
            };
        }

        async function init() {
            try {
                const params = new URLSearchParams(window.location.search);
                const view = params.get('view') || 'login';
                const id = params.get('id');

                document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));

                const { data: { session }, error } = await db.auth.getSession();
                state.user = session?.user;

                if (view === 'public') {
                    if(id) loadPublicProposal(id);
                    document.getElementById('view-public').classList.remove('hidden');
                } else if (!state.user && view !== 'login') {
                    window.history.replaceState(null, '', '?view=login');
                    document.getElementById('view-login').classList.remove('hidden');
                } else if (state.user && view === 'login') {
                    goTo('dashboard');
                } else {
                    document.getElementById(`view-${view}`).classList.remove('hidden');
                    if(view === 'dashboard') await loadDashboard();
                    if(view === 'editor' && id) await loadEditor(id);
                }
                setTimeout(() => { document.getElementById('system-loader').style.display='none'; }, 600);
            } catch (e) { alert("Erro: " + e.message); }
        }

        function goTo(view, id = null) {
            window.history.pushState(null, '', id ? `?view=${view}&id=${id}` : `?view=${view}`);
            init();
        }

        async function handleLogin() {
            const email = document.getElementById('email').value;
            const btn = document.getElementById('btn-login');
            if(!email) return alert("Digite o e-mail");
            btn.innerHTML = 'Enviando...';
            const { error } = await db.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.href }});
            if(error) { alert(error.message); btn.innerText = 'Entrar'; }
            else { btn.innerText = 'Verifique seu E-mail'; alert('Link enviado!'); }
        }

        // --- DASHBOARD & EDITOR (Lógica mantida V10) ---
        async function loadDashboard() {
            const list = document.getElementById('project-list');
            list.innerHTML = '<div class="col-span-3 text-center py-10 text-slate-400">Carregando...</div>';
            const { data: projects } = await db.from('projects').select('*, versions(status, total_value, version_number)').eq('user_id', state.user.id).order('created_at', { ascending: false });
            
            let ap = 0, pe = 0; list.innerHTML = '';
            if(!projects || !projects.length) list.innerHTML = `<div class="col-span-3 text-center py-20 border-2 border-dashed border-slate-200 rounded-xl text-slate-400 opacity-50"><i class="fas fa-plus text-4xl mb-4"></i><br>Crie seu primeiro orçamento</div>`;
            else {
                projects.forEach(p => {
                    const v = (p.versions && p.versions.length) ? p.versions.sort((a,b)=>b.version_number-a.version_number)[0] : { total_value: 0, status: 'draft', version_number: 1 };
                    const val = parseFloat(v.total_value)||0; if(v.status==='approved') ap+=val; else pe+=val;
                    list.innerHTML += `<div onclick="goTo('editor', '${p.id}')" class="project-item group"><div class="project-status-bar ${v.status==='approved'?'bg-emerald-500':'bg-amber-400'}"></div><div class="flex justify-between items-start mb-4 pl-2"><div><h3 class="font-bold text-slate-800 text-lg group-hover:text-emerald-600 transition-colors">${p.name}</h3><p class="text-xs text-slate-400 mt-1 font-bold uppercase tracking-wider">V${v.version_number} • ${new Date(p.created_at).toLocaleDateString()}</p></div><span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wide ${v.status==='approved'?'bg-emerald-100 text-emerald-800':'bg-amber-50 text-amber-700'}">${v.status==='approved'?'Aprovado':'Aberto'}</span></div><div class="pl-2 border-t border-slate-50 pt-4 flex justify-between items-end"><div class="text-xs text-slate-500 truncate max-w-[150px] font-medium"><i class="far fa-user mr-1"></i> ${p.client_name||'Cliente'}</div><div class="text-xl font-bold text-slate-900 brand-font">R$ ${val.toLocaleString('pt-BR',{minimumFractionDigits:2})}</div></div></div>`;
                });
            }
            document.getElementById('kpi-revenue').innerText = ap.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
            document.getElementById('kpi-pipeline').innerText = pe.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
        }

        async function createProject() {
            const name = prompt("Nome do Projeto:"); if(!name) return;
            const { data: p, error } = await db.from('projects').insert({ name, user_id: state.user.id, client_name: 'Novo Cliente' }).select().single();
            if(error) return alert(error.message);
            const initialData = normalizeData(null); initialData.settings.myPhone = localStorage.getItem('escopo_phone') || '';
            await db.from('versions').insert({ project_id: p.id, version_number: 1, items: initialData, total_value: 0, status: 'draft' });
            goTo('editor', p.id);
        }

        async function loadEditor(id) {
            document.getElementById('editor-content').classList.add('hidden');
            document.getElementById('editor-loading').classList.remove('hidden');
            const { data: proj } = await db.from('projects').select('*').eq('id', id).single();
            state.project = proj;
            const { data: vers } = await db.from('versions').select('*').eq('project_id', id).order('version_number', {ascending:true});
            state.version = (vers && vers.length) ? vers[vers.length-1] : (await createFirstVersion(id));
            state.data = normalizeData(state.version.items);
            if(state.version.notes && !state.data.terms.obs) state.data.terms.obs = state.version.notes;
            if(!state.data.settings.myPhone) state.data.settings.myPhone = localStorage.getItem('escopo_phone') || '';
            renderEditor();
            document.getElementById('editor-loading').classList.add('hidden');
            document.getElementById('editor-content').classList.remove('hidden');
        }

        async function createFirstVersion(pid) {
            const d = normalizeData(null); d.settings.myPhone = localStorage.getItem('escopo_phone')||'';
            const { data } = await db.from('versions').insert({ project_id: pid, version_number: 1, items: d, total_value: 0, status: 'draft' }).select().single();
            return data;
        }

        function renderEditor() {
            const d = state.data; const isApp = state.version.status === 'approved';
            const set = (id,v) => { const el=document.getElementById(id); if(el) el.value=v||''; };
            const txt = (id,v) => { const el=document.getElementById(id); if(el) el.innerText=v||''; };

            txt('ed-title', state.project.name); txt('ed-ver', `V${state.version.version_number}`);
            set('in-c-name', d.client.name); set('in-c-doc', d.client.doc); set('in-c-email', d.client.email); set('in-c-phone', d.client.phone); set('in-c-addr', d.client.address); set('in-s-myphone', d.settings.myPhone);
            const locCheck = document.getElementById('in-l-check'); if(locCheck) locCheck.checked = d.location.sameAsClient;
            const locAddr = document.getElementById('in-l-addr'); if(locAddr) { locAddr.value = d.location.address||''; locAddr.disabled = d.location.sameAsClient || isApp; }
            set('in-t-dead', d.terms.deadline); set('in-t-val', d.terms.validity); set('in-t-obs', d.terms.obs);
            const payDisp = document.getElementById('payment-display'); if(payDisp) payDisp.innerText = d.terms.paymentText || "Use a calculadora acima.";

            const list = document.getElementById('ed-list'); list.innerHTML = ''; let total = 0;
            if(!d.items.length) list.innerHTML = `<div class="text-center text-sm text-slate-400 py-10 border-2 border-dashed border-slate-200 rounded-lg">Adicione itens ao escopo.</div>`;
            
            d.items.forEach((i, idx) => {
                const tot = (i.qty||0)*(i.price||0); total += tot;
                const locked = isApp || (i.type==='original' && state.version.version_number>1);
                list.innerHTML += `<div class="item-row ${i.type==='addon'?'border-l-4 border-l-amber-400':''}"><div class="flex justify-between mb-3"><span class="text-[10px] font-bold uppercase tracking-wider text-slate-500 bg-slate-100 px-2 py-1 rounded">${i.type==='addon'?'Aditivo':'Item'}</span>${!locked?`<button onclick="rmItem(${idx})" class="text-red-400 text-xs font-bold hover:text-red-600">EXCLUIR</button>`:''}</div><div class="flex gap-4 items-start mb-3"><div class="flex-1"><label class="input-label text-xs font-bold text-slate-500 mb-1 block">Título</label><input value="${i.name}" onchange="upItem(${idx},'name',this.value)" class="input-field font-bold" ${locked?'disabled':''}></div><div class="w-24"><label class="input-label text-xs font-bold text-slate-500 mb-1 block text-center">Qtd</label><input type="number" value="${i.qty}" onchange="upItem(${idx},'qty',this.value)" class="input-field text-center" ${locked?'disabled':''}></div><div class="w-32"><label class="input-label text-xs font-bold text-slate-500 mb-1 block text-right">Preço</label><input type="number" value="${i.price}" onchange="upItem(${idx},'price',this.value)" class="input-field text-right" ${locked?'disabled':''}></div></div><div><label class="input-label text-xs font-bold text-slate-500 mb-1 block">Descrição Técnica</label><textarea onchange="upItem(${idx},'description',this.value)" class="item-tech-desc w-full border border-slate-200 rounded p-2 text-sm" rows="2" ${locked?'disabled':''}>${i.description||''}</textarea></div><div class="text-right mt-2 text-sm font-bold text-slate-900">Total: R$ ${tot.toLocaleString('pt-BR',{minimumFractionDigits:2})}</div></div>`;
            });
            txt('ed-total-display', total.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}));
            
            const acts = document.getElementById('ed-actions'); const btnAdd = document.getElementById('btn-add-item');
            document.querySelectorAll('input, textarea, select').forEach(i => { if(i.id && !i.id.includes('search')) i.disabled = isApp; });
            if(isApp) { acts.innerHTML = `<button onclick="createAddon()" class="btn btn-primary w-full bg-amber-600 border-amber-600 hover:bg-amber-700">Criar Aditivo / Alteração</button>`; if(btnAdd) btnAdd.style.display = 'none'; } 
            else { acts.innerHTML = `<button onclick="save()" class="btn btn-primary w-full py-3 shadow-lg bg-slate-900 text-white font-bold rounded-lg hover:bg-slate-800 transition-colors">SALVAR PROPOSTA</button>`; if(btnAdd) btnAdd.style.display = 'inline-flex'; }
        }

        function upClient(f,v) { state.data.client[f]=v; }
        function toggleLocation(c) { state.data.location.sameAsClient=c; renderEditor(); }
        function upLocation(v) { state.data.location.address=v; }
        function upTerms(f,v) { state.data.terms[f]=v; }
        function upSettings(f,v) { state.data.settings[f]=v; localStorage.setItem('escopo_phone',v); }
        function upItem(i,f,v) { const it=state.data.items[i]; if(f==='qty'||f==='price') it[f]=parseFloat(v)||0; else it[f]=v; renderEditor(); }
        function addItem() { state.data.items.push({name:'',description:'',qty:1,price:0,type:state.version.version_number>1?'addon':'original'}); renderEditor(); }
        function rmItem(i) { state.data.items.splice(i,1); renderEditor(); }
        function calcTotal() { return state.data.items.reduce((acc,i)=>acc+(i.qty*i.price),0); }

        function generatePayment() {
            const tot = calcTotal(); if(tot===0) return alert("Adicione valores.");
            const m = document.getElementById('pay-mode').value; let t = "";
            if(m==='single') t = `Pagamento Único: ${tot.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})} na entrega.`;
            else {
                const ep = prompt("Entrada % (ex: 30)", "30"); const np = prompt("Parcelas (ex: 2)", "2");
                if(!ep || !np) return;
                const ent = tot*(parseInt(ep)/100); const parc = (tot-ent)/parseInt(np);
                t = `CRONOGRAMA:\n1. Entrada: ${ent.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}\n`;
                for(let i=1; i<=parseInt(np); i++) t += `${i+1}. Parcela (30d): ${parc.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}\n`;
            }
            state.data.terms.paymentText = t; renderEditor();
        }

        async function save() {
            const t = calcTotal();
            if(state.data.client.name) await db.from('projects').update({client_name:state.data.client.name}).eq('id',state.project.id);
            const {error} = await db.from('versions').update({items:state.data, total_value:t, notes:state.data.terms.obs}).eq('id',state.version.id);
            if(error) alert(error.message); else alert("Salvo!");
        }

        async function createAddon() {
            if(!confirm("Criar aditivo?")) return;
            const t = calcTotal();
            const {error} = await db.from('versions').insert({project_id:state.project.id, version_number:state.version.version_number+1, items:state.data, total_value:t, status:'draft'});
            if(!error) { alert("Aditivo criado!"); loadEditor(state.project.id); }
        }

        async function share() {
            if(state.version.status!=='approved') await save();
            navigator.clipboard.writeText(`${window.location.origin}${window.location.pathname}?view=public&id=${state.version.id}`);
            alert("Link copiado!");
        }

        async function loadPublicProposal(id) {
            const { data: v } = await db.from('versions').select('*, projects(name)').eq('id', id).maybeSingle();
            if(!v) throw new Error("Não encontrado.");
            state.version = v; const d = normalizeData(v.items);
            const txt = (id,v) => { const el=document.getElementById(id); if(el) el.innerText=v||'-'; };
            txt('doc-title', v.projects?.name); txt('doc-id', `#${v.project_id.substr(0,4).toUpperCase()}-${v.version_number}`);
            txt('doc-date', new Date(v.created_at).toLocaleDateString()); txt('doc-c-name', d.client.name);
            txt('doc-c-doc', d.client.doc); txt('doc-c-addr', d.location.sameAsClient?d.client.address:d.location.address);
            const tb = document.getElementById('doc-items-body'); tb.innerHTML = '';
            d.items.forEach(i => {
                tb.innerHTML += `<tr class="border-b border-slate-100 last:border-0"><td class="py-4 pl-4"><div class="font-bold text-slate-800 ${i.type==='addon'?'text-amber-600':''}">${i.type==='addon'?'[EXTRA] ':''}${i.name}</div>${i.description?`<div class="text-xs text-slate-500 mt-1 whitespace-pre-wrap">${i.description}</div>`:''}</td><td class="text-center text-sm">${i.qty}</td><td class="text-right text-sm pr-4 font-bold">R$ ${(i.qty*i.price).toLocaleString('pt-BR',{minimumFractionDigits:2})}</td></tr>`;
            });
            txt('doc-total', parseFloat(v.total_value).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}));
            txt('doc-payment', d.terms.paymentText); txt('doc-deadline', d.terms.deadline); txt('doc-validity', d.terms.validity); txt('doc-obs', d.terms.obs);
            const acts = document.getElementById('doc-actions');
            if(v.status==='approved') {
                document.getElementById('stamp-approved').classList.remove('hidden');
                acts.innerHTML = `<div class="bg-emerald-50 text-emerald-800 p-4 rounded-lg text-center font-bold border border-emerald-100">PROPOSTA APROVADA</div>`;
            } else {
                acts.innerHTML = `<button onclick="approve()" class="btn btn-success w-full py-4 text-lg shadow-xl uppercase tracking-wider bg-emerald-600 text-white font-bold rounded-lg hover:bg-emerald-700 transition-colors">Aprovar Proposta</button>`;
            }
        }

        async function approve() {
            if(!confirm("Aprovar?")) return;
            let ip='IP'; try{const r=await fetch('https://api.ipify.org?format=json');const j=await r.json();ip=j.ip;}catch(e){}
            await db.from('versions').update({status:'approved', approved_at:new Date(), approved_by_ip:ip}).eq('id',state.version.id);
            const ph = normalizeData(state.version.items).settings?.myPhone;
            if(ph) window.open(`https://wa.me/${ph.replace(/\D/g,'')}?text=${encodeURIComponent(`✅ Aprovado: ${state.version.projects.name}`)}`,'_blank');
            window.location.reload();
        }

        window.onload = init; window.onpopstate = init;
    </script>

    <section id="view-login" class="hidden flex-1 login-wrapper">
        <div class="login-visual">
            <div class="blob blob-1"></div>
            <div class="blob blob-2"></div>

            <div class="z-10 anim-entry">
                <div class="brand-font text-emerald-400 text-sm tracking-widest font-bold mb-4 uppercase">Gestão Inteligente</div>
                <h1 class="text-6xl font-bold mb-6 leading-tight brand-font">Orçamentos que <br><span class="text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-teal-300">Garantem</span> seu Lucro</h1>
                <p class="text-slate-400 text-lg mb-12 max-w-md">O sistema definitivo para quem vende projetos e serviços. Profissionalize sua gestão hoje.</p>
                
                <div class="flex flex-col gap-6">
                    <div class="feature-box delay-100">
                        <div class="feature-icon"><i class="fas fa-shield-alt text-white"></i></div>
                        <div>
                            <h3 class="font-bold text-lg">Evite prejuízos</h3>
                            <p class="text-sm text-slate-300">Registre mudanças de escopo e se proteja.</p>
                        </div>
                    </div>
                    <div class="feature-box delay-200">
                        <div class="feature-icon"><i class="fas fa-check-circle text-white"></i></div>
                        <div>
                            <h3 class="font-bold text-lg">Aprovação do cliente</h3>
                            <p class="text-sm text-slate-300">Link direto, histórico e IP registrado.</p>
                        </div>
                    </div>
                    <div class="feature-box delay-300">
                        <div class="feature-icon"><i class="fas fa-comments text-white"></i></div>
                        <div>
                            <h3 class="font-bold text-lg">Menos discussão</h3>
                            <p class="text-sm text-slate-300">Tudo documentado, sem retrabalho.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="login-form-side">
            <div class="form-container anim-entry delay-300">
                <div class="text-center mb-10">
                    <div class="w-16 h-16 bg-emerald-50 rounded-2xl flex items-center justify-center text-3xl text-emerald-600 mx-auto mb-4 shadow-sm transform rotate-3">
                        <i class="fas fa-check"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-slate-900 brand-font">Acesse sua conta</h2>
                    <p class="text-slate-500 mt-2">Sem senha. Apenas seu e-mail profissional.</p>
                </div>

                <div class="space-y-4">
                    <input type="email" id="email" placeholder="nome@empresa.com" class="input-modern">
                    <button onclick="handleLogin()" id="btn-login" class="btn-modern">Receber Link de Acesso</button>
                </div>
                
                <p class="text-center text-xs text-slate-400 mt-8">
                    Uso liberado • <span class="text-emerald-600 font-bold">Versão Beta</span>
                </p>
            </div>
        </div>
    </section>

    <section id="view-dashboard" class="hidden flex-1 bg-slate-50">
        <div class="app-header bg-white">
            <div class="font-bold text-xl flex items-center gap-2 brand-font tracking-tight"><div class="w-8 h-8 bg-emerald-500 rounded-lg flex items-center justify-center text-white text-sm"><i class="fas fa-check"></i></div> Aprovado</div>
            <div class="flex gap-3">
                <button onclick="createProject()" class="bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-slate-800 transition-colors">+ Novo Projeto</button>
                <button onclick="db.auth.signOut().then(()=>window.location.reload())" class="text-slate-400 hover:text-red-500 px-2 transition-colors"><i class="fas fa-power-off"></i></button>
            </div>
        </div>
        <div class="max-w-7xl mx-auto p-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
                <div class="bg-white p-6 rounded-2xl border border-emerald-100 shadow-sm relative overflow-hidden">
                    <div class="absolute right-0 top-0 p-4 opacity-10 text-6xl text-emerald-500"><i class="fas fa-wallet"></i></div>
                    <div class="text-xs font-bold uppercase text-emerald-600 mb-2 tracking-widest">Aprovado</div>
                    <div class="text-4xl font-bold text-slate-800 brand-font" id="kpi-revenue">R$ 0,00</div>
                </div>
                <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm relative overflow-hidden">
                    <div class="absolute right-0 top-0 p-4 opacity-10 text-6xl text-slate-400"><i class="fas fa-clock"></i></div>
                    <div class="text-xs font-bold uppercase text-amber-500 mb-2 tracking-widest">Em Aberto</div>
                    <div class="text-4xl font-bold text-slate-800 brand-font" id="kpi-pipeline">R$ 0,00</div>
                </div>
            </div>
            <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-6">Seus Projetos</h2>
            <div id="project-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>
    </section>

    <section id="view-editor" class="hidden flex-1 bg-slate-50 h-screen flex flex-col">
        <div id="editor-loading" class="flex-1 flex items-center justify-center"><div class="loader-spin"></div></div>
        <div id="editor-content" class="hidden flex-col h-full">
            <div class="app-header justify-between bg-white">
                <div class="flex items-center gap-4">
                    <button onclick="goTo('dashboard')" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 hover:bg-slate-200"><i class="fas fa-arrow-left"></i></button>
                    <div><h2 id="ed-title" class="font-bold leading-none text-lg text-slate-800">...</h2><span id="ed-ver" class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">V1</span></div>
                </div>
                <button onclick="share()" class="bg-white border border-slate-200 text-slate-700 hover:border-emerald-500 hover:text-emerald-600 px-4 py-2 rounded-lg text-sm font-bold transition-all flex items-center gap-2"><i class="fas fa-link"></i> Link Cliente</button>
            </div>
            <div class="panel-grid overflow-hidden">
                <div class="overflow-y-auto pr-2 pb-20 no-scrollbar">
                    <div class="editor-section"><div class="editor-header"><i class="fas fa-user-tie text-slate-400"></i> Cliente</div><div class="editor-body"><div class="input-group"><label class="input-label text-xs font-bold text-slate-500 mb-1 block">Nome / Empresa</label><input id="in-c-name" onchange="upClient('name',this.value)" class="input-field" placeholder="Ex: Construtora Silva"></div><div class="grid grid-cols-2 gap-4"><div class="input-group"><label class="input-label text-xs font-bold text-slate-500 mb-1 block">CPF/CNPJ</label><input id="in-c-doc" onchange="upClient('doc',this.value)" class="input-field"></div><div class="input-group"><label class="input-label text-xs font-bold text-slate-500 mb-1 block">Telefone</label><input id="in-c-phone" onchange="upClient('phone',this.value)" class="input-field"></div></div><div class="input-group"><label class="input-label text-xs font-bold text-slate-500 mb-1 block">E-mail</label><input id="in-c-email" onchange="upClient('email',this.value)" class="input-field"></div><div class="input-group"><label class="input-label text-xs font-bold text-slate-500 mb-1 block">Endereço</label><input id="in-c-addr" onchange="upClient('address',this.value)" class="input-field"></div><div class="mt-4 pt-4 border-t border-slate-100"><label class="input-label text-xs font-bold text-emerald-600 mb-1 block">Seu WhatsApp (Para receber o Aceite)</label><input id="in-s-myphone" onchange="upSettings('myPhone',this.value)" class="input-field bg-emerald-50 border-emerald-200 text-emerald-800" placeholder="5511999999999"></div></div></div>
                    <div class="editor-section"><div class="editor-header justify-between"><span><i class="fas fa-list-ol text-slate-400"></i> Escopo</span><button id="btn-add-item" onclick="addItem()" class="text-xs bg-slate-900 text-white px-3 py-1 rounded font-bold hover:bg-slate-700">+ Adicionar Item</button></div><div class="editor-body bg-slate-50 min-h-[300px]"><div id="ed-list" class="space-y-3"></div></div></div>
                </div>
                <div class="overflow-y-auto pb-20 no-scrollbar">
                    <div class="editor-section sticky top-0 shadow-lg border-emerald-100"><div class="editor-header bg-emerald-50/50 text-emerald-800"><i class="fas fa-coins"></i> Resumo Financeiro</div><div class="editor-body"><div class="bg-slate-900 text-white p-6 rounded-xl text-center mb-6 shadow-xl"><div class="text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-1">Valor Total</div><div id="ed-total-display" class="text-4xl font-bold brand-font">R$ 0,00</div></div><div class="input-group"><div class="flex gap-2 mb-2"><select id="pay-mode" class="input-field font-bold text-slate-700"><option value="entry_installments">Entrada + Parcelas</option><option value="single">Pagamento Único</option></select><button onclick="generatePayment()" class="bg-slate-200 text-slate-600 px-3 rounded-lg hover:bg-slate-300"><i class="fas fa-calculator"></i></button></div><div id="payment-display" class="text-xs bg-amber-50 p-3 rounded border border-amber-100 text-amber-900 whitespace-pre-line min-h-[60px] font-mono">...</div></div><div class="grid grid-cols-2 gap-4"><div class="input-group"><label class="input-label text-xs font-bold text-slate-500 mb-1 block">Entrega</label><input id="in-t-dead" onchange="upTerms('deadline',this.value)" class="input-field" placeholder="Ex: 15 dias"></div><div class="input-group"><label class="input-label text-xs font-bold text-slate-500 mb-1 block">Validade</label><select id="in-t-val" onchange="upTerms('validity',this.value)" class="input-field"><option>7 dias</option><option>15 dias</option><option>30 dias</option></select></div></div><div class="input-group"><label class="input-label text-xs font-bold text-slate-500 mb-1 block">Observações</label><textarea id="in-t-obs" onchange="upTerms('obs',this.value)" class="input-field h-24 text-sm" placeholder="Garantias, condições..."></textarea></div><div id="ed-actions" class="mt-6"></div></div></div>
                    <div class="editor-section"><div class="editor-header"><i class="fas fa-map-marker-alt text-slate-400"></i> Local</div><div class="editor-body"><label class="flex items-center gap-2 text-xs font-bold text-slate-600 mb-2 cursor-pointer select-none"><input type="checkbox" id="in-l-check" onchange="toggleLocation(this.checked)" class="accent-emerald-500"> Mesmo endereço do cliente</label><input id="in-l-addr" onchange="upLocation(this.value)" class="input-field" placeholder="Endereço da obra/serviço"></div></div>
                </div>
            </div>
        </div>
    </section>

    <section id="view-public" class="hidden min-h-screen bg-slate-200 p-4 md:py-10 overflow-y-auto print:p-0">
        <div id="public-content" class="hidden max-w-4xl mx-auto bg-white shadow-2xl min-h-[297mm] relative flex flex-col">
            <div id="stamp-approved" class="hidden absolute top-10 right-10 border-4 border-emerald-600 text-emerald-600 font-bold text-3xl px-6 py-2 uppercase opacity-30 transform -rotate-12 z-20">APROVADO</div>
            <div class="bg-slate-900 text-white p-12 print:bg-white print:text-black print:border-b-2"><div class="flex justify-between items-start"><div><h1 id="doc-title" class="text-4xl font-bold mb-2 brand-font">Projeto</h1><p class="text-xs uppercase tracking-widest text-slate-400 font-bold">Proposta Técnica e Comercial</p></div><div class="text-right"><div id="doc-id" class="font-bold text-xl text-emerald-400">#REF</div><div id="doc-date" class="text-sm opacity-70 mt-1">--/--/--</div></div></div></div>
            <div class="p-12 flex-1">
                <div class="flex gap-12 mb-12 text-sm"><div class="flex-1"><h3 class="font-bold text-xs uppercase text-slate-400 mb-2 border-b pb-1 tracking-wider">Contratante</h3><div id="doc-c-name" class="font-bold text-xl text-slate-900"></div><div id="doc-c-doc" class="text-slate-500 mt-1"></div></div><div class="flex-1"><h3 class="font-bold text-xs uppercase text-slate-400 mb-2 border-b pb-1 tracking-wider">Local de Execução</h3><div id="doc-c-addr" class="text-slate-700 text-lg"></div></div></div>
                <div class="mb-12"><h3 class="font-bold text-xs uppercase text-slate-400 mb-4 tracking-wider">Escopo Detalhado</h3><table class="w-full text-sm"><tbody id="doc-items-body"></tbody></table></div>
                <div class="bg-slate-50 border border-slate-100 rounded-xl p-8 mb-12 flex gap-12"><div class="flex-1"><h4 class="font-bold text-xs uppercase text-slate-400 mb-3 tracking-wider">Condições de Pagamento</h4><div id="doc-payment" class="text-sm font-mono text-slate-800 whitespace-pre-line bg-white p-4 rounded border border-slate-200"></div><div class="mt-4 flex gap-8 text-sm"><div><span class="font-bold text-xs uppercase text-slate-400 block mb-1">Prazo de Entrega</span><span id="doc-deadline" class="font-bold text-slate-900"></span></div><div><span class="font-bold text-xs uppercase text-slate-400 block mb-1">Validade da Proposta</span><span id="doc-validity" class="font-bold text-slate-900"></span></div></div></div><div class="text-right"><h4 class="font-bold text-xs uppercase text-slate-400 mb-2 tracking-wider">Investimento Total</h4><div id="doc-total" class="text-4xl font-bold text-slate-900 brand-font">R$ 0,00</div></div></div>
                <div id="doc-obs" class="text-xs text-slate-500 italic text-justify leading-relaxed"></div>
                <div class="p-6 text-center text-[10px] text-slate-400 border-t border-slate-100 mt-auto">Documento gerado profissionalmente via <strong>Aprovado</strong> • Crie o seu grátis em <span class="text-blue-600 font-bold">aprovado.app</span></div>
                <div id="doc-actions" class="no-print mt-8"></div>
            </div>
            <div class="bg-slate-50 p-4 text-center border-t no-print"><button onclick="window.print()" class="text-xs font-bold text-slate-400 uppercase hover:text-slate-600 transition-colors"><i class="fas fa-print mr-1"></i> Salvar PDF / Imprimir</button></div>
        </div>
    </section>

</body>
</html>
