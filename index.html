<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aprova Ai | Gestão Inteligente</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        /* ----- ESTILOS NOVOS (SIDEBAR, TABELAS, ETC) ----- */
        body { font-family: 'Inter', sans-serif; background-color: #F3F4F6; color: #334155; }
        .sidebar { width: 260px; background: white; height: 100vh; position: fixed; left: 0; top: 0; border-right: 1px solid #E2E8F0; display: flex; flex-direction: column; z-index: 50; transition: transform 0.3s; }
        .main-content { margin-left: 260px; padding: 2rem; min-height: 100vh; transition: margin 0.3s; }
        .nav-item { display: flex; align-items: center; padding: 12px 24px; color: #64748B; font-weight: 500; transition: all 0.2s; cursor: pointer; border-left: 3px solid transparent; }
        .nav-item:hover, .nav-item.active { background: #F8FAFC; color: #3B82F6; border-left-color: #3B82F6; }
        .nav-item i { width: 24px; margin-right: 10px; }
        .btn-new { background: #3B82F6; color: white; border-radius: 8px; padding: 12px; margin: 20px; text-align: center; font-weight: 600; cursor: pointer; transition: background 0.2s; display: block; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5); }
        .btn-new:hover { background: #2563EB; }
        .custom-table { width: 100%; text-align: left; border-collapse: separate; border-spacing: 0; }
        .custom-table th { padding: 16px; background: #F8FAFC; color: #64748B; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; border-bottom: 1px solid #E2E8F0; }
        .custom-table td { padding: 16px; border-bottom: 1px solid #E2E8F0; background: white; font-size: 0.9rem; }
        .custom-table tr:hover td { background: #F1F5F9; cursor: pointer; }
        .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .mobile-header { display: none; justify-content: space-between; align-items: center; padding: 1rem; background: white; border-bottom: 1px solid #E2E8F0; margin-bottom: 1rem; }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); width: 100%; }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 1rem; }
            .mobile-header { display: flex !important; }
        }

        /* ----- ESTILOS ORIGINAIS (PRESERVADOS) ----- */
        .item-box { background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin-bottom: 12px; position: relative; transition: all 0.2s; }
        .item-box:hover { border-color: #3b82f6; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .item-optional { border: 2px dashed #94a3b8 !important; background-color: #f8fafc; opacity: 0.9; }
        .optional-badge { background: #64748b; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; font-weight: bold; text-transform: uppercase; margin-left: 8px; }
        .diff-box { background-color: #fff7ed; border: 1px dashed #f97316; border-radius: 6px; padding: 8px; margin-top: 8px; font-size: 0.75rem; color: #9a3412; display: flex; align-items: center; gap: 8px; }
        .diff-tag { background: #f97316; color: white; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.65rem; text-transform: uppercase; }
        .old-val { text-decoration: line-through; color: #ef4444; margin-right: 4px; }
        .new-val { color: #16a34a; font-weight: bold; }
        .item-modified { border-left: 4px solid #f59e0b !important; }
        .item-new { border-left: 4px solid #10b981 !important; }
        .timeline-item { position: relative; padding-left: 2rem; border-left: 2px solid #e2e8f0; padding-bottom: 1.5rem; }
        .timeline-item::before { content: ''; position: absolute; left: -5px; top: 0; width: 8px; height: 8px; border-radius: 50%; background: #94a3b8; }
        .timeline-item:last-child { border-left: transparent; }
        .timeline-desc { font-size: 0.85rem; color: #334155; margin-top: 6px; background: #fff7ed; padding: 12px; border-radius: 8px; border: 1px solid #fed7aa; font-style: italic; }
        .timeline-desc.system { background: #f8fafc; border-color: #f1f5f9; font-style: normal; }
        .status-badge { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; padding: 4px 10px; border-radius: 999px; letter-spacing: 0.05em; white-space: nowrap; }
        .st-draft { background: #e0f2fe; color: #0284c7; } 
        .st-sent { background: #dbeafe; color: #1e40af; } 
        .st-negotiating { background: #ffedd5; color: #c2410c; } 
        .st-approved { background: #dcfce7; color: #166534; } 
        .st-canceled { background: #fee2e2; color: #991b1b; }
        
        /* Assinatura */
        #signature-pad { border: 2px dashed #cbd5e1; border-radius: 12px; background: #f8fafc; cursor: crosshair; touch-action: none; width: 100%; height: 200px; }
        
        /* Animações */
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .anim-entry { animation: fadeInUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; opacity: 0; }
        
        .loader-spin { width: 30px; height: 30px; border: 3px solid #E2E8F0; border-top-color: #3B82F6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .hidden { display: none !important; }

        /* Página pública (idêntica ao original) */
        #view-public { background: #f1f5f9; }
        #public-content { max-width: 1200px; margin: 0 auto; background: white; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); }
        #stamp-approved { position: absolute; top: 30px; right: 30px; border: 4px solid #16a34a; color: #16a34a; font-size: 2rem; font-weight: 800; padding: 0.5rem 2rem; text-transform: uppercase; opacity: 0.3; transform: rotate(-12deg); z-index: 20; }
        .doc-section-title { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; font-weight: 700; color: #64748b; margin-bottom: 1rem; border-left: 3px solid #3b82f6; padding-left: 0.75rem; }
        .att-card { background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; transition: all 0.2s; display: flex; flex-direction: column; gap: 0.5rem; }
        .att-card:hover { border-color: #3b82f6; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body>

    <!-- LOADER GLOBAL -->
    <div id="system-loader" style="position:fixed; inset:0; background:white; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <div class="loader-spin mb-4"></div>
        <p class="text-sm text-slate-500 font-medium">Carregando Sistema...</p>
    </div>

    <!-- FATAL ERROR (original) -->
    <div id="fatal-error" class="hidden fixed inset-0 bg-rose-50 z-[10000] flex flex-col items-center justify-center p-8 text-center">
        <i class="fas fa-exclamation-triangle text-4xl text-amber-500 mb-4"></i>
        <h2 class="text-2xl font-bold text-slate-800">Ops! Algo deu errado.</h2>
        <p id="error-msg" class="text-slate-600 mt-2 mb-6 max-w-md"></p>
        <button onclick="localStorage.clear(); window.location.reload()" class="px-6 py-3 bg-slate-900 text-white rounded font-bold">Recarregar</button>
    </div>

    <!-- LOGIN -->
    <section id="view-login" class="hidden min-h-screen flex items-center justify-center bg-slate-50 p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-slate-100">
            <h1 class="text-3xl font-bold text-slate-900 mb-2 text-center">Aprova Aí</h1>
            <input type="email" id="email" class="w-full p-3 border border-slate-300 rounded-lg mb-4" placeholder="seu@email.com">
            <button onclick="handleLogin()" id="btn-login" class="w-full bg-slate-900 text-white font-bold py-3 rounded-lg hover:bg-slate-800">Enviar link de acesso</button>
        </div>
    </section>

    <!-- LAYOUT PRINCIPAL (SIDEBAR) -->
    <div id="app-layout" class="hidden">
        <div class="mobile-header">
            <span class="font-bold text-lg text-slate-800">Aprova Ai</span>
            <button onclick="document.querySelector('.sidebar').classList.toggle('open')" class="text-slate-600"><i class="fas fa-bars text-xl"></i></button>
        </div>

        <aside class="sidebar">
            <div class="p-6 flex items-center gap-2 border-b border-slate-100">
                <i class="fas fa-layer-group text-2xl text-blue-600"></i>
                <span class="font-bold text-xl tracking-tight text-slate-800">Aprova Ai</span>
            </div>
            <div onclick="createProject()" class="btn-new">
                <i class="fas fa-plus mr-2"></i> Novo Orçamento
            </div>
            <nav class="flex-1 overflow-y-auto py-2">
                <div onclick="switchTab('dashboard')" class="nav-item active" id="nav-dashboard"><i class="fas fa-home"></i> Visão geral</div>
                <div onclick="switchTab('projects')" class="nav-item" id="nav-projects"><i class="fas fa-file-invoice"></i> Orçamentos</div>
                <div class="px-6 py-4 mt-2">
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-3">Status</p>
                    <div onclick="filterProjects('draft')" class="flex items-center text-sm text-slate-600 py-1 cursor-pointer hover:text-blue-600 mb-2"><span class="status-dot" style="background:#94a3b8"></span> Em Aberto</div>
                    <div onclick="filterProjects('negotiating')" class="flex items-center text-sm text-slate-600 py-1 cursor-pointer hover:text-blue-600 mb-2"><span class="status-dot" style="background:#f97316"></span> Em Negociação</div>
                    <div onclick="filterProjects('approved')" class="flex items-center text-sm text-slate-600 py-1 cursor-pointer hover:text-blue-600 mb-2"><span class="status-dot" style="background:#22c55e"></span> Aprovados</div>
                    <div onclick="filterProjects('canceled')" class="flex items-center text-sm text-slate-600 py-1 cursor-pointer hover:text-blue-600"><span class="status-dot" style="background:#ef4444"></span> Cancelados</div>
                </div>
                <div onclick="switchTab('clients')" class="nav-item" id="nav-clients"><i class="fas fa-users"></i> Clientes</div>
            </nav>
            <div class="p-4 border-t border-slate-100">
                <button onclick="db.auth.signOut().then(()=>window.location.reload())" class="flex items-center text-sm text-red-500 font-medium w-full px-4 py-2"><i class="fas fa-sign-out-alt mr-3"></i> Sair</button>
            </div>
        </aside>

        <main class="main-content">
            <!-- DASHBOARD (KPIs e lista de projetos IGUAIS AO ORIGINAL) -->
            <section id="view-dashboard" class="space-y-6">
                <h2 class="text-2xl font-bold text-slate-800">Visão geral</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <div class="text-xs text-slate-500 uppercase mb-1">Faturamento Aprovado</div>
                        <div class="text-2xl font-bold text-emerald-600" id="kpi-total-apr">R$ 0,00</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <div class="text-xs text-slate-500 uppercase mb-1">Pipeline (Total)</div>
                        <div class="text-2xl font-bold text-blue-600" id="kpi-total-est">R$ 0,00</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <div class="text-xs text-slate-500 uppercase mb-1">Em Negociação</div>
                        <div class="text-2xl font-bold text-orange-600" id="kpi-count-neg">0</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <div class="text-xs text-slate-500 uppercase mb-1">Aprovados</div>
                        <div class="text-2xl font-bold text-green-600" id="kpi-count-apr">0</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <div class="text-xs text-slate-500 uppercase mb-1">Em Aberto</div>
                        <div class="text-2xl font-bold text-slate-600" id="kpi-count-open">0</div>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row gap-4 mb-4 items-center bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                    <div class="flex-1 w-full relative">
                        <i class="fas fa-search absolute left-3 top-3 text-slate-400"></i>
                        <input id="dash-search" onkeyup="renderDashboardList()" class="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none focus:border-blue-500" placeholder="Buscar cliente ou projeto...">
                    </div>
                    <select id="dash-filter" onchange="renderDashboardList()" class="p-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none">
                        <option value="all">Todos os Status</option>
                        <option value="draft">Em Aberto</option>
                        <option value="sent">Enviados</option>
                        <option value="negotiating">Em Negociação</option>
                        <option value="approved">Aprovados</option>
                        <option value="canceled">Cancelados</option>
                    </select>
                </div>

                <div id="project-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </section>

            <!-- VIEW PROJECTS (TABELA) -->
            <section id="view-projects" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-slate-800">Orçamentos</h2>
                    <button onclick="createProject()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold">+ Novo</button>
                </div>
                <div class="bg-white p-4 rounded-xl border border-slate-200 flex gap-4">
                    <input id="search-input" onkeyup="renderProjectTable()" class="flex-1 p-2 border rounded-lg" placeholder="Buscar...">
                    <select id="status-filter" onchange="renderProjectTable()" class="p-2 border rounded-lg bg-white">
                        <option value="all">Todos</option>
                        <option value="draft">Em Aberto</option>
                        <option value="negotiating">Em Negociação</option>
                        <option value="approved">Aprovados</option>
                        <option value="canceled">Cancelados</option>
                    </select>
                </div>
                <div class="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Número</th>
                                <th>Cliente</th>
                                <th>Data</th>
                                <th class="text-right">Total</th>
                            </tr>
                        </thead>
                        <tbody id="project-table-body"></tbody>
                    </table>
                </div>
            </section>

            <!-- VIEW CLIENTES -->
            <section id="view-clients" class="hidden space-y-6">
                <h2 class="text-2xl font-bold text-slate-800">Clientes</h2>
                <div class="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm p-6">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Documento</th>
                                <th>Email</th>
                                <th>Projetos</th>
                            </tr>
                        </thead>
                        <tbody id="client-table-body"></tbody>
                    </table>
                </div>
            </section>

            <!-- EDITOR COMPLETO COM TODAS AS FUNCIONALIDADES ORIGINAIS + BOTÃO ENVIAR LINK -->
            <section id="view-editor" class="hidden pb-20">
                <!-- Header com botão de enviar link sempre visível -->
                <div class="flex items-center justify-between mb-6 bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                    <div class="flex items-center gap-4">
                        <button onclick="switchTab('projects')" class="text-slate-400 hover:text-slate-800"><i class="fas fa-arrow-left"></i></button>
                        <div>
                            <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                                <span id="ed-title">...</span>
                                <span id="ed-ver" class="text-xs bg-slate-100 px-2 py-1 rounded border">V1</span>
                                <span id="ed-status-badge" class="status-badge st-draft ml-2">EM ABERTO</span>
                            </h2>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openShareModal()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold shadow-lg shadow-blue-200">
                            <i class="fas fa-share-alt mr-2"></i> Enviar Link
                        </button>
                        <div id="ed-actions-header" class="flex gap-2"></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                    <!-- Coluna esquerda (2/3) -->
                    <div class="xl:col-span-2 space-y-6">
                        <!-- DADOS DO PRESTADOR -->
                        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                            <h3 class="font-bold border-b pb-2 mb-4 text-slate-700 flex items-center gap-2"><i class="fas fa-id-card text-blue-600"></i> Seus Dados</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <input id="p-name" onchange="upSettings('providerName',this.value)" class="border p-2 rounded text-sm" placeholder="Nome da Sua Empresa">
                                <input id="p-doc" onchange="upSettings('providerDoc',this.value)" class="border p-2 rounded text-sm" placeholder="CNPJ/CPF">
                                <input id="p-phone" onchange="upSettings('providerPhone',this.value)" class="border p-2 rounded text-sm" placeholder="Telefone">
                                <input id="p-addr" onchange="upSettings('providerAddr',this.value)" class="border p-2 rounded text-sm" placeholder="Endereço">
                            </div>
                        </div>

                        <!-- DADOS DO CLIENTE -->
                        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                            <h3 class="font-bold border-b pb-2 mb-4 text-slate-700 flex items-center gap-2"><i class="fas fa-user-tie text-blue-600"></i> Dados do Cliente</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <input id="c-name" onchange="upVal('c-name',this.value)" class="border p-2 rounded text-sm" placeholder="Nome / Razão Social">
                                <input id="c-doc" onchange="upVal('c-doc',this.value)" class="border p-2 rounded text-sm" placeholder="CPF/CNPJ">
                                <input id="c-phone" onchange="upVal('c-phone',this.value)" class="border p-2 rounded text-sm" placeholder="Telefone">
                                <input id="c-email" onchange="upVal('c-email',this.value)" class="border p-2 rounded text-sm" placeholder="E-mail">
                                <input id="c-addr" onchange="upVal('c-addr',this.value)" class="col-span-2 border p-2 rounded text-sm" placeholder="Endereço">
                            </div>
                            
                            <!-- ENDEREÇO DO SERVIÇO (ORIGINAL) -->
                            <div class="mt-4 pt-4 border-t border-dashed">
                                <label class="flex items-center gap-2 text-sm text-slate-600 mb-2 cursor-pointer">
                                    <input type="checkbox" id="loc-check" onchange="toggleLoc(this.checked)" class="accent-blue-600">
                                    Endereço do serviço é o mesmo do cliente?
                                </label>
                                <div id="loc-custom-div">
                                    <label class="text-xs font-bold text-slate-500 mb-1 block">Endereço do Serviço/Obra</label>
                                    <input id="loc-addr" class="w-full border p-2 rounded text-sm" placeholder="Onde será realizado o serviço?" onchange="upLoc(this.value)">
                                </div>
                            </div>

                            <!-- WHATSAPP PARA NOTIFICAÇÕES (ORIGINAL) -->
                            <div class="mt-4 pt-4 border-t">
                                <label class="text-xs font-bold text-slate-500 mb-1 block flex items-center gap-1">
                                    <i class="fab fa-whatsapp text-emerald-600"></i> Seu WhatsApp (para notificações)
                                </label>
                                <input id="in-s-myphone" onchange="upSettings('myPhone', this.value)" class="w-full border p-2 rounded text-sm bg-blue-50 border-blue-200" placeholder="(00) 00000-0000">
                            </div>
                        </div>

                        <!-- ESCOPO DO SERVIÇO -->
                        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-slate-700 flex items-center gap-2"><i class="fas fa-list-ol text-blue-600"></i> Escopo do Serviço</h3>
                                <button id="btn-add-item" onclick="addItem()" class="text-blue-600 text-sm font-bold border border-blue-200 px-3 py-1 rounded hover:bg-blue-50">+ Adicionar Item</button>
                            </div>
                            <div id="ed-items" class="space-y-3"></div>
                        </div>
                    </div>

                    <!-- Coluna direita (1/3) -->
                    <div class="space-y-6">
                        <!-- TOTAL GLOBAL -->
                        <div class="bg-slate-900 text-white p-6 rounded-xl shadow-lg text-center">
                            <p class="text-xs font-bold uppercase text-slate-400">Total Global</p>
                            <div id="ed-total" class="text-3xl font-bold">R$ 0,00</div>
                            <div id="ed-total-optional" class="text-xs text-slate-400 mt-1"></div>
                        </div>

                        <!-- ANEXOS -->
                        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                            <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="fas fa-paperclip text-blue-600"></i> Anexos</h3>
                            <div id="ed-attachments-list" class="mb-3"></div>
                            <div id="upload-area">
                                <label for="file-upload" id="upload-label" class="cursor-pointer block w-full text-center border-2 border-dashed border-slate-300 p-4 rounded hover:bg-slate-50 text-xs text-slate-500 font-bold uppercase">
                                    <i class="fas fa-cloud-upload-alt mr-2"></i> Adicionar PDF/IMG
                                </label>
                                <input id="file-upload" type="file" class="hidden" accept=".pdf,.png,.jpg,.jpeg" onchange="handleUpload(event)">
                            </div>
                        </div>

                        <!-- FINANCEIRO / PAGAMENTO -->
                        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                            <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="fas fa-coins text-blue-600"></i> Pagamento</h3>
                            <select id="pay-mode" class="w-full border p-2 rounded mb-2 text-sm">
                                <option value="entry_installments">Entrada + Parcelas</option>
                                <option value="single">À vista</option>
                            </select>
                            <button id="btn-calc-pay" onclick="generatePayment()" class="w-full bg-slate-100 text-slate-600 text-xs font-bold py-2 rounded mb-3 flex items-center justify-center gap-2">
                                <i class="fas fa-calculator"></i> Gerar Cronograma
                            </button>
                            <textarea id="t-obs" onchange="upVal('t-obs',this.value)" class="w-full border p-2 rounded text-sm h-20" placeholder="Condições de pagamento..."></textarea>
                            <div class="grid grid-cols-2 gap-2 mt-2">
                                <input id="t-deadline" onchange="upVal('t-deadline',this.value)" class="border p-2 rounded text-xs" placeholder="Prazo de entrega">
                                <input id="t-val" onchange="upVal('t-val',this.value)" class="border p-2 rounded text-xs" placeholder="Validade (ex: 10 dias)">
                            </div>
                        </div>

                        <!-- VERSÕES / AÇÕES (BOTÃO CRIAR REVISÃO / CANCELAR) -->
                        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                            <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="fas fa-code-branch text-blue-600"></i> Versões</h3>
                            <div id="ed-actions-area" class="space-y-3"></div>
                        </div>

                        <!-- HISTÓRICO (COMPLETO, IGUAL AO ORIGINAL) -->
                        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                            <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="fas fa-history text-blue-600"></i> Histórico</h3>
                            <div id="ed-history" class="space-y-4 max-h-80 overflow-y-auto pr-1"></div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- VIEW PÚBLICA (IDÊNTICA AO ORIGINAL) -->
    <section id="view-public" class="hidden min-h-screen bg-slate-200 p-4 md:py-10 overflow-y-auto print:p-0">
        <div id="public-loading" class="flex justify-center mt-20"><div class="loader-spin"></div></div>
        <div id="public-content" class="hidden max-w-4xl mx-auto bg-white shadow-2xl min-h-[297mm] relative flex flex-col">
            <div id="stamp-approved" class="hidden">APROVADO</div>
            <div class="bg-slate-900 text-white p-12 print:bg-white print:text-black print:border-b-2">
                <div id="doc-provider-info"></div>
                <div class="flex justify-between items-start mt-4">
                    <div>
                        <h1 id="doc-title" class="text-3xl font-bold mb-2">Projeto</h1>
                        <p class="text-xs uppercase tracking-widest text-slate-400">Proposta Técnica</p>
                    </div>
                    <div class="text-right">
                        <div id="doc-id" class="font-bold text-lg">#REF</div>
                        <div id="doc-date" class="text-sm opacity-70">--/--/--</div>
                    </div>
                </div>
            </div>
            <div class="p-12 flex-1">
                <div class="flex gap-12 mb-12 text-sm">
                    <div class="flex-1">
                        <h3 class="font-bold text-xs uppercase text-slate-400 mb-2 border-b pb-1">Contratante</h3>
                        <div id="doc-c-name" class="font-bold text-lg text-slate-800"></div>
                        <div id="doc-c-doc" class="text-slate-500"></div>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold text-xs uppercase text-slate-400 mb-2 border-b pb-1">Local</h3>
                        <div id="doc-c-addr" class="text-slate-600"></div>
                    </div>
                </div>

                <div class="mb-12">
                    <h3 class="font-bold text-xs uppercase text-slate-400 mb-4 tracking-wider">Escopo</h3>
                    <table class="w-full">
                        <thead>
                            <tr class="text-left text-xs uppercase text-slate-400 border-b">
                                <th class="pb-2 pl-4">Item</th>
                                <th class="pb-2 text-center">Qtd</th>
                                <th class="pb-2 text-right">Unit.</th>
                                <th class="pb-2 text-right pr-4">Total</th>
                            </tr>
                        </thead>
                        <tbody id="doc-items-body"></tbody>
                    </table>
                </div>

                <div id="doc-attachments-area"></div>

                <div class="bg-slate-50 border border-slate-100 rounded-lg p-8 mb-12 flex gap-12 mt-8">
                    <div class="flex-1">
                        <h4 class="font-bold text-xs uppercase text-slate-400 mb-2">Pagamento</h4>
                        <div id="doc-payment" class="text-sm font-mono text-slate-700 whitespace-pre-line"></div>
                        <div class="mt-4 flex gap-6 text-sm">
                            <div><span class="font-bold text-xs uppercase text-slate-400 block">Entrega</span><span id="doc-deadline"></span></div>
                            <div><span class="font-bold text-xs uppercase text-slate-400 block">Validade</span><span id="doc-validity"></span></div>
                        </div>
                    </div>
                    <div class="text-right">
                        <h4 class="font-bold text-xs uppercase text-slate-400 mb-1">Total</h4>
                        <div id="doc-total" class="text-3xl font-bold text-slate-900">R$ 0,00</div>
                    </div>
                </div>

                <div id="doc-obs" class="text-xs text-slate-500 italic text-justify"></div>
                <div id="doc-signature-area"></div>
                <div id="doc-actions" class="no-print mt-12"></div>
            </div>
            <div class="bg-slate-50 p-4 text-center border-t no-print">
                <button onclick="downloadPDF()" id="btn-download-pdf" class="text-xs font-bold text-slate-400 uppercase hover:text-slate-600">
                    <i class="fas fa-file-pdf"></i> Baixar Comprovante PDF
                </button>
            </div>
        </div>
    </section>

    <!-- TELA DE SUCESSO (APÓS APROVAÇÃO/RECUSA) -->
    <section id="view-success" class="hidden min-h-screen bg-white flex flex-col items-center justify-center p-8 text-center">
        <div class="max-w-md w-full">
            <i id="success-icon" class="fas fa-check-circle text-6xl text-green-500 mb-6 anim-entry"></i>
            <h2 id="success-title" class="text-3xl font-bold text-slate-900 mb-4 anim-entry delay-100">Tudo Certo!</h2>
            <p id="success-desc" class="text-slate-600 text-lg anim-entry delay-200">Sua resposta foi registrada com sucesso.</p>
            <div id="success-actions" class="mt-8 anim-entry delay-300"></div>
            <div class="mt-8 text-xs text-slate-400">Pode fechar esta janela.</div>
        </div>
    </section>

    <!-- MODAL DE INTERAÇÃO (ASSINATURA / SOLICITAÇÃO / RECUSA) -->
    <div id="interaction-modal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md p-6 rounded-xl animate-[fadeInUp_0.3s]">
            <h3 id="modal-title" class="text-xl font-bold mb-2 text-slate-800"></h3>
            <p id="modal-desc" class="text-sm text-slate-500 mb-4"></p>
            <textarea id="modal-input" class="w-full border p-3 rounded mb-4 h-24 text-sm bg-slate-50" placeholder="Digite aqui..."></textarea>
            <div id="modal-sig-area" class="hidden mb-4">
                <canvas id="signature-pad"></canvas>
                <div class="text-right mt-1"><button id="clear-sig" class="text-xs text-red-500 underline">Limpar Assinatura</button></div>
            </div>
            <div class="flex gap-2">
                <button onclick="document.getElementById('interaction-modal').classList.add('hidden')" class="flex-1 border py-3 rounded text-slate-600 font-bold hover:bg-slate-50">Cancelar</button>
                <button id="modal-btn" class="flex-1 bg-slate-900 text-white py-3 rounded font-bold"></button>
            </div>
        </div>
    </div>

    <!-- MODAL DE COMPARTILHAR (ORIGINAL) -->
    <div id="share-modal" class="hidden fixed inset-0 bg-black/50 z-[70] flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl w-full max-w-sm text-center">
            <h3 class="text-xl font-bold mb-6 text-slate-800"><i class="fas fa-share-alt mr-2 text-blue-600"></i>Enviar Proposta</h3>
            <div class="space-y-3">
                <button id="btn-share-wa" class="w-full py-4 bg-emerald-500 hover:bg-emerald-600 text-white rounded-xl font-bold flex items-center justify-center gap-3 transition-transform hover:scale-[1.02] shadow-lg shadow-emerald-100">
                    <i class="fab fa-whatsapp text-2xl"></i> Enviar no WhatsApp
                </button>
                <button id="btn-share-copy" class="w-full py-4 bg-slate-100 hover:bg-slate-200 text-slate-700 border border-slate-200 rounded-xl font-bold flex items-center justify-center gap-3 transition-colors">
                    <i class="fas fa-link text-lg"></i> Copiar Link
                </button>
            </div>
            <button onclick="document.getElementById('share-modal').classList.add('hidden')" class="mt-6 text-sm text-slate-400 hover:text-slate-600 underline">Cancelar</button>
        </div>
    </div>

    <script>
        // ----- CONFIGURAÇÃO SUPABASE -----
        const SUPABASE_URL = 'https://outasfgohiiyndsjciau.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im91dGFzZmdvaGlpeW5kc2pjaWF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4MTk4ODIsImV4cCI6MjA4NTM5NTg4Mn0.4yvGfYbQYf806FJcs34yPGkuU_kVTYHW8mBtbU3JD80';
        const { createClient } = supabase;
        let db = null;

        // ----- ESTADO GLOBAL (ORIGINAL) -----
        let state = { 
            user: null, 
            project: null, 
            version: null, 
            projectsCache: [], 
            data: null, 
            previousData: null, 
            snapshot: [] 
        };
        let signaturePad = null;

        // ----- FUNÇÕES AUXILIARES (ORIGINAIS) -----
        function safeVal(id) { const el = document.getElementById(id); return el ? el.value : ''; }
        function safeText(id, val) { const el = document.getElementById(id); if (el) el.innerText = val || ''; }
        function setHTML(id, val) { const el = document.getElementById(id); if (el) el.innerHTML = val || ''; }
        function setVal(id, val) { const el = document.getElementById(id); if (el) el.value = val || ''; }
        function safeShow(id) { const el = document.getElementById(id); if(el) el.classList.remove('hidden'); }
        function safeHide(id) { const el = document.getElementById(id); if(el) el.classList.add('hidden'); }

        // ----- NORMALIZAÇÃO DE DADOS (ORIGINAL) -----
        function normalizeData(dbData) {
            const schema = { 
                client: { name: '', doc: '', email: '', phone: '', address: '' }, 
                location: { address: '', sameAsClient: true }, 
                items: [], 
                terms: { paymentMode: 'custom', paymentText: '', deadline: '', validity: '10 dias', obs: '' }, 
                settings: { myPhone: '', serviceType: 'Outros', providerName: '', providerDoc: '', providerAddr: '', providerPhone: '' }, 
                history: [],
                attachments: [],
                signature: null 
            };
            if (!dbData) return JSON.parse(JSON.stringify(schema));
            let rawItems = Array.isArray(dbData.items) ? dbData.items : (dbData.scope || []);
            const cleanItems = rawItems.map(i => ({ 
                id: i.id || 'item_' + Math.random().toString(36).substr(2, 9), 
                name: i.name || '', 
                description: i.description || '', 
                qty: parseFloat(i.qty) || 1, 
                price: parseFloat(i.price) || 0, 
                type: i.type || 'original',
                optional: i.optional || false,
                publicSelected: i.publicSelected || false 
            }));
            return { 
                client: { ...schema.client, ...(dbData.client || {}) }, 
                location: { ...schema.location, ...(dbData.location || {}) }, 
                items: cleanItems, 
                terms: { ...schema.terms, ...(dbData.terms || {}) }, 
                settings: { ...schema.settings, ...(dbData.settings || {}) }, 
                history: Array.isArray(dbData.history) ? dbData.history : [],
                attachments: Array.isArray(dbData.attachments) ? dbData.attachments : [],
                signature: dbData.signature || null
            };
        }

        // ----- HISTÓRICO (ORIGINAL) -----
        function logHistory(action, user, detail) {
            if (!state.data.history) state.data.history = [];
            state.data.history.push({ 
                date: new Date().toISOString(), 
                action: action, 
                user: user, 
                detail: detail || '' 
            });
        }

        // ----- DETECTAR MUDANÇAS ENTRE VERSÕES -----
        function getChanges(oldArr, newArr) {
            let logs = [];
            const oldMap = new Map(oldArr.map(i => [i.id, i]));
            const newMap = new Map(newArr.map(i => [i.id, i]));
            newArr.forEach(i => {
                if(!oldMap.has(i.id)) logs.push(`Adicionou: ${i.name || 'Item sem nome'}`);
                else {
                    const old = oldMap.get(i.id);
                    if(old.name !== i.name) logs.push(`Renomeou: ${old.name || 'Sem nome'} -> ${i.name}`);
                    if(old.price !== i.price || old.qty !== i.qty) logs.push(`Alterou valor/qtd: ${i.name}`);
                }
            });
            oldArr.forEach(i => { if(!newMap.has(i.id)) logs.push(`Removeu: ${i.name}`); });
            return logs.length ? logs.join('; ') : null;
        }

        // ----- INICIALIZAÇÃO -----
        window.onerror = function(msg) {
            console.error("Erro:", msg);
            document.getElementById('system-loader').style.display = 'none';
            return false;
        };

        async function init() {
            try {
                db = createClient(SUPABASE_URL, SUPABASE_KEY);
                const params = new URLSearchParams(window.location.search);
                const view = params.get('view') || 'login';
                const id = params.get('id');
                document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
                document.getElementById('app-layout').classList.add('hidden');
                
                const { data: { session } } = await db.auth.getSession();
                state.user = session?.user;

                if (view === 'public') {
                    if(!id) throw new Error("Link inválido.");
                    await loadPublicProposal(id);
                    safeShow('view-public');
                } else if (!state.user && view !== 'login') {
                    window.history.replaceState(null, '', '?view=login');
                    safeShow('view-login');
                } else if (state.user && view === 'login') {
                    goTo('dashboard');
                } else {
                    document.getElementById('app-layout').classList.remove('hidden');
                    await loadProjects();
                    if (view === 'editor' && id) await loadEditor(id);
                    if (view === 'dashboard') switchTab('dashboard', false);
                    else if (view === 'projects') switchTab('projects', false);
                    else if (view === 'clients') switchTab('clients', false);
                    else if (view === 'editor') switchTab('editor', false);
                    else switchTab('dashboard', false);
                }
                setTimeout(() => { 
                    document.getElementById('system-loader').style.display = 'none'; 
                }, 500);
            } catch (e) {
                document.getElementById('system-loader').style.display = 'none';
                safeShow('fatal-error');
                safeText('error-msg', e.message);
            }
        }

        // ----- LOGIN -----
        async function handleLogin() {
            const email = safeVal('email');
            const btn = document.getElementById('btn-login');
            if(!email) return alert("Digite o e-mail");
            btn.innerHTML = 'Enviando...'; 
            btn.disabled = true;
            const { error } = await db.auth.signInWithOtp({ 
                email, 
                options: { emailRedirectTo: window.location.href }
            });
            if(error) { 
                alert(error.message); 
                btn.innerText = 'Tentar Novamente'; 
                btn.disabled = false; 
            } else { 
                btn.innerText = 'Enviado!'; 
                alert('Verifique seu e-mail.'); 
            }
        }

        // ----- NAVEGAÇÃO -----
        function goTo(view, id = null) {
            window.history.pushState(null, '', id ? `?view=${view}&id=${id}` : `?view=${view}`);
            init();
        }

        function switchTab(tab, updateUrl = true) {
            document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            const nav = document.getElementById(`nav-${tab}`);
            if(nav) nav.classList.add('active');
            document.querySelector('.sidebar').classList.remove('open');
            if(updateUrl) window.history.pushState(null, '', tab === 'dashboard' ? '?' : `?view=${tab}`);
            if(tab === 'dashboard') renderDashboardList();
            if(tab === 'projects') renderProjectTable();
            if(tab === 'clients') renderClients();
        }

        function filterProjects(status) {
            switchTab('projects');
            const filterEl = document.getElementById('status-filter');
            if(filterEl) filterEl.value = status;
            renderProjectTable();
        }

        // ----- CARREGAR PROJETOS (ORIGINAL) -----
        async function loadProjects() {
            const { data: projects, error } = await db
                .from('projects')
                .select('*, versions(status, total_value, version_number)')
                .eq('user_id', state.user.id)
                .order('created_at', { ascending: false });
            if (error) return;
            if (projects) {
                projects.forEach(p => {
                    if (p.versions && p.versions.length > 0) {
                        p.versions.sort((a, b) => b.version_number - a.version_number);
                    }
                });
            }
            state.projectsCache = projects || [];
        }

        // ----- DASHBOARD (LISTA DE PROJETOS) -----
        function renderDashboardList() {
            const list = document.getElementById('project-list');
            if(!list) return;
            const search = safeVal('dash-search').toLowerCase();
            const filterStatus = safeVal('dash-filter');
            let totalRev = 0, totalAprov = 0, countAprov = 0, countNegoc = 0, countOpen = 0;

            const filtered = state.projectsCache.filter(p => {
                const v = p.versions?.[0] || { status: 'draft', total_value: 0 };
                const matchSearch = p.name.toLowerCase().includes(search) || (p.client_name||'').toLowerCase().includes(search);
                const matchStatus = filterStatus === 'all' || !filterStatus || v.status === filterStatus;
                return matchSearch && matchStatus;
            });

            state.projectsCache.forEach(p => {
                const v = p.versions?.[0] || { status: 'draft', total_value: 0 };
                const val = parseFloat(v.total_value) || 0;
                totalRev += val; 
                if(v.status === 'approved') { totalAprov += val; countAprov++; }
                if(v.status === 'negotiating' || v.status === 'sent') countNegoc++;
                if(v.status === 'draft') countOpen++;
            });

            safeText('kpi-total-est', totalRev.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}));
            safeText('kpi-total-apr', totalAprov.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}));
            safeText('kpi-count-neg', countNegoc);
            safeText('kpi-count-apr', countAprov);
            safeText('kpi-count-open', countOpen);

            let html = '';
            if(filtered.length === 0) {
                html = '<div class="col-span-full text-center py-20 text-slate-400 border-2 border-dashed border-slate-200 rounded-xl">Nenhum orçamento encontrado.</div>';
            } else {
                filtered.forEach(p => {
                    const v = p.versions?.[0] || { total_value: 0, status: 'draft', version_number: 1 };
                    const val = parseFloat(v.total_value) || 0;
                    let badgeClass = 'st-draft'; let statusLabel = 'Em Aberto';
                    if(v.status === 'sent') { badgeClass = 'st-sent'; statusLabel = 'Enviado'; }
                    if(v.status === 'negotiating') { badgeClass = 'st-negotiating'; statusLabel = 'Em Negociação'; }
                    if(v.status === 'approved') { badgeClass = 'st-approved'; statusLabel = 'Aprovado'; }
                    if(v.status === 'canceled') { badgeClass = 'st-canceled'; statusLabel = 'Cancelado'; }

                    html += `<div onclick="openProject('${p.id}')" class="bg-white border border-slate-200 rounded-xl p-5 hover:border-blue-400 hover:shadow-md transition-all cursor-pointer group relative flex flex-col justify-between">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1 pr-2">
                                <h3 class="font-bold text-slate-800 text-lg group-hover:text-blue-600 transition-colors leading-tight">${p.name}</h3>
                                <p class="text-xs text-slate-500 mt-1 truncate"><i class="far fa-user mr-1"></i> ${p.client_name || 'Novo Cliente'}</p>
                            </div>
                            <span class="status-badge ${badgeClass}">${statusLabel}</span>
                        </div>
                        <div class="border-t border-slate-100 pt-3 flex justify-between items-end mt-2">
                            <div class="text-xs text-slate-400">V${v.version_number} • ${new Date(p.created_at).toLocaleDateString()}</div>
                            <div class="flex items-center gap-3">
                                <div class="text-lg font-bold text-slate-900">${val.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</div>
                                <button onclick="deleteProject('${p.id}', event)" class="text-slate-300 hover:text-red-500 transition-colors p-1 opacity-0 group-hover:opacity-100" title="Excluir"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>
                    </div>`;
                });
            }
            setHTML('project-list', html);
        }

        async function deleteProject(id, event) {
            event.stopPropagation(); 
            if(!confirm("Tem certeza que deseja EXCLUIR este orçamento permanentemente?")) return;
            const { error } = await db.from('projects').delete().eq('id', id);
            if(error) alert("Erro ao excluir: " + error.message);
            else { 
                state.projectsCache = state.projectsCache.filter(p => p.id !== id); 
                renderDashboardList(); 
                renderProjectTable();
            }
        }

        function openProject(id) {
            window.history.pushState(null, '', `?view=editor&id=${id}`);
            loadEditor(id).then(() => switchTab('editor', false));
        }

        // ----- CRIAÇÃO DE PROJETO (COM DADOS DO LOCALSTORAGE) -----
        async function createProject() {
            const name = prompt("Nome do Orçamento:"); 
            if(!name) return;
            const { data: p, error } = await db.from('projects').insert({ 
                name, 
                user_id: state.user.id, 
                client_name: 'Novo Cliente' 
            }).select().single();
            
            const d = normalizeData(null); 
            d.settings.myPhone = localStorage.getItem('escopo_phone') || '';
            d.settings.providerName = localStorage.getItem('prov_name') || '';
            d.settings.providerDoc = localStorage.getItem('prov_doc') || '';
            d.settings.providerAddr = localStorage.getItem('prov_addr') || '';
            d.settings.providerPhone = localStorage.getItem('prov_phone') || '';
            d.history.push({ date: new Date().toISOString(), action: 'created', user: 'provider', detail: 'Orçamento criado via painel.' });

            await db.from('versions').insert({ 
                project_id: p.id, 
                version_number: 1, 
                items: d, 
                total_value: 0, 
                status: 'draft' 
            });
            openProject(p.id);
        }

        // ----- TABELA DE PROJETOS (VIEW PROJECTS) -----
        function renderProjectTable() {
            const term = safeVal('search-input').toLowerCase();
            const status = safeVal('status-filter') || 'all';
            const filtered = state.projectsCache.filter(p => {
                const v = p.versions?.[0] || { status: 'draft' };
                const matchStatus = status === 'all' || v.status === status;
                const matchText = p.name.toLowerCase().includes(term) || (p.client_name||'').toLowerCase().includes(term);
                return matchStatus && matchText;
            });
            const html = filtered.map(p => {
                const v = p.versions?.[0] || { status: 'draft', total_value: 0, version_number: 1 };
                const badges = { 
                    'draft': ['bg-slate-100 text-slate-600', 'Rascunho'], 
                    'sent': ['bg-blue-100 text-blue-800', 'Enviado'], 
                    'negotiating': ['bg-orange-100 text-orange-800', 'Em Negociação'], 
                    'approved': ['bg-green-100 text-green-800', 'Aprovado'], 
                    'canceled': ['bg-red-100 text-red-800', 'Cancelado'] 
                };
                const b = badges[v.status] || badges['draft'];
                return `<tr onclick="openProject('${p.id}')">
                    <td><span class="px-2 py-1 rounded text-xs font-bold ${b[0]}">${b[1]}</span></td>
                    <td class="font-mono">#${p.id.substr(0,4)} (V${v.version_number})</td>
                    <td class="font-bold">${p.client_name}</td>
                    <td>${new Date(p.created_at).toLocaleDateString()}</td>
                    <td class="text-right font-bold">${(parseFloat(v.total_value)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</td>
                </tr>`;
            }).join('');
            document.getElementById('project-table-body').innerHTML = html || '<tr><td colspan="5" class="text-center py-4 text-slate-400">Nada encontrado</td></tr>';
        }

        function renderClients() {
            const map = {};
            state.projectsCache.forEach(p => { 
                if(p.client_name && p.client_name !== 'Novo Cliente') { 
                    map[p.client_name] = (map[p.client_name] || 0) + 1; 
                } 
            });
            const html = Object.keys(map).map(n => 
                `<tr><td class="font-bold">${n}</td><td>-</td><td>-</td><td><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-bold">${map[n]} Projetos</span></td></tr>`
            ).join('');
            document.getElementById('client-table-body').innerHTML = html || '<tr><td colspan="4" class="text-center py-4 text-slate-400">Nenhum cliente encontrado</td></tr>';
        }

        // ----- EDITOR (FUNÇÕES ORIGINAIS RESTAURADAS) -----
        async function loadEditor(id) {
            safeHide('editor-content');
            const { data: proj } = await db.from('projects').select('*').eq('id', id).single();
            state.project = proj;
            const { data: vers } = await db.from('versions').select('*').eq('project_id', id).order('version_number', { ascending: true });
            state.version = vers[vers.length - 1];
            state.data = normalizeData(state.version.items);
            state.snapshot = JSON.parse(JSON.stringify(state.data.items));

            state.previousData = null;
            if (state.version.version_number > 1 && vers[vers.length - 2]) {
                state.previousData = normalizeData(vers[vers.length - 2].items);
            }

            renderEditor();
        }

        function renderEditor() {
            const d = state.data; 
            const isLocked = state.version.status !== 'draft'; 
            
            safeText('ed-title', state.project.name);
            safeText('ed-ver', `V${state.version.version_number}`);
            
            const badge = document.getElementById('ed-status-badge');
            if(badge) {
                badge.className = `status-badge ml-2 ${
                    state.version.status === 'approved' ? 'st-approved' : 
                    state.version.status === 'canceled' ? 'st-canceled' : 
                    state.version.status === 'negotiating' ? 'st-negotiating' : 
                    'st-draft'
                }`;
                badge.innerText = state.version.status === 'draft' ? 'EM ABERTO' : 
                                 state.version.status === 'sent' ? 'ENVIADO' : 
                                 state.version.status.toUpperCase();
            }

            // Preencher campos
            setVal('p-name', d.settings.providerName);
            setVal('p-doc', d.settings.providerDoc);
            setVal('p-addr', d.settings.providerAddr);
            setVal('p-phone', d.settings.providerPhone);
            setVal('c-name', d.client.name);
            setVal('c-doc', d.client.doc);
            setVal('c-phone', d.client.phone);
            setVal('c-email', d.client.email);
            setVal('c-addr', d.client.address);
            setVal('in-s-myphone', d.settings.myPhone);
            
            setVal('t-deadline', d.terms.deadline); 
            setVal('t-val', d.terms.validity); 
            setVal('t-obs', d.terms.paymentText || d.terms.obs);

            // Endereço do serviço
            const locCheck = document.getElementById('loc-check');
            if(locCheck) locCheck.checked = d.location.sameAsClient;
            const locDiv = document.getElementById('loc-custom-div');
            if(locDiv) locDiv.style.display = d.location.sameAsClient ? 'none' : 'block';
            setVal('loc-addr', d.location.address);

            // Desabilitar campos se bloqueado
            const staticInputs = [
                'p-name','p-doc','p-addr','p-phone',
                'c-name','c-doc','c-phone','c-email','c-addr',
                'in-s-myphone','loc-check','loc-addr',
                't-deadline','t-val','t-obs','pay-mode'
            ];
            staticInputs.forEach(id => { 
                const el = document.getElementById(id); 
                if(el) el.disabled = isLocked; 
            });

            // Botões de adicionar item e calcular
            const btnAdd = document.getElementById('btn-add-item');
            if(btnAdd) btnAdd.style.display = isLocked ? 'none' : 'inline-block';
            
            const btnCalc = document.getElementById('btn-calc-pay');
            if(btnCalc) btnCalc.style.display = isLocked ? 'none' : 'inline-block';

            const uploadArea = document.getElementById('upload-area');
            if(uploadArea) uploadArea.style.display = isLocked ? 'none' : 'block';

            // Área de ações (header e sidebar)
            const headerActions = document.getElementById('ed-actions-header');
            if (headerActions) {
                if (isLocked) {
                    headerActions.innerHTML = `<button onclick="createAddon()" class="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded text-sm font-bold shadow"><i class="fas fa-copy mr-2"></i> Criar Revisão (V${state.version.version_number + 1})</button>`;
                } else {
                    headerActions.innerHTML = `<button onclick="save()" class="bg-slate-800 text-white px-4 py-2 rounded text-sm font-bold"><i class="fas fa-save mr-2"></i> Salvar</button>`;
                }
            }

            const area = document.getElementById('ed-actions-area');
            if (area) {
                if (isLocked) {
                    area.innerHTML = `<button onclick="createAddon()" class="w-full py-3 bg-amber-500 hover:bg-amber-600 text-white font-bold rounded-lg shadow"><i class="fas fa-copy mr-2"></i> Criar Revisão (V${state.version.version_number + 1})</button>`;
                } else {
                    area.innerHTML = `<button onclick="changeStatus('canceled')" class="w-full py-2 border border-red-200 text-red-500 hover:bg-red-50 rounded-lg text-sm font-bold">Cancelar Orçamento</button>`;
                }
            }

            renderItems();
            renderAttachments();
            renderHistory();
            updateTotal();
        }

        function renderItems() {
            const isLocked = state.version.status !== 'draft';
            const d = state.data;
            let html = ''; 
            let total = 0, totalOpt = 0;
            
            d.items.forEach((i, x) => {
                const t = (i.qty||0)*(i.price||0); 
                if(!i.optional) total += t;
                else totalOpt += t;

                let diffHtml = '';
                let cardClass = i.optional ? 'item-optional' : '';
                
                if (state.previousData) {
                    const oldItem = state.previousData.items.find(old => old.id === i.id);
                    if (!oldItem) {
                        cardClass += ' item-new';
                        diffHtml = `<div class="diff-box"><span class="diff-tag">NOVO</span> Este item foi adicionado.</div>`;
                    } else {
                        let changes = [];
                        if (oldItem.price !== i.price) changes.push(`Preço: <span class="old-val">R$${oldItem.price}</span> <i class="fas fa-arrow-right text-xs"></i> <span class="new-val">R$${i.price}</span>`);
                        if (oldItem.qty !== i.qty) changes.push(`Qtd: <span class="old-val">${oldItem.qty}</span> <i class="fas fa-arrow-right text-xs"></i> <span class="new-val">${i.qty}</span>`);
                        if (changes.length > 0) {
                            cardClass += ' item-modified';
                            diffHtml = `<div class="diff-box"><span class="diff-tag">ALTERADO</span> <span>${changes.join(' &bull; ')}</span></div>`;
                        }
                    }
                }

                html += `
                <div class="item-box ${cardClass} group">
                    ${!isLocked ? `<button onclick="rmItem(${x})" class="absolute top-2 right-2 text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100"><i class="fas fa-trash"></i></button>` : ''}
                    <div class="grid grid-cols-12 gap-4 mb-2">
                        <div class="col-span-8">
                            <label class="text-[10px] font-bold text-gray-400 uppercase flex items-center">
                                Item 
                                ${i.optional ? '<span class="optional-badge ml-2">Opcional</span>' : ''}
                            </label>
                            <input class="w-full font-bold bg-transparent outline-none border-b border-transparent focus:border-blue-200" placeholder="Nome do Item..." value="${i.name}" oninput="upItem(${x},'name',this.value)" ${isLocked?'disabled':''}>
                        </div>
                        <div class="col-span-2">
                            <label class="text-[10px] font-bold text-gray-400 uppercase text-center block">Qtd</label>
                            <input type="number" class="w-full bg-slate-50 border rounded text-center text-xs p-1" value="${i.qty}" onchange="upItem(${x},'qty',this.value)" ${isLocked?'disabled':''}>
                        </div>
                        <div class="col-span-2">
                            <label class="text-[10px] font-bold text-gray-400 uppercase text-right block">R$</label>
                            <input type="number" step="0.01" class="w-full bg-slate-50 border rounded text-right text-xs p-1" value="${i.price}" onchange="upItem(${x},'price',this.value)" ${isLocked?'disabled':''}>
                        </div>
                    </div>
                    <textarea class="w-full bg-transparent text-xs text-slate-500 resize-none outline-none border-t border-dashed pt-2 mt-2" rows="2" placeholder="Descrição técnica..." oninput="upItem(${x},'description',this.value)" ${isLocked?'disabled':''}>${i.description||''}</textarea>
                    ${!isLocked ? `
                        <button onclick="toggleOpt(${x})" class="text-[10px] mt-2 px-2 py-1 rounded border ${i.optional ? 'bg-slate-600 text-white border-slate-600' : 'text-slate-400 border-slate-200 hover:border-slate-400'}">
                            ${i.optional ? 'ITEM OPCIONAL' : 'Marcar como Opcional?'}
                        </button>
                    ` : ''}
                    ${diffHtml}
                </div>`;
            });
            
            setHTML('ed-items', html);
            document.getElementById('ed-total').innerText = total.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
            const optDiv = document.getElementById('ed-total-optional');
            if (optDiv) {
                optDiv.innerText = totalOpt > 0 ? `+ ${totalOpt.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})} em opcionais` : '';
            }
        }

        function upItem(i,f,v) { 
            const it = state.data.items[i]; 
            if(f === 'qty' || f === 'price') { 
                it[f] = parseFloat(v) || 0; 
                updateTotal(); 
            } else { 
                it[f] = v; 
            }
        }
        
        function toggleOpt(i) { 
            state.data.items[i].optional = !state.data.items[i].optional; 
            renderItems(); 
            updateTotal(); 
        }

        function addItem() { 
            if(!Array.isArray(state.data.items)) state.data.items = [];
            state.data.items.push({ 
                id: 'item_' + Date.now() + Math.random(), 
                name: '', 
                description: '', 
                qty: 1, 
                price: 0, 
                type: state.version?.version_number > 1 ? 'addon' : 'original', 
                optional: false 
            }); 
            renderItems(); 
        }
        
        function rmItem(i) { 
            if(confirm("Remover este item?")) { 
                state.data.items.splice(i, 1); 
                renderItems(); 
                updateTotal(); 
            } 
        }

        function updateTotal() { 
            const total = state.data.items.reduce((a,b)=> !b.optional ? a + (b.qty*b.price) : a, 0);
            document.getElementById('ed-total').innerText = total.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
        }

        // ----- FUNÇÕES DE VALORES (ORIGINAL) -----
        function upVal(k,v) { 
            if(k.startsWith('c-')) state.data.client[k.substring(2)] = v; 
            else if(k.startsWith('t-')) {
                if (k === 't-obs') state.data.terms.paymentText = v;
                else state.data.terms[k.substring(2)] = v;
            }
        }
        
        function upSettings(k,v) { 
            state.data.settings[k] = v; 
            if(['providerName','providerDoc','providerAddr','providerPhone'].includes(k)) {
                localStorage.setItem(k.replace('provider','prov_').toLowerCase(), v);
            }
            if(k === 'myPhone') localStorage.setItem('escopo_phone', v);
        }

        function toggleLoc(checked) { 
            state.data.location.sameAsClient = checked; 
            const locDiv = document.getElementById('loc-custom-div');
            if(locDiv) locDiv.style.display = checked ? 'none' : 'block';
        }
        function upLoc(v) { state.data.location.address = v; }

        // ----- GERAÇÃO DE TEXTO DE PAGAMENTO (ORIGINAL) -----
        function generatePayment() {
            const total = state.data.items.reduce((acc, i) => (!i.optional ? acc + (i.qty * i.price) : acc), 0);
            if(total === 0) return alert("Adicione valores (não opcionais) primeiro.");
            const mode = document.getElementById('pay-mode').value;
            let text = "";
            if(mode === 'entry_installments') {
                const entryP = prompt("Porcentagem de Entrada? (Ex: 30)", "30");
                const inst = prompt("Restante em quantas vezes?", "2");
                if(!entryP || !inst) return;
                const entryVal = total * (parseInt(entryP)/100);
                const restVal = (total - entryVal) / parseInt(inst);
                text = `CRONOGRAMA:\n1. Entrada: ${entryVal.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}\n`;
                for(let i=1; i<=parseInt(inst); i++) text += `${i+1}. Parcela (30d): ${restVal.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}\n`;
            } else {
                text = `Pagamento Único: ${total.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}`;
            }
            state.data.terms.paymentText = text;
            setVal('t-obs', text);
        }

        // ----- ANEXOS -----
        async function handleUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            if (file.size > 5 * 1024 * 1024) return alert("Arquivo muito grande! Máximo 5MB.");
            const ext = file.name.split('.').pop().toLowerCase();
            if(!['pdf','png','jpg','jpeg'].includes(ext)) return alert("Formato não permitido. Use PDF, PNG ou JPG.");

            const label = document.getElementById('upload-label');
            const originalText = label.innerHTML;
            label.innerText = "Enviando...";

            try {
                const path = `${state.project.id}/${Date.now()}_${file.name}`;
                const { error } = await db.storage.from('attachments').upload(path, file);
                if (error) throw error;
                const { data: pubData } = db.storage.from('attachments').getPublicUrl(path);
                if (!state.data.attachments) state.data.attachments = [];
                state.data.attachments.push({ name: file.name, url: pubData.publicUrl, type: ext });
                await save();
                renderAttachments();
            } catch (err) {
                alert("Erro no upload: " + err.message);
            } finally {
                label.innerHTML = originalText;
                e.target.value = '';
            }
        }

        function deleteAttachment(idx) {
            if(!confirm("Remover este anexo?")) return;
            state.data.attachments.splice(idx, 1);
            save().then(() => renderAttachments());
        }

        function renderAttachments() {
            const attachList = document.getElementById('ed-attachments-list');
            if (!attachList) return;
            let attHtml = '';
            if (state.data.attachments && state.data.attachments.length > 0) {
                state.data.attachments.forEach((att, idx) => {
                    let icon = att.type === 'pdf' ? 'fa-file-pdf text-red-500' : 'fa-file-image text-blue-500';
                    attHtml += `<div class="flex items-center justify-between bg-white border p-2 rounded mb-2 text-xs">
                        <div class="flex items-center gap-2 overflow-hidden">
                            <i class="fas ${icon}"></i> 
                            <span class="truncate">${att.name}</span>
                        </div>
                        <div class="flex gap-2">
                            <a href="${att.url}" target="_blank" class="text-blue-500 hover:text-blue-700"><i class="fas fa-eye"></i></a>
                            ${state.version.status === 'draft' ? `<button onclick="deleteAttachment(${idx})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                    </div>`;
                });
            } else {
                attHtml = '<div class="text-xs text-slate-400 italic text-center py-2">Nenhum arquivo anexado.</div>';
            }
            attachList.innerHTML = attHtml;
        }

        // ----- SALVAR (COM HISTÓRICO E SNAPSHOT) -----
        async function save() {
            const t = state.data.items.reduce((a,b)=> (!b.optional ? a+(b.qty*b.price) : a),0);
            
            const changes = getChanges(state.snapshot, state.data.items);
            if(changes) {
                logHistory('edited', 'provider', changes);
                state.snapshot = JSON.parse(JSON.stringify(state.data.items)); 
            }

            if(state.data.client.name) {
                await db.from('projects').update({client_name: state.data.client.name}).eq('id', state.project.id);
            }
            await db.from('versions').update({
                items: state.data, 
                total_value: t, 
                notes: state.data.terms.obs || state.data.terms.paymentText
            }).eq('id', state.version.id);
            
            renderHistory();
        }

        // ----- CRIAR NOVA VERSÃO (ADITIVO) -----
        async function createAddon() {
            if(!confirm("Criar nova versão (Aditivo)?")) return;
            const t = state.data.items.reduce((a,b)=> (!b.optional ? a+(b.qty*b.price) : a),0);
            logHistory('created', 'provider', `Criou nova versão V${state.version.version_number+1}.`);
            await db.from('versions').insert({
                project_id: state.project.id,
                version_number: state.version.version_number + 1,
                items: state.data,
                total_value: t,
                status: 'draft'
            });
            loadEditor(state.project.id);
        }

        // ----- ALTERAR STATUS MANUALMENTE -----
        async function changeStatus(newStatus) {
            if(!confirm(`Mudar status para ${newStatus}?`)) return;
            await db.from('versions').update({status: newStatus}).eq('id', state.version.id);
            logHistory(newStatus, 'provider', 'Alteração manual de status.');
            await save();
            loadEditor(state.project.id);
        }

        // ----- HISTÓRICO (IGUAL AO ORIGINAL) -----
        function renderHistory() {
            const hist = state.data.history || [];
            let histHtml = '';
            if(hist.length > 0) {
                hist.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(h => {
                    const date = new Date(h.date).toLocaleString('pt-BR');
                    let icon = 'info-circle text-blue-400';
                    let actionLabel = 'Visualizou';
                    if (h.action === 'approved') { icon = 'check text-green-500'; actionLabel = 'Aprovou'; }
                    else if (h.action === 'change_request') { icon = 'comment-dots text-amber-500'; actionLabel = 'Solicitou alteração'; }
                    else if (h.action === 'canceled') { icon = 'times text-red-500'; actionLabel = 'Recusou/Cancelou'; }
                    else if (h.action === 'created') { icon = 'plus-circle text-blue-600'; actionLabel = 'Criou o orçamento'; }
                    else if (h.action === 'edited') { icon = 'pen text-indigo-500'; actionLabel = 'Alterou o escopo'; }

                    histHtml += `<div class="timeline-item">
                        <div class="text-xs text-slate-400">${date} • ${h.user === 'provider' ? 'Você' : 'Cliente'}</div>
                        <div class="font-bold text-sm text-slate-700 flex items-center gap-2 mt-1">
                            <i class="fas fa-${icon}"></i> ${actionLabel}
                        </div>
                        ${h.detail ? `<div class="timeline-desc ${h.action.includes('request') ? '' : 'system'}">${h.detail}</div>` : ''}
                    </div>`;
                });
            } else {
                histHtml = '<div class="text-xs text-slate-400 italic">Sem histórico registrado.</div>';
            }
            setHTML('ed-history', histHtml);
        }

        // ----- COMPARTILHAR (MODAL ORIGINAL CORRIGIDO) -----
        async function openShareModal() {
            await save();
            if (!state.version?.id) return alert("Erro ao salvar versão.");

            const url = `${window.location.origin}${window.location.pathname}?view=public&id=${state.version.id}`;
            const clientName = state.data.client.name ? ` ${state.data.client.name}` : '';
            const msg = `Olá${clientName}! Segue o link da proposta comercial para sua aprovação: ${url}`;

            document.getElementById('btn-share-wa').onclick = function() {
                let phone = (state.data.client.phone || '').replace(/\D/g, '');
                let link = `https://wa.me/${phone.length >= 10 ? '55' + phone : ''}?text=${encodeURIComponent(msg)}`;
                window.open(link, '_blank');
                document.getElementById('share-modal').classList.add('hidden');
            };

            document.getElementById('btn-share-copy').onclick = async function() {
                try {
                    await navigator.clipboard.writeText(url);
                    alert("✅ Link copiado com sucesso!");
                } catch (err) {
                    const textArea = document.createElement("textarea");
                    textArea.value = url;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand("copy");
                    document.body.removeChild(textArea);
                    alert("✅ Link copiado!");
                }
                document.getElementById('share-modal').classList.add('hidden');
            };

            safeShow('share-modal');
        }

        // ----- PÁGINA PÚBLICA (IDÊNTICA AO ORIGINAL) -----
        async function loadPublicProposal(id) {
            try {
                safeShow('public-loading');
                const { data: v, error } = await db.from('versions').select('*, projects(name)').eq('id', id).maybeSingle();
                if (error || !v) throw new Error("Orçamento não encontrado.");
                state.version = v; 
                state.data = normalizeData(v.items);
                const d = state.data;
                
                if(v.status === 'approved') document.getElementById('stamp-approved').style.display = 'block';

                if(d.settings.providerName) {
                    setHTML('doc-provider-info', `<div class="mb-4 pb-4 border-b border-slate-700"><h2 class="text-xl font-bold">${d.settings.providerName}</h2><p class="text-slate-400 text-sm">${d.settings.providerDoc || ''} • ${d.settings.providerPhone || ''}</p><p class="text-slate-400 text-xs">${d.settings.providerAddr || ''}</p></div>`);
                }

                safeText('doc-title', v.projects?.name);
                safeText('doc-id', `#${v.project_id ? v.project_id.substr(0,4).toUpperCase() : 'XXXX'}-${v.version_number}`);
                safeText('doc-c-name', d.client.name);
                safeText('doc-c-doc', d.client.doc);
                
                const finalAddr = d.location.sameAsClient ? d.client.address : (d.location.address || 'Não informado');
                safeText('doc-c-addr', finalAddr);
                
                renderPublicItems(); 

                safeText('doc-payment', d.terms.paymentText); 
                safeText('doc-deadline', d.terms.deadline); 
                safeText('doc-validity', d.terms.validity); 
                safeText('doc-obs', d.terms.obs);

                if(d.attachments && d.attachments.length > 0) {
                    let attHtml = '<h3 class="font-bold text-xs uppercase text-slate-400 mb-2 mt-8 tracking-wider">Documentos Anexos</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-2">';
                    d.attachments.forEach(att => {
                        let icon = att.type === 'pdf' ? 'fa-file-pdf text-red-500' : 'fa-file-image text-blue-500';
                        attHtml += `<a href="${att.url}" target="_blank" class="flex items-center gap-3 p-3 border rounded hover:bg-slate-50 transition-colors"><i class="fas ${icon} text-lg"></i><span class="text-sm font-medium text-slate-700 truncate">${att.name}</span></a>`;
                    });
                    attHtml += '</div>';
                    setHTML('doc-attachments-area', attHtml);
                } else {
                    setHTML('doc-attachments-area', '');
                }

                if (d.signature) {
                    setHTML('doc-signature-area', `<div class="mt-8 border-t border-dashed pt-4 w-64 text-center"><img src="${d.signature}" class="mx-auto h-16 mb-2" alt="Assinatura"><p class="text-xs text-slate-500 uppercase font-bold">Assinado Digitalmente</p></div>`);
                }

                const actions = document.getElementById('doc-actions');
                if(actions) {
                    if(v.status === 'approved' || v.status === 'canceled') {
                        showSuccessScreen(v.status);
                    } else {
                        actions.innerHTML = `
                            <button onclick="openModal('approve')" class="w-full bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-green-700 mb-3 transition-transform hover:scale-[1.01]">APROVAR PROPOSTA</button>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="openModal('change')" class="bg-amber-100 text-amber-700 font-bold py-3 rounded-xl hover:bg-amber-200">Solicitar Alteração</button>
                                <button onclick="openModal('cancel')" class="bg-red-50 text-red-600 font-bold py-3 rounded-xl hover:bg-red-100">Recusar</button>
                            </div>
                        `;
                    }
                }
                safeHide('public-loading');
                safeShow('view-public');
                safeShow('public-content');
            } catch(e) { 
                safeHide('public-loading');
                safeText('error-msg', `Erro: ${e.message}`);
                safeShow('fatal-error');
            }
        }

        function renderPublicItems() {
            let html = '';
            let total = 0;
            const items = state.data.items;
            const isFrozen = state.version.status !== 'sent' && state.version.status !== 'negotiating' && state.version.status !== 'draft';

            items.forEach((i, idx) => {
                let isActive = !i.optional; 
                if (i.optional && i.publicSelected) isActive = true; 
                
                if(i.optional && typeof i.publicSelected === 'undefined') i.publicSelected = false;

                if (!i.optional || i.publicSelected) {
                    total += (i.qty * i.price);
                }

                html += `<tr class="border-b border-slate-100 ${i.optional ? 'bg-slate-50' : ''}">
                    <td class="py-4 pl-4">
                        <div class="flex items-start gap-3">
                            ${i.optional && !isFrozen ? `<input type="checkbox" onchange="togglePublicOpt(${idx})" ${i.publicSelected ? 'checked' : ''} class="mt-1 w-5 h-5 cursor-pointer accent-green-600">` : ''}
                            ${i.optional && isFrozen ? (i.publicSelected ? '<i class="fas fa-check-square text-green-600 mt-1"></i>' : '<i class="far fa-square text-slate-400 mt-1"></i>') : ''}
                            <div>
                                <div class="font-bold text-slate-800 ${i.optional ? 'text-slate-600' : ''}">
                                    ${i.name} ${i.optional ? '<span class="text-[10px] bg-slate-200 text-slate-600 px-1 rounded uppercase ml-2">Opcional</span>' : ''}
                                </div>
                                <span class="font-normal text-xs text-slate-500">${i.description}</span>
                            </div>
                        </div>
                    </td>
                    <td class="text-center text-sm">${i.qty}</td>
                    <td class="text-right text-sm text-slate-500">R$ ${i.price.toLocaleString('pt-BR',{minimumFractionDigits:2})}</td>
                    <td class="text-right pr-4 font-bold text-sm ${i.optional && !i.publicSelected ? 'text-slate-400 decoration-slate-400 line-through' : 'text-slate-800'}">
                        R$ ${(i.qty*i.price).toLocaleString('pt-BR',{minimumFractionDigits:2})}
                    </td>
                </tr>`; 
            });
            setHTML('doc-items-body', html);
            safeText('doc-total', total.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'}));
        }

        function togglePublicOpt(idx) {
            state.data.items[idx].publicSelected = !state.data.items[idx].publicSelected;
            renderPublicItems();
        }

        // ----- PDF (ORIGINAL) -----
        function downloadPDF() {
            const element = document.getElementById('public-content');
            const btn = document.getElementById('btn-download-pdf');
            if(btn) btn.innerText = "Gerando PDF...";
            const stamp = document.getElementById('stamp-approved');
            const originalDisplay = stamp.style.display;
            stamp.style.display = 'block';
            document.querySelectorAll('.no-print').forEach(el => el.style.display = 'none');
            const opt = { 
                margin: 0, 
                filename: `Comprovante_${state.version?.projects?.name || 'proposta'}.pdf`, 
                image: { type: 'jpeg', quality: 0.98 }, 
                html2canvas: { scale: 2 }, 
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } 
            };
            html2pdf().set(opt).from(element).save().then(() => {
                if(btn) btn.innerText = "Baixar Comprovante PDF";
                document.querySelectorAll('.no-print').forEach(el => el.style.display = '');
                stamp.style.display = originalDisplay;
            });
        }

        // ----- MODAL DE INTERAÇÃO PÚBLICA (ORIGINAL) -----
        function openModal(type) {
            const modal = document.getElementById('interaction-modal');
            const title = document.getElementById('modal-title');
            const desc = document.getElementById('modal-desc');
            const input = document.getElementById('modal-input');
            const sigArea = document.getElementById('modal-sig-area');
            const btn = document.getElementById('modal-btn');
            
            modal.classList.remove('hidden');
            input.value = '';
            input.classList.add('hidden');
            sigArea.classList.add('hidden');
            
            if(type === 'approve') {
                title.innerText = 'Assinar e Aprovar';
                desc.innerText = 'Por favor, assine abaixo para confirmar a aprovação.';
                sigArea.classList.remove('hidden');
                btn.innerText = 'Confirmar Aprovação';
                btn.className = "flex-1 bg-green-600 text-white py-3 rounded font-bold hover:bg-green-700";
                btn.onclick = () => executeAction('approve');
                setTimeout(initSignaturePad, 100); 
            } else if(type === 'change') {
                title.innerText = 'O que deseja alterar?';
                desc.innerText = 'Descreva as mudanças desejadas:';
                input.classList.remove('hidden');
                btn.innerText = 'Enviar Solicitação';
                btn.className = "flex-1 bg-amber-600 text-white py-3 rounded font-bold hover:bg-amber-700";
                btn.onclick = () => executeAction('change');
            } else if(type === 'cancel') {
                title.innerText = 'Recusar Orçamento';
                desc.innerText = 'Motivo (Opcional):';
                input.classList.remove('hidden');
                btn.innerText = 'Confirmar Recusa';
                btn.className = "flex-1 bg-red-600 text-white py-3 rounded font-bold hover:bg-red-700";
                btn.onclick = () => executeAction('cancel');
            }
        }

        function initSignaturePad() {
            const canvas = document.getElementById('signature-pad');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            function resizeCanvas() {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                ctx.scale(ratio, ratio);
            }
            resizeCanvas();
            let painting = false;
            function startPosition(e) { 
                painting = true; 
                ctx.beginPath();
                draw(e); 
            }
            function endPosition() { 
                painting = false; 
                ctx.beginPath(); 
            }
            function draw(e) {
                if (!painting) return;
                e.preventDefault(); 
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || (e.touches?.[0]?.clientX)) - rect.left;
                const y = (e.clientY || (e.touches?.[0]?.clientY)) - rect.top;
                ctx.lineWidth = 2; 
                ctx.lineCap = 'round'; 
                ctx.strokeStyle = '#0f172a';
                ctx.lineTo(x, y); 
                ctx.stroke(); 
                ctx.beginPath(); 
                ctx.moveTo(x, y);
            }
            canvas.addEventListener('mousedown', startPosition); 
            canvas.addEventListener('mouseup', endPosition); 
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('touchstart', startPosition); 
            canvas.addEventListener('touchend', endPosition); 
            canvas.addEventListener('touchmove', draw);
            document.getElementById('clear-sig').onclick = () => { 
                ctx.clearRect(0, 0, canvas.width, canvas.height); 
            };
        }

        async function executeAction(type) {
            const inputVal = safeVal('modal-input');
            const btn = document.getElementById('modal-btn');
            btn.innerText = "Processando...";
            btn.disabled = true;

            if (type === 'approve') {
                const canvas = document.getElementById('signature-pad');
                const signatureData = canvas.toDataURL();
                state.data.signature = signatureData;
                await approveLogic();
            } else if (type === 'change') {
                if(!inputVal) { 
                    alert("Escreva o que deseja alterar."); 
                    btn.disabled = false; 
                    btn.innerText = "Enviar Solicitação"; 
                    return; 
                }
                await sendLogic('change_request', 'negotiating', inputVal);
            } else if (type === 'cancel') {
                await sendLogic('canceled', 'canceled', inputVal || 'Recusado pelo cliente');
            }
        }

        async function sendLogic(action, newStatus, text) {
            logHistory(action, 'client', text);
            await db.from('versions').update({ 
                status: newStatus, 
                items: state.data 
            }).eq('id', state.version.id);
            document.getElementById('interaction-modal').classList.add('hidden');
            showSuccessScreen(action);
        }

        async function approveLogic() {
            let ip = 'IP não identificado'; 
            try { 
                const r = await fetch('https://api.ipify.org?format=json'); 
                const j = await r.json(); 
                ip = j.ip; 
            } catch(e){}
            
            logHistory('approved', 'client', 'Aprovado via link com assinatura');
            
            // Recalcular total com base nos opcionais selecionados
            const items = state.data.items;
            const finalTotal = items.reduce((acc, i) => (!i.optional || i.publicSelected ? acc + (i.qty * i.price) : acc), 0);
            
            await db.from('versions').update({ 
                status: 'approved', 
                approved_at: new Date(), 
                approved_by_ip: ip, 
                items: state.data, 
                total_value: finalTotal 
            }).eq('id', state.version.id);
            
            const phone = state.data.settings?.myPhone;
            if(phone) {
                const msg = `✅ O cliente APROVOU o orçamento ${state.version.projects?.name || ''}!`;
                window.open(`https://wa.me/${phone.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`, '_blank');
            }
            document.getElementById('interaction-modal').classList.add('hidden');
            showSuccessScreen('approved');
        }

        function showSuccessScreen(type) {
            safeHide('view-public');
            safeShow('view-success');
            const icon = document.getElementById('success-icon');
            const title = document.getElementById('success-title');
            const desc = document.getElementById('success-desc');
            const actions = document.getElementById('success-actions');
            actions.innerHTML = ''; 

            if(type === 'approved' || type === 'approve') {
                icon.className = "fas fa-check-circle text-6xl text-green-500 mb-4";
                title.innerText = "Orçamento Aprovado!";
                desc.innerText = "Obrigado pela confiança. O comprovante foi gerado.";
                actions.innerHTML = `<button onclick="loadPublicProposal('${state.version.id}').then(() => setTimeout(downloadPDF, 1000))" class="px-6 py-3 bg-slate-800 text-white rounded-lg font-bold shadow hover:bg-slate-700"><i class="fas fa-file-pdf mr-2"></i> Baixar Comprovante PDF</button>`;
            } else if (type === 'change_request' || type === 'negotiating') {
                icon.className = "fas fa-clock text-6xl text-amber-500 mb-4";
                title.innerText = "Solicitação Enviada";
                desc.innerText = "Aguarde o retorno do prestador.";
            } else {
                icon.className = "fas fa-times-circle text-6xl text-slate-400 mb-4";
                title.innerText = "Orçamento Recusado";
                desc.innerText = "O orçamento foi marcado como recusado.";
            }
        }

        window.onload = init;
        window.onpopstate = init;
    </script>
</body>
</html>
