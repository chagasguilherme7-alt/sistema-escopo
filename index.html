<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aprova Ai | Gestão Inteligente</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #1E3A8A;
            --primary-light: #3B5BA5;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--gray-100); 
            color: var(--gray-700); 
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-weight: 700;
        }

        .sidebar { 
            width: 260px; 
            background: white; 
            height: 100vh; 
            position: fixed; 
            left: 0; 
            top: 0; 
            border-right: 1px solid var(--gray-200); 
            display: flex; 
            flex-direction: column; 
            z-index: 50; 
            transition: transform 0.3s; 
            box-shadow: 4px 0 12px rgba(0,0,0,0.02);
        }
        .main-content { 
            margin-left: 260px; 
            padding: 2rem; 
            min-height: 100vh; 
            transition: margin 0.3s; 
        }
        .nav-item { 
            display: flex; 
            align-items: center; 
            padding: 12px 24px; 
            color: var(--gray-500); 
            font-weight: 500; 
            transition: all 0.2s; 
            cursor: pointer; 
            border-left: 3px solid transparent; 
        }
        .nav-item:hover, .nav-item.active { 
            background: var(--gray-50); 
            color: var(--primary); 
            border-left-color: var(--primary); 
        }
        .nav-item i { 
            width: 24px; 
            margin-right: 12px; 
            font-size: 1.2rem; 
        }
        .btn-new { 
            background: var(--primary); 
            color: white; 
            border-radius: 8px; 
            padding: 12px; 
            margin: 20px; 
            text-align: center; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.2s; 
            display: block; 
            box-shadow: 0 4px 8px rgba(30,58,138,0.2); 
        }
        .btn-new:hover { 
            background: var(--primary-light); 
            transform: scale(1.02); 
        }
        .mobile-header { 
            display: none; 
            justify-content: space-between; 
            align-items: center; 
            padding: 1rem; 
            background: white; 
            border-bottom: 1px solid var(--gray-200); 
            margin-bottom: 1rem; 
        }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); width: 100%; max-width: 320px; box-shadow: 4px 0 20px rgba(0,0,0,0.1); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 1rem; }
            .mobile-header { display: flex !important; }
            .mobile-header button { min-width: 48px; min-height: 48px; }
            .sidebar-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 45; backdrop-filter: blur(2px); }
            .sidebar.open ~ .sidebar-backdrop { display: block; }
            .grid-cols-1.md\:grid-cols-2.lg\:grid-cols-5 { grid-template-columns: repeat(2,1fr); }
            #project-cards-container { grid-template-columns: 1fr; }
            .bg-white.rounded-xl.border.border-slate-200.overflow-hidden { overflow-x: auto; }
            .custom-table { min-width: 600px; }
            .grid-cols-1.xl\:grid-cols-3 { grid-template-columns: 1fr; }
            .grid-cols-2 { grid-template-columns: 1fr; }
            .item-box .grid.grid-cols-12 { grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; }
            .item-box .grid.grid-cols-12 > .col-span-8 { grid-column: span 3; }
            .item-box .grid.grid-cols-12 > .col-span-2 { grid-column: span 1; }
            input, select, textarea, button { font-size: 16px; min-height: 48px; }
            .fixed.inset-0 .bg-white { max-width: 90%; margin: 0 auto; }
            .kpi-card .text-2xl { font-size: 1.2rem; }
            .reports-grid { grid-template-columns: 1fr; }
            .project-card { padding: 1rem; } /* Reduzir padding em mobile */
        }

        .custom-table { width: 100%; text-align: left; border-collapse: separate; border-spacing: 0; }
        .custom-table th { padding: 16px; background: var(--gray-50); color: var(--gray-500); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; border-bottom: 1px solid var(--gray-200); }
        .custom-table td { padding: 16px; border-bottom: 1px solid var(--gray-200); background: white; font-size: 0.9rem; }
        .custom-table tr:hover td { background: var(--gray-50); cursor: pointer; }

        .project-card { 
            background: white; 
            border: 1px solid var(--gray-200); 
            border-radius: 16px; 
            padding: 1.5rem; 
            transition: all 0.2s; 
            cursor: pointer; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.02); 
            width: 100%;
            overflow: hidden;
        }
        .project-card:hover { 
            border-color: var(--primary); 
            box-shadow: 0 12px 24px -8px rgba(30,58,138,0.15); 
            transform: translateY(-2px); 
        }

        .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }

        .status-badge { 
            font-size: 0.7rem; 
            font-weight: 700; 
            text-transform: uppercase; 
            padding: 4px 10px; 
            border-radius: 999px; 
            letter-spacing: 0.03em; 
            white-space: nowrap; 
            box-shadow: none !important; 
            border: none;
        }
        .st-draft { background: #EFF6FF; color: var(--primary); } 
        .st-sent { background: #DBEAFE; color: #1E3A8A; } 
        .st-negotiating { background: #FEF3C7; color: #B45309; } 
        .st-approved { background: #D1FAE5; color: #065F46; } 
        .st-canceled { background: #FEE2E2; color: #991B1B; }

        .item-box { background: white; border: 1px solid var(--gray-200); border-radius: 12px; padding: 16px; margin-bottom: 12px; position: relative; transition: all 0.2s; }
        .item-box:hover { border-color: var(--primary); box-shadow: 0 8px 16px rgba(0,0,0,0.05); }
        .item-optional { border: 2px dashed var(--gray-400) !important; background-color: var(--gray-50); opacity: 0.9; }
        .optional-badge { background: var(--gray-500); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; font-weight: bold; text-transform: uppercase; margin-left: 8px; }
        .diff-box { background-color: #FFFBEB; border: 1px dashed var(--warning); border-radius: 6px; padding: 8px; margin-top: 8px; font-size: 0.75rem; color: #9A3412; display: flex; align-items: center; gap: 8px; }
        .diff-tag { background: var(--warning); color: white; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.65rem; text-transform: uppercase; }
        .old-val { text-decoration: line-through; color: var(--danger); margin-right: 4px; }
        .new-val { color: var(--success); font-weight: bold; }
        .item-modified { border-left: 4px solid var(--warning) !important; }
        .item-new { border-left: 4px solid var(--success) !important; }

        .timeline-item { position: relative; padding-left: 2rem; border-left: 2px solid var(--gray-200); padding-bottom: 1.5rem; }
        .timeline-item::before { content: ''; position: absolute; left: -5px; top: 0; width: 8px; height: 8px; border-radius: 50%; background: var(--gray-400); }
        .timeline-item:last-child { border-left: transparent; }
        .timeline-desc { font-size: 0.85rem; color: var(--gray-700); margin-top: 6px; background: #FFFBEB; padding: 12px; border-radius: 8px; border: 1px solid #FED7AA; font-style: italic; }
        .timeline-desc.system { background: var(--gray-50); border-color: var(--gray-200); font-style: normal; }

        #signature-pad { border: 2px dashed var(--gray-300); border-radius: 12px; background: var(--gray-50); cursor: crosshair; touch-action: none; width: 100%; height: 200px; }

        .loader-spin { width: 30px; height: 30px; border: 3px solid var(--gray-200); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: white; border-radius: 12px; padding: 16px 20px; box-shadow: 0 20px 30px -10px rgba(0,0,0,0.2); border-left: 6px solid; display: flex; align-items: center; gap: 12px; min-width: 280px; max-width: 400px; animation: slideIn 0.3s; }
        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: var(--danger); }
        .toast.warning { border-left-color: var(--warning); }
        .toast.info { border-left-color: var(--primary); }
        .toast-icon { font-size: 1.5rem; }
        .toast-message { flex: 1; font-size: 0.9rem; font-weight: 500; }
        .toast-close { cursor: pointer; color: var(--gray-400); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .skeleton { background: linear-gradient(90deg, var(--gray-200) 25%, var(--gray-100) 50%, var(--gray-200) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 8px; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        [data-tooltip] { position: relative; cursor: help; }
        [data-tooltip]:hover:after { content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: var(--gray-800); color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; white-space: nowrap; z-index: 10; margin-bottom: 6px; }

        .progress-bar { height: 6px; background: var(--gray-200); border-radius: 999px; overflow: hidden; margin-top: 8px; }
        .progress-fill { height: 100%; border-radius: 999px; transition: width 0.3s; }
        .progress-fill.draft { background: var(--gray-400); width: 20%; }
        .progress-fill.sent { background: var(--primary); width: 40%; }
        .progress-fill.negotiating { background: var(--warning); width: 60%; }
        .progress-fill.approved { background: var(--success); width: 100%; }
        .progress-fill.canceled { background: var(--danger); width: 100%; }

        .avatar-circle { width: 40px; height: 40px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1rem; flex-shrink: 0; }

        .split-screen { display: flex; min-height: 100vh; width: 100%; position: absolute; top: 0; left: 0; z-index: 50; background: white; }
        .left-area { 
            width: 60%; 
            background: linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%);
            color: var(--gray-800); 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            padding: 4rem 5rem; 
            position: relative; 
            overflow: hidden; 
        }
        .glow-orb { 
            position: absolute; 
            border-radius: 50%; 
            filter: blur(100px); 
            opacity: 0.2; 
        }
        .orb-1 { 
            width: 700px; 
            height: 700px; 
            background: var(--primary); 
            top: -20%; 
            left: -20%; 
            animation: float 18s ease-in-out infinite; 
        }
        .orb-2 { 
            width: 600px; 
            height: 600px; 
            background: var(--success); 
            bottom: -20%; 
            right: -15%; 
            animation: float 22s ease-in-out infinite reverse; 
        }
        @keyframes float { 
            0% { transform: translate(0, 0); } 
            50% { transform: translate(-30px, 30px); } 
            100% { transform: translate(0, 0); } 
        }
        .benefit-item { 
            display: flex; 
            align-items: start; 
            gap: 1.25rem; 
            padding: 1.25rem; 
            margin-bottom: 1.25rem; 
            background: rgba(255,255,255,0.7); 
            backdrop-filter: blur(8px);
            border-radius: 16px; 
            transition: all 0.3s ease; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.02);
            border-left: 4px solid transparent;
        }
        .benefit-item:nth-child(1) { border-left-color: var(--warning); }
        .benefit-item:nth-child(2) { border-left-color: var(--primary); }
        .benefit-item:nth-child(3) { border-left-color: var(--success); }
        .benefit-item:hover { 
            background: white; 
            transform: translateX(8px); 
            box-shadow: 0 12px 28px rgba(0,0,0,0.05);
        }
        .icon-circle { 
            width: 48px; 
            height: 48px; 
            border-radius: 16px; 
            background: white; 
            color: var(--primary); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 1.5rem; 
            flex-shrink: 0; 
            box-shadow: 0 8px 16px rgba(0,0,0,0.05); 
        }
        .right-area { 
            width: 40%; 
            background: white; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: relative; 
            padding: 2rem; 
        }
        .login-card { 
            background: white; 
            width: 100%; 
            max-width: 420px; 
            padding: 3rem 2rem; 
            border-radius: 32px; 
            box-shadow: 0 30px 60px -20px rgba(0,0,0,0.2); 
            border: 1px solid var(--gray-200); 
            text-align: center; 
        }
        .input-pro { 
            width: 100%; 
            padding: 16px; 
            background: var(--gray-50); 
            border: 1px solid var(--gray-200); 
            border-radius: 16px; 
            font-size: 1rem; 
            color: var(--gray-800); 
            text-align: center; 
            transition: all 0.2s; 
            margin-bottom: 1.5rem; 
            outline: none; 
        }
        .input-pro:focus { 
            background: white; 
            border-color: var(--primary); 
            box-shadow: 0 0 0 4px rgba(30,58,138,0.1); 
        }
        .btn-pro { 
            width: 100%; 
            padding: 16px; 
            border-radius: 16px; 
            font-weight: 700; 
            color: white; 
            background: var(--primary); 
            border: none; 
            cursor: pointer; 
            transition: all 0.3s; 
            font-size: 1rem; 
            box-shadow: 0 10px 20px -5px rgba(30,58,138,0.3); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px;
        }
        .btn-pro:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 20px 30px -5px rgba(30,58,138,0.4); 
        }
        .btn-pro:disabled { opacity: 0.6; cursor: not-allowed; }

        .collapsible-header { cursor: pointer; user-select: none; }
        .collapsible-content { transition: max-height 0.3s ease; overflow: hidden; }
        .collapsible-content.collapsed { max-height: 0; }

        @media print {
            body { background: white; }
            .no-print { display: none !important; }
            #public-content { 
                box-shadow: none; 
                margin: 0; 
                width: 100%; 
                max-width: 100%; 
                font-size: 12pt; 
                line-height: 1.4; 
            }
            #public-content .p-12 { padding: 1.5cm !important; }
            table, tr, td, th { page-break-inside: avoid; }
            h1, h2, h3, h4 { page-break-after: avoid; }
            .print-break-before { page-break-before: always; }
            .print-break-after { page-break-after: always; }
            .print-break-inside { page-break-inside: avoid; }
            .bg-slate-900 { background: white !important; color: black !important; }
            .bg-slate-900 * { color: black !important; }
            #stamp-approved { opacity: 0.3 !important; }
        }

        @media (max-width: 768px) {
            #public-content .p-12 { padding: 1rem !important; }
            #public-content .flex.gap-12 { flex-direction: column; gap: 1rem; }
            #public-content table { font-size: 0.8rem; }
            #public-content .text-3xl { font-size: 1.5rem; }
            .kpi-card .text-2xl { font-size: 1.1rem; }
            .kpi-card .text-xs { font-size: 0.65rem; }
            #public-content .overflow-x-auto { overflow-x: auto; }
            .reports-grid { grid-template-columns: 1fr; }
        }

        /* Estilos para relatórios */
        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--gray-200);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            transition: all 0.2s;
        }
        .stat-card:hover {
            border-color: var(--primary);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        }
        .progress-bar-small {
            height: 8px;
            background: var(--gray-200);
            border-radius: 999px;
            overflow: hidden;
            width: 100%;
        }
        .progress-fill-small {
            height: 100%;
            background: var(--success);
            border-radius: 999px;
        }
        .client-item, .item-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-bottom: 1px solid var(--gray-200);
        }
        .client-item:last-child, .item-item:last-child {
            border-bottom: none;
        }
        .client-rank {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div id="system-loader" style="position:fixed; inset:0; background:white; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <div class="loader-spin mb-4"></div>
        <img src="logo.png" alt="Aprova Ai" class="h-16 mb-2">
        <p class="text-sm text-slate-500 font-medium">Carregando Sistema...</p>
    </div>

    <div id="fatal-error" class="hidden fixed inset-0 bg-rose-50 z-[10000] flex flex-col items-center justify-center p-8 text-center">
        <i class="fas fa-exclamation-triangle text-4xl text-amber-500 mb-4"></i>
        <h2 class="text-2xl font-bold text-slate-800">Ops! Algo deu errado.</h2>
        <p id="error-msg" class="text-slate-600 mt-2 mb-6 max-w-md"></p>
        <button onclick="localStorage.clear(); window.location.reload()" class="px-6 py-3 bg-slate-900 text-white rounded font-bold">Recarregar</button>
    </div>

    <!-- LOGIN -->
    <section id="view-login" class="hidden split-screen">
        <div class="left-area">
            <div class="glow-orb orb-1"></div><div class="glow-orb orb-2"></div>
            <div class="relative z-10">
                <div class="mb-6">
                    <img src="logo.png" alt="Aprova Ai" class="h-16">
                </div>
                <h1 class="text-5xl font-extrabold leading-tight mb-4 font-heading">Orçamentos que <br><span class="text-transparent bg-clip-text bg-gradient-to-r from-[#1E3A8A] to-[#3B5BA5]">protegem seu negócio</span></h1>
                <p class="text-xl text-slate-600 mb-8">Crie, envie e acompanhe orçamentos com aprovação digital e histórico completo.</p>
                <div class="space-y-4">
                    <div class="benefit-item">
                        <div class="icon-circle"><i class="fas fa-shield-alt"></i></div>
                        <div><h3 class="font-bold text-xl text-slate-800">Evite prejuízos</h3><p class="text-sm text-slate-500">Registre mudanças de escopo e evite retrabalho.</p></div>
                    </div>
                    <div class="benefit-item">
                        <div class="icon-circle"><i class="fas fa-check-circle"></i></div>
                        <div><h3 class="font-bold text-xl text-slate-800">Aprovação rápida</h3><p class="text-sm text-slate-500">Link direto para o cliente aprovar com assinatura digital.</p></div>
                    </div>
                    <div class="benefit-item">
                        <div class="icon-circle"><i class="fas fa-file-contract"></i></div>
                        <div><h3 class="font-bold text-xl text-slate-800">Sem discussão</h3><p class="text-sm text-slate-500">Tudo documentado, histórico completo e PDF comprovante.</p></div>
                    </div>
                </div>
                <div class="mt-12">
                    <h3 class="text-2xl font-bold text-slate-800 mb-6">Como funciona?</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                        <div class="bg-white/80 backdrop-blur-sm rounded-2xl p-5 border border-[#1E3A8A]/20 hover:border-[#1E3A8A]/40 transition">
                            <div class="w-12 h-12 bg-[#1E3A8A] text-white rounded-2xl flex items-center justify-center font-bold text-xl mb-3">1</div>
                            <h4 class="font-bold text-slate-800 text-lg">Crie</h4>
                            <p class="text-sm text-slate-500">Adicione itens, opcionais e anexos. Seus dados são salvos automaticamente.</p>
                        </div>
                        <div class="bg-white/80 backdrop-blur-sm rounded-2xl p-5 border border-[#1E3A8A]/20 hover:border-[#1E3A8A]/40 transition">
                            <div class="w-12 h-12 bg-[#1E3A8A] text-white rounded-2xl flex items-center justify-center font-bold text-xl mb-3">2</div>
                            <h4 class="font-bold text-slate-800 text-lg">Envie</h4>
                            <p class="text-sm text-slate-500">Compartilhe o link por WhatsApp ou e-mail. O cliente vê tudo.</p>
                        </div>
                        <div class="bg-white/80 backdrop-blur-sm rounded-2xl p-5 border border-[#1E3A8A]/20 hover:border-[#1E3A8A]/40 transition">
                            <div class="w-12 h-12 bg-[#1E3A8A] text-white rounded-2xl flex items-center justify-center font-bold text-xl mb-3">3</div>
                            <h4 class="font-bold text-slate-800 text-lg">Aprovação</h4>
                            <p class="text-sm text-slate-500">Cliente aprova com assinatura digital. Você recebe notificação e PDF.</p>
                        </div>
                    </div>
                </div>
                <div class="mt-12 flex flex-wrap items-center gap-4">
                    <div class="bg-white/70 backdrop-blur-sm rounded-full px-4 py-2 border border-[#1E3A8A]/20">
                        <i class="fas fa-users text-[#10B981]"></i>
                        <span class="text-slate-600 font-medium">+500 usuários</span>
                    </div>
                    <div class="bg-white/70 backdrop-blur-sm rounded-full px-4 py-2 border border-[#1E3A8A]/20">
                        <i class="fas fa-file-invoice text-[#10B981]"></i>
                        <span class="text-slate-600 font-medium">+2.000 orçamentos</span>
                    </div>
                    <div class="bg-white/70 backdrop-blur-sm rounded-full px-4 py-2 border border-[#1E3A8A]/20">
                        <i class="fas fa-star text-[#10B981]"></i>
                        <span class="text-slate-600 font-medium">98% satisfação</span>
                    </div>
                </div>
                <div class="mt-12 text-sm text-slate-400 flex gap-6">
                    <a href="#" onclick="openTermsModal()" class="hover:text-[#1E3A8A] transition">Termos</a>
                    <a href="#" onclick="openPrivacyModal()" class="hover:text-[#1E3A8A] transition">Privacidade</a>
                    <span>© 2025 Aprova Ai</span>
                </div>
            </div>
        </div>
        <div class="right-area">
            <div class="login-card">
                <div class="w-16 h-16 bg-[#1E3A8A] text-white text-2xl rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-envelope"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-800 mb-2">Acesse sua conta</h2>
                <p class="text-slate-400 mb-8 text-sm">Digite seu e-mail para entrar.</p>
                <input type="email" id="email" placeholder="seu@email.com" class="input-pro">
                <button onclick="handleLogin()" id="btn-login" class="btn-pro"><i class="fas fa-paper-plane"></i> Enviar link de acesso</button>
            </div>
        </div>
    </section>

    <!-- LAYOUT PRINCIPAL -->
    <div id="app-layout" class="hidden">
        <div class="mobile-header">
            <img src="logo.png" alt="Aprova Ai" class="h-8">
            <button onclick="document.querySelector('.sidebar').classList.toggle('open')" class="text-slate-600"><i class="fas fa-bars text-xl"></i></button>
        </div>

        <aside class="sidebar">
            <div class="py-4 flex justify-center border-b border-slate-100">
                <img src="logo.png" alt="Aprova Ai" class="h-16">
            </div>
            <div onclick="createProject()" class="btn-new">
                <i class="fas fa-plus mr-2"></i> Novo Orçamento
            </div>
            <nav class="flex-1 overflow-y-auto py-2">
                <div onclick="switchTab('dashboard')" class="nav-item active" id="nav-dashboard"><i class="fas fa-home"></i> Visão geral</div>
                <div onclick="switchTab('projects')" class="nav-item" id="nav-projects"><i class="fas fa-file-invoice"></i> Orçamentos</div>
                <div class="px-6 py-4 mt-2">
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-3">Filtros rápidos</p>
                    <div onclick="filterProjects('draft')" class="flex items-center text-sm text-slate-600 py-1 cursor-pointer hover:text-[#1E3A8A] mb-2"><span class="status-dot" style="background:#9CA3AF"></span> Rascunho</div>
                    <div onclick="filterProjects('sent')" class="flex items-center text-sm text-slate-600 py-1 cursor-pointer hover:text-[#1E3A8A] mb-2"><span class="status-dot" style="background:#1E3A8A"></span> Aguardando resposta</div>
                    <div onclick="filterProjects('negotiating')" class="flex items-center text-sm text-slate-600 py-1 cursor-pointer hover:text-[#1E3A8A] mb-2"><span class="status-dot" style="background:#F59E0B"></span> Em Negociação</div>
                    <div onclick="filterProjects('approved')" class="flex items-center text-sm text-slate-600 py-1 cursor-pointer hover:text-[#1E3A8A] mb-2"><span class="status-dot" style="background:#10B981"></span> Aprovados</div>
                    <div onclick="filterProjects('canceled')" class="flex items-center text-sm text-slate-600 py-1 cursor-pointer hover:text-[#1E3A8A]"><span class="status-dot" style="background:#EF4444"></span> Cancelados</div>
                </div>
                <div onclick="switchTab('clients')" class="nav-item" id="nav-clients"><i class="fas fa-users"></i> Clientes</div>
                <div onclick="switchTab('catalog')" class="nav-item" id="nav-catalog"><i class="fas fa-box"></i> Catálogo</div>
                <div onclick="switchTab('reports')" class="nav-item" id="nav-reports"><i class="fas fa-chart-pie"></i> Relatórios</div>
            </nav>
            <div class="p-4 border-t border-slate-100">
                <button onclick="db.auth.signOut().then(()=>window.location.reload())" class="flex items-center text-sm text-red-500 font-medium w-full px-4 py-2"><i class="fas fa-sign-out-alt mr-3"></i> Sair</button>
            </div>
        </aside>

        <div class="sidebar-backdrop hidden md:hidden" onclick="document.querySelector('.sidebar').classList.remove('open')"></div>

        <main class="main-content">
            <!-- DASHBOARD -->
            <section id="view-dashboard" class="space-y-6">
                <h2 class="text-2xl font-bold text-slate-800">Visão geral</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                    <div class="kpi-card bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition">
                        <div class="flex items-center justify-between">
                            <div class="truncate">
                                <div class="text-xs text-slate-500 uppercase mb-1">Faturamento Aprovado</div>
                                <div class="text-2xl font-bold text-[#10B981] truncate" id="kpi-total-apr">R$ 0,00</div>
                            </div>
                            <i class="fas fa-chart-line text-2xl text-[#10B981]"></i>
                        </div>
                        <span class="text-xs text-green-500">↑ 12%</span>
                    </div>
                    <div class="kpi-card bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition">
                        <div class="flex items-center justify-between">
                            <div class="truncate">
                                <div class="text-xs text-slate-500 uppercase mb-1">Pipeline (Total)</div>
                                <div class="text-2xl font-bold text-[#1E3A8A] truncate" id="kpi-total-est">R$ 0,00</div>
                            </div>
                            <i class="fas fa-chart-bar text-2xl text-[#1E3A8A]"></i>
                        </div>
                        <span class="text-xs text-green-500">↑ 8%</span>
                    </div>
                    <div class="kpi-card bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition">
                        <div class="flex items-center justify-between">
                            <div class="truncate">
                                <div class="text-xs text-slate-500 uppercase mb-1">Aguardando resposta</div>
                                <div class="text-2xl font-bold text-[#1E3A8A] truncate" id="kpi-count-sent">0</div>
                            </div>
                            <i class="fas fa-clock text-2xl text-[#1E3A8A]"></i>
                        </div>
                        <span class="text-xs text-amber-500">↘ 3%</span>
                    </div>
                    <div class="kpi-card bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition">
                        <div class="flex items-center justify-between">
                            <div class="truncate">
                                <div class="text-xs text-slate-500 uppercase mb-1">Em Negociação</div>
                                <div class="text-2xl font-bold text-[#F59E0B] truncate" id="kpi-count-neg">0</div>
                            </div>
                            <i class="fas fa-handshake text-2xl text-[#F59E0B]"></i>
                        </div>
                        <span class="text-xs text-green-500">↑ 2%</span>
                    </div>
                    <div class="kpi-card bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition">
                        <div class="flex items-center justify-between">
                            <div class="truncate">
                                <div class="text-xs text-slate-500 uppercase mb-1">Rascunhos</div>
                                <div class="text-2xl font-bold text-slate-600 truncate" id="kpi-count-open">0</div>
                            </div>
                            <i class="fas fa-pen text-2xl text-slate-600"></i>
                        </div>
                        <span class="text-xs text-slate-400">↔ 0%</span>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-700">Atividade de orçamentos</h3>
                        <div class="flex gap-2">
                            <button onclick="setChartPeriod(7)" class="period-btn px-3 py-1 text-xs font-medium rounded-lg bg-[#1E3A8A] text-white" data-period="7">7d</button>
                            <button onclick="setChartPeriod(30)" class="period-btn px-3 py-1 text-xs font-medium rounded-lg bg-slate-100 text-slate-700 hover:bg-slate-200" data-period="30">30d</button>
                            <button onclick="setChartPeriod(90)" class="period-btn px-3 py-1 text-xs font-medium rounded-lg bg-slate-100 text-slate-700 hover:bg-slate-200" data-period="90">90d</button>
                        </div>
                    </div>
                    <div style="height: 320px;">
                        <canvas id="dashboardChart"></canvas>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold text-slate-700 flex items-center gap-2">
                            <i class="fas fa-history text-[#1E3A8A]"></i> Atividade recente
                        </h3>
                        <span class="text-xs text-slate-400">últimas 10 ações</span>
                    </div>
                    <div id="activity-feed" class="divide-y divide-slate-100"></div>
                    <div class="mt-4 text-center">
                        <button onclick="showAllActivities()" class="text-xs font-bold text-[#1E3A8A] hover:underline">Ver todas</button>
                    </div>
                </div>
            </section>

            <!-- PROJETOS -->
            <section id="view-projects" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-slate-800">Orçamentos</h2>
                    <div class="flex gap-2">
                        <button onclick="openTemplateModal()" class="bg-[#10B981] text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-[#0E9E6F] transition"><i class="fas fa-copy mr-2"></i> Carregar Template</button>
                        <button onclick="createProject()" class="bg-[#1E3A8A] text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-[#3B5BA5] transition"><i class="fas fa-plus mr-2"></i> Novo</button>
                    </div>
                </div>
                <div class="flex flex-col md:flex-row gap-4 items-center bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                    <div class="flex-1 w-full relative">
                        <i class="fas fa-search absolute left-3 top-3 text-slate-400"></i>
                        <input id="project-search" onkeyup="renderProjectCards()" class="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none focus:border-[#1E3A8A]" placeholder="Buscar cliente ou projeto...">
                    </div>
                    <div class="flex gap-2">
                        <select id="project-status-filter" onchange="renderProjectCards()" class="p-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none">
                            <option value="all">Todos os Status</option>
                            <option value="draft">Rascunho</option>
                            <option value="sent">Aguardando resposta</option>
                            <option value="negotiating">Em Negociação</option>
                            <option value="approved">Aprovados</option>
                            <option value="canceled">Cancelados</option>
                        </select>
                        <div class="relative" data-tooltip="Filtrar por data (em breve)">
                            <button class="p-2 bg-slate-50 border border-slate-200 rounded-lg"><i class="fas fa-calendar-alt"></i></button>
                        </div>
                    </div>
                </div>
                <div id="project-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </section>

            <!-- CLIENTES -->
            <section id="view-clients" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-slate-800">Clientes</h2>
                    <button onclick="openClientModal()" class="bg-[#1E3A8A] text-white px-4 py-2 rounded-lg text-sm font-bold"><i class="fas fa-plus mr-2"></i> Novo Cliente</button>
                </div>
                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                    <div class="flex gap-4 items-center">
                        <div class="flex-1 relative">
                            <i class="fas fa-search absolute left-3 top-3 text-slate-400"></i>
                            <input id="client-search" onkeyup="renderClients()" class="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none focus:border-[#1E3A8A]" placeholder="Buscar cliente...">
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Documento</th>
                                <th>Telefone</th>
                                <th>Email</th>
                                <th>Endereço</th>
                                <th class="text-right">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="client-table-body"></tbody>
                    </table>
                </div>
            </section>

            <!-- CATÁLOGO (PRESTADOR) -->
            <section id="view-catalog" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-slate-800">Catálogo de Serviços</h2>
                    <div class="flex gap-2">
                        <button onclick="openShareCatalogModal()" class="bg-[#10B981] text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-[#0E9E6F] transition"><i class="fas fa-share-alt mr-2"></i> Compartilhar Catálogo</button>
                        <button onclick="openCatalogModal()" class="bg-[#1E3A8A] text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-[#3B5BA5] transition"><i class="fas fa-plus mr-2"></i> Novo Serviço</button>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                    <div class="flex gap-4 items-center">
                        <div class="flex-1 relative">
                            <i class="fas fa-search absolute left-3 top-3 text-slate-400"></i>
                            <input id="catalog-search" onkeyup="renderCatalog()" class="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none focus:border-[#1E3A8A]" placeholder="Buscar serviço...">
                        </div>
                        <select id="catalog-category-filter" onchange="renderCatalog()" class="p-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none">
                            <option value="">Todas categorias</option>
                        </select>
                    </div>
                </div>
                <div id="catalog-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </section>

            <!-- RELATÓRIOS (REFATORADO) -->
            <section id="view-reports" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-slate-800">Relatórios</h2>
                    <button onclick="exportToExcel()" class="bg-[#1E3A8A] text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-[#3B5BA5] transition">
                        <i class="fas fa-file-excel mr-2"></i> Exportar Excel
                    </button>
                </div>

                <!-- Cards de resumo -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="stat-card">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-full bg-[#10B981]/10 flex items-center justify-center text-[#10B981]">
                                <i class="fas fa-chart-line text-xl"></i>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500 uppercase">Total aprovado</p>
                                <p class="text-2xl font-bold text-slate-800" id="report-total-approved">R$ 0,00</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-full bg-[#1E3A8A]/10 flex items-center justify-center text-[#1E3A8A]">
                                <i class="fas fa-ticket-alt text-xl"></i>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500 uppercase">Ticket médio</p>
                                <p class="text-2xl font-bold text-slate-800" id="report-average-ticket">R$ 0,00</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-full bg-[#F59E0B]/10 flex items-center justify-center text-[#F59E0B]">
                                <i class="fas fa-file-invoice text-xl"></i>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500 uppercase">Total de orçamentos</p>
                                <p class="text-2xl font-bold text-slate-800" id="report-total-count">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Top clientes e Top itens -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 reports-grid">
                    <div class="stat-card">
                        <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
                            <i class="fas fa-trophy text-[#F59E0B]"></i> Top Clientes
                        </h3>
                        <div id="top-clients-list" class="space-y-1 max-h-96 overflow-y-auto">
                            Carregando...
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
                            <i class="fas fa-crown text-[#F59E0B]"></i> Itens mais vendidos
                        </h3>
                        <div id="top-items-list" class="space-y-1 max-h-96 overflow-y-auto">
                            Carregando...
                        </div>
                    </div>
                </div>
            </section>

            <!-- EDITOR -->
            <section id="view-editor" class="hidden pb-20">
                <div class="flex items-center justify-between mb-6 bg-white p-4 rounded-xl border border-slate-200 shadow-sm sticky top-0 z-10 backdrop-blur-sm bg-white/90">
                    <div class="flex items-center gap-4">
                        <button onclick="switchTab('projects')" class="text-slate-400 hover:text-slate-800"><i class="fas fa-arrow-left"></i></button>
                        <div>
                            <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                                <span id="ed-title">...</span>
                                <span id="ed-ver" class="text-xs bg-slate-100 px-2 py-1 rounded border">V1</span>
                                <span id="ed-status-badge" class="status-badge st-draft ml-2">RASCUNHO</span>
                            </h2>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="saveAsTemplate()" class="bg-[#10B981] text-white px-4 py-2 rounded text-sm font-bold shadow-lg shadow-[#10B981]/20 hover:bg-[#0E9E6F] transition"><i class="fas fa-save mr-2"></i> Salvar como Template</button>
                        <button onclick="openShareModal()" class="bg-[#1E3A8A] text-white px-4 py-2 rounded text-sm font-bold shadow-lg shadow-[#1E3A8A]/20 hover:bg-[#3B5BA5] transition">
                            <i class="fas fa-share-alt mr-2"></i> Enviar Link
                        </button>
                        <div id="ed-actions-header" class="flex gap-2"></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                    <div class="xl:col-span-2 space-y-6">
                        <!-- DADOS DO PRESTADOR -->
                        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                            <div class="collapsible-header flex justify-between items-center" onclick="toggleCollapse(this)">
                                <h3 class="font-bold text-slate-700 flex items-center gap-2"><i class="fas fa-id-card text-[#1E3A8A]"></i> Seus Dados</h3>
                                <i class="fas fa-chevron-down transition-transform"></i>
                            </div>
                            <div class="collapsible-content mt-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <input id="p-name" onchange="upSettings('providerName',this.value)" class="border p-2 rounded text-sm" placeholder="Nome da Sua Empresa">
                                    <input id="p-doc" onchange="upSettings('providerDoc',this.value)" class="border p-2 rounded text-sm" placeholder="CNPJ/CPF">
                                    <input id="p-phone" onchange="upSettings('providerPhone',this.value)" class="border p-2 rounded text-sm" placeholder="Telefone">
                                    <input id="p-addr" onchange="upSettings('providerAddr',this.value)" class="border p-2 rounded text-sm" placeholder="Endereço">
                                </div>
                            </div>
                        </div>

                        <!-- DADOS DO CLIENTE -->
                        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                            <div class="collapsible-header flex justify-between items-center" onclick="toggleCollapse(this)">
                                <h3 class="font-bold text-slate-700 flex items-center gap-2"><i class="fas fa-user-tie text-[#1E3A8A]"></i> Dados do Cliente</h3>
                                <i class="fas fa-chevron-down transition-transform"></i>
                            </div>
                            <div class="collapsible-content mt-4">
                                <div class="flex justify-between items-center mb-4">
                                    <div class="flex gap-2">
                                        <div class="relative w-64">
                                            <input type="text" id="client-search-input" placeholder="Buscar cliente..." class="w-full border p-2 rounded text-sm pr-8" onkeyup="searchClients(event)" autocomplete="off">
                                            <i class="fas fa-search absolute right-3 top-3 text-slate-400"></i>
                                            <div id="client-suggestions" class="autocomplete-suggestions hidden"></div>
                                        </div>
                                        <button onclick="openClientModal(true)" class="text-[#1E3A8A] text-sm font-bold border border-[#1E3A8A]/20 px-3 py-1 rounded hover:bg-blue-50">
                                            <i class="fas fa-plus mr-1"></i> Novo Cliente
                                        </button>
                                        <button onclick="clearSelectedClient()" class="text-red-600 text-sm font-bold border border-red-200 px-3 py-1 rounded hover:bg-red-50" title="Remover cliente">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                <div id="client-fields-container" class="hidden">
                                    <div class="grid grid-cols-2 gap-4">
                                        <input id="c-name" onchange="upVal('c-name',this.value)" class="border p-2 rounded text-sm" placeholder="Nome / Razão Social">
                                        <input id="c-doc" onchange="upVal('c-doc',this.value)" class="border p-2 rounded text-sm" placeholder="CPF/CNPJ">
                                        <input id="c-phone" onchange="upVal('c-phone',this.value)" class="border p-2 rounded text-sm" placeholder="Telefone">
                                        <input id="c-email" onchange="upVal('c-email',this.value)" class="border p-2 rounded text-sm" placeholder="E-mail">
                                        <input id="c-addr" onchange="upVal('c-addr',this.value)" class="col-span-2 border p-2 rounded text-sm" placeholder="Endereço">
                                    </div>
                                </div>
                                <div class="mt-4 pt-4 border-t border-dashed">
                                    <label class="flex items-center gap-2 text-sm text-slate-600 mb-2 cursor-pointer">
                                        <input type="checkbox" id="loc-check" onchange="toggleLoc(this.checked)" class="accent-[#1E3A8A]">
                                        Endereço do serviço é o mesmo do cliente?
                                    </label>
                                    <div id="loc-custom-div">
                                        <label class="text-xs font-bold text-slate-500 mb-1 block">Endereço do Serviço/Obra</label>
                                        <input id="loc-addr" class="w-full border p-2 rounded text-sm" placeholder="Onde será realizado o serviço?" onchange="upLoc(this.value)">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ESCOPO DO SERVIÇO -->
                        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                            <div class="collapsible-header flex justify-between items-center" onclick="toggleCollapse(this)">
                                <h3 class="font-bold text-slate-700 flex items-center gap-2"><i class="fas fa-list-ol text-[#1E3A8A]"></i> Escopo do Serviço</h3>
                                <i class="fas fa-chevron-down transition-transform"></i>
                            </div>
                            <div class="collapsible-content mt-4">
                                <div class="flex justify-between items-center mb-4">
                                    <div class="flex gap-2">
                                        <button id="btn-add-item" onclick="addItem()" class="text-[#1E3A8A] text-sm font-bold border border-[#1E3A8A]/20 px-3 py-1 rounded hover:bg-blue-50">+ Adicionar Item</button>
                                        <button onclick="openCatalogSelector()" class="text-[#10B981] text-sm font-bold border border-[#10B981]/20 px-3 py-1 rounded hover:bg-green-50">
                                            <i class="fas fa-file-import mr-1"></i> Importar do catálogo
                                        </button>
                                    </div>
                                </div>
                                <div id="ed-items" class="space-y-3"></div>
                                <div class="mt-6 pt-4 border-t border-dashed">
                                    <label class="text-xs font-bold text-slate-500 mb-1 block flex items-center gap-1">
                                        <i class="fas fa-truck text-[#1E3A8A]"></i> Prazo de entrega
                                    </label>
                                    <input id="t-deadline" onchange="upVal('t-deadline',this.value)" class="w-full border p-2 rounded text-sm" placeholder="Ex: 30 dias úteis após aprovação">
                                </div>
                                <div class="mt-6 pt-4 border-t border-dashed">
                                    <h4 class="font-bold text-slate-700 mb-3 flex items-center gap-2"><i class="fas fa-paperclip text-[#1E3A8A]"></i> Anexos e Documentos</h4>
                                    <div id="ed-attachments-list" class="mb-3 space-y-3"></div>
                                    <div id="upload-area">
                                        <label for="file-upload" id="upload-label" class="cursor-pointer block w-full text-center border-2 border-dashed border-slate-300 p-4 rounded hover:bg-slate-50 text-xs text-slate-500 font-bold uppercase">
                                            <i class="fas fa-cloud-upload-alt mr-2"></i> Adicionar PDF/IMG
                                        </label>
                                        <input id="file-upload" type="file" class="hidden" accept=".pdf,.png,.jpg,.jpeg" onchange="handleUpload(event)">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div class="bg-slate-900 text-white p-6 rounded-xl shadow-lg text-center">
                            <p class="text-xs font-bold uppercase text-slate-400">Total Global</p>
                            <div id="ed-total" class="text-3xl font-bold">R$ 0,00</div>
                            <div id="ed-total-optional" class="text-xs text-slate-400 mt-1"></div>
                        </div>

                        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                            <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="fas fa-coins text-[#1E3A8A]"></i> Pagamento</h3>
                            <select id="pay-mode" class="w-full border p-2 rounded mb-2 text-sm">
                                <option value="entry_installments">Entrada + Parcelas</option>
                                <option value="no_entry_installments">Parcelas sem entrada</option>
                                <option value="single">À vista</option>
                            </select>
                            <button id="btn-calc-pay" onclick="generatePayment()" class="w-full bg-slate-100 text-slate-600 text-xs font-bold py-2 rounded mb-3 flex items-center justify-center gap-2 hover:bg-slate-200 transition">
                                <i class="fas fa-calculator"></i> Gerar Cronograma
                            </button>
                            <textarea id="t-obs" onchange="upVal('t-obs',this.value)" class="w-full border p-2 rounded text-sm h-20" placeholder="Condições de pagamento..."></textarea>
                            <div class="grid grid-cols-2 gap-2 mt-2">
                                <input id="t-val" onchange="upVal('t-val',this.value)" class="border p-2 rounded text-xs" placeholder="Validade (ex: 10 dias)">
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                            <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="fas fa-code-branch text-[#1E3A8A]"></i> Versões</h3>
                            <div id="ed-actions-area" class="space-y-3"></div>
                        </div>

                        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                            <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="fas fa-history text-[#1E3A8A]"></i> Histórico</h3>
                            <div id="ed-history" class="space-y-4 max-h-80 overflow-y-auto pr-1"></div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- MODAIS -->
    <div id="client-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-[80] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md p-6 rounded-xl">
            <h3 id="client-modal-title" class="text-xl font-bold mb-4 text-slate-800">Novo Cliente</h3>
            <input type="hidden" id="client-id">
            <div class="space-y-3">
                <input id="client-name" class="w-full border p-2 rounded text-sm" placeholder="Nome / Razão Social *">
                <input id="client-doc" class="w-full border p-2 rounded text-sm" placeholder="CPF/CNPJ">
                <input id="client-phone" class="w-full border p-2 rounded text-sm" placeholder="Telefone">
                <input id="client-email" class="w-full border p-2 rounded text-sm" placeholder="E-mail">
                <input id="client-addr" class="w-full border p-2 rounded text-sm" placeholder="Endereço">
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="closeClientModal()" class="flex-1 border py-2 rounded text-slate-600 font-bold hover:bg-slate-50">Cancelar</button>
                <button onclick="saveClient()" class="flex-1 bg-[#1E3A8A] text-white py-2 rounded font-bold hover:bg-[#3B5BA5]">Salvar</button>
            </div>
        </div>
    </div>

    <div id="catalog-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-[80] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md p-6 rounded-xl">
            <h3 id="catalog-modal-title" class="text-xl font-bold mb-4 text-slate-800">Novo Serviço</h3>
            <input type="hidden" id="catalog-id">
            <div class="space-y-3">
                <input id="catalog-name" class="w-full border p-2 rounded text-sm" placeholder="Nome do Serviço *">
                <textarea id="catalog-description" class="w-full border p-2 rounded text-sm" placeholder="Descrição" rows="2"></textarea>
                <input id="catalog-price" type="number" step="0.01" class="w-full border p-2 rounded text-sm" placeholder="Preço (opcional)">
                <input id="catalog-category" class="w-full border p-2 rounded text-sm" placeholder="Categoria (opcional)">
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="closeCatalogModal()" class="flex-1 border py-2 rounded text-slate-600 font-bold hover:bg-slate-50">Cancelar</button>
                <button onclick="saveCatalogItem()" class="flex-1 bg-[#1E3A8A] text-white py-2 rounded font-bold hover:bg-[#3B5BA5]">Salvar</button>
            </div>
        </div>
    </div>

    <div id="catalog-selector-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-[90] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-2xl p-6 rounded-xl max-h-[80vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 text-slate-800">Selecionar serviços do catálogo</h3>
            <div class="mb-4 flex gap-2">
                <input type="text" id="catalog-selector-search" placeholder="Buscar..." class="flex-1 border p-2 rounded text-sm" onkeyup="renderCatalogSelector()">
                <select id="catalog-selector-category" onchange="renderCatalogSelector()" class="p-2 border rounded text-sm">
                    <option value="">Todas categorias</option>
                </select>
            </div>
            <div id="catalog-selector-list" class="space-y-2 max-h-96 overflow-y-auto border rounded p-2"></div>
            <div class="flex gap-2 mt-6">
                <button onclick="closeCatalogSelector()" class="flex-1 border py-2 rounded text-slate-600 font-bold hover:bg-slate-50">Cancelar</button>
                <button onclick="importSelectedCatalogItems()" class="flex-1 bg-[#10B981] text-white py-2 rounded font-bold hover:bg-[#0E9E6F]">Adicionar selecionados</button>
            </div>
        </div>
    </div>

    <div id="share-catalog-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-[90] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md p-6 rounded-xl">
            <h3 class="text-xl font-bold mb-4 text-slate-800">Compartilhar Catálogo</h3>
            <p class="text-sm text-slate-500 mb-4">Compartilhe este link com seus clientes para que eles possam selecionar os serviços desejados.</p>
            <div class="bg-slate-50 p-3 rounded-lg text-sm break-all mb-4 border" id="catalog-share-link">Carregando...</div>
            <div class="flex gap-2">
                <button onclick="copyCatalogLink()" class="flex-1 bg-[#1E3A8A] text-white py-2 rounded font-bold hover:bg-[#3B5BA5]">Copiar Link</button>
                <button onclick="shareCatalogViaWhatsApp()" class="flex-1 bg-[#10B981] text-white py-2 rounded font-bold hover:bg-[#0E9E6F]">WhatsApp</button>
            </div>
            <button onclick="document.getElementById('share-catalog-modal').classList.add('hidden')" class="mt-4 text-sm text-slate-500 underline w-full">Fechar</button>
        </div>
    </div>

    <div id="client-data-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md p-6 rounded-xl">
            <h3 class="text-xl font-bold mb-4 text-slate-800">Para continuar, informe seus dados</h3>
            <div class="space-y-3">
                <input id="public-client-name" class="w-full border p-2 rounded text-sm" placeholder="Nome completo *">
                <input id="public-client-email" type="email" class="w-full border p-2 rounded text-sm" placeholder="E-mail">
                <input id="public-client-phone" class="w-full border p-2 rounded text-sm" placeholder="Telefone">
                <input id="public-client-address" class="w-full border p-2 rounded text-sm" placeholder="Endereço">
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="cancelPublicClientData()" class="flex-1 border py-2 rounded text-slate-600 font-bold hover:bg-slate-50">Cancelar</button>
                <button onclick="savePublicClientData()" class="flex-1 bg-[#10B981] text-white py-2 rounded font-bold hover:bg-[#0E9E6F]">Continuar</button>
            </div>
        </div>
    </div>

    <div id="template-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-[90] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-2xl p-6 rounded-xl max-h-[80vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 text-slate-800">Carregar Template</h3>
            <div id="templates-list" class="space-y-2">
                Carregando...
            </div>
            <div class="flex justify-end mt-6">
                <button onclick="document.getElementById('template-modal').classList.add('hidden')" class="px-4 py-2 border rounded text-slate-600 font-bold">Fechar</button>
            </div>
        </div>
    </div>

    <!-- VIEW PÚBLICA DO CATÁLOGO -->
    <section id="view-public-catalog" class="hidden min-h-screen bg-slate-50 p-6">
        <div class="max-w-4xl mx-auto">
            <div id="public-catalog-loading" class="flex justify-center py-20">
                <div class="loader-spin"></div>
            </div>
            <div id="public-catalog-content" class="hidden">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-8 mb-6">
                    <div class="flex items-center gap-4 mb-6">
                        <img src="logo.png" alt="Logo" class="h-12">
                        <div>
                            <h1 class="text-2xl font-bold text-slate-800">Catálogo de Serviços</h1>
                            <p id="provider-name" class="text-slate-500">Carregando...</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="public-catalog-items"></div>

                    <div class="mt-8 pt-6 border-t border-dashed">
                        <h3 class="font-bold text-slate-700 mb-2">Descreva um serviço personalizado</h3>
                        <textarea id="custom-service-description" rows="3" class="w-full border p-3 rounded-lg text-sm" placeholder="Ex: Gostaria de um serviço que não está listado..."></textarea>
                    </div>

                    <div class="mt-8 flex justify-end">
                        <button onclick="submitPublicCatalogRequest()" class="bg-[#10B981] text-white px-6 py-3 rounded-lg font-bold shadow-sm hover:bg-[#0E9E6F] transition">
                            Solicitar Orçamento
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- VIEW PÚBLICA (PROPOSTA) -->
    <section id="view-public" class="hidden min-h-screen bg-slate-200 p-4 md:py-10 overflow-y-auto print:p-0">
        <div id="public-loading" class="flex justify-center mt-20"><div class="loader-spin"></div></div>
        <div id="public-content" class="hidden max-w-4xl mx-auto bg-white shadow-2xl min-h-[297mm] relative flex flex-col print:shadow-none print:min-h-0">
            <div id="stamp-approved" class="hidden absolute top-10 right-10 border-4 border-[#10B981] text-[#10B981] text-4xl font-extrabold py-2 px-8 rotate-[-12deg] opacity-30 z-20">APROVADO</div>
            <div class="bg-slate-900 text-white p-12 print:bg-white print:text-black print:border-b-2">
                <div id="doc-provider-info"></div>
                <div class="flex justify-between items-start mt-4">
                    <div>
                        <h1 id="doc-title" class="text-3xl font-bold mb-2">Projeto</h1>
                        <p class="text-xs uppercase tracking-widest text-slate-400">Proposta Técnica</p>
                    </div>
                    <div class="text-right">
                        <div id="doc-id" class="font-bold text-lg">#REF</div>
                        <div id="doc-date" class="text-sm opacity-70">--/--/--</div>
                    </div>
                </div>
            </div>
            <div class="p-12 flex-1 print:p-8 overflow-x-auto">
                <div class="flex gap-12 mb-12 text-sm print:flex-row print:gap-12">
                    <div class="flex-1">
                        <h3 class="font-bold text-xs uppercase text-slate-400 mb-2 border-b pb-1">Contratante</h3>
                        <div id="doc-c-name" class="font-bold text-lg text-slate-800"></div>
                        <div id="doc-c-doc" class="text-slate-500"></div>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold text-xs uppercase text-slate-400 mb-2 border-b pb-1">Local</h3>
                        <div id="doc-c-addr" class="text-slate-600"></div>
                    </div>
                </div>

                <div class="mb-12 print-break-inside overflow-x-auto">
                    <h3 class="font-bold text-xs uppercase text-slate-400 mb-4 tracking-wider">Escopo do Serviço</h3>
                    <table class="w-full min-w-[600px]">
                        <thead>
                            <tr class="text-left text-xs uppercase text-slate-400 border-b">
                                <th class="pb-2 pl-4">Item</th>
                                <th class="pb-2 text-center">Qtd</th>
                                <th class="pb-2 text-right">Unit.</th>
                                <th class="pb-2 text-right pr-4">Total</th>
                            </tr>
                        </thead>
                        <tbody id="doc-items-body"></tbody>
                    </table>
                    <div id="doc-deadline-container" class="mt-4 text-sm text-slate-700 font-medium">
                        <span class="font-bold">Prazo de entrega:</span> <span id="doc-deadline"></span>
                    </div>
                </div>

                <div id="doc-attachments-area" class="mb-12 print-break-inside"></div>

                <div class="bg-slate-50 border border-slate-100 rounded-lg p-8 mb-12 flex flex-col md:flex-row gap-12 mt-8 print:bg-white print:border print-break-inside">
                    <div class="flex-1">
                        <h4 class="font-bold text-xs uppercase text-slate-400 mb-2">Pagamento</h4>
                        <div id="doc-payment" class="text-sm font-mono text-slate-700 whitespace-pre-line"></div>
                        <div class="mt-4 flex gap-6 text-sm">
                            <div><span class="font-bold text-xs uppercase text-slate-400 block">Validade</span><span id="doc-validity"></span></div>
                        </div>
                    </div>
                    <div class="text-right">
                        <h4 class="font-bold text-xs uppercase text-slate-400 mb-1">Total</h4>
                        <div id="doc-total" class="text-3xl font-bold text-slate-900">R$ 0,00</div>
                    </div>
                </div>

                <div id="doc-obs" class="text-xs text-slate-500 italic text-justify"></div>
                <div id="doc-signature-area"></div>
                <div id="doc-actions" class="no-print mt-12"></div>
            </div>
            <div class="bg-slate-50 p-4 text-center border-t no-print">
                <button onclick="downloadPDF()" id="btn-download-pdf" class="text-xs font-bold text-slate-400 uppercase hover:text-slate-600">
                    <i class="fas fa-file-pdf"></i> Baixar Comprovante PDF
                </button>
            </div>
        </div>
    </section>

    <section id="view-success" class="hidden min-h-screen bg-white flex flex-col items-center justify-center p-8 text-center">
        <div class="max-w-md w-full">
            <i id="success-icon" class="fas fa-check-circle text-6xl text-[#10B981] mb-6"></i>
            <h2 id="success-title" class="text-3xl font-bold text-slate-900 mb-4">Tudo Certo!</h2>
            <p id="success-desc" class="text-slate-500 text-lg">Sua resposta foi registrada com sucesso.</p>
            <div id="success-actions" class="mt-8"></div>
            <div class="mt-8 text-xs text-slate-400">Pode fechar esta janela.</div>
        </div>
    </section>

    <div id="interaction-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md p-6 rounded-xl">
            <h3 id="modal-title" class="text-xl font-bold mb-2 text-slate-800"></h3>
            <p id="modal-desc" class="text-sm text-slate-500 mb-4"></p>
            <textarea id="modal-input" class="w-full border p-3 rounded mb-4 h-24 text-sm bg-slate-50" placeholder="Digite aqui..."></textarea>
            <div id="modal-sig-area" class="hidden mb-4">
                <canvas id="signature-pad"></canvas>
                <div class="text-right mt-1"><button id="clear-sig" class="text-xs text-red-500 underline">Limpar Assinatura</button></div>
            </div>
            <div class="flex gap-2">
                <button onclick="document.getElementById('interaction-modal').classList.add('hidden')" class="flex-1 border py-3 rounded text-slate-600 font-bold hover:bg-slate-50">Cancelar</button>
                <button id="modal-btn" class="flex-1 bg-slate-900 text-white py-3 rounded font-bold"></button>
            </div>
        </div>
    </div>

    <div id="share-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-[70] flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl w-full max-w-sm text-center">
            <h3 class="text-xl font-bold mb-6 text-slate-800"><i class="fas fa-share-alt mr-2 text-[#1E3A8A]"></i>Enviar Proposta</h3>
            <div class="space-y-3">
                <button id="btn-share-wa" class="w-full py-4 bg-emerald-500 hover:bg-emerald-600 text-white rounded-xl font-bold flex items-center justify-center gap-3 transition-transform hover:scale-[1.02] shadow-lg shadow-emerald-100">
                    <i class="fab fa-whatsapp text-2xl"></i> Enviar no WhatsApp
                </button>
                <button id="btn-share-copy" class="w-full py-4 bg-slate-100 hover:bg-slate-200 text-slate-700 border border-slate-200 rounded-xl font-bold flex items-center justify-center gap-3 transition-colors">
                    <i class="fas fa-link text-lg"></i> Copiar Link
                </button>
            </div>
            <button onclick="document.getElementById('share-modal').classList.add('hidden')" class="mt-6 text-sm text-slate-400 hover:text-slate-600 underline">Cancelar</button>
        </div>
    </div>

    <script>
        // ==================== SUPABASE ====================
        const SUPABASE_URL = 'https://outasfgohiiyndsjciau.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im91dGFzZmdvaGlpeW5kc2pjaWF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4MTk4ODIsImV4cCI6MjA4NTM5NTg4Mn0.4yvGfYbQYf806FJcs34yPGkuU_kVTYHW8mBtbU3JD80';
        const { createClient } = supabase;
        let db = null;

        let state = { 
            user: null, 
            project: null, 
            version: null, 
            projectsCache: [], 
            clientsCache: [],
            catalogCache: [],
            templatesCache: [], // templates do Supabase
            localStorageTemplates: [], // templates do localStorage
            data: null, 
            previousData: null, 
            snapshot: [] 
        };
        let chartInstance = null;
        let chartPeriod = 30;
        let sortableInstance = null;

        // ==================== TOAST ====================
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            if (type === 'error') icon = 'times-circle';
            if (type === 'warning') icon = 'exclamation-triangle';
            toast.innerHTML = `
                <i class="fas fa-${icon} toast-icon"></i>
                <span class="toast-message">${message}</span>
                <i class="fas fa-times toast-close" onclick="this.parentElement.remove()"></i>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }
        window.alert = function(msg) { showToast(msg, 'warning'); };

        // ==================== FUNÇÕES AUXILIARES ====================
        function safeVal(id) { const el = document.getElementById(id); return el ? el.value : ''; }
        function safeText(id, val) { const el = document.getElementById(id); if (el) el.innerText = val || ''; }
        function setHTML(id, val) { const el = document.getElementById(id); if (el) el.innerHTML = val || ''; }
        function setVal(id, val) { const el = document.getElementById(id); if (el) el.value = val || ''; }
        function safeShow(id) { const el = document.getElementById(id); if(el) el.classList.remove('hidden'); }
        function safeHide(id) { const el = document.getElementById(id); if(el) el.classList.add('hidden'); }

        function formatPrice(value) {
            if (value === null || value === undefined || value === '') return '';
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }

        function parsePrice(str) {
            if (!str) return 0;
            let cleaned = str.replace(/[R$\s]/g, '').replace(/\./g, '').replace(',', '.');
            return parseFloat(cleaned) || 0;
        }

        function applyPriceMask(input, index) {
            let value = input.value;
            let digits = value.replace(/\D/g, '');
            if (digits.length === 0) {
                input.value = '';
                state.data.items[index].price = 0;
                updateTotal();
                return;
            }
            let numericValue = parseInt(digits) / 100;
            state.data.items[index].price = numericValue;
            input.value = formatPrice(numericValue);
            updateTotal();
        }

        function toggleCollapse(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('i');
            content.classList.toggle('collapsed');
            icon.classList.toggle('rotate-180');
        }

        function normalizeData(dbData) {
            const schema = { 
                client: { name: '', doc: '', email: '', phone: '', address: '' }, 
                location: { address: '', sameAsClient: true }, 
                items: [], 
                terms: { paymentMode: 'custom', paymentText: '', deadline: '', validity: '', obs: '' },
                settings: { providerName: '', providerDoc: '', providerAddr: '', providerPhone: '' },
                history: [],
                attachments: [],
                signature: null,
                viewedAt: null
            };
            if (!dbData) return JSON.parse(JSON.stringify(schema));
            let rawItems = Array.isArray(dbData.items) ? dbData.items : (dbData.scope || []);
            const cleanItems = rawItems.map(i => ({ 
                id: i.id || 'item_' + Math.random().toString(36).substr(2, 9), 
                name: i.name || '', 
                description: i.description || '', 
                qty: parseFloat(i.qty) || 1, 
                price: parseFloat(i.price) || 0, 
                type: i.type || 'original',
                optional: i.optional || false,
                publicSelected: i.publicSelected || false 
            }));
            let attachments = Array.isArray(dbData.attachments) ? dbData.attachments : [];
            attachments = attachments.map(a => ({
                name: a.name || '',
                url: a.url || '',
                type: a.type || 'file',
                description: a.description || ''
            }));
            return { 
                client: { ...schema.client, ...(dbData.client || {}) }, 
                location: { ...schema.location, ...(dbData.location || {}) }, 
                items: cleanItems, 
                terms: { ...schema.terms, ...(dbData.terms || {}) }, 
                settings: { ...schema.settings, ...(dbData.settings || {}) }, 
                history: Array.isArray(dbData.history) ? dbData.history : [],
                attachments: attachments,
                signature: dbData.signature || null,
                viewedAt: dbData.viewedAt || null
            };
        }

        function logHistory(action, user, detail) {
            if (!state.data) state.data = { history: [] };
            if (!state.data.history) state.data.history = [];
            state.data.history.push({ 
                date: new Date().toISOString(), 
                action: action, 
                user: user, 
                detail: detail || '' 
            });
        }

        function getChanges(oldArr, newArr) {
            let logs = [];
            const oldMap = new Map(oldArr.map(i => [i.id, i]));
            const newMap = new Map(newArr.map(i => [i.id, i]));
            newArr.forEach(i => {
                if(!oldMap.has(i.id)) logs.push(`Adicionou: ${i.name || 'Item sem nome'}`);
                else {
                    const old = oldMap.get(i.id);
                    if(old.name !== i.name) logs.push(`Renomeou: ${old.name || 'Sem nome'} -> ${i.name}`);
                    if(old.price !== i.price || old.qty !== i.qty) logs.push(`Alterou valor/qtd: ${i.name}`);
                }
            });
            oldArr.forEach(i => { if(!newMap.has(i.id)) logs.push(`Removeu: ${i.name}`); });
            return logs.length ? logs.join('; ') : null;
        }

        // ==================== TEMPLATES (com fallback localStorage) ====================
        async function loadTemplates() {
            if (!state.user) return;
            // Tenta carregar do Supabase
            const { data, error } = await db
                .from('templates')
                .select('*')
                .eq('user_id', state.user.id)
                .order('name', { ascending: true });
            if (error) {
                console.warn("Erro ao carregar templates do Supabase, usando localStorage:", error.message);
                // Fallback: localStorage
                const local = localStorage.getItem(`templates_${state.user.id}`);
                state.localStorageTemplates = local ? JSON.parse(local) : [];
                state.templatesCache = []; // não usar supabase
            } else {
                state.templatesCache = data || [];
                state.localStorageTemplates = [];
            }
        }

        async function saveAsTemplate() {
            await save();
            const name = prompt("Nome do template:");
            if (!name) return;
            const templateData = {
                id: 'local_' + Date.now(),
                name,
                user_id: state.user.id,
                data: state.data,
                created_at: new Date().toISOString()
            };

            // Tenta salvar no Supabase
            if (state.templatesCache.length > 0 || !state.localStorageTemplates) {
                const { error } = await db.from('templates').insert(templateData);
                if (error) {
                    // Fallback: localStorage
                    showToast("Erro ao salvar no servidor, salvando localmente.", 'warning');
                    const localKey = `templates_${state.user.id}`;
                    const localList = JSON.parse(localStorage.getItem(localKey) || '[]');
                    localList.push(templateData);
                    localStorage.setItem(localKey, JSON.stringify(localList));
                    state.localStorageTemplates = localList;
                } else {
                    showToast("Template salvo no servidor!", 'success');
                    await loadTemplates();
                }
            } else {
                // Já estava em modo localStorage
                const localKey = `templates_${state.user.id}`;
                const localList = JSON.parse(localStorage.getItem(localKey) || '[]');
                localList.push(templateData);
                localStorage.setItem(localKey, JSON.stringify(localList));
                state.localStorageTemplates = localList;
                showToast("Template salvo localmente!", 'success');
            }
        }

        function openTemplateModal() {
            const modal = document.getElementById('template-modal');
            modal.classList.remove('hidden');
            const listDiv = document.getElementById('templates-list');
            const templates = state.templatesCache.length > 0 ? state.templatesCache : state.localStorageTemplates;
            if (templates.length === 0) {
                listDiv.innerHTML = '<p class="text-center text-slate-500">Nenhum template salvo.</p>';
                return;
            }
            let html = '';
            templates.forEach(t => {
                html += `
                    <div class="flex justify-between items-center border-b pb-2">
                        <span>${t.name}</span>
                        <button onclick="loadTemplate('${t.id}')" class="text-[#1E3A8A] text-sm font-bold">Carregar</button>
                    </div>
                `;
            });
            listDiv.innerHTML = html;
        }

        async function loadTemplate(id) {
            const templates = state.templatesCache.length > 0 ? state.templatesCache : state.localStorageTemplates;
            const template = templates.find(t => t.id === id);
            if (!template) return;
            // Solicita um novo nome para o projeto (evita duplicação de nome)
            const projectName = prompt("Nome do novo orçamento:", template.name + " (cópia)");
            if (!projectName) return;
            const { data: p, error } = await db.from('projects').insert({ 
                name: projectName, 
                user_id: state.user.id, 
                client_name: template.data.client.name || 'Novo Cliente' 
            }).select().single();
            if (error) {
                showToast("Erro ao criar projeto: " + error.message, 'error');
                return;
            }
            const d = JSON.parse(JSON.stringify(template.data));
            d.history.push({ date: new Date().toISOString(), action: 'created', user: 'provider', detail: 'Criado a partir de template.' });
            await db.from('versions').insert({ 
                project_id: p.id, 
                version_number: 1, 
                items: d, 
                total_value: d.items.reduce((a,b)=>a+(b.qty*b.price),0), 
                status: 'draft' 
            });
            document.getElementById('template-modal').classList.add('hidden');
            openProject(p.id);
            showToast('Template carregado!', 'success');
        }

        // ==================== RELATÓRIOS ====================
        async function loadReports() {
            if (!state.user) return;
            await loadProjects(); // recarrega projetos para ter dados atualizados
            const approvedVersions = [];
            let totalApproved = 0;
            let countApproved = 0;
            const clientMap = new Map(); // nome -> total
            const itemMap = new Map(); // nome -> total

            state.projectsCache.forEach(p => {
                const v = p.versions?.[0];
                if (v && v.status === 'approved') {
                    const val = v.total_value || 0;
                    totalApproved += val;
                    countApproved++;
                    approvedVersions.push({
                        projectName: p.name,
                        clientName: p.client_name || 'Sem nome',
                        date: v.approved_at || p.created_at,
                        value: val,
                        items: v.items?.items || []
                    });

                    // Cliente
                    const client = p.client_name || 'Sem nome';
                    clientMap.set(client, (clientMap.get(client) || 0) + val);

                    // Itens
                    if (v.items?.items) {
                        v.items.items.forEach(i => {
                            if (!i.optional || i.publicSelected) {
                                const itemName = i.name;
                                const itemTotal = (i.qty || 0) * (i.price || 0);
                                itemMap.set(itemName, (itemMap.get(itemName) || 0) + itemTotal);
                            }
                        });
                    }
                }
            });

            const average = countApproved > 0 ? totalApproved / countApproved : 0;

            safeText('report-total-approved', formatPrice(totalApproved));
            safeText('report-average-ticket', formatPrice(average));
            safeText('report-total-count', countApproved);

            // Top clientes
            const sortedClients = Array.from(clientMap.entries()).sort((a,b) => b[1] - a[1]).slice(0,10);
            let clientHtml = '';
            if (sortedClients.length === 0) {
                clientHtml = '<p class="text-center text-slate-400 py-4">Nenhum cliente com aprovação.</p>';
            } else {
                const maxValue = sortedClients[0][1];
                sortedClients.forEach(([name, total], index) => {
                    const percent = maxValue > 0 ? (total / maxValue) * 100 : 0;
                    clientHtml += `
                        <div class="client-item">
                            <div class="client-rank">${index+1}</div>
                            <div class="flex-1">
                                <div class="flex justify-between">
                                    <span class="font-medium text-slate-700">${name}</span>
                                    <span class="font-bold text-[#10B981]">${formatPrice(total)}</span>
                                </div>
                                <div class="progress-bar-small mt-1">
                                    <div class="progress-fill-small" style="width: ${percent}%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            document.getElementById('top-clients-list').innerHTML = clientHtml;

            // Top itens
            const sortedItems = Array.from(itemMap.entries()).sort((a,b) => b[1] - a[1]).slice(0,10);
            let itemHtml = '';
            if (sortedItems.length === 0) {
                itemHtml = '<p class="text-center text-slate-400 py-4">Nenhum item vendido.</p>';
            } else {
                const maxValue = sortedItems[0][1];
                sortedItems.forEach(([name, total], index) => {
                    const percent = maxValue > 0 ? (total / maxValue) * 100 : 0;
                    itemHtml += `
                        <div class="client-item">
                            <div class="client-rank">${index+1}</div>
                            <div class="flex-1">
                                <div class="flex justify-between">
                                    <span class="font-medium text-slate-700">${name}</span>
                                    <span class="font-bold text-[#10B981]">${formatPrice(total)}</span>
                                </div>
                                <div class="progress-bar-small mt-1">
                                    <div class="progress-fill-small" style="width: ${percent}%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            document.getElementById('top-items-list').innerHTML = itemHtml;
        }

        // ==================== EXPORTAR EXCEL ====================
        function exportToExcel() {
            // Coletar dados dos orçamentos aprovados
            const data = [];
            // Cabeçalho
            data.push(['Projeto', 'Cliente', 'Data Aprovação', 'Valor (R$)', 'Itens']);

            state.projectsCache.forEach(p => {
                const v = p.versions?.[0];
                if (v && v.status === 'approved') {
                    const itemsStr = v.items?.items?.map(i => `${i.name} (${i.qty}x ${formatPrice(i.price)})`).join('; ') || '';
                    data.push([
                        p.name,
                        p.client_name || 'Sem nome',
                        v.approved_at ? new Date(v.approved_at).toLocaleString('pt-BR') : '',
                        v.total_value || 0,
                        itemsStr
                    ]);
                }
            });

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Orçamentos Aprovados');
            XLSX.writeFile(wb, `relatorio_aprovados_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        // ==================== CLIENTES ====================
        async function loadClients() {
            if (!state.user) return;
            const { data, error } = await db
                .from('clients')
                .select('*')
                .eq('user_id', state.user.id)
                .order('name', { ascending: true });
            if (error) {
                console.error("Erro ao carregar clientes:", error);
                return;
            }
            state.clientsCache = data || [];
        }

        function renderClients() {
            const tbody = document.getElementById('client-table-body');
            if (!tbody) return;
            const search = safeVal('client-search').toLowerCase();
            const filtered = state.clientsCache.filter(c => 
                c.name.toLowerCase().includes(search) || 
                (c.doc && c.doc.toLowerCase().includes(search)) ||
                (c.email && c.email.toLowerCase().includes(search))
            );
            let html = '';
            if (filtered.length === 0) {
                html = '<tr><td colspan="6" class="text-center py-4 text-slate-400">Nenhum cliente encontrado.</td></tr>';
            } else {
                filtered.forEach(c => {
                    html += `<tr>
                        <td class="font-bold">${c.name}</td>
                        <td>${c.doc || '-'}</td>
                        <td>${c.phone || '-'}</td>
                        <td>${c.email || '-'}</td>
                        <td>${c.address || '-'}</td>
                        <td class="text-right">
                            <button onclick="editClient('${c.id}')" class="text-[#1E3A8A] hover:text-[#3B5BA5] mr-2"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteClient('${c.id}')" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                });
            }
            tbody.innerHTML = html;
        }

        function openClientModal(fromEditor = false) {
            document.getElementById('client-modal').classList.remove('hidden');
            document.getElementById('client-modal-title').innerText = 'Novo Cliente';
            document.getElementById('client-id').value = '';
            document.getElementById('client-name').value = '';
            document.getElementById('client-doc').value = '';
            document.getElementById('client-phone').value = '';
            document.getElementById('client-email').value = '';
            document.getElementById('client-addr').value = '';
            window.__clientModalCallback = fromEditor ? (client) => {
                selectClient(client.id);
            } : null;
        }

        function closeClientModal() {
            document.getElementById('client-modal').classList.add('hidden');
            window.__clientModalCallback = null;
        }

        async function saveClient() {
            const id = document.getElementById('client-id').value;
            const name = document.getElementById('client-name').value.trim();
            if (!name) {
                showToast("Nome é obrigatório.", 'error');
                return;
            }
            const clientData = {
                name,
                doc: document.getElementById('client-doc').value,
                phone: document.getElementById('client-phone').value,
                email: document.getElementById('client-email').value,
                address: document.getElementById('client-addr').value,
                user_id: state.user.id
            };
            let savedClient;
            if (id) {
                const { data, error } = await db.from('clients').update(clientData).eq('id', id).select().single();
                if (error) { showToast("Erro ao atualizar: " + error.message, 'error'); return; }
                savedClient = data;
            } else {
                const { data, error } = await db.from('clients').insert(clientData).select().single();
                if (error) { showToast("Erro ao criar: " + error.message, 'error'); return; }
                savedClient = data;
            }
            await loadClients();
            renderClients();
            closeClientModal();
            if (window.__clientModalCallback) {
                window.__clientModalCallback(savedClient);
                window.__clientModalCallback = null;
            }
            showToast('Cliente salvo com sucesso!', 'success');
        }

        async function editClient(id) {
            const client = state.clientsCache.find(c => c.id === id);
            if (!client) return;
            document.getElementById('client-modal').classList.remove('hidden');
            document.getElementById('client-modal-title').innerText = 'Editar Cliente';
            document.getElementById('client-id').value = client.id;
            document.getElementById('client-name').value = client.name;
            document.getElementById('client-doc').value = client.doc || '';
            document.getElementById('client-phone').value = client.phone || '';
            document.getElementById('client-email').value = client.email || '';
            document.getElementById('client-addr').value = client.address || '';
        }

        async function deleteClient(id) {
            if (!confirm("Tem certeza que deseja excluir este cliente?")) return;
            const { error } = await db.from('clients').delete().eq('id', id);
            if (error) {
                showToast("Erro ao excluir: " + error.message, 'error');
                return;
            }
            await loadClients();
            renderClients();
            showToast('Cliente excluído.', 'success');
        }

        function searchClients(event) {
            const input = document.getElementById('client-search-input');
            const query = input.value.toLowerCase();
            const suggestionsDiv = document.getElementById('client-suggestions');
            if (query.length < 2) {
                suggestionsDiv.classList.add('hidden');
                return;
            }
            const results = state.clientsCache.filter(c => 
                c.name.toLowerCase().includes(query)
            ).slice(0, 5);
            if (results.length === 0) {
                suggestionsDiv.classList.add('hidden');
                return;
            }
            let html = '';
            results.forEach(c => {
                html += `<div class="autocomplete-suggestion p-2 cursor-pointer hover:bg-slate-100" onclick="selectClient('${c.id}')">${c.name}</div>`;
            });
            suggestionsDiv.innerHTML = html;
            suggestionsDiv.classList.remove('hidden');
        }

        function selectClient(id) {
            const client = state.clientsCache.find(c => c.id === id);
            if (!client) return;
            setVal('c-name', client.name);
            setVal('c-doc', client.doc || '');
            setVal('c-phone', client.phone || '');
            setVal('c-email', client.email || '');
            setVal('c-addr', client.address || '');
            if (state.data) {
                state.data.client.name = client.name;
                state.data.client.doc = client.doc || '';
                state.data.client.phone = client.phone || '';
                state.data.client.email = client.email || '';
                state.data.client.address = client.address || '';
            }
            document.getElementById('client-fields-container').classList.remove('hidden');
            document.getElementById('client-search-input').value = '';
            document.getElementById('client-suggestions').classList.add('hidden');
        }

        function clearSelectedClient() {
            setVal('c-name', '');
            setVal('c-doc', '');
            setVal('c-phone', '');
            setVal('c-email', '');
            setVal('c-addr', '');
            if (state.data) {
                state.data.client.name = '';
                state.data.client.doc = '';
                state.data.client.phone = '';
                state.data.client.email = '';
                state.data.client.address = '';
            }
            document.getElementById('client-fields-container').classList.add('hidden');
        }

        // ==================== CATÁLOGO ====================
        async function loadCatalog() {
            if (!state.user) return;
            const { data, error } = await db
                .from('service_catalog')
                .select('*')
                .eq('user_id', state.user.id)
                .order('name', { ascending: true });
            if (error) {
                console.error("Erro ao carregar catálogo:", error);
                return;
            }
            state.catalogCache = data || [];
            updateCategoryFilters();
            renderCatalog();
        }

        function updateCategoryFilters() {
            const categories = [...new Set(state.catalogCache.map(item => item.category).filter(c => c))];
            const filterSelect = document.getElementById('catalog-category-filter');
            const selectorFilter = document.getElementById('catalog-selector-category');
            if (filterSelect) {
                filterSelect.innerHTML = '<option value="">Todas categorias</option>' + 
                    categories.map(c => `<option value="${c}">${c}</option>`).join('');
            }
            if (selectorFilter) {
                selectorFilter.innerHTML = '<option value="">Todas categorias</option>' + 
                    categories.map(c => `<option value="${c}">${c}</option>`).join('');
            }
        }

        function renderCatalog() {
            const container = document.getElementById('catalog-cards-container');
            if (!container) return;
            const search = safeVal('catalog-search').toLowerCase();
            const category = safeVal('catalog-category-filter');
            const filtered = state.catalogCache.filter(item => 
                item.name.toLowerCase().includes(search) &&
                (!category || item.category === category)
            );
            let html = '';
            if (filtered.length === 0) {
                html = '<div class="col-span-full text-center py-8 text-slate-400">Nenhum serviço encontrado.</div>';
            } else {
                filtered.forEach(item => {
                    html += `
                        <div class="bg-white border border-slate-200 rounded-xl p-4 hover:border-[#1E3A8A] transition shadow-sm">
                            <div class="flex items-start gap-3">
                                <div class="w-10 h-10 rounded-lg bg-[#1E3A8A]/10 flex items-center justify-center text-[#1E3A8A]"><i class="fas fa-cube"></i></div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-slate-800">${item.name}</h4>
                                    ${item.description ? `<p class="text-xs text-slate-500 mt-1">${item.description}</p>` : ''}
                                    <div class="flex justify-between items-center mt-2">
                                        <span class="text-xs bg-slate-100 px-2 py-0.5 rounded">${item.category || 'Sem categoria'}</span>
                                        <span class="font-bold text-[#10B981]">${item.price ? formatPrice(item.price) : 'Sob consulta'}</span>
                                    </div>
                                    <div class="flex justify-end gap-2 mt-3">
                                        <button onclick="editCatalogItem('${item.id}')" class="text-xs text-[#1E3A8A] hover:underline"><i class="fas fa-edit"></i> Editar</button>
                                        <button onclick="deleteCatalogItem('${item.id}')" class="text-xs text-red-600 hover:underline"><i class="fas fa-trash"></i> Excluir</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            container.innerHTML = html;
        }

        function openCatalogModal(editId = null) {
            const modal = document.getElementById('catalog-modal');
            modal.classList.remove('hidden');
            if (editId) {
                const item = state.catalogCache.find(i => i.id === editId);
                if (item) {
                    document.getElementById('catalog-modal-title').innerText = 'Editar Serviço';
                    document.getElementById('catalog-id').value = item.id;
                    document.getElementById('catalog-name').value = item.name;
                    document.getElementById('catalog-description').value = item.description || '';
                    document.getElementById('catalog-price').value = item.price || '';
                    document.getElementById('catalog-category').value = item.category || '';
                }
            } else {
                document.getElementById('catalog-modal-title').innerText = 'Novo Serviço';
                document.getElementById('catalog-id').value = '';
                document.getElementById('catalog-name').value = '';
                document.getElementById('catalog-description').value = '';
                document.getElementById('catalog-price').value = '';
                document.getElementById('catalog-category').value = '';
            }
        }

        function closeCatalogModal() {
            document.getElementById('catalog-modal').classList.add('hidden');
        }

        async function saveCatalogItem() {
            const id = document.getElementById('catalog-id').value;
            const name = document.getElementById('catalog-name').value.trim();
            if (!name) {
                showToast("Nome é obrigatório.", 'error');
                return;
            }
            const itemData = {
                name,
                description: document.getElementById('catalog-description').value,
                price: document.getElementById('catalog-price').value ? parseFloat(document.getElementById('catalog-price').value) : null,
                category: document.getElementById('catalog-category').value || null,
                user_id: state.user.id
            };
            let savedItem;
            if (id) {
                const { data, error } = await db.from('service_catalog').update(itemData).eq('id', id).select().single();
                if (error) { showToast("Erro ao atualizar: " + error.message, 'error'); return; }
                savedItem = data;
            } else {
                const { data, error } = await db.from('service_catalog').insert(itemData).select().single();
                if (error) { showToast("Erro ao criar: " + error.message, 'error'); return; }
                savedItem = data;
            }
            await loadCatalog();
            renderCatalog();
            closeCatalogModal();
            showToast('Serviço salvo!', 'success');
        }

        async function editCatalogItem(id) {
            openCatalogModal(id);
        }

        async function deleteCatalogItem(id) {
            if (!confirm("Tem certeza que deseja excluir este serviço?")) return;
            const { error } = await db.from('service_catalog').delete().eq('id', id);
            if (error) {
                showToast("Erro ao excluir: " + error.message, 'error');
                return;
            }
            await loadCatalog();
            renderCatalog();
            showToast('Serviço excluído.', 'success');
        }

        let selectedCatalogIds = new Set();

        function openCatalogSelector() {
            if (!state.version || state.version.status !== 'draft') {
                showToast("Orçamento bloqueado. Não é possível adicionar itens.", 'warning');
                return;
            }
            selectedCatalogIds.clear();
            renderCatalogSelector();
            document.getElementById('catalog-selector-modal').classList.remove('hidden');
        }

        function closeCatalogSelector() {
            document.getElementById('catalog-selector-modal').classList.add('hidden');
        }

        function renderCatalogSelector() {
            const listDiv = document.getElementById('catalog-selector-list');
            const search = document.getElementById('catalog-selector-search')?.value.toLowerCase() || '';
            const category = document.getElementById('catalog-selector-category')?.value || '';
            const filtered = state.catalogCache.filter(item => 
                item.name.toLowerCase().includes(search) &&
                (!category || item.category === category)
            );
            let html = '';
            if (filtered.length === 0) {
                html = '<div class="text-center py-4 text-slate-400">Nenhum serviço encontrado.</div>';
            } else {
                filtered.forEach(item => {
                    const checked = selectedCatalogIds.has(item.id) ? 'checked' : '';
                    html += `
                        <div class="catalog-item flex items-center p-2 border-b">
                            <input type="checkbox" id="cat_${item.id}" value="${item.id}" ${checked} onchange="toggleCatalogSelect('${item.id}')" class="mr-3 accent-[#1E3A8A]">
                            <label for="cat_${item.id}" class="flex-1 cursor-pointer">
                                <span class="font-bold">${item.name}</span>
                                ${item.description ? `<span class="text-sm text-slate-500 ml-2">${item.description}</span>` : ''}
                                ${item.price ? `<span class="text-sm font-mono ml-2">${formatPrice(item.price)}</span>` : ''}
                                ${item.category ? `<span class="text-xs bg-slate-100 px-2 py-0.5 rounded ml-2">${item.category}</span>` : ''}
                            </label>
                        </div>
                    `;
                });
            }
            listDiv.innerHTML = html;
        }

        function toggleCatalogSelect(id) {
            if (selectedCatalogIds.has(id)) {
                selectedCatalogIds.delete(id);
            } else {
                selectedCatalogIds.add(id);
            }
        }

        function importSelectedCatalogItems() {
            if (selectedCatalogIds.size === 0) {
                showToast("Nenhum item selecionado.", 'warning');
                return;
            }
            const selectedItems = state.catalogCache.filter(item => selectedCatalogIds.has(item.id));
            selectedItems.forEach(item => {
                state.data.items.push({
                    id: 'item_' + Date.now() + Math.random(),
                    name: item.name,
                    description: item.description || '',
                    qty: 1,
                    price: item.price || 0,
                    type: 'original',
                    optional: false,
                    publicSelected: false
                });
            });
            renderItems();
            updateTotal();
            closeCatalogSelector();
            showToast('Itens adicionados!', 'success');
        }

        function openShareCatalogModal() {
            const link = `${window.location.origin}${window.location.pathname}?view=public-catalog&user=${state.user.id}`;
            document.getElementById('catalog-share-link').innerText = link;
            document.getElementById('share-catalog-modal').classList.remove('hidden');
        }

        function copyCatalogLink() {
            const link = document.getElementById('catalog-share-link').innerText;
            navigator.clipboard.writeText(link).then(() => {
                showToast("Link copiado!", 'success');
            }).catch(() => {
                const textArea = document.createElement("textarea");
                textArea.value = link;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand("copy");
                document.body.removeChild(textArea);
                showToast("Link copiado!", 'success');
            });
        }

        function shareCatalogViaWhatsApp() {
            const link = document.getElementById('catalog-share-link').innerText;
            const msg = `Confira meu catálogo de serviços: ${link}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }

        // ==================== DASHBOARD E PROJETOS ====================
        function getRecentActivities(limit = 10) {
            let activities = [];
            state.projectsCache.forEach(project => {
                const projectName = project.name;
                const version = project.versions?.[0] || null;
                if (version?.items?.history && Array.isArray(version.items.history)) {
                    version.items.history.forEach(h => {
                        if (h.user === 'client' && ['approved', 'change_request', 'canceled'].includes(h.action)) {
                            activities.push({
                                date: h.date,
                                projectId: project.id,
                                projectName: projectName,
                                action: h.action,
                                user: h.user,
                                detail: h.detail
                            });
                        }
                    });
                }
                if (version?.items?.viewedAt) {
                    activities.push({
                        date: version.items.viewedAt,
                        projectId: project.id,
                        projectName: projectName,
                        action: 'viewed',
                        user: 'client',
                        detail: 'Cliente visualizou o orçamento'
                    });
                }
            });
            activities.sort((a, b) => new Date(b.date) - new Date(a.date));
            return activities.slice(0, limit);
        }

        function renderActivityFeed() {
            const feedContainer = document.getElementById('activity-feed');
            if (!feedContainer) return;
            const activities = getRecentActivities(10);
            if (activities.length === 0) {
                feedContainer.innerHTML = '<div class="text-center py-8 text-slate-400 italic">Nenhuma atividade do cliente registrada ainda.</div>';
                return;
            }
            let html = '';
            activities.forEach(act => {
                const date = new Date(act.date);
                const timeAgo = formatTimeAgo(date);
                let icon = '', bgColor = '', textColor = '', actionText = '';
                switch (act.action) {
                    case 'approved':
                        icon = 'fa-check-circle';
                        bgColor = 'bg-green-100';
                        textColor = 'text-[#10B981]';
                        actionText = 'Aprovou';
                        break;
                    case 'change_request':
                        icon = 'fa-comment-dots';
                        bgColor = 'bg-amber-100';
                        textColor = 'text-[#F59E0B]';
                        actionText = 'Solicitou alteração';
                        break;
                    case 'canceled':
                        icon = 'fa-times-circle';
                        bgColor = 'bg-red-100';
                        textColor = 'text-red-600';
                        actionText = 'Cancelou';
                        break;
                    case 'viewed':
                        icon = 'fa-eye';
                        bgColor = 'bg-blue-100';
                        textColor = 'text-[#1E3A8A]';
                        actionText = 'Visualizou';
                        break;
                    default:
                        icon = 'fa-info-circle';
                        bgColor = 'bg-slate-100';
                        textColor = 'text-slate-600';
                        actionText = act.action;
                }
                const userLabel = 'Cliente';
                const detail = act.detail ? ` – ${act.detail}` : '';
                const initials = act.projectName.charAt(0).toUpperCase();
                html += `
                    <div class="activity-item flex gap-3 py-3">
                        <div class="avatar-circle w-8 h-8 bg-[#1E3A8A] text-white text-xs flex items-center justify-center rounded-full">${initials}</div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-sm">${act.projectName}</span>
                                <span class="text-xs px-2 py-0.5 rounded-full ${bgColor} ${textColor}">${actionText}</span>
                            </div>
                            <p class="text-xs text-slate-500 mt-1">${detail}</p>
                            <span class="text-xs text-slate-400">${timeAgo}</span>
                        </div>
                    </div>
                `;
            });
            feedContainer.innerHTML = html;
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffSec = Math.round(diffMs / 1000);
            const diffMin = Math.round(diffSec / 60);
            const diffHour = Math.round(diffMin / 60);
            const diffDay = Math.round(diffHour / 24);
            const diffMonth = Math.round(diffDay / 30);
            if (diffMonth > 0) return `${diffMonth} mês${diffMonth > 1 ? 'es' : ''} atrás`;
            if (diffDay > 0) return `${diffDay} dia${diffDay > 1 ? 's' : ''} atrás`;
            if (diffHour > 0) return `${diffHour} hora${diffHour > 1 ? 's' : ''} atrás`;
            if (diffMin > 0) return `${diffMin} minuto${diffMin > 1 ? 's' : ''} atrás`;
            return 'agora mesmo';
        }

        function showAllActivities() {
            showToast('Em breve: histórico completo.', 'info');
        }

        async function loadProjects() {
            const { data: projects, error } = await db
                .from('projects')
                .select('*, versions(status, total_value, version_number, items)')
                .eq('user_id', state.user.id)
                .order('created_at', { ascending: false });
            if (error) return;
            if (projects) {
                projects.forEach(p => {
                    if (p.versions && p.versions.length > 0) {
                        p.versions.sort((a, b) => b.version_number - a.version_number);
                    }
                });
            }
            state.projectsCache = projects || [];
        }

        function renderDashboardKPIs() {
            let totalRev = 0, totalAprov = 0, countAprov = 0, countNegoc = 0, countOpen = 0, countSent = 0;
            state.projectsCache.forEach(p => {
                const v = p.versions?.[0] || { status: 'draft', total_value: 0 };
                const val = parseFloat(v.total_value) || 0;
                totalRev += val; 
                if(v.status === 'approved') { totalAprov += val; countAprov++; }
                if(v.status === 'negotiating') countNegoc++;
                if(v.status === 'sent') countSent++;
                if(v.status === 'draft') countOpen++;
            });
            safeText('kpi-total-est', formatPrice(totalRev));
            safeText('kpi-total-apr', formatPrice(totalAprov));
            safeText('kpi-count-neg', countNegoc);
            safeText('kpi-count-apr', countAprov);
            safeText('kpi-count-open', countOpen);
            safeText('kpi-count-sent', countSent);
        }

        function setChartPeriod(days) {
            chartPeriod = days;
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('bg-[#1E3A8A]', 'text-white');
                btn.classList.add('bg-slate-100', 'text-slate-700');
            });
            const activeBtn = document.querySelector(`.period-btn[data-period="${days}"]`);
            if (activeBtn) {
                activeBtn.classList.remove('bg-slate-100', 'text-slate-700');
                activeBtn.classList.add('bg-[#1E3A8A]', 'text-white');
            }
            renderDashboardCharts();
        }

        function renderDashboardCharts() {
            const ctx = document.getElementById('dashboardChart');
            if (!ctx) return;
            if (chartInstance) chartInstance.destroy();

            const days = {};
            for (let i = chartPeriod - 1; i >= 0; i--) { 
                const d = new Date(); 
                d.setDate(d.getDate() - i); 
                const key = d.toLocaleDateString('pt-BR').slice(0,5);
                days[key] = { count: 0, total: 0 };
            }

            state.projectsCache.forEach(p => {
                const v = p.versions?.[0] || { total_value: 0 };
                const created = new Date(p.created_at);
                const today = new Date();
                const diffTime = today - created;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                if (diffDays <= chartPeriod) {
                    const key = created.toLocaleDateString('pt-BR').slice(0,5);
                    if (days[key]) {
                        days[key].count += 1;
                        days[key].total += parseFloat(v.total_value) || 0;
                    }
                }
            });

            const labels = Object.keys(days);
            const countData = Object.values(days).map(d => d.count);
            const totalData = Object.values(days).map(d => d.total);

            const isMobile = window.innerWidth < 768;

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Orçamentos',
                            data: countData,
                            backgroundColor: 'rgba(30,58,138,0.6)',
                            borderColor: '#1E3A8A',
                            borderWidth: 1,
                            yAxisID: 'y',
                            order: 2
                        },
                        {
                            label: 'Valor total (R$)',
                            data: totalData,
                            type: 'line',
                            backgroundColor: 'rgba(16,185,129,0.1)',
                            borderColor: '#10B981',
                            borderWidth: 2,
                            pointBackgroundColor: '#10B981',
                            pointBorderColor: 'white',
                            pointBorderWidth: 1,
                            pointRadius: isMobile ? 2 : 3,
                            pointHoverRadius: isMobile ? 4 : 5,
                            yAxisID: 'y1',
                            order: 1,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.dataset.label === 'Valor total (R$)') {
                                        label += formatPrice(context.raw);
                                    } else {
                                        label += context.raw;
                                    }
                                    return label;
                                }
                            }
                        },
                        legend: { display: true, position: 'top' }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { maxTicksLimit: isMobile ? 5 : undefined } },
                        y1: { beginAtZero: true, position: 'right', grid: { drawOnChartArea: false }, ticks: { callback: value => 'R$ ' + (value/1000).toFixed(0) + 'k' } }
                    }
                }
            });
        }

        function renderProjectCards() {
            const container = document.getElementById('project-cards-container');
            if (!container) return;
            const search = safeVal('project-search').toLowerCase();
            const filterStatus = safeVal('project-status-filter') || 'all';
            const filtered = state.projectsCache.filter(p => {
                const v = p.versions?.[0] || { status: 'draft', total_value: 0 };
                const matchSearch = p.name.toLowerCase().includes(search) || (p.client_name||'').toLowerCase().includes(search);
                const matchStatus = filterStatus === 'all' || v.status === filterStatus;
                return matchSearch && matchStatus;
            });
            let html = '';
            if (filtered.length === 0) {
                html = '<div class="col-span-full text-center py-20 text-slate-400 border-2 border-dashed border-slate-200 rounded-xl">Nenhum orçamento encontrado.</div>';
            } else {
                filtered.forEach(p => {
                    const v = p.versions?.[0] || { total_value: 0, status: 'draft', version_number: 1 };
                    const val = parseFloat(v.total_value) || 0;
                    let badgeClass = 'st-draft'; let statusLabel = 'Rascunho';
                    let progressClass = 'draft';
                    if (v.status === 'sent') { badgeClass = 'st-sent'; statusLabel = 'Aguardando resposta'; progressClass = 'sent'; }
                    if (v.status === 'negotiating') { badgeClass = 'st-negotiating'; statusLabel = 'Em Negociação'; progressClass = 'negotiating'; }
                    if (v.status === 'approved') { badgeClass = 'st-approved'; statusLabel = 'Aprovado'; progressClass = 'approved'; }
                    if (v.status === 'canceled') { badgeClass = 'st-canceled'; statusLabel = 'Cancelado'; progressClass = 'canceled'; }
                    const initials = (p.client_name || 'NC').charAt(0).toUpperCase();
                    html += `<div onclick="openProject('${p.id}')" class="project-card group">
                        <div class="flex items-start gap-3">
                            <div class="avatar-circle w-10 h-10 bg-[#1E3A8A] text-white text-sm flex items-center justify-center rounded-full">${initials}</div>
                            <div class="flex-1">
                                <div class="flex justify-between">
                                    <h3 class="font-bold text-slate-800 group-hover:text-[#1E3A8A] transition truncate">${p.name}</h3>
                                    <span class="status-badge ${badgeClass} ml-2">${statusLabel}</span>
                                </div>
                                <p class="text-xs text-slate-500 mt-1 truncate">${p.client_name || 'Novo Cliente'}</p>
                                <div class="progress-bar mt-2">
                                    <div class="progress-fill ${progressClass}"></div>
                                </div>
                                <div class="flex justify-between items-center mt-3">
                                    <span class="text-xs text-slate-400">V${v.version_number} • ${new Date(p.created_at).toLocaleDateString()}</span>
                                    <span class="font-bold text-lg text-slate-900">${formatPrice(val)}</span>
                                </div>
                                <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition flex gap-1">
                                    <button onclick="deleteProject('${p.id}', event)" class="p-2 text-slate-400 hover:text-red-500" title="Excluir"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                });
            }
            container.innerHTML = html;
        }

        async function deleteProject(id, event) {
            event.stopPropagation(); 
            if(!confirm("Tem certeza que deseja EXCLUIR este orçamento permanentemente?")) return;
            const { error } = await db.from('projects').delete().eq('id', id);
            if(error) showToast("Erro ao excluir: " + error.message, 'error');
            else { 
                state.projectsCache = state.projectsCache.filter(p => p.id !== id); 
                renderDashboardKPIs();
                renderDashboardCharts();
                renderProjectCards();
                renderClients();
                renderActivityFeed();
                showToast('Orçamento excluído.', 'success');
            }
        }

        function openProject(id) {
            window.history.pushState(null, '', `?view=editor&id=${id}`);
            loadEditor(id).then(() => switchTab('editor', false));
        }

        async function createProject() {
            const name = prompt("Nome do Orçamento:"); 
            if(!name) return;
            const { data: p, error } = await db.from('projects').insert({ 
                name, 
                user_id: state.user.id, 
                client_name: 'Novo Cliente' 
            }).select().single();
            const d = normalizeData(null); 
            d.settings.providerName = localStorage.getItem('prov_name') || '';
            d.settings.providerDoc = localStorage.getItem('prov_doc') || '';
            d.settings.providerAddr = localStorage.getItem('prov_addr') || '';
            d.settings.providerPhone = localStorage.getItem('prov_phone') || '';
            d.history.push({ date: new Date().toISOString(), action: 'created', user: 'provider', detail: 'Orçamento criado via painel.' });
            await db.from('versions').insert({ 
                project_id: p.id, 
                version_number: 1, 
                items: d, 
                total_value: 0, 
                status: 'draft' 
            });
            openProject(p.id);
            showToast('Orçamento criado!', 'success');
        }

        // ==================== EDITOR ====================
        async function loadEditor(id) {
            const { data: proj } = await db.from('projects').select('*').eq('id', id).single();
            state.project = proj;
            const { data: vers } = await db.from('versions').select('*').eq('project_id', id).order('version_number', { ascending: true });
            state.version = vers[vers.length - 1];
            state.data = normalizeData(state.version.items);
            state.snapshot = JSON.parse(JSON.stringify(state.data.items));
            state.previousData = null;
            if (state.version.version_number > 1 && vers[vers.length - 2]) {
                state.previousData = normalizeData(vers[vers.length - 2].items);
            }
            renderEditor();
            if (state.data.client.name) {
                document.getElementById('client-fields-container').classList.remove('hidden');
            } else {
                document.getElementById('client-fields-container').classList.add('hidden');
            }
            setTimeout(() => {
                if (sortableInstance) sortableInstance.destroy();
                const itemsContainer = document.getElementById('ed-items');
                if (itemsContainer && state.version.status === 'draft') {
                    sortableInstance = new Sortable(itemsContainer, {
                        animation: 150,
                        handle: '.item-box',
                        onEnd: function(evt) {
                            const movedItem = state.data.items.splice(evt.oldIndex, 1)[0];
                            state.data.items.splice(evt.newIndex, 0, movedItem);
                            renderItems();
                        }
                    });
                }
            }, 100);
        }

        function renderEditor() {
            const d = state.data; 
            const isLocked = state.version.status !== 'draft';
            safeText('ed-title', state.project.name);
            safeText('ed-ver', `V${state.version.version_number}`);
            const badge = document.getElementById('ed-status-badge');
            if(badge) {
                badge.className = `status-badge ml-2 ${
                    state.version.status === 'approved' ? 'st-approved' : 
                    state.version.status === 'canceled' ? 'st-canceled' : 
                    state.version.status === 'negotiating' ? 'st-negotiating' : 
                    state.version.status === 'sent' ? 'st-sent' : 
                    'st-draft'
                }`;
                badge.innerText = 
                    state.version.status === 'draft' ? 'RASCUNHO' : 
                    state.version.status === 'sent' ? 'AGUARDANDO RESPOSTA' : 
                    state.version.status.toUpperCase();
            }
            setVal('p-name', d.settings.providerName);
            setVal('p-doc', d.settings.providerDoc);
            setVal('p-addr', d.settings.providerAddr);
            setVal('p-phone', d.settings.providerPhone);
            setVal('c-name', d.client.name);
            setVal('c-doc', d.client.doc);
            setVal('c-phone', d.client.phone);
            setVal('c-email', d.client.email);
            setVal('c-addr', d.client.address);
            setVal('t-deadline', d.terms.deadline); 
            setVal('t-val', d.terms.validity); 
            setVal('t-obs', d.terms.paymentText || d.terms.obs);
            const locCheck = document.getElementById('loc-check');
            if(locCheck) locCheck.checked = d.location.sameAsClient;
            const locDiv = document.getElementById('loc-custom-div');
            if(locDiv) locDiv.style.display = d.location.sameAsClient ? 'none' : 'block';
            setVal('loc-addr', d.location.address);
            
            const staticInputs = [
                'p-name','p-doc','p-addr','p-phone',
                'c-name','c-doc','c-phone','c-email','c-addr',
                'client-search-input',
                'loc-check','loc-addr',
                't-deadline','t-val','t-obs','pay-mode'
            ];
            staticInputs.forEach(id => { 
                const el = document.getElementById(id); 
                if(el) el.disabled = isLocked; 
            });
            
            const btnAdd = document.getElementById('btn-add-item');
            if(btnAdd) {
                btnAdd.disabled = isLocked;
                btnAdd.style.opacity = isLocked ? '0.5' : '1';
                btnAdd.style.pointerEvents = isLocked ? 'none' : 'auto';
            }
            const btnImport = document.querySelector('button[onclick="openCatalogSelector()"]');
            if(btnImport) {
                btnImport.disabled = isLocked;
                btnImport.style.opacity = isLocked ? '0.5' : '1';
                btnImport.style.pointerEvents = isLocked ? 'none' : 'auto';
            }
            const btnCalc = document.getElementById('btn-calc-pay');
            if(btnCalc) {
                btnCalc.disabled = isLocked;
                btnCalc.style.opacity = isLocked ? '0.5' : '1';
                btnCalc.style.pointerEvents = isLocked ? 'none' : 'auto';
            }
            const btnNewClient = document.querySelector('button[onclick="openClientModal(true)"]');
            if(btnNewClient) btnNewClient.disabled = isLocked;
            const btnClearClient = document.querySelector('button[onclick="clearSelectedClient()"]');
            if(btnClearClient) btnClearClient.disabled = isLocked;
            
            const uploadArea = document.getElementById('upload-area');
            if(uploadArea) uploadArea.style.display = isLocked ? 'none' : 'block';
            
            const headerActions = document.getElementById('ed-actions-header');
            if (headerActions) {
                if (isLocked) {
                    headerActions.innerHTML = `<button onclick="createAddon()" class="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded text-sm font-bold shadow"><i class="fas fa-copy mr-2"></i> Criar Revisão (V${state.version.version_number + 1})</button>`;
                } else {
                    headerActions.innerHTML = `<button onclick="save()" class="bg-slate-800 text-white px-4 py-2 rounded text-sm font-bold hover:bg-slate-700"><i class="fas fa-save mr-2"></i> Salvar</button>`;
                }
            }
            const area = document.getElementById('ed-actions-area');
            if (area) {
                if (isLocked) {
                    area.innerHTML = `<button onclick="createAddon()" class="w-full py-3 bg-amber-500 hover:bg-amber-600 text-white font-bold rounded-lg shadow"><i class="fas fa-copy mr-2"></i> Criar Revisão (V${state.version.version_number + 1})</button>`;
                } else {
                    area.innerHTML = `<button onclick="changeStatus('canceled')" class="w-full py-2 border border-red-200 text-red-500 hover:bg-red-50 rounded-lg text-sm font-bold">Cancelar Orçamento</button>`;
                }
            }
            renderItems();
            renderAttachments();
            renderHistory();
            updateTotal();
        }

        function renderItems() {
            const isLocked = state.version.status !== 'draft';
            const d = state.data;
            let html = ''; 
            let total = 0, totalOpt = 0;
            d.items.forEach((i, x) => {
                const t = (i.qty||0)*(i.price||0); 
                if(!i.optional) total += t;
                else totalOpt += t;
                let diffHtml = '';
                let cardClass = i.optional ? 'item-optional' : '';
                if (state.previousData) {
                    const oldItem = state.previousData.items.find(old => old.id === i.id);
                    if (!oldItem) {
                        cardClass += ' item-new';
                        diffHtml = `<div class="diff-box"><span class="diff-tag">NOVO</span> Este item foi adicionado.</div>`;
                    } else {
                        let changes = [];
                        if (oldItem.price !== i.price) changes.push(`Preço: <span class="old-val">${formatPrice(oldItem.price)}</span> <i class="fas fa-arrow-right text-xs"></i> <span class="new-val">${formatPrice(i.price)}</span>`);
                        if (oldItem.qty !== i.qty) changes.push(`Qtd: <span class="old-val">${oldItem.qty}</span> <i class="fas fa-arrow-right text-xs"></i> <span class="new-val">${i.qty}</span>`);
                        if (changes.length > 0) {
                            cardClass += ' item-modified';
                            diffHtml = `<div class="diff-box"><span class="diff-tag">ALTERADO</span> <span>${changes.join(' &bull; ')}</span></div>`;
                        }
                    }
                }
                html += `
                <div class="item-box ${cardClass} group" data-id="${i.id}">
                    ${!isLocked ? `<button onclick="rmItem(${x})" class="absolute top-2 right-2 text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100"><i class="fas fa-trash"></i></button>` : ''}
                    <div class="grid grid-cols-12 gap-4 mb-2">
                        <div class="col-span-8">
                            <label class="text-[10px] font-bold text-gray-400 uppercase flex items-center">
                                Item 
                                ${i.optional ? '<span class="optional-badge ml-2">Opcional</span>' : ''}
                            </label>
                            <input class="w-full font-bold bg-transparent outline-none border-b border-transparent focus:border-blue-200" placeholder="Nome do Item..." value="${i.name}" oninput="upItem(${x},'name',this.value)" ${isLocked?'disabled':''}>
                        </div>
                        <div class="col-span-2">
                            <label class="text-[10px] font-bold text-gray-400 uppercase text-center block">Qtd</label>
                            <input type="number" class="w-full bg-slate-50 border rounded text-center text-xs p-1" value="${i.qty}" onchange="upItem(${x},'qty',this.value)" ${isLocked?'disabled':''}>
                        </div>
                        <div class="col-span-2">
                            <label class="text-[10px] font-bold text-gray-400 uppercase text-right block">R$</label>
                            <input type="text" class="w-full bg-slate-50 border rounded text-right text-xs p-1 price-input" value="${formatPrice(i.price)}" oninput="applyPriceMask(this, ${x})" data-index="${x}" ${isLocked?'disabled':''}>
                        </div>
                    </div>
                    <textarea class="w-full bg-transparent text-xs text-slate-500 resize-none outline-none border-t border-dashed pt-2 mt-2" rows="2" placeholder="Descrição técnica..." oninput="upItem(${x},'description',this.value)" ${isLocked?'disabled':''}>${i.description||''}</textarea>
                    ${!isLocked ? `
                        <button onclick="toggleOpt(${x})" class="text-[10px] mt-2 px-2 py-1 rounded border ${i.optional ? 'bg-slate-600 text-white border-slate-600' : 'text-slate-400 border-slate-200 hover:border-slate-400'}">
                            ${i.optional ? 'ITEM OPCIONAL' : 'Marcar como Opcional?'}
                        </button>
                    ` : ''}
                    ${diffHtml}
                </div>`;
            });
            setHTML('ed-items', html);
            updateTotal();
        }

        function upItem(i,f,v) { 
            const it = state.data.items[i]; 
            if(f === 'qty') { 
                it[f] = parseFloat(v) || 0; 
                updateTotal(); 
            } else { 
                it[f] = v; 
            }
        }
        function toggleOpt(i) { 
            state.data.items[i].optional = !state.data.items[i].optional; 
            renderItems(); 
            updateTotal(); 
        }
        function addItem() { 
            if(!Array.isArray(state.data.items)) state.data.items = [];
            state.data.items.push({ 
                id: 'item_' + Date.now() + Math.random(), 
                name: '', 
                description: '', 
                qty: 1, 
                price: 0, 
                type: state.version?.version_number > 1 ? 'addon' : 'original', 
                optional: false 
            }); 
            renderItems(); 
            showToast('Item adicionado.', 'success');
        }
        function rmItem(i) { 
            if(confirm("Remover este item?")) { 
                state.data.items.splice(i, 1); 
                renderItems(); 
                updateTotal(); 
                showToast('Item removido.', 'success');
            } 
        }
        function updateTotal() { 
            const total = state.data.items.reduce((a,b)=> !b.optional ? a + (b.qty*b.price) : a, 0);
            document.getElementById('ed-total').innerText = formatPrice(total);
            const totalOpt = state.data.items.reduce((a,b)=> b.optional ? a + (b.qty*b.price) : a, 0);
            const optDiv = document.getElementById('ed-total-optional');
            if (optDiv) {
                optDiv.innerText = totalOpt > 0 ? `+ ${formatPrice(totalOpt)} em opcionais` : '';
            }
        }

        function upVal(k,v) { 
            if (k.startsWith('c-')) {
                if (k === 'c-addr') {
                    state.data.client.address = v;
                } else {
                    state.data.client[k.substring(2)] = v;
                }
            } else if (k.startsWith('t-')) {
                if (k === 't-obs') {
                    state.data.terms.paymentText = v;
                } else if (k === 't-val') {
                    state.data.terms.validity = v;
                } else {
                    state.data.terms[k.substring(2)] = v;
                }
            }
        }
        function upSettings(k,v) { 
            state.data.settings[k] = v; 
            if(['providerName','providerDoc','providerAddr','providerPhone'].includes(k)) {
                localStorage.setItem(k.replace('provider','prov_').toLowerCase(), v);
            }
        }
        function toggleLoc(checked) { 
            state.data.location.sameAsClient = checked; 
            const locDiv = document.getElementById('loc-custom-div');
            if(locDiv) locDiv.style.display = checked ? 'none' : 'block';
        }
        function upLoc(v) { state.data.location.address = v; }

        function generatePayment() {
            const total = state.data.items.reduce((acc, i) => (!i.optional ? acc + (i.qty * i.price) : acc), 0);
            if(total === 0) return showToast("Adicione valores (não opcionais) primeiro.", 'warning');
            const mode = document.getElementById('pay-mode').value;
            let text = "";
            if(mode === 'entry_installments') {
                const entryP = prompt("Porcentagem de Entrada? (Ex: 30)", "30");
                const inst = prompt("Restante em quantas vezes?", "2");
                if(!entryP || !inst) return;
                const entryVal = total * (parseInt(entryP)/100);
                const restVal = (total - entryVal) / parseInt(inst);
                text = `CRONOGRAMA:\n1. Entrada: ${formatPrice(entryVal)}\n`;
                for(let i=1; i<=parseInt(inst); i++) text += `${i+1}. Parcela (30d): ${formatPrice(restVal)}\n`;
            } 
            else if(mode === 'no_entry_installments') {
                const inst = prompt("Número de parcelas?", "3");
                if(!inst) return;
                const parcelValue = total / parseInt(inst);
                text = `PAGAMENTO PARCELADO SEM ENTRADA:\n`;
                for(let i=1; i<=parseInt(inst); i++) text += `${i}. Parcela (30d): ${formatPrice(parcelValue)}\n`;
            }
            else {
                text = `Pagamento Único: ${formatPrice(total)}`;
            }
            state.data.terms.paymentText = text;
            setVal('t-obs', text);
            showToast('Cronograma gerado!', 'success');
        }

        async function handleUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            if (file.size > 5 * 1024 * 1024) return showToast("Arquivo muito grande! Máximo 5MB.", 'error');
            const ext = file.name.split('.').pop().toLowerCase();
            if(!['pdf','png','jpg','jpeg'].includes(ext)) return showToast("Formato não permitido. Use PDF, PNG ou JPG.", 'error');
            const label = document.getElementById('upload-label');
            const originalText = label.innerHTML;
            label.innerText = "Enviando...";
            try {
                const path = `${state.project.id}/${Date.now()}_${file.name}`;
                const { error } = await db.storage.from('attachments').upload(path, file);
                if (error) throw error;
                const { data: pubData } = db.storage.from('attachments').getPublicUrl(path);
                if (!state.data.attachments) state.data.attachments = [];
                state.data.attachments.push({ 
                    name: file.name, 
                    url: pubData.publicUrl, 
                    type: ext,
                    description: '' 
                });
                await save();
                renderAttachments();
                showToast('Arquivo enviado!', 'success');
            } catch (err) {
                showToast("Erro no upload: " + err.message, 'error');
            } finally {
                label.innerHTML = originalText;
                e.target.value = '';
            }
        }
        function deleteAttachment(idx) {
            if(!confirm("Remover este anexo?")) return;
            state.data.attachments.splice(idx, 1);
            save().then(() => renderAttachments());
            showToast('Anexo removido.', 'success');
        }
        function updateAttachmentDescription(idx, desc) {
            state.data.attachments[idx].description = desc;
            clearTimeout(window.descTimeout);
            window.descTimeout = setTimeout(() => save(), 800);
        }
        function renderAttachments() {
            const attachList = document.getElementById('ed-attachments-list');
            if (!attachList) return;
            const isLocked = state.version.status !== 'draft';
            let attHtml = '';
            if (state.data.attachments && state.data.attachments.length > 0) {
                state.data.attachments.forEach((att, idx) => {
                    let icon = att.type === 'pdf' ? 'fa-file-pdf text-red-500' : 'fa-file-image text-blue-500';
                    let preview = att.type !== 'pdf' ? `<img src="${att.url}" class="h-10 w-10 object-cover rounded mr-2">` : '';
                    attHtml += `<div class="flex flex-col bg-white border p-3 rounded mb-2 text-sm">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2 overflow-hidden">
                                ${preview || `<i class="fas ${icon}"></i>`}
                                <span class="truncate font-medium">${att.name}</span>
                            </div>
                            <div class="flex gap-2">
                                <a href="${att.url}" target="_blank" class="text-blue-500 hover:text-blue-700"><i class="fas fa-eye"></i></a>
                                ${!isLocked ? `<button onclick="deleteAttachment(${idx})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>` : ''}
                            </div>
                        </div>
                        <div class="mt-2">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Descrição</label>
                            ${!isLocked 
                                ? `<input type="text" class="w-full border-0 border-b border-slate-200 bg-transparent text-xs p-1 focus:border-[#1E3A8A]" 
                                    value="${att.description || ''}" 
                                    placeholder="Ex: Nota fiscal, memorial fotográfico..."
                                    onchange="updateAttachmentDescription(${idx}, this.value);">`
                                : `<p class="text-xs text-slate-600 mt-1">${att.description || '—'}</p>`
                            }
                        </div>
                    </div>`;
                });
            } else {
                attHtml = '<div class="text-xs text-slate-400 italic text-center py-2">Nenhum arquivo anexado.</div>';
            }
            attachList.innerHTML = attHtml;
        }

        async function save() {
            const t = state.data.items.reduce((a,b)=> (!b.optional ? a+(b.qty*b.price) : a),0);
            const changes = getChanges(state.snapshot, state.data.items);
            if(changes) {
                logHistory('edited', 'provider', changes);
                state.snapshot = JSON.parse(JSON.stringify(state.data.items)); 
            }
            if(state.data.client.name) {
                await db.from('projects').update({client_name: state.data.client.name}).eq('id', state.project.id);
            }
            await db.from('versions').update({
                items: state.data, 
                total_value: t, 
                notes: state.data.terms.obs || state.data.terms.paymentText
            }).eq('id', state.version.id);
            renderHistory();
            showToast('Alterações salvas!', 'success');
        }

        async function createAddon() {
            await save();
            if(!confirm("Criar nova versão (Aditivo)?")) return;
            const t = state.data.items.reduce((a,b)=> (!b.optional ? a+(b.qty*b.price) : a),0);
            logHistory('created', 'provider', `Criou nova versão V${state.version.version_number+1}.`);
            await db.from('versions').insert({
                project_id: state.project.id,
                version_number: state.version.version_number + 1,
                items: state.data,
                total_value: t,
                status: 'draft'
            });
            loadEditor(state.project.id);
            showToast('Nova versão criada!', 'success');
        }

        async function changeStatus(newStatus, skipConfirm = false) {
            if (!skipConfirm && !confirm(`Mudar status para ${newStatus}?`)) return;
            await db.from('versions').update({status: newStatus}).eq('id', state.version.id);
            logHistory(newStatus, 'provider', skipConfirm ? 'Status alterado automaticamente (envio de link)' : 'Alteração manual de status.');
            await loadProjects();
            renderDashboardKPIs();
            renderDashboardCharts();
            renderProjectCards();
            renderActivityFeed();
            loadEditor(state.project.id);
            showToast(`Status alterado para ${newStatus}.`, 'success');
        }

        async function openShareModal() {
            await save();
            if (state.version.status === 'draft') {
                await changeStatus('sent', true);
            }
            if (!state.version?.id) return showToast("Erro ao salvar versão.", 'error');
            const url = `${window.location.origin}${window.location.pathname}?view=public&id=${state.version.id}`;
            const clientName = state.data.client.name ? ` ${state.data.client.name}` : '';
            const msg = `Olá${clientName}! Segue o link da proposta comercial para sua aprovação: ${url}`;
            document.getElementById('btn-share-wa').onclick = function() {
                let phone = (state.data.client.phone || '').replace(/\D/g, '');
                let link = `https://wa.me/${phone.length >= 10 ? '55' + phone : ''}?text=${encodeURIComponent(msg)}`;
                window.open(link, '_blank');
                document.getElementById('share-modal').classList.add('hidden');
            };
            document.getElementById('btn-share-copy').onclick = async function() {
                try {
                    await navigator.clipboard.writeText(url);
                    showToast("✅ Link copiado!", 'success');
                } catch (err) {
                    const textArea = document.createElement("textarea");
                    textArea.value = url;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand("copy");
                    document.body.removeChild(textArea);
                    showToast("✅ Link copiado!", 'success');
                }
                document.getElementById('share-modal').classList.add('hidden');
            };
            safeShow('share-modal');
        }

        function renderHistory() {
            const hist = state.data.history || [];
            let histHtml = '';
            if(hist.length > 0) {
                hist.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(h => {
                    const date = new Date(h.date).toLocaleString('pt-BR');
                    let icon = 'info-circle';
                    let actionLabel = 'Visualizou';
                    if (h.action === 'approved') { icon = 'check-circle text-[#10B981]'; actionLabel = 'Aprovou'; }
                    else if (h.action === 'change_request') { icon = 'comment-dots text-[#F59E0B]'; actionLabel = 'Solicitou alteração'; }
                    else if (h.action === 'canceled') { icon = 'times-circle text-red-500'; actionLabel = 'Recusou/Cancelou'; }
                    else if (h.action === 'created') { icon = 'plus-circle text-[#1E3A8A]'; actionLabel = 'Criou o orçamento'; }
                    else if (h.action === 'edited') { icon = 'pen text-indigo-500'; actionLabel = 'Alterou o escopo'; }
                    else if (h.action === 'sent') { icon = 'paper-plane text-[#1E3A8A]'; actionLabel = 'Enviou link'; }
                    histHtml += `<div class="timeline-item">
                        <div class="text-xs text-slate-400">${date} • ${h.user === 'provider' ? 'Você' : 'Cliente'}</div>
                        <div class="font-bold text-sm text-slate-700 flex items-center gap-2 mt-1">
                            <i class="fas fa-${icon}"></i> ${actionLabel}
                        </div>
                        ${h.detail ? `<div class="timeline-desc ${h.action.includes('request') ? '' : 'system'}">${h.detail}</div>` : ''}
                    </div>`;
                });
            } else {
                histHtml = '<div class="text-xs text-slate-400 italic">Sem histórico registrado.</div>';
            }
            setHTML('ed-history', histHtml);
        }

        // ==================== PÁGINA PÚBLICA (PROPOSTA) ====================
        async function loadPublicProposal(id) {
            try {
                safeShow('public-loading');
                const { data: v, error } = await db.from('versions').select('*, projects(name)').eq('id', id).maybeSingle();
                if (error || !v) throw new Error("Orçamento não encontrado.");
                state.version = v; 
                state.data = normalizeData(v.items);
                const d = state.data;
                // Registrar visualização
                if (!d.viewedAt) {
                    d.viewedAt = new Date().toISOString();
                    await db.from('versions').update({ items: d }).eq('id', id);
                }
                if(v.status === 'approved') {
                    document.getElementById('stamp-approved').style.display = 'block';
                    if (v.approved_at) {
                        const date = new Date(v.approved_at).toLocaleString('pt-BR');
                        safeText('doc-date', date);
                    }
                } else {
                    safeText('doc-date', '--/--/--');
                }
                if(d.settings.providerName) {
                    setHTML('doc-provider-info', `<div class="mb-4 pb-4 border-b border-slate-700"><h2 class="text-xl font-bold">${d.settings.providerName}</h2><p class="text-slate-400 text-sm">${d.settings.providerDoc || ''} • ${d.settings.providerPhone || ''}</p><p class="text-slate-400 text-xs">${d.settings.providerAddr || ''}</p></div>`);
                }
                safeText('doc-title', v.projects?.name);
                safeText('doc-id', `#${v.project_id ? v.project_id.substr(0,4).toUpperCase() : 'XXXX'}-${v.version_number}`);
                safeText('doc-c-name', d.client.name);
                safeText('doc-c-doc', d.client.doc);
                const finalAddr = d.location.sameAsClient ? d.client.address : (d.location.address || 'Não informado');
                safeText('doc-c-addr', finalAddr);
                renderPublicItems(); 
                safeText('doc-payment', d.terms.paymentText); 
                safeText('doc-deadline', d.terms.deadline || 'Não informado'); 
                safeText('doc-validity', d.terms.validity); 
                safeText('doc-obs', d.terms.obs);
                if(d.attachments && d.attachments.length > 0) {
                    let attHtml = '<h3 class="font-bold text-xs uppercase text-slate-400 mb-2 mt-8 tracking-wider">Documentos Anexos</h3><div class="grid grid-cols-1 gap-3">';
                    d.attachments.forEach(att => {
                        let icon = att.type === 'pdf' ? 'fa-file-pdf text-red-500' : 'fa-file-image text-blue-500';
                        attHtml += `<div class="att-card border rounded-lg p-3">
                            <div class="flex items-center gap-3">
                                <i class="fas ${icon} text-lg"></i>
                                <span class="text-sm font-medium text-slate-700 truncate">${att.name}</span>
                                <a href="${att.url}" target="_blank" class="text-blue-500 hover:text-blue-700 ml-auto"><i class="fas fa-eye"></i></a>
                            </div>
                            ${att.description ? `<p class="text-xs text-slate-500 mt-1 pl-2 border-l-2 border-blue-200">${att.description}</p>` : ''}
                        </div>`;
                    });
                    attHtml += '</div>';
                    setHTML('doc-attachments-area', attHtml);
                } else {
                    setHTML('doc-attachments-area', '');
                }
                if (d.signature) {
                    setHTML('doc-signature-area', `<div class="mt-8 border-t border-dashed pt-4 w-64 text-center"><img src="${d.signature}" class="mx-auto h-16 mb-2" alt="Assinatura"><p class="text-xs text-slate-500 uppercase font-bold">Assinado Digitalmente</p></div>`);
                }
                const actions = document.getElementById('doc-actions');
                if(actions) {
                    if(v.status === 'approved' || v.status === 'canceled') {
                        showSuccessScreen(v.status);
                    } else {
                        actions.innerHTML = `
                            <button onclick="openModal('approve')" class="w-full bg-[#10B981] text-white font-bold py-4 rounded-xl shadow-lg hover:bg-[#0E9E6F] mb-3 transition-transform hover:scale-[1.01]">APROVAR PROPOSTA</button>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="openModal('change')" class="bg-amber-100 text-amber-700 font-bold py-3 rounded-xl hover:bg-amber-200">Solicitar Alteração</button>
                                <button onclick="openModal('cancel')" class="bg-red-50 text-red-600 font-bold py-3 rounded-xl hover:bg-red-100">Recusar</button>
                            </div>
                        `;
                    }
                }
                safeHide('public-loading');
                safeShow('view-public');
                safeShow('public-content');
            } catch(e) { 
                safeHide('public-loading');
                safeText('error-msg', `Erro: ${e.message}`);
                safeShow('fatal-error');
            }
        }

        function renderPublicItems() {
            let html = '';
            let total = 0;
            const items = state.data.items;
            const isFrozen = state.version.status !== 'sent' && state.version.status !== 'negotiating' && state.version.status !== 'draft';
            items.forEach((i, idx) => {
                if(i.optional && typeof i.publicSelected === 'undefined') i.publicSelected = false;
                if (!i.optional || i.publicSelected) {
                    total += (i.qty * i.price);
                }
                html += `<tr class="border-b border-slate-100 ${i.optional ? 'bg-slate-50' : ''}">
                    <td class="py-4 pl-4">
                        <div class="flex items-start gap-3">
                            ${i.optional && !isFrozen ? `<input type="checkbox" onchange="togglePublicOpt(${idx})" ${i.publicSelected ? 'checked' : ''} class="mt-1 w-5 h-5 cursor-pointer accent-[#10B981]">` : ''}
                            ${i.optional && isFrozen ? (i.publicSelected ? '<i class="fas fa-check-square text-[#10B981] mt-1"></i>' : '<i class="fas fa-square text-slate-400 mt-1"></i>') : ''}
                            <div>
                                <div class="font-bold text-slate-800 ${i.optional ? 'text-slate-600' : ''}">
                                    ${i.name} ${i.optional ? '<span class="text-[10px] bg-slate-200 text-slate-600 px-1 rounded uppercase ml-2">Opcional</span>' : ''}
                                </div>
                                <span class="font-normal text-xs text-slate-500">${i.description}</span>
                            </div>
                        </div>
                    </td>
                    <td class="text-center text-sm">${i.qty}</td>
                    <td class="text-right text-sm text-slate-500">${formatPrice(i.price)}</td>
                    <td class="text-right pr-4 font-bold text-sm ${i.optional && !i.publicSelected ? 'text-slate-400 line-through' : 'text-slate-800'}">
                        ${formatPrice(i.qty * i.price)}
                    </td>
                </tr>`; 
            });
            setHTML('doc-items-body', html);
            safeText('doc-total', formatPrice(total));
        }

        function togglePublicOpt(idx) {
            state.data.items[idx].publicSelected = !state.data.items[idx].publicSelected;
            renderPublicItems();
        }

        function downloadPDF() {
            const element = document.getElementById('public-content');
            const btn = document.getElementById('btn-download-pdf');
            if(btn) btn.innerText = "Gerando PDF...";
            const stamp = document.getElementById('stamp-approved');
            const originalDisplay = stamp.style.display;
            stamp.style.display = 'block';
            document.querySelectorAll('.no-print').forEach(el => el.style.display = 'none');
            const opt = { 
                margin: [0.6, 0.6, 0.6, 0.6],
                filename: `Comprovante_${state.version?.projects?.name || 'proposta'}.pdf`, 
                image: { type: 'jpeg', quality: 0.98 }, 
                html2canvas: { scale: 2, letterRendering: true, useCORS: true, logging: false }, 
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak: { mode: ['css', 'legacy'] }
            };
            html2pdf().set(opt).from(element).save().then(() => {
                if(btn) btn.innerText = "Baixar Comprovante PDF";
                document.querySelectorAll('.no-print').forEach(el => el.style.display = '');
                stamp.style.display = originalDisplay;
            });
        }

        function openModal(type) {
            const modal = document.getElementById('interaction-modal');
            const title = document.getElementById('modal-title');
            const desc = document.getElementById('modal-desc');
            const input = document.getElementById('modal-input');
            const sigArea = document.getElementById('modal-sig-area');
            const btn = document.getElementById('modal-btn');
            modal.classList.remove('hidden');
            input.value = '';
            input.classList.add('hidden');
            sigArea.classList.add('hidden');
            if(type === 'approve') {
                title.innerText = 'Assinar e Aprovar';
                desc.innerText = 'Por favor, assine abaixo para confirmar a aprovação.';
                sigArea.classList.remove('hidden');
                btn.innerText = 'Confirmar Aprovação';
                btn.className = "flex-1 bg-[#10B981] text-white py-3 rounded font-bold hover:bg-[#0E9E6F]";
                btn.onclick = () => executeAction('approve');
                setTimeout(initSignaturePad, 100); 
            } else if(type === 'change') {
                title.innerText = 'O que deseja alterar?';
                desc.innerText = 'Descreva as mudanças desejadas:';
                input.classList.remove('hidden');
                btn.innerText = 'Enviar Solicitação';
                btn.className = "flex-1 bg-[#F59E0B] text-white py-3 rounded font-bold hover:bg-[#E68A00]";
                btn.onclick = () => executeAction('change');
            } else if(type === 'cancel') {
                title.innerText = 'Recusar Orçamento';
                desc.innerText = 'Motivo (Opcional):';
                input.classList.remove('hidden');
                btn.innerText = 'Confirmar Recusa';
                btn.className = "flex-1 bg-red-600 text-white py-3 rounded font-bold hover:bg-red-700";
                btn.onclick = () => executeAction('cancel');
            }
        }

        function initSignaturePad() {
            const canvas = document.getElementById('signature-pad');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            function resizeCanvas() {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                ctx.scale(ratio, ratio);
            }
            resizeCanvas();
            let painting = false;
            function startPosition(e) { 
                painting = true; 
                ctx.beginPath();
                draw(e); 
            }
            function endPosition() { 
                painting = false; 
                ctx.beginPath(); 
            }
            function draw(e) {
                if (!painting) return;
                e.preventDefault(); 
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || (e.touches?.[0]?.clientX)) - rect.left;
                const y = (e.clientY || (e.touches?.[0]?.clientY)) - rect.top;
                ctx.lineWidth = 2; 
                ctx.lineCap = 'round'; 
                ctx.strokeStyle = '#0f172a';
                ctx.lineTo(x, y); 
                ctx.stroke(); 
                ctx.beginPath(); 
                ctx.moveTo(x, y);
            }
            canvas.addEventListener('mousedown', startPosition); 
            canvas.addEventListener('mouseup', endPosition); 
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('touchstart', startPosition); 
            canvas.addEventListener('touchend', endPosition); 
            canvas.addEventListener('touchmove', draw);
            document.getElementById('clear-sig').onclick = () => { 
                ctx.clearRect(0, 0, canvas.width, canvas.height); 
            };
        }

        async function executeAction(type) {
            const inputVal = safeVal('modal-input');
            const btn = document.getElementById('modal-btn');
            btn.innerText = "Processando...";
            btn.disabled = true;
            if (type === 'approve') {
                const canvas = document.getElementById('signature-pad');
                const signatureData = canvas.toDataURL();
                state.data.signature = signatureData;
                await approveLogic();
            } else if (type === 'change') {
                if(!inputVal) { 
                    showToast("Escreva o que deseja alterar.", 'warning'); 
                    btn.disabled = false; 
                    btn.innerText = "Enviar Solicitação"; 
                    return; 
                }
                await sendLogic('change_request', 'negotiating', inputVal);
            } else if (type === 'cancel') {
                await sendLogic('canceled', 'canceled', inputVal || 'Recusado pelo cliente');
            }
        }

        async function sendLogic(action, newStatus, text) {
            logHistory(action, 'client', text);
            await db.from('versions').update({ 
                status: newStatus, 
                items: state.data 
            }).eq('id', state.version.id);
            document.getElementById('interaction-modal').classList.add('hidden');
            await loadProjects();
            renderDashboardKPIs();
            renderDashboardCharts();
            renderProjectCards();
            renderActivityFeed();
            showSuccessScreen(action);
        }

        async function approveLogic() {
            let ip = 'IP não identificado'; 
            try { 
                const r = await fetch('https://api.ipify.org?format=json'); 
                const j = await r.json(); 
                ip = j.ip; 
            } catch(e){}
            logHistory('approved', 'client', 'Aprovado via link com assinatura');
            const items = state.data.items;
            const finalTotal = items.reduce((acc, i) => (!i.optional || i.publicSelected ? acc + (i.qty * i.price) : acc), 0);
            await db.from('versions').update({ 
                status: 'approved', 
                approved_at: new Date(), 
                approved_by_ip: ip, 
                items: state.data, 
                total_value: finalTotal 
            }).eq('id', state.version.id);
            document.getElementById('interaction-modal').classList.add('hidden');
            await loadProjects();
            renderDashboardKPIs();
            renderDashboardCharts();
            renderProjectCards();
            renderActivityFeed();
            window.history.replaceState(null, '', '?view=success');
            showSuccessScreen('approved');
        }

        function showSuccessScreen(type) {
            safeHide('view-public');
            safeShow('view-success');
            const icon = document.getElementById('success-icon');
            const title = document.getElementById('success-title');
            const desc = document.getElementById('success-desc');
            const actions = document.getElementById('success-actions');
            actions.innerHTML = ''; 
            if(type === 'approved' || type === 'approve') {
                icon.className = "fas fa-check-circle text-6xl text-[#10B981] mb-4";
                title.innerText = "Orçamento Aprovado!";
                desc.innerText = "Obrigado pela confiança. O comprovante foi gerado.";
                actions.innerHTML = `<button onclick="window.location.href='?view=public&id=${state.version.id}'; setTimeout(downloadPDF, 1000)" class="px-6 py-3 bg-slate-800 text-white rounded-lg font-bold shadow hover:bg-slate-700"><i class="fas fa-file-pdf mr-2"></i> Baixar Comprovante PDF</button>`;
            } else if (type === 'change_request' || type === 'negotiating') {
                icon.className = "fas fa-clock text-6xl text-[#F59E0B] mb-4";
                title.innerText = "Solicitação Enviada";
                desc.innerText = "Aguarde o retorno do prestador.";
            } else {
                icon.className = "fas fa-times-circle text-6xl text-slate-400 mb-4";
                title.innerText = "Orçamento Recusado";
                desc.innerText = "O orçamento foi marcado como recusado.";
            }
        }

        function openTermsModal() {
            showToast('Termos de uso em breve.', 'info');
        }
        function openPrivacyModal() {
            showToast('Política de privacidade em breve.', 'info');
        }

        // ==================== INICIALIZAÇÃO E ROTEAMENTO ====================
        async function handleLogin() {
            const email = safeVal('email');
            const btn = document.getElementById('btn-login');
            if(!email) return showToast("Digite o e-mail", 'error');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...'; 
            btn.disabled = true;
            const { error } = await db.auth.signInWithOtp({ 
                email, 
                options: { emailRedirectTo: window.location.href }
            });
            if(error) { 
                showToast(error.message, 'error'); 
                btn.innerText = 'Enviar link de acesso'; 
                btn.disabled = false; 
            } else { 
                btn.innerText = 'Enviado!'; 
                showToast('Verifique seu e-mail.', 'success'); 
            }
        }

        function filterProjects(status) {
            switchTab('projects');
            const filterEl = document.getElementById('project-status-filter');
            if(filterEl) {
                filterEl.value = status;
                renderProjectCards();
            }
        }

        function switchTab(tab, updateUrl = true) {
            document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            const nav = document.getElementById(`nav-${tab}`);
            if(nav) nav.classList.add('active');
            document.querySelector('.sidebar').classList.remove('open');
            if(updateUrl) window.history.pushState(null, '', tab === 'dashboard' ? '?' : `?view=${tab}`);
            
            if (tab === 'dashboard') {
                renderDashboardKPIs();
                renderDashboardCharts();
                renderActivityFeed();
            }
            if (tab === 'projects') {
                renderProjectCards();
            }
            if (tab === 'clients') {
                renderClients();
            }
            if (tab === 'catalog') {
                renderCatalog();
            }
            if (tab === 'reports') {
                loadReports();
            }
        }

        async function init() {
            try {
                db = createClient(SUPABASE_URL, SUPABASE_KEY);
                const params = new URLSearchParams(window.location.search);
                const view = params.get('view') || 'login';
                const id = params.get('id');
                const userId = params.get('user');
                document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
                document.getElementById('app-layout').classList.add('hidden');
                
                const { data: { session } } = await db.auth.getSession();
                state.user = session?.user;

                if (view === 'public-catalog' && userId) {
                    await loadPublicCatalog(userId);
                    safeShow('view-public-catalog');
                } else if (view === 'public' && id) {
                    await loadPublicProposal(id);
                    safeShow('view-public');
                } else if (view === 'success') {
                    safeShow('view-success');
                } else if (!state.user) {
                    window.history.replaceState(null, '', '?view=login');
                    safeShow('view-login');
                } else {
                    document.getElementById('app-layout').classList.remove('hidden');
                    await loadProjects();
                    await loadClients();
                    await loadCatalog();
                    await loadTemplates();
                    if (view === 'editor' && id) {
                        await loadEditor(id);
                        switchTab('editor', false);
                    } else if (view === 'dashboard' || view === 'projects' || view === 'clients' || view === 'catalog' || view === 'reports') {
                        switchTab(view, false);
                    } else {
                        switchTab('dashboard', false);
                    }
                }
                setTimeout(() => { 
                    document.getElementById('system-loader').style.display = 'none'; 
                }, 500);
            } catch (e) {
                document.getElementById('system-loader').style.display = 'none';
                safeShow('fatal-error');
                safeText('error-msg', e.message);
            }
        }

        setChartPeriod(30);
        window.onload = init;
        window.onpopstate = init;
    </script>
</body>
</html>
