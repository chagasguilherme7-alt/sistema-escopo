<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aprova Ai | Orçamentos inteligentes</title>
    
    <!-- Tailwind + fontes + ícones -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Bibliotecas -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Notyf (toasts) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">
    <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
    <!-- SortableJS (drag and drop) -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <style>
        /* Design System */
        :root {
            --primary: #1e3a8a;
            --primary-light: #3b82f6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-500: #64748b;
            --gray-700: #334155;
            --gray-900: #0f172a;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--gray-50);
            color: var(--gray-700);
        }
        h1, h2, h3, h4, .font-heading {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        /* Cards e sombras */
        .card {
            background: white;
            border-radius: 1.25rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
            transition: all 0.2s;
            border: 1px solid var(--gray-100);
        }
        .card:hover {
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.05), 0 8px 10px -6px rgb(0 0 0 / 0.05);
            border-color: var(--primary-light);
        }
        /* Botões */
        .btn {
            font-weight: 600;
            border-radius: 0.75rem;
            padding: 0.5rem 1rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(30, 58, 138, 0.2);
        }
        .btn-primary:hover {
            background: #2563eb;
            transform: scale(1.02);
        }
        .btn-success {
            background: var(--success);
            color: white;
        }
        .btn-success:hover {
            background: #059669;
        }
        .btn-outline {
            border: 1px solid var(--gray-200);
            background: white;
            color: var(--gray-700);
        }
        .btn-outline:hover {
            background: var(--gray-50);
            border-color: var(--gray-500);
        }
        /* Badges */
        .badge {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            white-space: nowrap;
        }
        .badge-draft { background: #e0f2fe; color: #0284c7; }
        .badge-sent { background: #dbeafe; color: #1e40af; }
        .badge-negotiating { background: #ffedd5; color: #c2410c; }
        .badge-approved { background: #dcfce7; color: #166534; }
        .badge-canceled { background: #fee2e2; color: #991b1b; }
        /* Animações */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-in {
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        /* Skeletons */
        .skeleton {
            background: linear-gradient(90deg, var(--gray-100) 25%, var(--gray-200) 50%, var(--gray-100) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        /* Sidebar */
        .sidebar {
            width: 18rem;
            background: white;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            border-right: 1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
            z-index: 50;
            transition: transform 0.3s;
        }
        .main-content {
            margin-left: 18rem;
            padding: 2rem;
            min-height: 100vh;
            transition: margin 0.3s;
        }
        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: var(--gray-500);
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
            border-left: 3px solid transparent;
        }
        .nav-item:hover, .nav-item.active {
            background: var(--gray-50);
            color: var(--primary);
            border-left-color: var(--primary);
        }
        .nav-item i { width: 1.5rem; }
        /* Mobile */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 1rem; }
        }
        /* Abas */
        .tab-btn.active {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
        }
        /* Itens do escopo */
        .item-box {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 0.75rem;
            padding: 1rem;
            position: relative;
        }
        .item-optional { border: 2px dashed var(--gray-500); background: var(--gray-50); }
        .optional-badge { background: var(--gray-500); color: white; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.7rem; }
        .diff-box { background: #fff7ed; border: 1px dashed var(--warning); border-radius: 0.5rem; padding: 0.5rem; font-size: 0.75rem; margin-top: 0.5rem; }
        /* Melhorias mobile para tabelas */
        @media (max-width: 640px) {
            table { display: block; overflow-x: auto; }
        }
    </style>
</head>
<body class="antialiased">

    <!-- Loader -->
    <div id="system-loader" class="fixed inset-0 bg-white z-[9999] flex items-center justify-center">
        <div class="text-center">
            <div class="inline-block w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div>
            <p class="mt-4 text-sm text-slate-500 font-medium">Carregando Aprova Ai...</p>
        </div>
    </div>

    <!-- PÁGINA DE APRESENTAÇÃO (LANDING) -->
    <section id="view-landing" class="hidden min-h-screen bg-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <nav class="flex items-center justify-between mb-16">
                <img src="logo.png" alt="Aprova Ai" class="h-12">
                <div class="flex gap-4">
                    <button onclick="showLogin()" class="btn btn-outline">Entrar</button>
                    <button onclick="showLogin()" class="btn btn-primary">Experimentar grátis</button>
                </div>
            </nav>
            <div class="grid lg:grid-cols-2 gap-12 items-center">
                <div class="space-y-6 animate-in">
                    <h1 class="text-5xl lg:text-6xl font-extrabold text-slate-900 leading-tight">
                        Orçamentos que <span class="text-blue-600">vendem</span> e protegem seu negócio
                    </h1>
                    <p class="text-xl text-slate-600">Crie propostas profissionais em minutos, envie com link e acompanhe tudo. Seu cliente aprova com um clique.</p>
                    <div class="flex flex-wrap gap-4">
                        <button onclick="showLogin()" class="btn btn-primary text-lg px-8 py-4">Começar agora →</button>
                        <button onclick="document.getElementById('como-funciona').scrollIntoView({behavior:'smooth'})" class="btn btn-outline text-lg px-8 py-4">Ver demonstração</button>
                    </div>
                    <div class="flex gap-6 text-sm text-slate-500">
                        <span>✓ Sem cartão de crédito</span>
                        <span>✓ 14 dias grátis</span>
                        <span>✓ Suporte humanizado</span>
                    </div>
                </div>
                <div class="relative">
                    <img src="https://images.unsplash.com/photo-1551288049-bebda4e38f71?ixlib=rb-4.0.3&auto=format&fit=crop&w=1470&q=80" alt="Dashboard preview" class="rounded-2xl shadow-2xl border border-slate-200">
                    <div class="absolute -bottom-6 -left-6 bg-white p-4 rounded-2xl shadow-lg border border-slate-100 flex gap-4">
                        <div class="text-center"><span class="text-2xl font-bold text-blue-600">+500</span><p class="text-xs">usuários</p></div>
                        <div class="text-center"><span class="text-2xl font-bold text-green-600">2k+</span><p class="text-xs">orçamentos</p></div>
                        <div class="text-center"><span class="text-2xl font-bold text-amber-600">98%</span><p class="text-xs">satisfação</p></div>
                    </div>
                </div>
            </div>
            <!-- Benefícios em cards -->
            <div class="grid md:grid-cols-3 gap-8 mt-32" id="como-funciona">
                <div class="card p-8 text-center hover:scale-105 transition-transform">
                    <div class="w-16 h-16 bg-blue-100 rounded-2xl flex items-center justify-center mx-auto mb-4"><i class="fas fa-shield-alt text-3xl text-blue-600"></i></div>
                    <h3 class="text-xl font-bold mb-2">Evite prejuízos</h3>
                    <p class="text-slate-500">Registre mudanças de escopo e evite retrabalho. Histórico completo de versões.</p>
                </div>
                <div class="card p-8 text-center hover:scale-105 transition-transform">
                    <div class="w-16 h-16 bg-green-100 rounded-2xl flex items-center justify-center mx-auto mb-4"><i class="fas fa-bolt text-3xl text-green-600"></i></div>
                    <h3 class="text-xl font-bold mb-2">Aprovação rápida</h3>
                    <p class="text-slate-500">Link direto para o cliente aprovar com assinatura digital, onde estiver.</p>
                </div>
                <div class="card p-8 text-center hover:scale-105 transition-transform">
                    <div class="w-16 h-16 bg-amber-100 rounded-2xl flex items-center justify-center mx-auto mb-4"><i class="fas fa-file-contract text-3xl text-amber-600"></i></div>
                    <h3 class="text-xl font-bold mb-2">Sem discussão</h3>
                    <p class="text-slate-500">Tudo documentado, PDF automático e histórico de interações.</p>
                </div>
            </div>
            <!-- Como funciona -->
            <div class="mt-32 text-center">
                <h2 class="text-3xl font-bold mb-12">Como funciona?</h2>
                <div class="grid md:grid-cols-3 gap-8">
                    <div class="relative">
                        <div class="w-12 h-12 bg-blue-600 text-white rounded-2xl flex items-center justify-center text-xl font-bold mx-auto mb-4">1</div>
                        <h4 class="font-bold text-lg">Crie</h4>
                        <p class="text-slate-500">Adicione itens, opcionais e anexos. Seus dados são salvos automaticamente.</p>
                    </div>
                    <div class="relative">
                        <div class="w-12 h-12 bg-blue-600 text-white rounded-2xl flex items-center justify-center text-xl font-bold mx-auto mb-4">2</div>
                        <h4 class="font-bold text-lg">Envie</h4>
                        <p class="text-slate-500">Compartilhe o link por WhatsApp ou e-mail. O cliente vê tudo.</p>
                    </div>
                    <div class="relative">
                        <div class="w-12 h-12 bg-blue-600 text-white rounded-2xl flex items-center justify-center text-xl font-bold mx-auto mb-4">3</div>
                        <h4 class="font-bold text-lg">Aprovação</h4>
                        <p class="text-slate-500">Cliente aprova com assinatura. Você recebe notificação e PDF.</p>
                    </div>
                </div>
            </div>
            <!-- Depoimentos -->
            <div class="mt-32 bg-slate-50 p-12 rounded-3xl">
                <h2 class="text-3xl font-bold text-center mb-12">O que nossos clientes dizem</h2>
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-2xl shadow-sm">
                        <div class="flex gap-2 text-amber-400 mb-2">★★★★★</div>
                        <p class="text-slate-700">"Reduziu meu tempo de criação de orçamentos de horas para minutos. Meus clientes adoram a facilidade de aprovar."</p>
                        <div class="mt-4 flex items-center gap-3">
                            <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold">CA</div>
                            <div><span class="font-bold">Carlos Andrade</span><p class="text-xs text-slate-500">Eletricista</p></div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm">
                        <div class="flex gap-2 text-amber-400 mb-2">★★★★★</div>
                        <p class="text-slate-700">"A aprovação digital com assinatura deu um ar super profissional. Já fechei vários contratos por aqui."</p>
                        <div class="mt-4 flex items-center gap-3">
                            <div class="w-10 h-10 bg-green-600 rounded-full flex items-center justify-center text-white font-bold">MP</div>
                            <div><span class="font-bold">Mariana Prado</span><p class="text-xs text-slate-500">Arquiteta</p></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- CTA final -->
            <div class="mt-32 text-center">
                <h2 class="text-4xl font-bold mb-4">Pronto para começar?</h2>
                <p class="text-xl text-slate-500 mb-8">Crie sua conta gratuita e comece a enviar orçamentos hoje mesmo.</p>
                <button onclick="showLogin()" class="btn btn-primary text-lg px-12 py-4">Experimentar grátis →</button>
            </div>
            <footer class="mt-32 text-sm text-slate-400 flex justify-between">
                <span>© 2025 Aprova Ai. Todos os direitos reservados.</span>
                <div class="flex gap-4">
                    <a href="#" class="hover:text-slate-600">Termos</a>
                    <a href="#" class="hover:text-slate-600">Privacidade</a>
                </div>
            </footer>
        </div>
    </section>

    <!-- LOGIN -->
    <section id="view-login" class="hidden min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center p-4">
        <div class="max-w-6xl w-full grid md:grid-cols-2 bg-white rounded-3xl shadow-2xl overflow-hidden">
            <div class="bg-gradient-to-br from-blue-600 to-blue-800 p-12 text-white flex flex-col justify-between">
                <div>
                    <img src="logo.png" alt="Aprova Ai" class="h-12 brightness-0 invert mb-8">
                    <h1 class="text-4xl font-bold mb-4">Acesse sua conta</h1>
                    <p class="text-blue-100">Digite seu e-mail para receber um link mágico e entrar.</p>
                </div>
                <div class="space-y-4 mt-12">
                    <div class="flex items-center gap-3"><i class="fas fa-check-circle text-blue-200"></i> <span>Sem senhas para decorar</span></div>
                    <div class="flex items-center gap-3"><i class="fas fa-check-circle text-blue-200"></i> <span>Link seguro e temporário</span></div>
                    <div class="flex items-center gap-3"><i class="fas fa-check-circle text-blue-200"></i> <span>Rápido e prático</span></div>
                </div>
            </div>
            <div class="p-12">
                <div class="max-w-sm mx-auto">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">Entrar</h2>
                    <input type="email" id="email" placeholder="Seu e-mail profissional" class="w-full border border-slate-200 rounded-xl p-4 mb-4 focus:ring-2 focus:ring-blue-200 outline-none">
                    <button onclick="handleLogin()" id="btn-login" class="w-full btn-primary py-4 text-lg">Enviar link de acesso</button>
                    <p class="text-xs text-slate-400 mt-6 text-center">Ao continuar, você concorda com nossos Termos e Política de Privacidade.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- LAYOUT PRINCIPAL (APÓS LOGIN) -->
    <div id="app-layout" class="hidden">
        <!-- Mobile header -->
        <div class="md:hidden bg-white border-b border-slate-200 p-4 flex items-center justify-between sticky top-0 z-30">
            <img src="logo.png" alt="Aprova Ai" class="h-8">
            <button onclick="document.querySelector('.sidebar').classList.toggle('open')" class="text-slate-600 p-2"><i class="fas fa-bars text-xl"></i></button>
        </div>

        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="p-6 border-b border-slate-100">
                <img src="logo.png" alt="Aprova Ai" class="h-10">
            </div>
            <div class="p-4">
                <button onclick="createProject()" class="btn-primary w-full flex items-center justify-center gap-2 py-3"><i class="fas fa-plus"></i> Novo Orçamento</button>
            </div>
            <nav class="flex-1 overflow-y-auto py-2">
                <div onclick="switchTab('dashboard')" class="nav-item active" id="nav-dashboard"><i class="fas fa-home w-6"></i> Visão geral</div>
                <div onclick="switchTab('projects')" class="nav-item" id="nav-projects"><i class="fas fa-file-invoice w-6"></i> Orçamentos</div>
                <div onclick="switchTab('templates')" class="nav-item" id="nav-templates"><i class="fas fa-copy w-6"></i> Templates</div>
                <div onclick="switchTab('clients')" class="nav-item" id="nav-clients"><i class="fas fa-users w-6"></i> Clientes</div>
                <div onclick="switchTab('catalog')" class="nav-item" id="nav-catalog"><i class="fas fa-box w-6"></i> Catálogo</div>
                <div onclick="switchTab('reports')" class="nav-item" id="nav-reports"><i class="fas fa-chart-pie w-6"></i> Relatórios</div>
            </nav>
            <div class="p-4 border-t border-slate-100">
                <button onclick="logout()" class="flex items-center text-red-500 w-full px-4 py-2"><i class="fas fa-sign-out-alt mr-3"></i> Sair</button>
            </div>
        </aside>

        <!-- Backdrop mobile -->
        <div class="sidebar-backdrop fixed inset-0 bg-black/50 z-30 hidden md:hidden" onclick="document.querySelector('.sidebar').classList.remove('open')"></div>

        <main class="main-content">
            <!-- DASHBOARD -->
            <section id="view-dashboard" class="space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Visão geral</h2>
                    <div class="flex gap-2">
                        <button onclick="setChartPeriod(7)" class="period-btn btn-outline text-sm" data-period="7">7d</button>
                        <button onclick="setChartPeriod(30)" class="period-btn btn-primary text-sm" data-period="30">30d</button>
                        <button onclick="setChartPeriod(90)" class="period-btn btn-outline text-sm" data-period="90">90d</button>
                    </div>
                </div>

                <!-- KPIs em cards -->
                <div class="grid grid-cols-2 lg:grid-cols-5 gap-4">
                    <div class="card p-4">
                        <p class="text-xs text-slate-500 uppercase">Faturamento aprovado</p>
                        <p class="text-2xl font-bold text-success" id="kpi-total-apr">R$ 0</p>
                    </div>
                    <div class="card p-4">
                        <p class="text-xs text-slate-500 uppercase">Pipeline total</p>
                        <p class="text-2xl font-bold text-primary" id="kpi-total-est">R$ 0</p>
                    </div>
                    <div class="card p-4">
                        <p class="text-xs text-slate-500 uppercase">Aguardando</p>
                        <p class="text-2xl font-bold" id="kpi-count-sent">0</p>
                    </div>
                    <div class="card p-4">
                        <p class="text-xs text-slate-500 uppercase">Negociação</p>
                        <p class="text-2xl font-bold text-warning" id="kpi-count-neg">0</p>
                    </div>
                    <div class="card p-4">
                        <p class="text-xs text-slate-500 uppercase">Rascunhos</p>
                        <p class="text-2xl font-bold" id="kpi-count-open">0</p>
                    </div>
                </div>

                <!-- Gráfico -->
                <div class="card p-6">
                    <canvas id="dashboardChart" style="height: 300px;"></canvas>
                </div>

                <!-- Feed de atividades -->
                <div class="card p-6">
                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2"><i class="fas fa-history text-primary"></i> Atividade recente</h3>
                    <div id="activity-feed" class="space-y-3"></div>
                </div>
            </section>

            <!-- PROJETOS -->
            <section id="view-projects" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Orçamentos</h2>
                    <button onclick="createProject()" class="btn-primary"><i class="fas fa-plus mr-2"></i>Novo</button>
                </div>
                <div class="flex flex-col md:flex-row gap-4">
                    <input id="project-search" onkeyup="renderProjectCards()" class="flex-1 border border-slate-200 rounded-xl p-3" placeholder="Buscar por cliente ou projeto...">
                    <select id="project-status-filter" onchange="renderProjectCards()" class="border border-slate-200 rounded-xl p-3">
                        <option value="all">Todos os status</option>
                        <option value="draft">Rascunho</option>
                        <option value="sent">Aguardando</option>
                        <option value="negotiating">Negociação</option>
                        <option value="approved">Aprovado</option>
                        <option value="canceled">Cancelado</option>
                    </select>
                </div>
                <div id="project-cards-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
            </section>

            <!-- TEMPLATES -->
            <section id="view-templates" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Templates de orçamento</h2>
                    <button onclick="openTemplateModal()" class="btn-primary"><i class="fas fa-plus mr-2"></i>Novo template</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="templates-grid"></div>
            </section>

            <!-- CLIENTES -->
            <section id="view-clients" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Clientes</h2>
                    <button onclick="openClientModal()" class="btn-primary"><i class="fas fa-plus mr-2"></i>Novo cliente</button>
                </div>
                <input id="client-search" onkeyup="renderClients()" class="w-full border border-slate-200 rounded-xl p-3" placeholder="Buscar cliente...">
                <div class="bg-white rounded-xl border border-slate-200 overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-slate-50 text-left text-xs uppercase text-slate-500">
                            <tr><th class="p-3">Nome</th><th class="p-3">Documento</th><th class="p-3">Telefone</th><th class="p-3">E-mail</th><th class="p-3">Ações</th></tr>
                        </thead>
                        <tbody id="client-table-body"></tbody>
                    </table>
                </div>
            </section>

            <!-- CATÁLOGO (em grade) -->
            <section id="view-catalog" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Catálogo de serviços</h2>
                    <div class="flex gap-2">
                        <button onclick="openShareCatalogModal()" class="btn-outline"><i class="fas fa-share-alt mr-2"></i>Compartilhar</button>
                        <button onclick="openCatalogModal()" class="btn-primary"><i class="fas fa-plus mr-2"></i>Novo serviço</button>
                    </div>
                </div>
                <div class="flex gap-4">
                    <input id="catalog-search" onkeyup="renderCatalogGrid()" class="flex-1 border border-slate-200 rounded-xl p-3" placeholder="Buscar serviço...">
                    <select id="catalog-category-filter" onchange="renderCatalogGrid()" class="border border-slate-200 rounded-xl p-3"></select>
                </div>
                <div id="catalog-grid" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
            </section>

            <!-- RELATÓRIOS -->
            <section id="view-reports" class="hidden space-y-6">
                <h2 class="text-2xl font-bold">Relatórios</h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="card p-6">
                        <h3 class="font-bold mb-4">Orçamentos por status</h3>
                        <canvas id="reportsPieChart" style="height: 250px;"></canvas>
                    </div>
                    <div class="card p-6">
                        <h3 class="font-bold mb-4">Evolução mensal</h3>
                        <canvas id="reportsLineChart" style="height: 250px;"></canvas>
                    </div>
                </div>
                <div class="card p-6">
                    <h3 class="font-bold mb-4">Últimos orçamentos</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead><tr class="text-left text-xs text-slate-500"><th>Projeto</th><th>Cliente</th><th>Valor</th><th>Status</th><th>Data</th></tr></thead>
                            <tbody id="reports-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- EDITOR -->
            <section id="view-editor" class="hidden pb-20">
                <!-- Cabeçalho fixo -->
                <div class="sticky top-0 bg-white/90 backdrop-blur-sm border-b border-slate-200 z-20 p-4 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <button onclick="switchTab('projects')" class="text-slate-400 hover:text-slate-800"><i class="fas fa-arrow-left text-xl"></i></button>
                        <div>
                            <h2 class="text-xl font-bold" id="ed-title">...</h2>
                            <div class="flex items-center gap-2 text-sm">
                                <span id="ed-ver" class="bg-slate-100 px-2 py-0.5 rounded">V1</span>
                                <span id="ed-status-badge" class="badge badge-draft">RASCUNHO</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openShareModal()" class="btn-primary"><i class="fas fa-share-alt mr-2"></i>Enviar</button>
                        <div id="ed-actions-header"></div>
                    </div>
                </div>

                <!-- Conteúdo do editor com abas -->
                <div class="mt-6">
                    <div class="border-b border-slate-200 flex gap-6 px-2">
                        <button class="tab-btn active text-primary border-b-2 border-primary pb-2 font-medium" data-tab="client">Cliente</button>
                        <button class="tab-btn text-slate-500 pb-2 font-medium" data-tab="items">Escopo</button>
                        <button class="tab-btn text-slate-500 pb-2 font-medium" data-tab="payment">Pagamento</button>
                        <button class="tab-btn text-slate-500 pb-2 font-medium" data-tab="history">Histórico</button>
                    </div>

                    <!-- Aba Cliente -->
                    <div class="tab-pane active mt-6" id="tab-client">
                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="card p-6">
                                <h3 class="font-bold mb-4 flex items-center gap-2"><i class="fas fa-building text-primary"></i> Seus dados</h3>
                                <div class="space-y-3">
                                    <input id="p-name" onchange="upSettings('providerName',this.value)" class="w-full border border-slate-200 rounded-lg p-3" placeholder="Nome da empresa">
                                    <input id="p-doc" onchange="upSettings('providerDoc',this.value)" class="w-full border border-slate-200 rounded-lg p-3" placeholder="CNPJ/CPF">
                                    <input id="p-phone" onchange="upSettings('providerPhone',this.value)" class="w-full border border-slate-200 rounded-lg p-3" placeholder="Telefone">
                                    <input id="p-addr" onchange="upSettings('providerAddr',this.value)" class="w-full border border-slate-200 rounded-lg p-3" placeholder="Endereço">
                                </div>
                            </div>
                            <div class="card p-6">
                                <h3 class="font-bold mb-4 flex items-center gap-2"><i class="fas fa-user-tie text-primary"></i> Dados do cliente</h3>
                                <div class="space-y-3">
                                    <div class="relative">
                                        <input type="text" id="client-search-input" placeholder="Buscar cliente..." class="w-full border border-slate-200 rounded-lg p-3" onkeyup="searchClients()">
                                        <div id="client-suggestions" class="absolute bg-white border rounded-lg w-full mt-1 hidden z-10"></div>
                                    </div>
                                    <button onclick="openClientModal(true)" class="text-sm text-blue-600"><i class="fas fa-plus mr-1"></i>Novo cliente</button>
                                    <input id="c-name" onchange="upVal('c-name',this.value)" class="w-full border border-slate-200 rounded-lg p-3" placeholder="Nome / Razão Social">
                                    <input id="c-doc" onchange="upVal('c-doc',this.value)" class="w-full border border-slate-200 rounded-lg p-3" placeholder="CPF/CNPJ">
                                    <input id="c-phone" onchange="upVal('c-phone',this.value)" class="w-full border border-slate-200 rounded-lg p-3" placeholder="Telefone">
                                    <input id="c-email" onchange="upVal('c-email',this.value)" class="w-full border border-slate-200 rounded-lg p-3" placeholder="E-mail">
                                    <input id="c-addr" onchange="upVal('c-addr',this.value)" class="w-full border border-slate-200 rounded-lg p-3" placeholder="Endereço">
                                </div>
                                <div class="mt-4 pt-4 border-t">
                                    <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="loc-check" onchange="toggleLoc(this.checked)" class="accent-primary"> Endereço do serviço é o mesmo do cliente?</label>
                                    <div id="loc-custom-div" class="mt-3 hidden">
                                        <input id="loc-addr" onchange="upLoc(this.value)" class="w-full border border-slate-200 rounded-lg p-3" placeholder="Endereço do serviço/obra">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Aba Escopo -->
                    <div class="tab-pane hidden mt-6" id="tab-items">
                        <div class="card p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold">Itens do orçamento</h3>
                                <div class="flex gap-2">
                                    <button onclick="addItem()" class="btn-primary text-sm"><i class="fas fa-plus mr-1"></i>Adicionar</button>
                                    <button onclick="openCatalogSelector()" class="btn-outline text-sm"><i class="fas fa-import mr-1"></i>Importar</button>
                                </div>
                            </div>
                            <div id="ed-items" class="space-y-3"></div>
                            <div class="mt-6 pt-4 border-t">
                                <label class="text-sm font-medium">Prazo de entrega</label>
                                <input id="t-deadline" onchange="upVal('t-deadline',this.value)" class="w-full border border-slate-200 rounded-lg p-3 mt-1" placeholder="Ex: 30 dias úteis">
                            </div>
                            <div class="mt-6 pt-4 border-t">
                                <h4 class="font-bold mb-3">Anexos</h4>
                                <div id="ed-attachments-list" class="space-y-3"></div>
                                <label for="file-upload" class="cursor-pointer block text-center border-2 border-dashed border-slate-300 p-4 rounded-lg hover:bg-slate-50 text-sm text-slate-500">
                                    <i class="fas fa-cloud-upload-alt mr-2"></i>Adicionar PDF/IMG
                                </label>
                                <input id="file-upload" type="file" class="hidden" accept=".pdf,.png,.jpg,.jpeg" onchange="handleUpload(event)">
                            </div>
                        </div>
                    </div>

                    <!-- Aba Pagamento -->
                    <div class="tab-pane hidden mt-6" id="tab-payment">
                        <div class="card p-6">
                            <h3 class="font-bold mb-4">Condições de pagamento</h3>
                            <select id="pay-mode" class="w-full border border-slate-200 rounded-lg p-3 mb-3">
                                <option value="entry_installments">Entrada + parcelas</option>
                                <option value="no_entry_installments">Parcelas sem entrada</option>
                                <option value="single">À vista</option>
                            </select>
                            <button onclick="generatePayment()" class="btn-outline w-full mb-4"><i class="fas fa-calculator mr-2"></i>Gerar cronograma</button>
                            <textarea id="t-obs" onchange="upVal('t-obs',this.value)" class="w-full border border-slate-200 rounded-lg p-3 h-24" placeholder="Descrição do pagamento..."></textarea>
                            <input id="t-val" onchange="upVal('t-val',this.value)" class="w-full border border-slate-200 rounded-lg p-3 mt-3" placeholder="Validade (ex: 10 dias)">
                        </div>
                        <div class="card p-6 mt-6 bg-slate-900 text-white">
                            <p class="text-sm uppercase text-slate-400">Total global</p>
                            <p id="ed-total" class="text-3xl font-bold">R$ 0,00</p>
                            <p id="ed-total-optional" class="text-xs text-slate-400"></p>
                        </div>
                    </div>

                    <!-- Aba Histórico -->
                    <div class="tab-pane hidden mt-6" id="tab-history">
                        <div class="card p-6">
                            <h3 class="font-bold mb-4">Linha do tempo</h3>
                            <div id="ed-history" class="space-y-4 max-h-96 overflow-y-auto"></div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- VIEW PÚBLICA (PROPOSTA) -->
    <section id="view-public" class="hidden bg-slate-100 py-8 md:py-12">
        <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div id="public-loading" class="p-20 text-center"><div class="inline-block w-8 h-8 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div></div>
            <div id="public-content" class="hidden p-8 md:p-12">
                <div id="stamp-approved" class="hidden absolute top-6 right-6 rotate-12 text-4xl font-black text-green-500/30">APROVADO</div>
                <!-- Cabeçalho -->
                <div class="flex justify-between items-start border-b pb-6">
                    <div>
                        <h1 id="doc-title" class="text-3xl font-bold text-slate-900">Projeto</h1>
                        <p id="doc-id" class="text-sm text-slate-400">#REF</p>
                    </div>
                    <div class="text-right">
                        <div id="doc-provider-info" class="font-medium"></div>
                        <p id="doc-date" class="text-sm text-slate-400">--/--/--</p>
                    </div>
                </div>
                <!-- Cliente e local -->
                <div class="grid md:grid-cols-2 gap-6 py-6">
                    <div>
                        <h3 class="text-xs uppercase text-slate-400 font-bold">Contratante</h3>
                        <p id="doc-c-name" class="text-xl font-bold"></p>
                        <p id="doc-c-doc" class="text-slate-500"></p>
                    </div>
                    <div>
                        <h3 class="text-xs uppercase text-slate-400 font-bold">Local do serviço</h3>
                        <p id="doc-c-addr" class="text-slate-700"></p>
                    </div>
                </div>
                <!-- Tabela de itens -->
                <table class="w-full mt-4">
                    <thead class="text-left text-xs uppercase text-slate-400 border-b">
                        <tr><th class="pb-2">Item</th><th class="pb-2 text-center">Qtd</th><th class="pb-2 text-right">Unit.</th><th class="pb-2 text-right">Total</th></tr>
                    </thead>
                    <tbody id="doc-items-body" class="divide-y"></tbody>
                </table>
                <div id="doc-deadline-container" class="mt-4 text-sm"><span class="font-bold">Prazo:</span> <span id="doc-deadline"></span></div>
                <!-- Anexos -->
                <div id="doc-attachments-area" class="mt-8"></div>
                <!-- Pagamento e total -->
                <div class="mt-8 bg-slate-50 p-6 rounded-xl flex flex-wrap justify-between items-center">
                    <div>
                        <h4 class="text-xs uppercase text-slate-400 font-bold">Pagamento</h4>
                        <p id="doc-payment" class="text-sm font-mono whitespace-pre-line"></p>
                        <p class="text-xs text-slate-400 mt-2">Validade: <span id="doc-validity"></span></p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs uppercase text-slate-400">Total</p>
                        <p id="doc-total" class="text-3xl font-bold text-primary">R$ 0,00</p>
                    </div>
                </div>
                <div id="doc-obs" class="mt-6 text-sm italic text-slate-500"></div>
                <div id="doc-signature-area" class="mt-8"></div>
                <!-- Botões de ação -->
                <div id="doc-actions" class="mt-8 flex flex-col gap-3"></div>
            </div>
        </div>
    </section>

    <!-- VIEW PÚBLICA DO CATÁLOGO -->
    <section id="view-public-catalog" class="hidden min-h-screen bg-slate-50 p-6">
        <div class="max-w-4xl mx-auto">
            <div id="public-catalog-loading" class="flex justify-center py-20">
                <div class="loader-spin"></div>
            </div>
            <div id="public-catalog-content" class="hidden">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-8 mb-6">
                    <div class="flex items-center gap-4 mb-6">
                        <img src="logo.png" alt="Logo" class="h-12">
                        <div>
                            <h1 class="text-2xl font-bold text-slate-800">Catálogo de Serviços</h1>
                            <p id="provider-name" class="text-slate-500">Carregando...</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="public-catalog-items"></div>

                    <div class="mt-8 pt-6 border-t border-dashed">
                        <h3 class="font-bold text-slate-700 mb-2">Descreva um serviço personalizado</h3>
                        <textarea id="custom-service-description" rows="3" class="w-full border p-3 rounded-lg text-sm" placeholder="Ex: Gostaria de um serviço que não está listado..."></textarea>
                    </div>

                    <div class="mt-8 flex justify-end">
                        <button onclick="submitPublicCatalogRequest()" class="bg-green-600 text-white px-6 py-3 rounded-lg font-bold shadow-lg hover:bg-green-700">
                            Solicitar Orçamento
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- VIEW SUCESSO -->
    <section id="view-success" class="hidden min-h-screen bg-white flex items-center justify-center p-4">
        <div class="max-w-md text-center">
            <i id="success-icon" class="fas fa-check-circle text-6xl text-green-500 mb-4"></i>
            <h2 id="success-title" class="text-3xl font-bold mb-2">Tudo certo!</h2>
            <p id="success-desc" class="text-slate-600 mb-6">Sua resposta foi registrada.</p>
            <div id="success-actions"></div>
        </div>
    </section>

    <!-- MODAIS -->
    <div id="client-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full p-6">
            <h3 class="text-xl font-bold mb-4" id="client-modal-title">Novo cliente</h3>
            <input type="hidden" id="client-id">
            <div class="space-y-3">
                <input id="client-name" class="w-full border border-slate-200 rounded-lg p-3" placeholder="Nome *">
                <input id="client-doc" class="w-full border border-slate-200 rounded-lg p-3" placeholder="CPF/CNPJ">
                <input id="client-phone" class="w-full border border-slate-200 rounded-lg p-3" placeholder="Telefone">
                <input id="client-email" class="w-full border border-slate-200 rounded-lg p-3" placeholder="E-mail">
                <input id="client-addr" class="w-full border border-slate-200 rounded-lg p-3" placeholder="Endereço">
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeClientModal()" class="flex-1 btn-outline">Cancelar</button>
                <button onclick="saveClient()" class="flex-1 btn-primary">Salvar</button>
            </div>
        </div>
    </div>

    <div id="catalog-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full p-6">
            <h3 class="text-xl font-bold mb-4" id="catalog-modal-title">Novo serviço</h3>
            <input type="hidden" id="catalog-id">
            <div class="space-y-3">
                <input id="catalog-name" class="w-full border border-slate-200 rounded-lg p-3" placeholder="Nome *">
                <textarea id="catalog-description" class="w-full border border-slate-200 rounded-lg p-3" placeholder="Descrição" rows="2"></textarea>
                <input id="catalog-price" type="number" step="0.01" class="w-full border border-slate-200 rounded-lg p-3" placeholder="Preço (opcional)">
                <input id="catalog-category" class="w-full border border-slate-200 rounded-lg p-3" placeholder="Categoria">
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeCatalogModal()" class="flex-1 btn-outline">Cancelar</button>
                <button onclick="saveCatalogItem()" class="flex-1 btn-primary">Salvar</button>
            </div>
        </div>
    </div>

    <div id="catalog-selector-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-2xl w-full p-6 max-h-[80vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">Selecionar serviços do catálogo</h3>
            <div class="flex gap-2 mb-4">
                <input type="text" id="catalog-selector-search" placeholder="Buscar..." class="flex-1 border border-slate-200 rounded-lg p-3" onkeyup="renderCatalogSelector()">
                <select id="catalog-selector-category" onchange="renderCatalogSelector()" class="border border-slate-200 rounded-lg p-3"></select>
            </div>
            <div id="catalog-selector-list" class="space-y-2 max-h-96 overflow-y-auto border rounded-lg p-2"></div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeCatalogSelector()" class="flex-1 btn-outline">Cancelar</button>
                <button onclick="importSelectedCatalogItems()" class="flex-1 btn-primary">Adicionar selecionados</button>
            </div>
        </div>
    </div>

    <div id="share-catalog-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full p-6">
            <h3 class="text-xl font-bold mb-4">Compartilhar catálogo</h3>
            <p class="text-sm text-slate-500 mb-4">Envie este link para seus clientes escolherem os serviços.</p>
            <div id="catalog-share-link" class="bg-slate-100 p-3 rounded-lg text-sm break-all mb-4"></div>
            <div class="flex gap-3">
                <button onclick="copyCatalogLink()" class="flex-1 btn-primary">Copiar link</button>
                <button onclick="shareCatalogViaWhatsApp()" class="flex-1 btn-success"><i class="fab fa-whatsapp mr-2"></i>WhatsApp</button>
            </div>
            <button onclick="closeShareCatalogModal()" class="mt-4 text-sm text-slate-400 underline w-full">Fechar</button>
        </div>
    </div>

    <div id="template-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full p-6">
            <h3 class="text-xl font-bold mb-4">Salvar como template</h3>
            <input id="template-name" class="w-full border border-slate-200 rounded-lg p-3 mb-4" placeholder="Nome do template">
            <textarea id="template-desc" class="w-full border border-slate-200 rounded-lg p-3 mb-4" placeholder="Descrição (opcional)"></textarea>
            <div class="flex gap-3">
                <button onclick="closeTemplateModal()" class="flex-1 btn-outline">Cancelar</button>
                <button onclick="saveTemplate()" class="flex-1 btn-primary">Salvar</button>
            </div>
        </div>
    </div>

    <div id="share-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-sm w-full p-6 text-center">
            <h3 class="text-xl font-bold mb-4"><i class="fas fa-share-alt text-primary mr-2"></i>Enviar proposta</h3>
            <button id="btn-share-wa" class="w-full btn-success py-3 mb-3"><i class="fab fa-whatsapp mr-2"></i>Enviar WhatsApp</button>
            <button id="btn-share-copy" class="w-full btn-outline py-3"><i class="fas fa-link mr-2"></i>Copiar link</button>
            <button onclick="closeShareModal()" class="mt-4 text-sm text-slate-400 underline">Cancelar</button>
        </div>
    </div>

    <div id="signature-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-lg w-full p-6">
            <h3 class="text-xl font-bold mb-4">Assine para aprovar</h3>
            <canvas id="signature-pad" class="border-2 border-dashed border-slate-300 rounded-lg w-full h-48 touch-none"></canvas>
            <div class="flex justify-end mt-2"><button onclick="clearSignature()" class="text-sm text-red-500">Limpar</button></div>
            <div class="flex gap-3 mt-4">
                <button onclick="closeSignatureModal()" class="flex-1 btn-outline">Cancelar</button>
                <button onclick="submitSignature()" class="flex-1 btn-success">Confirmar aprovação</button>
            </div>
        </div>
    </div>

    <div id="client-data-modal" class="hidden fixed inset-0 bg-black/70 z-[100] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md p-6 rounded-xl">
            <h3 class="text-xl font-bold mb-4 text-slate-800">Para continuar, informe seus dados</h3>
            <div class="space-y-3">
                <input id="public-client-name" class="w-full border p-2 rounded text-sm" placeholder="Nome completo *">
                <input id="public-client-email" type="email" class="w-full border p-2 rounded text-sm" placeholder="E-mail">
                <input id="public-client-phone" class="w-full border p-2 rounded text-sm" placeholder="Telefone">
                <input id="public-client-address" class="w-full border p-2 rounded text-sm" placeholder="Endereço">
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="cancelPublicClientData()" class="flex-1 border py-2 rounded text-slate-600 font-bold hover:bg-slate-50">Cancelar</button>
                <button onclick="savePublicClientData()" class="flex-1 bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700">Continuar</button>
            </div>
        </div>
    </div>

    <script>
        // ========== CONFIGURAÇÕES INICIAIS ==========
        const SUPABASE_URL = 'https://outasfgohiiyndsjciau.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im91dGFzZmdvaGlpeW5kc2pjaWF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4MTk4ODIsImV4cCI6MjA4NTM5NTg4Mn0.4yvGfYbQYf806FJcs34yPGkuU_kVTYHW8mBtbU3JD80';
        const { createClient } = supabase;
        let db = null;

        // Estado global
        let state = { 
            user: null, 
            project: null, 
            version: null, 
            projectsCache: [], 
            clientsCache: [],
            catalogCache: [],
            templates: [],
            data: null, 
            previousData: null, 
            snapshot: [] 
        };
        let chartInstance = null;
        let chartPeriod = 30;
        let notyf = null;

        // Utilitários
        function showToast(message, type = 'success') {
            if (!notyf) notyf = new Notyf({ duration: 3000, position: { x: 'right', y: 'top' } });
            if (type === 'success') notyf.success(message); else notyf.error(message);
        }

        function safeVal(id) { return document.getElementById(id)?.value || ''; }
        function setVal(id, val) { const el = document.getElementById(id); if (el) el.value = val || ''; }
        function safeText(id, val) { const el = document.getElementById(id); if (el) el.innerText = val || ''; }
        function setHTML(id, html) { const el = document.getElementById(id); if (el) el.innerHTML = html || ''; }
        function show(id) { document.getElementById(id)?.classList.remove('hidden'); }
        function hide(id) { document.getElementById(id)?.classList.add('hidden'); }

        function formatPrice(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
        }

        // ========== INICIALIZAÇÃO ==========
        async function init() {
            try {
                db = createClient(SUPABASE_URL, SUPABASE_KEY);
                const params = new URLSearchParams(window.location.search);
                const view = params.get('view') || 'landing';

                document.querySelectorAll('section, #app-layout').forEach(el => el.classList.add('hidden'));

                if (view === 'landing') {
                    show('view-landing');
                } else if (view === 'login') {
                    show('view-login');
                } else if (view === 'public' && params.get('id')) {
                    await loadPublicProposal(params.get('id'));
                    show('view-public');
                } else if (view === 'public-catalog' && params.get('user')) {
                    await loadPublicCatalog(params.get('user'));
                    show('view-public-catalog');
                } else if (view === 'success') {
                    show('view-success');
                } else {
                    const { data: { session } } = await db.auth.getSession();
                    state.user = session?.user;
                    if (!state.user) {
                        window.location.href = '?view=landing';
                        return;
                    }
                    document.getElementById('app-layout').classList.remove('hidden');
                    await Promise.all([loadProjects(), loadClients(), loadCatalog(), loadTemplates()]);
                    
                    if (view === 'editor' && params.get('id')) {
                        await loadEditor(params.get('id'));
                        switchTab('editor', false);
                    } else if (['dashboard','projects','templates','clients','catalog','reports'].includes(view)) {
                        switchTab(view, false);
                    } else {
                        switchTab('dashboard', false);
                    }
                }
                document.getElementById('system-loader').style.display = 'none';
            } catch (e) {
                console.error(e);
                document.getElementById('system-loader').style.display = 'none';
                showToast('Erro ao carregar sistema', 'error');
            }
        }

        function showLogin() {
            window.location.href = '?view=login';
        }

        async function handleLogin() {
            const email = safeVal('email');
            if (!email) return showToast('Digite o e-mail', 'error');
            const btn = document.getElementById('btn-login');
            btn.disabled = true; btn.innerText = 'Enviando...';
            const { error } = await db.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.origin } });
            btn.disabled = false;
            if (error) {
                showToast(error.message, 'error');
                btn.innerText = 'Tentar novamente';
            } else {
                showToast('Link enviado! Verifique seu e-mail.');
                btn.innerText = 'Enviado!';
            }
        }

        function logout() {
            db.auth.signOut().then(() => window.location.reload());
        }

        // ========== DASHBOARD ==========
        async function loadProjects() {
            const { data } = await db.from('projects').select('*, versions(status, total_value, version_number, items)').eq('user_id', state.user.id).order('created_at', { ascending: false });
            state.projectsCache = data || [];
        }

        function renderDashboardKPIs() {
            let totalRev = 0, totalApr = 0, countSent = 0, countNeg = 0, countDraft = 0;
            state.projectsCache.forEach(p => {
                const v = p.versions?.[0] || { total_value: 0, status: 'draft' };
                totalRev += parseFloat(v.total_value) || 0;
                if (v.status === 'approved') totalApr += parseFloat(v.total_value) || 0;
                if (v.status === 'sent') countSent++;
                if (v.status === 'negotiating') countNeg++;
                if (v.status === 'draft') countDraft++;
            });
            safeText('kpi-total-apr', formatPrice(totalApr));
            safeText('kpi-total-est', formatPrice(totalRev));
            safeText('kpi-count-sent', countSent);
            safeText('kpi-count-neg', countNeg);
            safeText('kpi-count-open', countDraft);
        }

        function setChartPeriod(days) {
            chartPeriod = days;
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline');
            });
            const active = document.querySelector(`.period-btn[data-period="${days}"]`);
            if (active) {
                active.classList.remove('btn-outline');
                active.classList.add('btn-primary');
            }
            renderDashboardCharts();
        }

        function renderDashboardCharts() {
            const ctx = document.getElementById('dashboardChart');
            if (!ctx) return;
            if (chartInstance) chartInstance.destroy();

            const days = {};
            for (let i = chartPeriod - 1; i >= 0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                days[d.toLocaleDateString('pt-BR').slice(0,5)] = { count: 0, total: 0 };
            }
            state.projectsCache.forEach(p => {
                const created = new Date(p.created_at);
                const diff = Math.ceil((new Date() - created) / (1000*60*60*24));
                if (diff <= chartPeriod) {
                    const key = created.toLocaleDateString('pt-BR').slice(0,5);
                    if (days[key]) {
                        days[key].count++;
                        days[key].total += parseFloat(p.versions?.[0]?.total_value) || 0;
                    }
                }
            });

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(days),
                    datasets: [
                        { label: 'Orçamentos', data: Object.values(days).map(d => d.count), backgroundColor: '#3b82f6', yAxisID: 'y' },
                        { label: 'Valor (R$)', data: Object.values(days).map(d => d.total), type: 'line', borderColor: '#10b981', backgroundColor: 'transparent', tension: 0.3, yAxisID: 'y1' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true }, y1: { position: 'right', beginAtZero: true, grid: { drawOnChartArea: false } } }
                }
            });
        }

        function renderActivityFeed() {
            const feed = document.getElementById('activity-feed');
            let activities = [];
            state.projectsCache.forEach(p => {
                p.versions?.forEach(v => {
                    if (v.items?.history) {
                        v.items.history.forEach(h => {
                            if (h.user === 'client') activities.push({ ...h, projectName: p.name });
                        });
                    }
                });
            });
            activities.sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0,10);
            if (!activities.length) {
                feed.innerHTML = '<div class="text-center text-slate-400 py-4">Nenhuma atividade recente</div>';
                return;
            }
            feed.innerHTML = activities.map(a => `
                <div class="flex items-start gap-3 border-b pb-3">
                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600"><i class="fas fa-user"></i></div>
                    <div>
                        <p class="font-medium">${a.projectName}</p>
                        <p class="text-sm text-slate-500">${a.detail || a.action}</p>
                        <p class="text-xs text-slate-400">${new Date(a.date).toLocaleString()}</p>
                    </div>
                </div>
            `).join('');
        }

        // ========== PROJETOS ==========
        function renderProjectCards() {
            const container = document.getElementById('project-cards-container');
            const search = safeVal('project-search').toLowerCase();
            const filter = safeVal('project-status-filter') || 'all';
            const filtered = state.projectsCache.filter(p => {
                const v = p.versions?.[0] || { status: 'draft' };
                return (filter === 'all' || v.status === filter) && (p.name.toLowerCase().includes(search) || (p.client_name||'').toLowerCase().includes(search));
            });
            if (!filtered.length) {
                container.innerHTML = '<div class="col-span-full text-center py-20 text-slate-400 border-2 border-dashed rounded-xl">Nenhum orçamento encontrado.</div>';
                return;
            }
            container.innerHTML = filtered.map(p => {
                const v = p.versions?.[0] || { total_value: 0, status: 'draft', version_number: 1 };
                const statusClass = {
                    draft: 'badge-draft', sent: 'badge-sent', negotiating: 'badge-negotiating', approved: 'badge-approved', canceled: 'badge-canceled'
                }[v.status] || 'badge-draft';
                const statusLabel = { draft:'Rascunho', sent:'Aguardando', negotiating:'Negociação', approved:'Aprovado', canceled:'Cancelado' }[v.status] || 'Rascunho';
                return `
                <div onclick="openProject('${p.id}')" class="card p-5 cursor-pointer hover:border-primary transition">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-700 font-bold">${(p.client_name||'N').charAt(0)}</div>
                        <div class="flex-1">
                            <h3 class="font-bold text-lg">${p.name}</h3>
                            <p class="text-sm text-slate-500">${p.client_name || 'Novo cliente'}</p>
                        </div>
                        <span class="badge ${statusClass}">${statusLabel}</span>
                    </div>
                    <div class="mt-4 flex justify-between items-end">
                        <span class="text-xs text-slate-400">V${v.version_number} • ${new Date(p.created_at).toLocaleDateString()}</span>
                        <span class="text-xl font-bold text-slate-900">${formatPrice(v.total_value)}</span>
                    </div>
                </div>`;
            }).join('');
        }

        async function createProject() {
            const name = prompt('Nome do orçamento:');
            if (!name) return;
            const { data: p, error } = await db.from('projects').insert({ name, user_id: state.user.id, client_name: 'Novo cliente' }).select().single();
            if (error) return showToast(error.message, 'error');
            const defaultData = { client: {}, location: { sameAsClient: true }, items: [], terms: {}, settings: {}, history: [{ date: new Date(), action: 'created', user: 'provider' }], attachments: [] };
            await db.from('versions').insert({ project_id: p.id, version_number: 1, items: defaultData, total_value: 0, status: 'draft' });
            openProject(p.id);
        }

        function openProject(id) {
            window.history.pushState(null, '', `?view=editor&id=${id}`);
            loadEditor(id).then(() => switchTab('editor', false));
        }

        // ========== EDITOR ==========
        function normalizeData(dbData) {
            const schema = { 
                client: { name: '', doc: '', email: '', phone: '', address: '' }, 
                location: { address: '', sameAsClient: true }, 
                items: [], 
                terms: { paymentMode: 'custom', paymentText: '', deadline: '', validity: '', obs: '' },
                settings: { providerName: '', providerDoc: '', providerAddr: '', providerPhone: '' },
                history: [],
                attachments: [],
                signature: null 
            };
            if (!dbData) return JSON.parse(JSON.stringify(schema));
            let rawItems = Array.isArray(dbData.items) ? dbData.items : (dbData.scope || []);
            const cleanItems = rawItems.map(i => ({ 
                id: i.id || 'item_' + Math.random().toString(36).substr(2, 9), 
                name: i.name || '', 
                description: i.description || '', 
                qty: parseFloat(i.qty) || 1, 
                price: parseFloat(i.price) || 0, 
                type: i.type || 'original',
                optional: i.optional || false,
                publicSelected: i.publicSelected || false 
            }));
            let attachments = Array.isArray(dbData.attachments) ? dbData.attachments : [];
            attachments = attachments.map(a => ({
                name: a.name || '',
                url: a.url || '',
                type: a.type || 'file',
                description: a.description || ''
            }));
            return { 
                client: { ...schema.client, ...(dbData.client || {}) }, 
                location: { ...schema.location, ...(dbData.location || {}) }, 
                items: cleanItems, 
                terms: { ...schema.terms, ...(dbData.terms || {}) }, 
                settings: { ...schema.settings, ...(dbData.settings || {}) }, 
                history: Array.isArray(dbData.history) ? dbData.history : [],
                attachments: attachments,
                signature: dbData.signature || null
            };
        }

        async function loadEditor(id) {
            const { data: proj } = await db.from('projects').select('*').eq('id', id).single();
            state.project = proj;
            const { data: vers } = await db.from('versions').select('*').eq('project_id', id).order('version_number', { ascending: true });
            state.version = vers[vers.length - 1];
            state.data = normalizeData(state.version.items);
            state.snapshot = JSON.parse(JSON.stringify(state.data.items));
            state.previousData = null;
            if (state.version.version_number > 1 && vers[vers.length - 2]) {
                state.previousData = normalizeData(vers[vers.length - 2].items);
            }
            renderEditor();
        }

        function renderEditor() {
            const d = state.data; 
            const isLocked = state.version.status !== 'draft';
            safeText('ed-title', state.project.name);
            safeText('ed-ver', `V${state.version.version_number}`);
            const badge = document.getElementById('ed-status-badge');
            if(badge) {
                badge.className = `badge ${
                    state.version.status === 'approved' ? 'badge-approved' : 
                    state.version.status === 'canceled' ? 'badge-canceled' : 
                    state.version.status === 'negotiating' ? 'badge-negotiating' : 
                    state.version.status === 'sent' ? 'badge-sent' : 
                    'badge-draft'
                }`;
                badge.innerText = 
                    state.version.status === 'draft' ? 'RASCUNHO' : 
                    state.version.status === 'sent' ? 'AGUARDANDO' : 
                    state.version.status.toUpperCase();
            }
            setVal('p-name', d.settings.providerName);
            setVal('p-doc', d.settings.providerDoc);
            setVal('p-addr', d.settings.providerAddr);
            setVal('p-phone', d.settings.providerPhone);
            setVal('c-name', d.client.name);
            setVal('c-doc', d.client.doc);
            setVal('c-phone', d.client.phone);
            setVal('c-email', d.client.email);
            setVal('c-addr', d.client.address);
            setVal('t-deadline', d.terms.deadline); 
            setVal('t-val', d.terms.validity); 
            setVal('t-obs', d.terms.paymentText || d.terms.obs);
            const locCheck = document.getElementById('loc-check');
            if(locCheck) locCheck.checked = d.location.sameAsClient;
            const locDiv = document.getElementById('loc-custom-div');
            if(locDiv) locDiv.style.display = d.location.sameAsClient ? 'none' : 'block';
            setVal('loc-addr', d.location.address);
            
            // Desabilitar se bloqueado
            const inputs = ['p-name','p-doc','p-addr','p-phone','c-name','c-doc','c-phone','c-email','c-addr','client-search-input','loc-check','loc-addr','t-deadline','t-val','t-obs','pay-mode'];
            inputs.forEach(id => { const el = document.getElementById(id); if(el) el.disabled = isLocked; });
            
            const headerActions = document.getElementById('ed-actions-header');
            if (headerActions) {
                if (isLocked) {
                    headerActions.innerHTML = `<button onclick="createAddon()" class="btn-outline"><i class="fas fa-copy mr-2"></i>Revisão V${state.version.version_number + 1}</button>`;
                } else {
                    headerActions.innerHTML = `<button onclick="save()" class="btn-primary"><i class="fas fa-save mr-2"></i>Salvar</button>`;
                }
            }
            renderItems();
            renderAttachments();
            renderHistory();
            updateTotal();
        }

        function renderItems() {
            const isLocked = state.version.status !== 'draft';
            const d = state.data;
            let html = ''; 
            let total = 0, totalOpt = 0;
            d.items.forEach((i, x) => {
                const t = (i.qty||0)*(i.price||0); 
                if(!i.optional) total += t;
                else totalOpt += t;
                let diffHtml = '';
                let cardClass = i.optional ? 'item-optional' : '';
                if (state.previousData) {
                    const oldItem = state.previousData.items.find(old => old.id === i.id);
                    if (!oldItem) {
                        cardClass += ' item-new';
                        diffHtml = `<div class="diff-box"><span class="diff-tag">NOVO</span> Item adicionado.</div>`;
                    } else {
                        let changes = [];
                        if (oldItem.price !== i.price) changes.push(`Preço: ${formatPrice(oldItem.price)} → ${formatPrice(i.price)}`);
                        if (oldItem.qty !== i.qty) changes.push(`Qtd: ${oldItem.qty} → ${i.qty}`);
                        if (changes.length > 0) {
                            cardClass += ' item-modified';
                            diffHtml = `<div class="diff-box"><span class="diff-tag">ALTERADO</span> ${changes.join('; ')}</div>`;
                        }
                    }
                }
                html += `
                <div class="item-box ${cardClass} group">
                    ${!isLocked ? `<button onclick="rmItem(${x})" class="absolute top-2 right-2 text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100"><i class="fas fa-trash"></i></button>` : ''}
                    <div class="grid grid-cols-12 gap-4 mb-2">
                        <div class="col-span-8">
                            <label class="text-[10px] font-bold text-gray-400 uppercase flex items-center">
                                Item 
                                ${i.optional ? '<span class="optional-badge ml-2">Opcional</span>' : ''}
                            </label>
                            <input class="w-full font-bold bg-transparent outline-none border-b border-transparent focus:border-blue-200" placeholder="Nome do Item..." value="${i.name}" oninput="upItem(${x},'name',this.value)" ${isLocked?'disabled':''}>
                        </div>
                        <div class="col-span-2">
                            <label class="text-[10px] font-bold text-gray-400 uppercase text-center block">Qtd</label>
                            <input type="number" class="w-full bg-slate-50 border rounded text-center text-xs p-1" value="${i.qty}" onchange="upItem(${x},'qty',this.value)" ${isLocked?'disabled':''}>
                        </div>
                        <div class="col-span-2">
                            <label class="text-[10px] font-bold text-gray-400 uppercase text-right block">R$</label>
                            <input type="text" class="w-full bg-slate-50 border rounded text-right text-xs p-1 price-input" value="${formatPrice(i.price)}" oninput="applyPriceMask(this, ${x})" data-index="${x}" ${isLocked?'disabled':''}>
                        </div>
                    </div>
                    <textarea class="w-full bg-transparent text-xs text-slate-500 resize-none outline-none border-t border-dashed pt-2 mt-2" rows="2" placeholder="Descrição técnica..." oninput="upItem(${x},'description',this.value)" ${isLocked?'disabled':''}>${i.description||''}</textarea>
                    ${!isLocked ? `
                        <button onclick="toggleOpt(${x})" class="text-[10px] mt-2 px-2 py-1 rounded border ${i.optional ? 'bg-slate-600 text-white border-slate-600' : 'text-slate-400 border-slate-200 hover:border-slate-400'}">
                            ${i.optional ? 'ITEM OPCIONAL' : 'Marcar como Opcional?'}
                        </button>
                    ` : ''}
                    ${diffHtml}
                </div>`;
            });
            setHTML('ed-items', html);
            updateTotal();
        }

        function upItem(i,f,v) { 
            const it = state.data.items[i]; 
            if(f === 'qty') { 
                it[f] = parseFloat(v) || 0; 
                updateTotal(); 
            } else if (f === 'price') {
                // não usado diretamente
            } else { 
                it[f] = v; 
            }
        }

        function applyPriceMask(input, index) {
            let value = input.value;
            let digits = value.replace(/\D/g, '');
            if (digits.length === 0) {
                input.value = '';
                state.data.items[index].price = 0;
                updateTotal();
                return;
            }
            let numericValue = parseInt(digits) / 100;
            state.data.items[index].price = numericValue;
            input.value = formatPrice(numericValue);
            updateTotal();
        }

        function toggleOpt(i) { 
            state.data.items[i].optional = !state.data.items[i].optional; 
            renderItems(); 
            updateTotal(); 
        }

        function addItem() { 
            if(!Array.isArray(state.data.items)) state.data.items = [];
            state.data.items.push({ 
                id: 'item_' + Date.now() + Math.random(), 
                name: '', 
                description: '', 
                qty: 1, 
                price: 0, 
                type: state.version?.version_number > 1 ? 'addon' : 'original', 
                optional: false 
            }); 
            renderItems(); 
        }

        function rmItem(i) { 
            if(confirm("Remover este item?")) { 
                state.data.items.splice(i, 1); 
                renderItems(); 
                updateTotal(); 
            } 
        }

        function updateTotal() { 
            const total = state.data.items.reduce((a,b)=> !b.optional ? a + (b.qty*b.price) : a, 0);
            document.getElementById('ed-total').innerText = formatPrice(total);
            const totalOpt = state.data.items.reduce((a,b)=> b.optional ? a + (b.qty*b.price) : a, 0);
            const optDiv = document.getElementById('ed-total-optional');
            if (optDiv) {
                optDiv.innerText = totalOpt > 0 ? `+ ${formatPrice(totalOpt)} em opcionais` : '';
            }
        }

        function upVal(k,v) { 
            if (k.startsWith('c-')) {
                if (k === 'c-addr') {
                    state.data.client.address = v;
                } else {
                    state.data.client[k.substring(2)] = v;
                }
            } else if (k.startsWith('t-')) {
                if (k === 't-obs') {
                    state.data.terms.paymentText = v;
                } else if (k === 't-val') {
                    state.data.terms.validity = v;
                } else {
                    state.data.terms[k.substring(2)] = v;
                }
            }
        }

        function upSettings(k,v) { 
            state.data.settings[k] = v; 
        }

        function toggleLoc(checked) { 
            state.data.location.sameAsClient = checked; 
            const locDiv = document.getElementById('loc-custom-div');
            if(locDiv) locDiv.style.display = checked ? 'none' : 'block';
        }

        function upLoc(v) { state.data.location.address = v; }

        function generatePayment() {
            const total = state.data.items.reduce((acc, i) => (!i.optional ? acc + (i.qty * i.price) : acc), 0);
            if(total === 0) return alert("Adicione valores (não opcionais) primeiro.");
            const mode = document.getElementById('pay-mode').value;
            let text = "";
            if(mode === 'entry_installments') {
                const entryP = prompt("Porcentagem de Entrada? (Ex: 30)", "30");
                const inst = prompt("Restante em quantas vezes?", "2");
                if(!entryP || !inst) return;
                const entryVal = total * (parseInt(entryP)/100);
                const restVal = (total - entryVal) / parseInt(inst);
                text = `CRONOGRAMA:\n1. Entrada: ${formatPrice(entryVal)}\n`;
                for(let i=1; i<=parseInt(inst); i++) text += `${i+1}. Parcela (30d): ${formatPrice(restVal)}\n`;
            } 
            else if(mode === 'no_entry_installments') {
                const inst = prompt("Número de parcelas?", "3");
                if(!inst) return;
                const parcelValue = total / parseInt(inst);
                text = `PAGAMENTO PARCELADO SEM ENTRADA:\n`;
                for(let i=1; i<=parseInt(inst); i++) text += `${i}. Parcela (30d): ${formatPrice(parcelValue)}\n`;
            }
            else {
                text = `Pagamento Único: ${formatPrice(total)}`;
            }
            state.data.terms.paymentText = text;
            setVal('t-obs', text);
        }

        async function handleUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            if (file.size > 5 * 1024 * 1024) return alert("Arquivo muito grande! Máximo 5MB.");
            const ext = file.name.split('.').pop().toLowerCase();
            if(!['pdf','png','jpg','jpeg'].includes(ext)) return alert("Formato não permitido. Use PDF, PNG ou JPG.");
            const label = document.getElementById('upload-label');
            const originalText = label.innerHTML;
            label.innerText = "Enviando...";
            try {
                const path = `${state.project.id}/${Date.now()}_${file.name}`;
                const { error } = await db.storage.from('attachments').upload(path, file);
                if (error) throw error;
                const { data: pubData } = db.storage.from('attachments').getPublicUrl(path);
                if (!state.data.attachments) state.data.attachments = [];
                state.data.attachments.push({ 
                    name: file.name, 
                    url: pubData.publicUrl, 
                    type: ext,
                    description: '' 
                });
                await save();
                renderAttachments();
            } catch (err) {
                alert("Erro no upload: " + err.message);
            } finally {
                label.innerHTML = originalText;
                e.target.value = '';
            }
        }

        function deleteAttachment(idx) {
            if(!confirm("Remover este anexo?")) return;
            state.data.attachments.splice(idx, 1);
            save().then(() => renderAttachments());
        }

        function updateAttachmentDescription(idx, desc) {
            state.data.attachments[idx].description = desc;
            clearTimeout(window.descTimeout);
            window.descTimeout = setTimeout(() => save(), 800);
        }

        function renderAttachments() {
            const attachList = document.getElementById('ed-attachments-list');
            if (!attachList) return;
            const isLocked = state.version.status !== 'draft';
            let attHtml = '';
            if (state.data.attachments && state.data.attachments.length > 0) {
                state.data.attachments.forEach((att, idx) => {
                    let icon = att.type === 'pdf' ? 'fa-file-pdf text-red-500' : 'fa-file-image text-blue-500';
                    attHtml += `<div class="flex flex-col bg-white border p-3 rounded mb-2 text-sm">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2 overflow-hidden">
                                <i class="fas ${icon}"></i> 
                                <span class="truncate font-medium">${att.name}</span>
                            </div>
                            <div class="flex gap-2">
                                <a href="${att.url}" target="_blank" class="text-blue-500 hover:text-blue-700"><i class="fas fa-eye"></i></a>
                                ${!isLocked ? `<button onclick="deleteAttachment(${idx})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>` : ''}
                            </div>
                        </div>
                        <div class="mt-2">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Descrição</label>
                            ${!isLocked 
                                ? `<input type="text" class="w-full border-0 border-b border-slate-200 bg-transparent text-xs p-1 focus:border-blue-500 focus:ring-0" 
                                    value="${att.description || ''}" 
                                    placeholder="Ex: Nota fiscal, memorial..."
                                    onchange="updateAttachmentDescription(${idx}, this.value);">`
                                : `<p class="text-xs text-slate-600 mt-1">${att.description || '—'}</p>`
                            }
                        </div>
                    </div>`;
                });
            } else {
                attHtml = '<div class="text-xs text-slate-400 italic text-center py-2">Nenhum arquivo anexado.</div>';
            }
            attachList.innerHTML = attHtml;
        }

        function logHistory(action, user, detail) {
            if (!state.data.history) state.data.history = [];
            state.data.history.push({ date: new Date().toISOString(), action, user, detail });
        }

        function getChanges(oldArr, newArr) {
            let logs = [];
            const oldMap = new Map(oldArr.map(i => [i.id, i]));
            const newMap = new Map(newArr.map(i => [i.id, i]));
            newArr.forEach(i => {
                if(!oldMap.has(i.id)) logs.push(`Adicionou: ${i.name}`);
                else {
                    const old = oldMap.get(i.id);
                    if(old.name !== i.name) logs.push(`Renomeou: ${old.name} -> ${i.name}`);
                    if(old.price !== i.price || old.qty !== i.qty) logs.push(`Alterou valor/qtd: ${i.name}`);
                }
            });
            oldArr.forEach(i => { if(!newMap.has(i.id)) logs.push(`Removeu: ${i.name}`); });
            return logs.length ? logs.join('; ') : null;
        }

        async function save() {
            const t = state.data.items.reduce((a,b)=> (!b.optional ? a+(b.qty*b.price) : a),0);
            const changes = getChanges(state.snapshot, state.data.items);
            if(changes) {
                logHistory('edited', 'provider', changes);
                state.snapshot = JSON.parse(JSON.stringify(state.data.items)); 
            }
            if(state.data.client.name) {
                await db.from('projects').update({client_name: state.data.client.name}).eq('id', state.project.id);
            }
            await db.from('versions').update({
                items: state.data, 
                total_value: t, 
                notes: state.data.terms.obs || state.data.terms.paymentText
            }).eq('id', state.version.id);
            renderHistory();
            showToast('Orçamento salvo!');
        }

        async function createAddon() {
            await save();
            if(!confirm("Criar nova versão (Aditivo)?")) return;
            const t = state.data.items.reduce((a,b)=> (!b.optional ? a+(b.qty*b.price) : a),0);
            logHistory('created', 'provider', `Criou nova versão V${state.version.version_number+1}.`);
            await db.from('versions').insert({
                project_id: state.project.id,
                version_number: state.version.version_number + 1,
                items: state.data,
                total_value: t,
                status: 'draft'
            });
            loadEditor(state.project.id);
        }

        async function changeStatus(newStatus, skipConfirm = false) {
            if (!skipConfirm && !confirm(`Mudar status para ${newStatus}?`)) return;
            await db.from('versions').update({status: newStatus}).eq('id', state.version.id);
            logHistory(newStatus, 'provider', skipConfirm ? 'Status alterado automaticamente (envio de link)' : 'Alteração manual de status.');
            await loadProjects();
            renderDashboardKPIs();
            renderDashboardCharts();
            renderProjectCards();
            renderActivityFeed();
            loadEditor(state.project.id);
        }

        async function openShareModal() {
            await save();
            if (state.version.status === 'draft') {
                await changeStatus('sent', true);
            }
            const url = `${window.location.origin}${window.location.pathname}?view=public&id=${state.version.id}`;
            const clientName = state.data.client.name ? ` ${state.data.client.name}` : '';
            const msg = `Olá${clientName}! Segue o link da proposta comercial para sua aprovação: ${url}`;
            document.getElementById('btn-share-wa').onclick = function() {
                let phone = (state.data.client.phone || '').replace(/\D/g, '');
                let link = `https://wa.me/${phone.length >= 10 ? '55' + phone : ''}?text=${encodeURIComponent(msg)}`;
                window.open(link, '_blank');
                document.getElementById('share-modal').classList.add('hidden');
            };
            document.getElementById('btn-share-copy').onclick = async function() {
                try {
                    await navigator.clipboard.writeText(url);
                    showToast('Link copiado!');
                } catch {
                    const textArea = document.createElement("textarea");
                    textArea.value = url;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand("copy");
                    document.body.removeChild(textArea);
                    showToast('Link copiado!');
                }
                document.getElementById('share-modal').classList.add('hidden');
            };
            show('share-modal');
        }

        function closeShareModal() {
            hide('share-modal');
        }

        function renderHistory() {
            const hist = state.data.history || [];
            let histHtml = '';
            if(hist.length > 0) {
                hist.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(h => {
                    const date = new Date(h.date).toLocaleString('pt-BR');
                    let icon = 'info-circle text-blue-400';
                    let actionLabel = 'Visualizou';
                    if (h.action === 'approved') { icon = 'check text-green-500'; actionLabel = 'Aprovou'; }
                    else if (h.action === 'change_request') { icon = 'comment-dots text-amber-500'; actionLabel = 'Solicitou alteração'; }
                    else if (h.action === 'canceled') { icon = 'times text-red-500'; actionLabel = 'Recusou'; }
                    else if (h.action === 'created') { icon = 'plus-circle text-blue-600'; actionLabel = 'Criou'; }
                    else if (h.action === 'edited') { icon = 'pen text-indigo-500'; actionLabel = 'Alterou'; }
                    else if (h.action === 'sent') { icon = 'paper-plane text-blue-500'; actionLabel = 'Enviou'; }
                    histHtml += `<div class="timeline-item">
                        <div class="text-xs text-slate-400">${date} • ${h.user === 'provider' ? 'Você' : 'Cliente'}</div>
                        <div class="font-bold text-sm text-slate-700 flex items-center gap-2 mt-1">
                            <i class="fas fa-${icon}"></i> ${actionLabel}
                        </div>
                        ${h.detail ? `<div class="diff-box mt-1">${h.detail}</div>` : ''}
                    </div>`;
                });
            } else {
                histHtml = '<div class="text-xs text-slate-400 italic">Sem histórico registrado.</div>';
            }
            setHTML('ed-history', histHtml);
        }

        // ========== CLIENTES ==========
        async function loadClients() {
            const { data } = await db.from('clients').select('*').eq('user_id', state.user.id).order('name');
            state.clientsCache = data || [];
        }

        function renderClients() {
            const tbody = document.getElementById('client-table-body');
            const search = safeVal('client-search').toLowerCase();
            const filtered = state.clientsCache.filter(c => c.name.toLowerCase().includes(search) || (c.doc && c.doc.includes(search)));
            if (!filtered.length) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-slate-400">Nenhum cliente</td></tr>';
                return;
            }
            tbody.innerHTML = filtered.map(c => `<tr>
                <td class="p-2 font-bold">${c.name}</td>
                <td class="p-2">${c.doc || '-'}</td>
                <td class="p-2">${c.phone || '-'}</td>
                <td class="p-2">${c.email || '-'}</td>
                <td class="p-2">
                    <button onclick="editClient('${c.id}')" class="text-blue-600 mr-2"><i class="fas fa-edit"></i></button>
                    <button onclick="deleteClient('${c.id}')" class="text-red-600"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`).join('');
        }

        function openClientModal(fromEditor = false) {
            document.getElementById('client-modal').classList.remove('hidden');
            document.getElementById('client-modal-title').innerText = 'Novo Cliente';
            document.getElementById('client-id').value = '';
            setVal('client-name',''); setVal('client-doc',''); setVal('client-phone',''); setVal('client-email',''); setVal('client-addr','');
            window.__clientModalCallback = fromEditor ? (client) => selectClient(client.id) : null;
        }

        function closeClientModal() {
            document.getElementById('client-modal').classList.add('hidden');
            window.__clientModalCallback = null;
        }

        async function saveClient() {
            const id = document.getElementById('client-id').value;
            const name = safeVal('client-name').trim();
            if (!name) return showToast('Nome obrigatório', 'error');
            const clientData = {
                name, doc: safeVal('client-doc'), phone: safeVal('client-phone'), email: safeVal('client-email'), address: safeVal('client-addr'),
                user_id: state.user.id
            };
            if (id) {
                const { error } = await db.from('clients').update(clientData).eq('id', id);
                if (error) return showToast(error.message, 'error');
            } else {
                const { error } = await db.from('clients').insert(clientData);
                if (error) return showToast(error.message, 'error');
            }
            await loadClients();
            renderClients();
            closeClientModal();
            showToast('Cliente salvo');
            if (window.__clientModalCallback) {
                const newClient = state.clientsCache.find(c => c.name === name);
                if (newClient) window.__clientModalCallback(newClient);
                window.__clientModalCallback = null;
            }
        }

        async function editClient(id) {
            const c = state.clientsCache.find(c => c.id === id);
            if (!c) return;
            document.getElementById('client-modal').classList.remove('hidden');
            document.getElementById('client-modal-title').innerText = 'Editar Cliente';
            document.getElementById('client-id').value = c.id;
            setVal('client-name', c.name);
            setVal('client-doc', c.doc || '');
            setVal('client-phone', c.phone || '');
            setVal('client-email', c.email || '');
            setVal('client-addr', c.address || '');
        }

        async function deleteClient(id) {
            if (!confirm('Excluir cliente?')) return;
            const { error } = await db.from('clients').delete().eq('id', id);
            if (error) return showToast(error.message, 'error');
            await loadClients();
            renderClients();
            showToast('Cliente excluído');
        }

        function searchClients() {
            const input = document.getElementById('client-search-input');
            const query = input.value.toLowerCase();
            const suggestions = document.getElementById('client-suggestions');
            if (query.length < 2) {
                suggestions.classList.add('hidden');
                return;
            }
            const results = state.clientsCache.filter(c => c.name.toLowerCase().includes(query)).slice(0,5);
            if (!results.length) {
                suggestions.classList.add('hidden');
                return;
            }
            suggestions.innerHTML = results.map(c => `<div class="p-2 hover:bg-slate-100 cursor-pointer" onclick="selectClient('${c.id}')">${c.name}</div>`).join('');
            suggestions.classList.remove('hidden');
        }

        function selectClient(id) {
            const c = state.clientsCache.find(c => c.id === id);
            if (!c) return;
            setVal('c-name', c.name);
            setVal('c-doc', c.doc || '');
            setVal('c-phone', c.phone || '');
            setVal('c-email', c.email || '');
            setVal('c-addr', c.address || '');
            if (state.data) {
                state.data.client.name = c.name;
                state.data.client.doc = c.doc || '';
                state.data.client.phone = c.phone || '';
                state.data.client.email = c.email || '';
                state.data.client.address = c.address || '';
            }
            document.getElementById('client-search-input').value = '';
            document.getElementById('client-suggestions').classList.add('hidden');
        }

        // ========== CATÁLOGO ==========
        async function loadCatalog() {
            const { data } = await db.from('service_catalog').select('*').eq('user_id', state.user.id).order('name');
            state.catalogCache = data || [];
            updateCategoryFilters();
        }

        function updateCategoryFilters() {
            const categories = [...new Set(state.catalogCache.map(i => i.category).filter(c => c))];
            const filter = document.getElementById('catalog-category-filter');
            if (filter) filter.innerHTML = '<option value="">Todas</option>' + categories.map(c => `<option value="${c}">${c}</option>`).join('');
            const selectorFilter = document.getElementById('catalog-selector-category');
            if (selectorFilter) selectorFilter.innerHTML = '<option value="">Todas</option>' + categories.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function renderCatalogGrid() {
            const grid = document.getElementById('catalog-grid');
            const search = safeVal('catalog-search').toLowerCase();
            const cat = safeVal('catalog-category-filter');
            const filtered = state.catalogCache.filter(i => i.name.toLowerCase().includes(search) && (!cat || i.category === cat));
            if (!filtered.length) {
                grid.innerHTML = '<div class="col-span-full text-center py-12 text-slate-400">Nenhum serviço</div>';
                return;
            }
            grid.innerHTML = filtered.map(i => `
                <div class="card p-4">
                    <h3 class="font-bold">${i.name}</h3>
                    <p class="text-sm text-slate-500">${i.description || ''}</p>
                    <p class="text-lg font-bold mt-2">${i.price ? formatPrice(i.price) : '—'}</p>
                    ${i.category ? `<span class="badge badge-draft mt-2">${i.category}</span>` : ''}
                    <div class="flex gap-2 mt-4">
                        <button onclick="editCatalogItem('${i.id}')" class="text-blue-600"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteCatalogItem('${i.id}')" class="text-red-600"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function openCatalogModal(editId = null) {
            const modal = document.getElementById('catalog-modal');
            modal.classList.remove('hidden');
            if (editId) {
                const i = state.catalogCache.find(i => i.id === editId);
                if (i) {
                    document.getElementById('catalog-modal-title').innerText = 'Editar Serviço';
                    document.getElementById('catalog-id').value = i.id;
                    setVal('catalog-name', i.name);
                    setVal('catalog-description', i.description || '');
                    setVal('catalog-price', i.price || '');
                    setVal('catalog-category', i.category || '');
                }
            } else {
                document.getElementById('catalog-modal-title').innerText = 'Novo Serviço';
                document.getElementById('catalog-id').value = '';
                setVal('catalog-name', '');
                setVal('catalog-description', '');
                setVal('catalog-price', '');
                setVal('catalog-category', '');
            }
        }

        function closeCatalogModal() {
            document.getElementById('catalog-modal').classList.add('hidden');
        }

        async function saveCatalogItem() {
            const id = document.getElementById('catalog-id').value;
            const name = safeVal('catalog-name').trim();
            if (!name) return showToast('Nome obrigatório', 'error');
            const data = {
                name, description: safeVal('catalog-description'), price: parseFloat(safeVal('catalog-price')) || null, category: safeVal('catalog-category') || null,
                user_id: state.user.id
            };
            if (id) {
                const { error } = await db.from('service_catalog').update(data).eq('id', id);
                if (error) return showToast(error.message, 'error');
            } else {
                const { error } = await db.from('service_catalog').insert(data);
                if (error) return showToast(error.message, 'error');
            }
            await loadCatalog();
            renderCatalogGrid();
            closeCatalogModal();
            showToast('Serviço salvo');
        }

        async function editCatalogItem(id) {
            openCatalogModal(id);
        }

        async function deleteCatalogItem(id) {
            if (!confirm('Excluir serviço?')) return;
            const { error } = await db.from('service_catalog').delete().eq('id', id);
            if (error) return showToast(error.message, 'error');
            await loadCatalog();
            renderCatalogGrid();
            showToast('Serviço excluído');
        }

        // ========== SELETOR CATÁLOGO ==========
        let selectedCatalogIds = new Set();

        function openCatalogSelector() {
            if (state.version.status !== 'draft') return showToast('Orçamento bloqueado', 'error');
            selectedCatalogIds.clear();
            renderCatalogSelector();
            show('catalog-selector-modal');
        }

        function closeCatalogSelector() {
            hide('catalog-selector-modal');
        }

        function renderCatalogSelector() {
            const list = document.getElementById('catalog-selector-list');
            const search = document.getElementById('catalog-selector-search')?.value.toLowerCase() || '';
            const cat = document.getElementById('catalog-selector-category')?.value || '';
            const filtered = state.catalogCache.filter(i => i.name.toLowerCase().includes(search) && (!cat || i.category === cat));
            if (!filtered.length) {
                list.innerHTML = '<div class="text-center p-4 text-slate-400">Nenhum serviço</div>';
                return;
            }
            list.innerHTML = filtered.map(i => `
                <div class="flex items-center gap-3 p-2 border-b">
                    <input type="checkbox" id="sel_${i.id}" onchange="toggleCatalogSelect('${i.id}')" class="w-5 h-5">
                    <label for="sel_${i.id}" class="flex-1 cursor-pointer">
                        <span class="font-bold">${i.name}</span>
                        ${i.price ? `<span class="text-sm text-slate-500 ml-2">${formatPrice(i.price)}</span>` : ''}
                    </label>
                </div>
            `).join('');
        }

        function toggleCatalogSelect(id) {
            if (selectedCatalogIds.has(id)) selectedCatalogIds.delete(id);
            else selectedCatalogIds.add(id);
        }

        function importSelectedCatalogItems() {
            if (selectedCatalogIds.size === 0) return showToast('Nenhum item selecionado', 'error');
            const selected = state.catalogCache.filter(i => selectedCatalogIds.has(i.id));
            selected.forEach(i => {
                state.data.items.push({
                    id: 'item_' + Date.now() + Math.random(),
                    name: i.name,
                    description: i.description || '',
                    qty: 1,
                    price: i.price || 0,
                    type: 'original',
                    optional: false,
                    publicSelected: false
                });
            });
            renderItems();
            closeCatalogSelector();
            showToast(`${selected.length} item(s) adicionado(s)`);
        }

        // ========== COMPARTILHAR CATÁLOGO ==========
        function openShareCatalogModal() {
            const link = `${window.location.origin}${window.location.pathname}?view=public-catalog&user=${state.user.id}`;
            document.getElementById('catalog-share-link').innerText = link;
            show('share-catalog-modal');
        }

        function closeShareCatalogModal() {
            hide('share-catalog-modal');
        }

        function copyCatalogLink() {
            const link = document.getElementById('catalog-share-link').innerText;
            navigator.clipboard.writeText(link).then(() => showToast('Link copiado!'));
        }

        function shareCatalogViaWhatsApp() {
            const link = document.getElementById('catalog-share-link').innerText;
            const msg = `Confira meu catálogo de serviços: ${link}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }

        // ========== TEMPLATES ==========
        async function loadTemplates() {
            const { data } = await db.from('templates').select('*').eq('user_id', state.user.id);
            state.templates = data || [];
            renderTemplates();
        }

        function renderTemplates() {
            const grid = document.getElementById('templates-grid');
            if (!grid) return;
            if (!state.templates.length) {
                grid.innerHTML = '<div class="col-span-full text-center py-12 text-slate-400">Nenhum template criado.</div>';
                return;
            }
            grid.innerHTML = state.templates.map(t => `
                <div class="card p-5">
                    <h3 class="font-bold">${t.name}</h3>
                    <p class="text-sm text-slate-500 mt-1">${t.description || ''}</p>
                    <button onclick="useTemplate('${t.id}')" class="mt-4 btn-primary w-full">Usar template</button>
                </div>
            `).join('');
        }

        function openTemplateModal() {
            show('template-modal');
        }

        function closeTemplateModal() {
            hide('template-modal');
        }

        async function saveTemplate() {
            const name = safeVal('template-name');
            if (!name) return showToast('Nome obrigatório', 'error');
            const desc = safeVal('template-desc');
            const items = state.data?.items || [];
            const { error } = await db.from('templates').insert({ name, description: desc, user_id: state.user.id, items });
            if (error) showToast(error.message, 'error');
            else { showToast('Template salvo'); closeTemplateModal(); loadTemplates(); }
        }

        async function useTemplate(id) {
            const tmpl = state.templates.find(t => t.id === id);
            if (!tmpl) return;
            if (!state.data) state.data = { items: [] };
            tmpl.items.forEach(i => {
                state.data.items.push({ ...i, id: 'item_' + Date.now() + Math.random() });
            });
            renderItems();
            showToast('Template aplicado');
        }

        // ========== RELATÓRIOS ==========
        function renderReports() {
            const ctxPie = document.getElementById('reportsPieChart')?.getContext('2d');
            if (ctxPie) {
                const counts = { draft:0, sent:0, negotiating:0, approved:0, canceled:0 };
                state.projectsCache.forEach(p => {
                    const status = p.versions?.[0]?.status || 'draft';
                    counts[status] = (counts[status] || 0) + 1;
                });
                new Chart(ctxPie, {
                    type: 'pie',
                    data: {
                        labels: ['Rascunho','Aguardando','Negociação','Aprovado','Cancelado'],
                        datasets: [{ data: Object.values(counts), backgroundColor: ['#94a3b8','#3b82f6','#f59e0b','#10b981','#ef4444'] }]
                    }
                });
            }
            const tbody = document.getElementById('reports-table-body');
            if (tbody) {
                tbody.innerHTML = state.projectsCache.slice(0,10).map(p => {
                    const v = p.versions?.[0] || {};
                    return `<tr><td class="p-2">${p.name}</td><td>${p.client_name}</td><td>${formatPrice(v.total_value)}</td><td><span class="badge badge-${v.status}">${v.status}</span></td><td>${new Date(p.created_at).toLocaleDateString()}</td></tr>`;
                }).join('');
            }
        }

        // ========== PÁGINA PÚBLICA (PROPOSTA) ==========
        async function loadPublicProposal(id) {
            try {
                show('public-loading');
                hide('public-content');
                const { data: v, error } = await db.from('versions').select('*, projects(name)').eq('id', id).maybeSingle();
                if (error || !v) throw new Error("Orçamento não encontrado.");
                state.version = v; 
                state.data = normalizeData(v.items);
                const d = state.data;
                if(v.status === 'approved') {
                    document.getElementById('stamp-approved').style.display = 'block';
                } else {
                    document.getElementById('stamp-approved').style.display = 'none';
                }
                safeText('doc-title', v.projects?.name);
                safeText('doc-id', `#${v.project_id ? v.project_id.substr(0,4).toUpperCase() : 'XXXX'}-${v.version_number}`);
                safeText('doc-c-name', d.client.name);
                safeText('doc-c-doc', d.client.doc);
                const finalAddr = d.location.sameAsClient ? d.client.address : (d.location.address || 'Não informado');
                safeText('doc-c-addr', finalAddr);
                renderPublicItems(); 
                safeText('doc-payment', d.terms.paymentText || '—'); 
                safeText('doc-deadline', d.terms.deadline || 'Não informado'); 
                safeText('doc-validity', d.terms.validity); 
                safeText('doc-obs', d.terms.obs);
                if(d.attachments && d.attachments.length > 0) {
                    let attHtml = '<h3 class="font-bold text-xs uppercase text-slate-400 mb-2">Documentos Anexos</h3>';
                    d.attachments.forEach(att => {
                        let icon = att.type === 'pdf' ? 'fa-file-pdf text-red-500' : 'fa-file-image text-blue-500';
                        attHtml += `<div class="flex items-center gap-3 border p-3 rounded mt-2"><i class="fas ${icon}"></i><span class="text-sm">${att.name}</span><a href="${att.url}" target="_blank" class="text-blue-500 ml-auto"><i class="fas fa-eye"></i></a></div>`;
                    });
                    setHTML('doc-attachments-area', attHtml);
                } else {
                    setHTML('doc-attachments-area', '');
                }
                if (d.signature) {
                    setHTML('doc-signature-area', `<div class="mt-8 border-t pt-4"><img src="${d.signature}" class="h-16 mb-2"><p class="text-xs text-slate-500">Assinado digitalmente</p></div>`);
                }
                const actions = document.getElementById('doc-actions');
                if(actions) {
                    if(v.status === 'approved' || v.status === 'canceled') {
                        showSuccessScreen(v.status);
                        return;
                    } else {
                        actions.innerHTML = `
                            <button onclick="openSignatureModal()" class="w-full btn-success py-4 text-lg">APROVAR PROPOSTA</button>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="openChangeModal()" class="btn-outline py-3">Solicitar Alteração</button>
                                <button onclick="openCancelModal()" class="btn-outline text-red-600 border-red-200 hover:bg-red-50">Recusar</button>
                            </div>
                        `;
                    }
                }
                hide('public-loading');
                show('public-content');
            } catch(e) { 
                hide('public-loading');
                showToast(e.message, 'error');
            }
        }

        function renderPublicItems() {
            let html = '';
            let total = 0;
            const items = state.data.items;
            const isFrozen = state.version.status !== 'sent' && state.version.status !== 'negotiating';
            items.forEach((i, idx) => {
                if(i.optional && typeof i.publicSelected === 'undefined') i.publicSelected = false;
                if (!i.optional || i.publicSelected) {
                    total += (i.qty * i.price);
                }
                html += `<tr class="border-b">
                    <td class="py-3 pl-4">
                        <div class="flex items-start gap-2">
                            ${i.optional && !isFrozen ? `<input type="checkbox" onchange="togglePublicOpt(${idx})" ${i.publicSelected ? 'checked' : ''} class="mt-1 w-5 h-5">` : ''}
                            ${i.optional && isFrozen ? (i.publicSelected ? '<i class="fas fa-check-square text-green-600 mt-1"></i>' : '<i class="far fa-square text-slate-400 mt-1"></i>') : ''}
                            <div>
                                <div class="font-bold">${i.name} ${i.optional ? '<span class="text-xs bg-slate-200 px-1 rounded">Opcional</span>' : ''}</div>
                                <span class="text-xs text-slate-500">${i.description}</span>
                            </div>
                        </div>
                    </td>
                    <td class="text-center">${i.qty}</td>
                    <td class="text-right">${formatPrice(i.price)}</td>
                    <td class="text-right pr-4 font-bold ${i.optional && !i.publicSelected ? 'text-slate-400 line-through' : ''}">
                        ${formatPrice(i.qty * i.price)}
                    </td>
                </tr>`; 
            });
            setHTML('doc-items-body', html);
            safeText('doc-total', formatPrice(total));
        }

        function togglePublicOpt(idx) {
            state.data.items[idx].publicSelected = !state.data.items[idx].publicSelected;
            renderPublicItems();
        }

        function openSignatureModal() {
            show('signature-modal');
            setTimeout(initSignaturePad, 100);
        }

        function closeSignatureModal() {
            hide('signature-modal');
        }

        function initSignaturePad() {
            const canvas = document.getElementById('signature-pad');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            function resizeCanvas() {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                ctx.scale(ratio, ratio);
            }
            resizeCanvas();
            let painting = false;
            function startPosition(e) { painting = true; ctx.beginPath(); draw(e); }
            function endPosition() { painting = false; ctx.beginPath(); }
            function draw(e) {
                if (!painting) return;
                e.preventDefault(); 
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || (e.touches?.[0]?.clientX)) - rect.left;
                const y = (e.clientY || (e.touches?.[0]?.clientY)) - rect.top;
                ctx.lineWidth = 2; ctx.lineCap = 'round'; ctx.strokeStyle = '#0f172a';
                ctx.lineTo(x, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y);
            }
            canvas.addEventListener('mousedown', startPosition); 
            canvas.addEventListener('mouseup', endPosition); 
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('touchstart', startPosition); 
            canvas.addEventListener('touchend', endPosition); 
            canvas.addEventListener('touchmove', draw);
            document.getElementById('clear-sig').onclick = () => { ctx.clearRect(0, 0, canvas.width, canvas.height); };
        }

        function clearSignature() {
            const canvas = document.getElementById('signature-pad');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        async function submitSignature() {
            const canvas = document.getElementById('signature-pad');
            const signatureData = canvas.toDataURL();
            state.data.signature = signatureData;
            await approveLogic();
            closeSignatureModal();
        }

        async function approveLogic() {
            let ip = 'IP não identificado'; 
            try { 
                const r = await fetch('https://api.ipify.org?format=json'); 
                const j = await r.json(); 
                ip = j.ip; 
            } catch(e){}
            logHistory('approved', 'client', 'Aprovado via link com assinatura');
            const items = state.data.items;
            const finalTotal = items.reduce((acc, i) => (!i.optional || i.publicSelected ? acc + (i.qty * i.price) : acc), 0);
            await db.from('versions').update({ 
                status: 'approved', 
                approved_at: new Date(), 
                approved_by_ip: ip, 
                items: state.data, 
                total_value: finalTotal 
            }).eq('id', state.version.id);
            await loadProjects();
            window.history.replaceState(null, '', '?view=success');
            showSuccessScreen('approved');
        }

        function openChangeModal() {
            const reason = prompt('Descreva o que deseja alterar:');
            if (!reason) return;
            sendLogic('change_request', 'negotiating', reason);
        }

        function openCancelModal() {
            const reason = prompt('Motivo da recusa (opcional):');
            sendLogic('canceled', 'canceled', reason || 'Recusado pelo cliente');
        }

        async function sendLogic(action, newStatus, text) {
            logHistory(action, 'client', text);
            await db.from('versions').update({ status: newStatus, items: state.data }).eq('id', state.version.id);
            await loadProjects();
            window.history.replaceState(null, '', '?view=success');
            showSuccessScreen(action);
        }

        function showSuccessScreen(type) {
            hide('view-public');
            show('view-success');
            const icon = document.getElementById('success-icon');
            const title = document.getElementById('success-title');
            const desc = document.getElementById('success-desc');
            const actions = document.getElementById('success-actions');
            actions.innerHTML = ''; 
            if(type === 'approved') {
                icon.className = "fas fa-check-circle text-6xl text-green-500 mb-4";
                title.innerText = "Orçamento Aprovado!";
                desc.innerText = "Obrigado pela confiança.";
                actions.innerHTML = `<button onclick="downloadPDF()" class="btn-primary px-6 py-3"><i class="fas fa-file-pdf mr-2"></i>Baixar PDF</button>`;
            } else if (type === 'change_request') {
                icon.className = "fas fa-clock text-6xl text-amber-500 mb-4";
                title.innerText = "Solicitação Enviada";
                desc.innerText = "Aguarde o retorno do prestador.";
            } else {
                icon.className = "fas fa-times-circle text-6xl text-slate-400 mb-4";
                title.innerText = "Orçamento Recusado";
                desc.innerText = "O orçamento foi recusado.";
            }
        }

        function downloadPDF() {
            const element = document.getElementById('public-content');
            const opt = { margin: [0.5,0.5,0.5,0.5], filename: `proposta.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4' } };
            html2pdf().set(opt).from(element).save();
        }

        // ========== PÁGINA PÚBLICA DO CATÁLOGO ==========
        let publicClientData = null;

        async function loadPublicCatalog(userId) {
            show('public-catalog-loading');
            hide('public-catalog-content');
            document.getElementById('client-data-modal').classList.remove('hidden');
        }

        function cancelPublicClientData() {
            document.getElementById('client-data-modal').classList.add('hidden');
            window.location.href = '?view=landing';
        }

        function savePublicClientData() {
            const name = document.getElementById('public-client-name').value.trim();
            if (!name) {
                alert("Por favor, informe seu nome.");
                return;
            }
            publicClientData = {
                name: name,
                email: document.getElementById('public-client-email').value,
                phone: document.getElementById('public-client-phone').value,
                address: document.getElementById('public-client-address').value
            };
            document.getElementById('client-data-modal').classList.add('hidden');
            reallyLoadPublicCatalog();
        }

        async function reallyLoadPublicCatalog() {
            const params = new URLSearchParams(window.location.search);
            const userId = params.get('user');
            if (!userId) return alert("Usuário não identificado.");

            const { data: catalog, error } = await db
                .from('service_catalog')
                .select('*')
                .eq('user_id', userId)
                .order('name', { ascending: true });
            if (error) {
                alert("Erro ao carregar catálogo.");
                return;
            }

            let providerName = "Prestador";
            document.getElementById('provider-name').innerText = `Serviços de ${providerName}`;

            const container = document.getElementById('public-catalog-items');
            let html = '';
            if (catalog.length === 0) {
                html = '<p class="col-span-2 text-center text-slate-500">Nenhum serviço disponível no momento.</p>';
            } else {
                catalog.forEach(item => {
                    html += `
                        <div class="public-catalog-card">
                            <label class="flex items-start gap-3 cursor-pointer">
                                <input type="checkbox" class="catalog-item-checkbox mt-1" data-id="${item.id}" data-name="${item.name}" data-description="${item.description || ''}" data-price="${item.price || 0}">
                                <div class="flex-1">
                                    <div class="font-bold text-slate-800">${item.name}</div>
                                    ${item.description ? `<p class="text-sm text-slate-500">${item.description}</p>` : ''}
                                    ${item.price ? `<p class="text-sm font-mono text-green-700 mt-1">${formatPrice(item.price)}</p>` : ''}
                                    ${item.category ? `<span class="text-xs bg-slate-100 px-2 py-0.5 rounded">${item.category}</span>` : ''}
                                </div>
                            </label>
                        </div>
                    `;
                });
            }
            container.innerHTML = html;
            hide('public-catalog-loading');
            show('public-catalog-content');
        }

        async function submitPublicCatalogRequest() {
            if (!publicClientData) {
                alert("Dados do cliente não informados.");
                return;
            }
            const params = new URLSearchParams(window.location.search);
            const userId = params.get('user');
            if (!userId) return alert("Erro: usuário não identificado.");

            const checkboxes = document.querySelectorAll('.catalog-item-checkbox:checked');
            const selectedItems = [];
            checkboxes.forEach(cb => {
                selectedItems.push({
                    name: cb.dataset.name,
                    description: cb.dataset.description,
                    price: parseFloat(cb.dataset.price) || 0
                });
            });

            const customDesc = document.getElementById('custom-service-description').value.trim();

            if (selectedItems.length === 0 && !customDesc) {
                alert("Selecione ao menos um serviço ou descreva o que precisa.");
                return;
            }

            const projectName = `Solicitação via catálogo - ${publicClientData.name}`;
            const { data: project, error: projError } = await db
                .from('projects')
                .insert({ name: projectName, user_id: userId, client_name: publicClientData.name })
                .select()
                .single();
            if (projError) {
                alert("Erro ao criar solicitação.");
                return;
            }

            const items = selectedItems.map((item, idx) => ({
                id: 'item_' + Date.now() + idx + Math.random(),
                name: item.name,
                description: item.description,
                qty: 1,
                price: item.price,
                type: 'original',
                optional: false,
                publicSelected: false
            }));
            if (customDesc) {
                items.push({
                    id: 'item_custom_' + Date.now(),
                    name: '🟡 Serviço personalizado',
                    description: customDesc + ' (solicitado pelo cliente – revisar e ajustar)',
                    qty: 1,
                    price: 0,
                    type: 'original',
                    optional: false,
                    publicSelected: false
                });
            }

            const total = items.reduce((acc, i) => acc + i.price, 0);
            const history = [{
                date: new Date().toISOString(),
                action: 'created',
                user: 'client',
                detail: 'Orçamento criado via catálogo público'
            }];

            const versionData = {
                client: {
                    name: publicClientData.name,
                    email: publicClientData.email || '',
                    phone: publicClientData.phone || '',
                    address: publicClientData.address || ''
                },
                location: { address: '', sameAsClient: true },
                items: items,
                terms: { paymentMode: 'custom', paymentText: '', deadline: '', validity: '', obs: '' },
                settings: { providerName: '', providerDoc: '', providerAddr: '', providerPhone: '' },
                history: history,
                attachments: [],
                signature: null
            };

            const { error: verError } = await db
                .from('versions')
                .insert({
                    project_id: project.id,
                    version_number: 1,
                    items: versionData,
                    total_value: total,
                    status: 'draft'
                });
            if (verError) {
                alert("Erro ao criar versão.");
                return;
            }

            window.location.href = '?view=success';
        }

        // ========== NAVEGAÇÃO ==========
        function switchTab(tab, updateUrl = true) {
            document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${tab}`)?.classList.remove('hidden');
            const nav = document.getElementById(`nav-${tab}`);
            if (nav) nav.classList.add('active');
            if (updateUrl) window.history.pushState(null, '', tab === 'dashboard' ? '?' : `?view=${tab}`);
            if (tab === 'dashboard') { renderDashboardKPIs(); renderDashboardCharts(); renderActivityFeed(); }
            if (tab === 'projects') renderProjectCards();
            if (tab === 'templates') renderTemplates();
            if (tab === 'clients') renderClients();
            if (tab === 'catalog') renderCatalogGrid();
            if (tab === 'reports') renderReports();
        }

        // ========== INICIALIZAÇÃO DE ABAS NO EDITOR ==========
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active', 'text-primary', 'border-primary'));
                this.classList.add('active', 'text-primary', 'border-primary');
                document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
                document.getElementById('tab-' + this.dataset.tab).classList.remove('hidden');
            });
        });

        // ========== INICIALIZAÇÃO ==========
        window.onload = init;
        window.onpopstate = init;
    </script>
</body>
</html>
