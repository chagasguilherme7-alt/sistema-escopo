<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aprova Ai | Sistema de Orçamentos</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        /* --- ESTILO GERAL --- */
        body { font-family: 'Inter', sans-serif; background-color: #F1F5F9; color: #334155; font-size: 15px; overflow-x: hidden; }
        .font-heading { font-family: 'Plus Jakarta Sans', sans-serif; }
        
        /* Scrollbar Personalizada */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* Animações */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .anim-entry { animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards; }

        /* --- COMPONENTES DE UI --- */
        .app-header { background: #0f172a; height: 70px; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; position: sticky; top: 0; z-index: 50; box-shadow: 0 4px 20px rgba(0,0,0,0.1); color: white; }
        
        /* Inputs & Forms */
        .input-label { display: block; font-size: 0.75rem; font-weight: 700; color: #64748b; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.05em; }
        .input-field { width: 100%; padding: 12px 16px; background: #fff; border: 1px solid #cbd5e1; border-radius: 10px; font-size: 0.95rem; color: #1e293b; transition: all 0.2s; outline: none; }
        .input-field:focus { border-color: #3b82f6; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }
        .input-field:disabled { background: #f1f5f9; color: #94a3b8; cursor: not-allowed; }

        /* Botões */
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 12px 24px; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 0.95rem; gap: 8px; }
        .btn:hover { transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        .btn-primary { background: linear-gradient(135deg, #0f172a 0%, #334155 100%); color: white; border: none; box-shadow: 0 4px 12px rgba(15, 23, 42, 0.2); }
        .btn-primary:hover { box-shadow: 0 6px 16px rgba(15, 23, 42, 0.3); }
        .btn-secondary { background: white; color: #475569; border: 1px solid #e2e8f0; }
        .btn-secondary:hover { background: #f8fafc; border-color: #cbd5e1; color: #1e293b; }
        .btn-danger { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .btn-danger:hover { background: #fecaca; }

        /* Cards do Editor */
        .panel-grid { display: grid; grid-template-columns: 1fr 420px; gap: 24px; max-width: 1900px; margin: 24px auto; padding: 0 24px; height: calc(100vh - 120px); }
        .col-scroll { overflow-y: auto; height: 100%; padding-right: 8px; padding-bottom: 40px; display: flex; flex-direction: column; gap: 24px; }
        
        .card { background: white; border: 1px solid #e2e8f0; border-radius: 16px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.03); transition: all 0.3s; }
        .card-header { background: #f8fafc; padding: 16px 24px; border-bottom: 1px solid #e2e8f0; font-size: 0.9rem; font-weight: 700; text-transform: uppercase; color: #475569; display: flex; align-items: center; gap: 10px; letter-spacing: 0.05em; }
        .card-body { padding: 24px; }

        /* Itens do Escopo */
        .item-row { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px; margin-bottom: 12px; position: relative; transition: all 0.2s; }
        .item-row:hover { border-color: #cbd5e1; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .item-optional { border: 2px dashed #94a3b8; background: #f8fafc; }
        
        /* Anexos */
        .attach-item { display: flex; align-items: center; gap: 12px; background: #f8fafc; border: 1px solid #e2e8f0; padding: 12px; border-radius: 10px; margin-bottom: 8px; }
        .attach-icon { width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; background: white; border: 1px solid #e2e8f0; }
        .attach-input { background: transparent; border: none; border-bottom: 1px dashed #cbd5e1; width: 100%; padding: 4px 0; font-size: 0.9rem; color: #475569; }
        .attach-input:focus { border-bottom-color: #3b82f6; outline: none; }

        /* Responsividade */
        @media (max-width: 1280px) { .panel-grid { grid-template-columns: 1fr 360px; padding: 0 16px; } }
        @media (max-width: 1024px) { 
            .panel-grid { display: flex; flex-direction: column; height: auto; overflow: visible; gap: 30px; } 
            .col-scroll { height: auto; overflow: visible; padding-right: 0; }
            .app-header { padding: 0 16px; height: 64px; }
        }

        /* Loading */
        #system-loader { position: fixed; inset: 0; background: #0f172a; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.2); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Utils */
        .hidden { display: none !important; }
        @media print { .no-print { display: none !important; } .panel-grid { display: block; } }
    </style>
</head>
<body>

    <div id="system-loader">
        <div class="spinner"></div>
        <p class="text-sm opacity-70 tracking-widest uppercase">Carregando...</p>
    </div>

    <div id="fatal-error" class="hidden fixed inset-0 bg-red-50 z-[10000] flex flex-col items-center justify-center text-center p-8">
        <i class="fas fa-bug text-5xl text-red-500 mb-4"></i>
        <h2 class="text-2xl font-bold text-red-900">Algo deu errado</h2>
        <p id="error-msg" class="text-red-700 mt-2 mb-6 max-w-md">Erro desconhecido.</p>
        <button onclick="localStorage.clear(); window.location.reload()" class="btn btn-primary bg-red-600 hover:bg-red-700">Recarregar Sistema</button>
    </div>

    <section id="view-login" class="hidden min-h-screen flex flex-col lg:flex-row">
        <div class="lg:w-3/5 bg-slate-900 relative flex items-center justify-center p-10 overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-full bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-slate-800 via-slate-900 to-black opacity-80"></div>
            <div class="absolute -top-20 -left-20 w-96 h-96 bg-blue-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse"></div>
            <div class="absolute -bottom-20 -right-20 w-96 h-96 bg-indigo-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse"></div>
            
            <div class="relative z-10 text-white max-w-lg">
                <div class="mb-6 flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center font-bold text-xl">A</div>
                    <span class="text-2xl font-bold tracking-tight">Aprova Ai</span>
                </div>
                <h1 class="text-5xl font-extrabold leading-tight mb-6">Orçamentos que <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400">fecham negócios.</span></h1>
                <p class="text-lg text-slate-300 mb-8 leading-relaxed">Profissionalize sua gestão, evite prejuízos com mudanças de escopo e transmita confiança para seus clientes.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-white/10 backdrop-blur-sm p-4 rounded-xl border border-white/10">
                        <i class="fas fa-check-circle text-emerald-400 mb-2 text-xl"></i>
                        <h3 class="font-bold">Aprovação Digital</h3>
                        <p class="text-xs text-slate-400">Link seguro para o cliente.</p>
                    </div>
                    <div class="bg-white/10 backdrop-blur-sm p-4 rounded-xl border border-white/10">
                        <i class="fas fa-history text-blue-400 mb-2 text-xl"></i>
                        <h3 class="font-bold">Histórico Completo</h3>
                        <p class="text-xs text-slate-400">Registre todas as alterações.</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="lg:w-2/5 bg-white flex items-center justify-center p-8">
            <div class="w-full max-w-md">
                <div class="text-center mb-10">
                    <h2 class="text-2xl font-bold text-slate-900">Bem-vindo de volta</h2>
                    <p class="text-slate-500">Digite seu e-mail para acessar sua conta.</p>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="input-label">E-mail Corporativo</label>
                        <input type="email" id="email" placeholder="seu@email.com" class="input-field">
                    </div>
                    <button onclick="handleLogin()" id="btn-login" class="btn btn-primary w-full py-4 text-lg">
                        <span>Enviar Link de Acesso</span> <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
                <p class="mt-8 text-center text-xs text-slate-400">Seu acesso é seguro e livre de senhas.</p>
            </div>
        </div>
    </section>

    <section id="view-dashboard" class="hidden min-h-screen flex flex-col">
        <header class="app-header">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center font-bold">A</div>
                <span class="font-bold text-lg tracking-tight">Painel de Controle</span>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="createProject()" class="btn bg-white text-slate-900 hover:bg-slate-100 py-2 px-4 text-xs font-bold border-none"><i class="fas fa-plus"></i> Novo Projeto</button>
                <button onclick="db.auth.signOut().then(()=>window.location.reload())" class="text-slate-400 hover:text-white transition-colors" title="Sair"><i class="fas fa-sign-out-alt text-lg"></i></button>
            </div>
        </header>

        <main class="flex-1 max-w-7xl mx-auto w-full p-6 md:p-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                    <p class="text-xs font-bold text-slate-400 uppercase mb-1">Em Aberto</p>
                    <h3 class="text-2xl font-bold text-slate-800" id="kpi-count-open">0</h3>
                </div>
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                    <p class="text-xs font-bold text-amber-500 uppercase mb-1">Em Negociação</p>
                    <h3 class="text-2xl font-bold text-slate-800" id="kpi-count-neg">0</h3>
                </div>
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                    <p class="text-xs font-bold text-emerald-500 uppercase mb-1">Aprovados</p>
                    <h3 class="text-2xl font-bold text-slate-800" id="kpi-count-apr">0</h3>
                </div>
                <div class="bg-slate-900 p-5 rounded-xl border border-slate-800 shadow-sm text-white">
                    <p class="text-xs font-bold text-slate-400 uppercase mb-1">Faturamento (Aprovado)</p>
                    <h3 class="text-2xl font-bold" id="kpi-total-apr">R$ 0,00</h3>
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-4 mb-6">
                <div class="flex-1 relative">
                    <i class="fas fa-search absolute left-4 top-3.5 text-slate-400"></i>
                    <input id="dash-search" onkeyup="renderDashboardList()" class="input-field pl-10" placeholder="Buscar por cliente ou projeto...">
                </div>
                <select id="dash-filter" onchange="renderDashboardList()" class="input-field md:w-64">
                    <option value="all">Todos os Status</option>
                    <option value="draft">Em Aberto</option>
                    <option value="sent">Enviados</option>
                    <option value="negotiating">Em Negociação</option>
                    <option value="approved">Aprovados</option>
                    <option value="canceled">Cancelados</option>
                </select>
            </div>

            <div id="project-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>
        </main>
    </section>

    <section id="view-editor" class="hidden min-h-screen flex flex-col bg-slate-50">
        <header class="app-header">
            <div class="flex items-center gap-4">
                <button onclick="goTo('dashboard')" class="text-slate-400 hover:text-white transition-colors"><i class="fas fa-arrow-left"></i> Voltar</button>
                <div class="h-6 w-px bg-slate-700"></div>
                <div>
                    <h2 id="ed-title" class="font-bold text-white leading-none">Carregando...</h2>
                    <div class="flex items-center gap-2 mt-1">
                        <span id="ed-ver" class="text-[10px] bg-slate-800 text-slate-300 px-1.5 rounded font-mono">V1</span>
                        <span id="ed-status-badge" class="text-[10px] uppercase font-bold tracking-wider">STATUS</span>
                    </div>
                </div>
            </div>
            <button onclick="openShareModal()" class="btn bg-blue-600 hover:bg-blue-500 text-white border-none py-2 px-4 text-xs font-bold shadow-lg shadow-blue-900/50">
                <i class="fas fa-share-alt"></i> Enviar Proposta
            </button>
        </header>

        <div class="panel-grid">
            
            <div class="col-scroll">
                
                <div class="card">
                    <div class="card-header"><i class="fas fa-building text-blue-500"></i> Seus Dados (Prestador)</div>
                    <div class="card-body">
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
                            <div class="md:col-span-6"><label class="input-label">Nome / Razão Social</label><input id="p-name" class="input-field" placeholder="Sua Empresa Ltda" onchange="upSettings('providerName',this.value)"></div>
                            <div class="md:col-span-3"><label class="input-label">CNPJ / CPF</label><input id="p-doc" class="input-field" placeholder="00.000.000/0000-00" onchange="upSettings('providerDoc',this.value)"></div>
                            <div class="md:col-span-3"><label class="input-label">Telefone</label><input id="p-phone" class="input-field" placeholder="(00) 00000-0000" onchange="upSettings('providerPhone',this.value)"></div>
                            <div class="md:col-span-12"><label class="input-label">Endereço Completo</label><input id="p-addr" class="input-field" placeholder="Rua, Número, Bairro, Cidade - UF" onchange="upSettings('providerAddr',this.value)"></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header flex justify-between">
                        <span><i class="fas fa-user-tie text-emerald-500"></i> Dados do Cliente</span>
                    </div>
                    <div class="card-body">
                        <div id="cl-type-btns" class="mb-4"></div>

                        <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
                            <div class="md:col-span-6"><label class="input-label" id="lbl-c-name">Nome</label><input id="c-name" class="input-field" placeholder="Nome do Cliente" onchange="upVal('c-name',this.value)"></div>
                            <div class="md:col-span-3"><label class="input-label" id="lbl-c-doc">Documento</label><input id="c-doc" class="input-field" placeholder="CPF/CNPJ" onchange="upVal('c-doc',this.value)"></div>
                            <div class="md:col-span-3"><label class="input-label">Telefone</label><input id="c-phone" class="input-field" placeholder="(00) 00000-0000" onchange="upVal('c-phone',this.value)"></div>
                            <div class="md:col-span-6"><label class="input-label">E-mail</label><input id="c-email" class="input-field" placeholder="cliente@email.com" onchange="upVal('c-email',this.value)"></div>
                            <div class="md:col-span-6"><label class="input-label">Endereço do Cliente</label><input id="c-addr" class="input-field" placeholder="Endereço Completo" onchange="upVal('c-addr',this.value)"></div>
                            
                            <div class="md:col-span-12 pt-4 mt-2 border-t border-dashed border-slate-200">
                                <label class="flex items-center gap-3 cursor-pointer mb-3">
                                    <input type="checkbox" id="loc-check" onchange="toggleLoc(this.checked)" class="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm font-medium text-slate-700">O endereço do serviço é o mesmo do cliente?</span>
                                </label>
                                <div id="loc-custom-div" class="animate-fade-in">
                                    <label class="input-label">Local de Execução do Serviço</label>
                                    <input id="loc-addr" class="input-field" placeholder="Onde o serviço será realizado?" onchange="upLoc(this.value)">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header justify-between">
                        <span><i class="fas fa-clipboard-list text-purple-500"></i> Escopo do Projeto</span>
                        <button id="btn-add-item" onclick="addItem()" class="btn btn-secondary py-1 px-3 text-xs bg-white border-slate-300 shadow-sm"><i class="fas fa-plus"></i> Adicionar Item</button>
                    </div>
                    <div class="card-body bg-slate-50 min-h-[200px]">
                        <div id="ed-items" class="space-y-3"></div>
                        
                        <div class="mt-8 pt-6 border-t-2 border-dashed border-slate-200">
                            <h4 class="font-bold text-slate-600 text-sm mb-3 uppercase flex items-center gap-2">
                                <i class="fas fa-paperclip text-slate-400"></i> Anexos e Imagens
                            </h4>
                            <div id="ed-attachments-list" class="space-y-2 mb-4"></div>
                            
                            <div id="upload-area">
                                <label for="file-upload" id="upload-label" class="cursor-pointer block w-full text-center p-6 border-2 border-dashed border-blue-200 bg-white rounded-xl hover:bg-blue-50 hover:border-blue-300 transition-all text-blue-600 font-bold uppercase text-xs tracking-wider">
                                    <i class="fas fa-cloud-upload-alt text-3xl mb-2 block text-blue-300"></i> 
                                    Clique aqui para anexar PDF ou Imagens
                                </label>
                                <input id="file-upload" type="file" class="hidden" accept=".pdf, .png, .jpg, .jpeg" onchange="handleUpload(event)">
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="right-col-fixed">
                
                <div class="card finance-section">
                    <div class="card-header"><i class="fas fa-coins text-emerald-600"></i> Resumo Financeiro</div>
                    <div class="card-body">
                        <div class="bg-slate-900 text-white p-6 rounded-xl text-center mb-6 shadow-xl shadow-slate-200 relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-emerald-500"></div>
                            <div class="text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-1">Valor Total</div>
                            <div id="ed-total" class="text-3xl font-bold tracking-tight">R$ 0,00</div>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="input-label">Forma de Pagamento</label>
                                <div class="flex gap-2 mb-2">
                                    <select id="pay-mode" class="input-field">
                                        <option value="single">Pagamento Único</option>
                                        <option value="entry_installments">Entrada + Parcelas</option>
                                    </select>
                                    <button id="btn-calc-pay" onclick="generatePayment()" class="btn btn-secondary px-3" title="Gerar Texto"><i class="fas fa-calculator"></i></button>
                                </div>
                                <div id="payment-display" class="text-xs bg-slate-50 p-3 rounded border border-slate-200 text-slate-600 whitespace-pre-line min-h-[60px]"></div>
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="input-label">Prazo Entrega</label><input id="t-deadline" class="input-field" placeholder="Ex: 15 dias" onchange="upVal('t-deadline',this.value)"></div>
                                <div><label class="input-label">Validade</label><input id="t-val" class="input-field" placeholder="Ex: 7 dias" onchange="upVal('t-val',this.value)"></div>
                            </div>

                            <div>
                                <label class="input-label">Observações Gerais</label>
                                <textarea id="t-obs" class="input-field h-24 resize-none" placeholder="Detalhes bancários, garantias, etc..." onchange="upVal('t-obs',this.value)"></textarea>
                            </div>
                        </div>

                        <div id="ed-actions" class="mt-6 border-t border-slate-100 pt-4 flex flex-col gap-2"></div>
                    </div>
                </div>

                <div class="card history-section">
                    <div class="card-header"><i class="fas fa-history text-slate-400"></i> Linha do Tempo</div>
                    <div id="ed-history" class="history-content-scroll bg-slate-50"></div>
                </div>

            </div>
        </div>
    </section>

    <div id="interaction-modal" class="modal-overlay hidden">
        <div class="modal-box">
            <h3 id="modal-title" class="text-xl font-bold mb-2 text-slate-800">Confirmar</h3>
            <p id="modal-desc" class="text-sm text-slate-500 mb-4">Ação necessária.</p>
            
            <textarea id="modal-input" class="w-full border p-3 rounded-lg mb-4 h-24 text-sm bg-slate-50 focus:ring-2 ring-blue-500 outline-none" placeholder="Digite aqui..."></textarea>
            
            <div id="modal-sig-area" class="mb-4 hidden">
                <canvas id="signature-pad"></canvas>
                <div class="text-right mt-1"><button id="clear-sig" class="text-xs text-red-500 hover:text-red-700 font-bold">Limpar Assinatura</button></div>
            </div>

            <div class="flex gap-3">
                <button onclick="document.getElementById('interaction-modal').classList.add('hidden')" class="flex-1 py-3 border rounded-lg text-slate-500 font-bold hover:bg-slate-50">Cancelar</button>
                <button id="modal-btn" class="flex-1 py-3 rounded-lg text-white font-bold bg-slate-900 hover:bg-slate-800">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="share-modal" class="modal-overlay hidden" style="z-index: 70;">
        <div class="modal-box text-center max-w-sm">
            <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 text-xl"><i class="fas fa-share-alt"></i></div>
            <h3 class="text-xl font-bold mb-2 text-slate-800">Enviar Proposta</h3>
            <p class="text-sm text-slate-500 mb-6">Escolha como deseja enviar o link para o cliente.</p>
            
            <div class="space-y-3">
                <button id="btn-share-wa" class="w-full py-3.5 bg-emerald-500 hover:bg-emerald-600 text-white rounded-xl font-bold flex items-center justify-center gap-3 transition-transform hover:scale-[1.02] shadow-lg shadow-emerald-100">
                    <i class="fab fa-whatsapp text-2xl"></i> 
                    <span>Enviar no WhatsApp</span>
                </button>

                <button id="btn-share-copy" class="w-full py-3.5 bg-slate-100 hover:bg-slate-200 text-slate-700 border border-slate-200 rounded-xl font-bold flex items-center justify-center gap-3 transition-colors">
                    <i class="fas fa-link text-lg"></i> 
                    <span>Copiar Link Apenas</span>
                </button>
            </div>

            <button onclick="document.getElementById('share-modal').classList.add('hidden')" class="mt-6 text-xs text-slate-400 hover:text-slate-600 uppercase font-bold tracking-wider">Cancelar</button>
        </div>
    </div>

    <section id="view-public" class="hidden min-h-screen bg-slate-200 p-4 md:py-10 overflow-y-auto print:p-0">
        <div id="public-loading" class="flex justify-center mt-20"><div class="spinner border-slate-900"></div></div>
        <div id="public-content" class="hidden max-w-4xl mx-auto bg-white shadow-2xl min-h-[297mm] relative flex flex-col">
            <div id="stamp-approved" class="hidden absolute top-10 right-10 border-4 border-emerald-600 text-emerald-600 font-bold text-3xl px-6 py-2 uppercase opacity-30 transform -rotate-12 z-20">APROVADO</div>
            
            <div class="bg-slate-900 text-white p-12 print:bg-white print:text-black print:border-b-2">
                <div id="doc-provider-info"></div>
                <div class="flex justify-between items-start mt-6 pt-6 border-t border-slate-700 print:border-slate-300">
                    <div><h1 id="doc-title" class="text-3xl font-bold mb-1">Orçamento</h1><p class="text-xs uppercase tracking-widest text-slate-400">Proposta Comercial</p></div>
                    <div class="text-right"><div id="doc-id" class="font-mono font-bold text-lg text-emerald-400 print:text-black">#REF</div><div id="doc-date" class="text-sm opacity-70"></div></div>
                </div>
            </div>

            <div class="p-12 flex-1">
                <div class="flex flex-col md:flex-row gap-12 mb-12 text-sm">
                    <div class="flex-1"><h3 class="font-bold text-xs uppercase text-slate-400 mb-2 border-b pb-1">Dados do Cliente</h3><div id="doc-c-name" class="font-bold text-lg text-slate-800"></div><div id="doc-c-doc" class="text-slate-500 mb-1"></div></div>
                    <div class="flex-1"><h3 class="font-bold text-xs uppercase text-slate-400 mb-2 border-b pb-1">Local do Serviço</h3><div id="doc-c-addr" class="text-slate-600"></div></div>
                </div>

                <div class="mb-12">
                    <h3 class="font-bold text-xs uppercase text-slate-400 mb-4 tracking-wider">Detalhamento do Escopo</h3>
                    <table class="w-full">
                        <thead>
                            <tr class="text-left text-xs uppercase text-slate-400 border-b border-slate-200">
                                <th class="pb-3 pl-2 w-3/5">Descrição</th>
                                <th class="pb-3 text-center w-24">Qtd</th>
                                <th class="pb-3 text-right">Valor Unit.</th>
                                <th class="pb-3 text-right pr-2">Total</th>
                            </tr>
                        </thead>
                        <tbody id="doc-items-body" class="text-sm"></tbody>
                    </table>
                </div>
                
                <div id="doc-attachments-area" class="mb-12"></div>

                <div class="bg-slate-50 border border-slate-100 rounded-xl p-8 mb-8 flex flex-col md:flex-row gap-12">
                    <div class="flex-1">
                        <h4 class="font-bold text-xs uppercase text-slate-400 mb-3">Condições Comerciais</h4>
                        <div id="doc-payment" class="text-sm font-mono text-slate-700 whitespace-pre-line mb-4"></div>
                        <div class="flex gap-8 text-sm">
                            <div><span class="font-bold text-xs uppercase text-slate-400 block">Prazo Entrega</span><span id="doc-deadline" class="font-bold text-slate-800"></span></div>
                            <div><span class="font-bold text-xs uppercase text-slate-400 block">Validade Proposta</span><span id="doc-validity" class="font-bold text-slate-800"></span></div>
                        </div>
                    </div>
                    <div class="text-right flex flex-col justify-center">
                        <h4 class="font-bold text-xs uppercase text-slate-400 mb-1">Valor Total</h4>
                        <div id="doc-total" class="text-4xl font-bold text-slate-900 tracking-tight">R$ 0,00</div>
                    </div>
                </div>

                <div id="doc-obs" class="text-xs text-slate-500 italic text-justify border-t pt-4"></div>
                <div id="doc-signature-area"></div>
                
                <div id="doc-actions" class="no-print mt-12 p-6 bg-slate-50 rounded-xl border border-slate-200"></div>
            </div>
            
            <div class="bg-slate-100 p-4 text-center border-t no-print">
                <button onclick="window.print()" class="text-xs font-bold text-slate-500 uppercase hover:text-slate-800 flex items-center justify-center gap-2 w-full">
                    <i class="fas fa-print"></i> Salvar como PDF / Imprimir
                </button>
            </div>
        </div>
    </section>

    <script>
        // Configuração Supabase
        const SUPABASE_URL = 'https://outasfgohiiyndsjciau.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im91dGFzZmdvaGlpeW5kc2pjaWF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4MTk4ODIsImV4cCI6MjA4NTM5NTg4Mn0.4yvGfYbQYf806FJcs34yPGkuU_kVTYHW8mBtbU3JD80';
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);

        // Estado Global
        let state = { user: null, project: null, version: null, projectsCache: [], data: null, previousData: null, snapshot: [] };
        let signaturePad = null;

        // --- Helpers ---
        function safeVal(id) { const el = document.getElementById(id); return el ? el.value : ''; }
        function safeText(id, val) { const el = document.getElementById(id); if (el) el.innerText = val || ''; }
        function setHTML(id, val) { const el = document.getElementById(id); if (el) el.innerHTML = val || ''; }
        function setVal(id, val) { const el = document.getElementById(id); if (el) el.value = val || ''; }
        function safeShow(id) { const el = document.getElementById(id); if(el) el.classList.remove('hidden'); }
        function safeHide(id) { const el = document.getElementById(id); if(el) el.classList.add('hidden'); }

        // --- Inicialização ---
        async function init() {
            try {
                const params = new URLSearchParams(window.location.search);
                const view = params.get('view') || 'login';
                const id = params.get('id');
                
                document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
                const { data: { session } } = await db.auth.getSession();
                state.user = session?.user;

                if (view === 'public') {
                    if(!id) throw new Error("Link inválido.");
                    await loadPublicProposal(id);
                } else if (!state.user && view !== 'login') {
                    window.history.replaceState(null, '', '?view=login');
                    safeShow('view-login');
                } else if (state.user && view === 'login') {
                    goTo('dashboard');
                } else {
                    if(view === 'dashboard') await loadDashboard();
                    if(view === 'editor' && id) await loadEditor(id);
                    safeShow(`view-${view}`);
                }
            } catch (e) {
                console.error(e);
                safeShow('fatal-error');
                safeText('error-msg', e.message);
            } finally {
                document.getElementById('system-loader').style.display = 'none';
            }
        }

        // --- Dados ---
        function normalizeData(dbData) {
            const defaultSchema = { 
                client: { name: '', doc: '', email: '', phone: '', address: '', type: 'pj' }, 
                location: { address: '', sameAsClient: true }, 
                items: [], 
                terms: { paymentMode: 'single', paymentText: '', deadline: '', validity: '10 dias', obs: '' }, 
                settings: { myPhone: '', serviceType: 'Outros', providerName: '', providerDoc: '', providerAddr: '', providerPhone: '' }, 
                history: [], attachments: [], signature: null 
            };
            
            if (!dbData) return defaultSchema;
            
            // Tratamento robusto para itens e anexos
            const items = (Array.isArray(dbData.items) ? dbData.items : (dbData.scope || [])).map(i => ({
                id: i.id || 'item_' + Math.random().toString(36).substr(2, 9),
                name: i.name || '', description: i.description || '',
                qty: parseFloat(i.qty) || 1, price: parseFloat(i.price) || 0,
                optional: i.optional || false, publicSelected: i.publicSelected || false
            }));

            const attachments = (Array.isArray(dbData.attachments) ? dbData.attachments : []).map(a => ({
                name: a.name, url: a.url, type: a.type, description: a.description || ''
            }));

            return {
                client: { ...defaultSchema.client, ...(dbData.client || {}) },
                location: { ...defaultSchema.location, ...(dbData.location || {}) },
                items: items,
                attachments: attachments,
                terms: { ...defaultSchema.terms, ...(dbData.terms || {}) },
                settings: { ...defaultSchema.settings, ...(dbData.settings || {}) },
                history: Array.isArray(dbData.history) ? dbData.history : [],
                signature: dbData.signature || null
            };
        }

        // --- Login & Dashboard ---
        async function handleLogin() {
            const email = safeVal('email');
            const btn = document.getElementById('btn-login');
            if(!email) return alert("Digite o e-mail");
            btn.innerHTML = 'Enviando...'; btn.disabled = true;
            const { error } = await db.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.href }});
            if(error) { alert(error.message); btn.innerHTML = 'Tentar Novamente'; btn.disabled = false; }
            else { btn.innerHTML = 'Link Enviado!'; alert('Verifique seu e-mail.'); }
        }

        function goTo(view, id) { window.history.pushState(null, '', id ? `?view=${view}&id=${id}` : `?view=${view}`); init(); }

        async function loadDashboard() {
            const { data } = await db.from('projects').select('*, versions(status, total_value)').eq('user_id', state.user.id).order('created_at', { ascending: false });
            state.projectsCache = data || [];
            renderDashboardList();
        }

        function renderDashboardList() {
            const list = document.getElementById('project-list');
            const filter = safeVal('dash-filter');
            const search = safeVal('dash-search').toLowerCase();
            
            let html = '';
            let stats = { open: 0, neg: 0, apr: 0, total: 0 };

            state.projectsCache.forEach(p => {
                const v = p.versions?.[0] || { status: 'draft', total_value: 0 };
                // Stats
                if(v.status === 'draft') stats.open++;
                if(v.status === 'negotiating' || v.status === 'sent') stats.neg++;
                if(v.status === 'approved') { stats.apr++; stats.total += (v.total_value || 0); }

                // Filter
                if(filter !== 'all' && v.status !== filter) return;
                if(search && !p.name.toLowerCase().includes(search) && !(p.client_name || '').toLowerCase().includes(search)) return;

                let badge = { class: 'st-draft', text: 'Em Aberto' };
                if(v.status === 'sent') badge = { class: 'st-sent', text: 'Enviado' };
                if(v.status === 'negotiating') badge = { class: 'st-negotiating', text: 'Negociação' };
                if(v.status === 'approved') badge = { class: 'st-approved', text: 'Aprovado' };
                if(v.status === 'canceled') badge = { class: 'st-canceled', text: 'Cancelado' };

                html += `
                <div onclick="goTo('editor', '${p.id}')" class="bg-white p-6 rounded-xl border border-slate-200 hover:border-blue-400 hover:shadow-lg transition-all cursor-pointer group">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-bold text-lg text-slate-800 group-hover:text-blue-600 transition-colors">${p.name}</h3>
                            <p class="text-sm text-slate-500"><i class="far fa-user mr-1"></i> ${p.client_name || 'Novo Cliente'}</p>
                        </div>
                        <span class="status-badge ${badge.class}">${badge.text}</span>
                    </div>
                    <div class="pt-4 border-t border-slate-50 flex justify-between items-end">
                        <div class="text-xs text-slate-400">${new Date(p.created_at).toLocaleDateString()}</div>
                        <div class="text-lg font-bold text-slate-900">${(v.total_value||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</div>
                    </div>
                </div>`;
            });

            list.innerHTML = html || '<div class="col-span-full text-center py-10 text-slate-400">Nenhum projeto encontrado.</div>';
            
            // Atualiza KPIs
            safeText('kpi-count-open', stats.open);
            safeText('kpi-count-neg', stats.neg);
            safeText('kpi-count-apr', stats.apr);
            safeText('kpi-total-apr', stats.total.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}));
        }

        async function createProject() {
            const name = prompt("Nome do Projeto:");
            if(!name) return;
            const { data: p } = await db.from('projects').insert({ name, user_id: state.user.id, client_name: 'Novo Cliente' }).select().single();
            const d = normalizeData(null);
            
            // Preenche dados do prestador do cache local
            ['providerName','providerDoc','providerAddr','providerPhone'].forEach(k => {
                d.settings[k] = localStorage.getItem('cfg_'+k) || '';
            });

            d.history.push({ date: new Date().toISOString(), action: 'created', user: 'provider', detail: 'Projeto criado.' });
            
            await db.from('versions').insert({ project_id: p.id, version_number: 1, items: d, total_value: 0, status: 'draft' });
            goTo('editor', p.id);
        }

        // --- Editor Core ---
        async function loadEditor(id) {
            safeShow('editor-loading'); safeHide('editor-content');
            
            const { data: proj } = await db.from('projects').select('*').eq('id', id).single();
            state.project = proj;
            const { data: vers } = await db.from('versions').select('*').eq('project_id', id).order('version_number', { ascending: true });
            
            state.version = vers[vers.length - 1];
            state.data = normalizeData(state.version.items);
            state.snapshot = JSON.parse(JSON.stringify(state.data.items)); // Para diff check
            
            // Verifica versão anterior para diff
            state.previousData = null;
            if (state.version.version_number > 1 && vers[vers.length - 2]) {
                state.previousData = normalizeData(vers[vers.length - 2].items);
            }

            renderEditor();
            safeHide('editor-loading'); safeShow('editor-content');
        }

        function renderEditor() {
            const d = state.data;
            const locked = state.version.status !== 'draft';

            // Cabeçalho
            safeText('ed-title', state.project.name);
            safeText('ed-ver', `V${state.version.version_number}`);
            safeText('ed-status-badge', state.version.status === 'draft' ? 'EM EDIÇÃO' : state.version.status);

            // Inputs Gerais
            setVal('p-name', d.settings.providerName); setVal('p-doc', d.settings.providerDoc);
            setVal('p-phone', d.settings.providerPhone); setVal('p-addr', d.settings.providerAddr);
            
            // Toggle Cliente
            const isPJ = d.client.type !== 'pf';
            document.getElementById('cl-type-btns').innerHTML = `
                <div class="flex bg-slate-100 p-1 rounded-lg w-full max-w-xs">
                    <button onclick="setClientType('pj')" class="flex-1 py-1.5 text-xs font-bold rounded ${isPJ ? 'bg-white shadow text-blue-700' : 'text-slate-500'}">Pessoa Jurídica</button>
                    <button onclick="setClientType('pf')" class="flex-1 py-1.5 text-xs font-bold rounded ${!isPJ ? 'bg-white shadow text-blue-700' : 'text-slate-500'}">Pessoa Física</button>
                </div>`;
            
            safeText('lbl-c-name', isPJ ? 'Razão Social' : 'Nome Completo');
            safeText('lbl-c-doc', isPJ ? 'CNPJ' : 'CPF');
            
            setVal('c-name', d.client.name); setVal('c-doc', d.client.doc);
            setVal('c-phone', d.client.phone); setVal('c-email', d.client.email);
            setVal('c-addr', d.client.address);

            // Local
            document.getElementById('loc-check').checked = d.location.sameAsClient;
            document.getElementById('loc-custom-div').style.display = d.location.sameAsClient ? 'none' : 'block';
            setVal('loc-addr', d.location.address);

            // Itens Escopo
            let itemsHtml = '';
            let total = 0;
            
            d.items.forEach((i, idx) => {
                const sub = (i.qty * i.price);
                if(!i.optional) total += sub;
                
                // Diff Check logic simplificada
                let diffBadge = '';
                if(state.previousData) {
                    const old = state.previousData.items.find(o => o.id === i.id);
                    if(!old) diffBadge = '<span class="ml-2 text-[10px] bg-emerald-100 text-emerald-700 px-2 rounded-full font-bold">NOVO</span>';
                    else if(old.price !== i.price || old.qty !== i.qty) diffBadge = '<span class="ml-2 text-[10px] bg-amber-100 text-amber-700 px-2 rounded-full font-bold">ALTERADO</span>';
                }

                itemsHtml += `
                <div class="item-row ${i.optional ? 'item-optional' : ''}">
                    ${!locked ? `<button onclick="rmItem(${idx})" class="absolute top-2 right-2 text-slate-300 hover:text-red-500"><i class="fas fa-trash"></i></button>` : ''}
                    <div class="flex items-center mb-2">
                        <span class="text-xs font-bold text-slate-400 uppercase mr-2">Item ${idx+1}</span>
                        ${i.optional ? '<span class="text-[10px] bg-slate-600 text-white px-2 rounded uppercase font-bold">Opcional</span>' : ''}
                        ${diffBadge}
                    </div>
                    <div class="grid grid-cols-12 gap-3">
                        <div class="col-span-8">
                            <input class="w-full font-bold text-slate-800 bg-transparent outline-none placeholder-slate-300" placeholder="Título do Item" value="${i.name}" oninput="upItem(${idx},'name',this.value)" ${locked?'disabled':''}>
                            <textarea class="w-full text-xs text-slate-500 bg-transparent outline-none resize-none mt-1" rows="1" placeholder="Descrição técnica..." oninput="upItem(${idx},'description',this.value)" ${locked?'disabled':''}>${i.description}</textarea>
                        </div>
                        <div class="col-span-2">
                            <input type="number" class="w-full text-center bg-slate-100 rounded py-1 text-sm font-bold" value="${i.qty}" onchange="upItem(${idx},'qty',this.value)" ${locked?'disabled':''}>
                        </div>
                        <div class="col-span-2">
                            <input type="number" class="w-full text-right bg-slate-100 rounded py-1 text-sm font-bold" value="${i.price}" onchange="upItem(${idx},'price',this.value)" ${locked?'disabled':''}>
                        </div>
                    </div>
                    ${!locked ? `<div class="mt-2 text-right"><button onclick="toggleOpt(${idx})" class="text-[10px] text-blue-500 font-bold hover:underline">${i.optional ? 'Tornar Obrigatório' : 'Marcar como Opcional'}</button></div>` : ''}
                </div>`;
            });
            document.getElementById('ed-items').innerHTML = itemsHtml;
            safeText('ed-total', total.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}));

            // Anexos (AGORA NO ESCOPO COM DESCRIÇÃO)
            const attachList = document.getElementById('ed-attachments-list');
            let attachHtml = '';
            if(d.attachments.length > 0) {
                d.attachments.forEach((att, idx) => {
                    let icon = att.type === 'pdf' ? 'fa-file-pdf text-red-500' : 'fa-file-image text-blue-500';
                    attachHtml += `
                    <div class="attach-item group">
                        <div class="attach-icon"><i class="fas ${icon}"></i></div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs font-bold text-slate-700 truncate" title="${att.name}">${att.name}</span>
                                <div class="flex gap-2 opacity-50 group-hover:opacity-100 transition-opacity">
                                    <a href="${att.url}" target="_blank" class="text-blue-500 hover:text-blue-700"><i class="fas fa-eye"></i></a>
                                    ${!locked ? `<button onclick="delAttach(${idx})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>` : ''}
                                </div>
                            </div>
                            <input type="text" class="attach-input" placeholder="Adicione uma descrição (Ex: Planta Baixa)..." 
                                value="${att.description}" onchange="upAttachDesc(${idx}, this.value)" ${locked?'disabled':''}>
                        </div>
                    </div>`;
                });
            } else {
                attachHtml = '<div class="text-xs text-slate-400 text-center py-2">Nenhum anexo.</div>';
            }
            attachList.innerHTML = attachHtml;
            document.getElementById('upload-area').style.display = locked ? 'none' : 'block';

            // Financeiro e Histórico
            setVal('t-deadline', d.terms.deadline); setVal('t-val', d.terms.validity); setVal('t-obs', d.terms.obs);
            
            let histHtml = '';
            d.history.sort((a,b)=>new Date(a.date)-new Date(b.date)).forEach(h => {
                histHtml += `<div class="p-3 border-l-2 border-slate-200 ml-2 relative">
                    <div class="absolute -left-[5px] top-4 w-2 h-2 rounded-full bg-slate-300"></div>
                    <div class="text-[10px] text-slate-400">${new Date(h.date).toLocaleString()}</div>
                    <div class="text-xs font-bold text-slate-700">${h.detail}</div>
                </div>`;
            });
            document.getElementById('ed-history').innerHTML = histHtml;

            // Botões de Ação
            const actions = document.getElementById('ed-actions');
            if(locked) {
                actions.innerHTML = `<button onclick="createVersion()" class="btn btn-primary w-full bg-amber-500 hover:bg-amber-600 border-none">Criar Nova Revisão (V${state.version.version_number+1})</button>`;
            } else {
                actions.innerHTML = `<button onclick="save()" class="btn btn-primary w-full">Salvar Alterações</button>
                                     <button onclick="cancelProject()" class="btn btn-danger w-full mt-2">Cancelar Orçamento</button>`;
            }

            // Bloqueio de Inputs
            document.querySelectorAll('#view-editor input, #view-editor textarea, #view-editor select').forEach(el => {
                if(el.id !== 'dash-search' && el.id !== 'dash-filter') el.disabled = locked;
            });
        }

        // --- Ações do Editor ---
        function setClientType(t) { state.data.client.type = t; renderEditor(); }
        function toggleLoc(checked) { state.data.location.sameAsClient = checked; renderEditor(); }
        
        function upVal(k,v) { 
            if(k.startsWith('c-')) state.data.client[k.substring(2)] = v;
            else if(k.startsWith('t-')) state.data.terms[k.substring(2)] = v;
        }
        
        function upSettings(k,v) { 
            state.data.settings[k] = v; 
            localStorage.setItem('cfg_'+k, v); 
        }
        
        function upLoc(v) { state.data.location.address = v; }
        
        function upItem(idx, field, val) {
            const item = state.data.items[idx];
            if(field === 'qty' || field === 'price') item[field] = parseFloat(val) || 0;
            else item[field] = val;
            if(field === 'qty' || field === 'price') renderEditor(); // Recalcula total
        }
        
        function addItem() { state.data.items.push({ id: Date.now(), name: '', description: '', qty: 1, price: 0 }); renderEditor(); }
        function rmItem(idx) { if(confirm('Remover?')) { state.data.items.splice(idx,1); renderEditor(); } }
        function toggleOpt(idx) { state.data.items[idx].optional = !state.data.items[idx].optional; renderEditor(); }

        // Anexos Logic
        async function handleUpload(e) {
            const file = e.target.files[0];
            if(!file) return;
            const label = document.getElementById('upload-label');
            label.innerText = 'Enviando...';
            try {
                const path = `${state.project.id}/${Date.now()}_${file.name}`;
                const { error } = await db.storage.from('attachments').upload(path, file);
                if(error) throw error;
                const { data } = db.storage.from('attachments').getPublicUrl(path);
                
                const ext = file.name.split('.').pop().toLowerCase();
                state.data.attachments.push({ name: file.name, url: data.publicUrl, type: ext, description: '' });
                await save();
            } catch(err) { alert('Erro no upload.'); console.error(err); }
            finally { label.innerHTML = '<i class="fas fa-cloud-upload-alt text-3xl mb-2 block text-blue-300"></i> Clique aqui para anexar PDF ou Imagens'; e.target.value = ''; }
        }
        
        function upAttachDesc(idx, val) { state.data.attachments[idx].description = val; }
        async function delAttach(idx) { if(confirm('Excluir anexo?')) { state.data.attachments.splice(idx,1); await save(); } }

        // --- Save & Versioning ---
        function getChanges() {
            // Lógica simples de diff
            const now = state.data.items.length;
            const before = state.snapshot.length;
            if(now !== before) return 'Alterou quantidade de itens no escopo';
            return 'Atualizou detalhes do orçamento';
        }

        async function save() {
            if(state.data.client.name) await db.from('projects').update({client_name: state.data.client.name}).eq('id', state.project.id);
            
            const total = state.data.items.reduce((acc, i) => !i.optional ? acc + (i.qty*i.price) : acc, 0);
            
            // Log histórico apenas se houve mudança real (simplificado)
            const logText = getChanges();
            // logHistory('edited', 'provider', logText); -> Opcional, pode poluir

            await db.from('versions').update({ items: state.data, total_value: total }).eq('id', state.version.id);
            state.snapshot = JSON.parse(JSON.stringify(state.data.items));
            renderEditor();
        }

        async function createVersion() {
            if(!confirm('Criar nova revisão? Isso travará a versão atual.')) return;
            const total = state.data.items.reduce((acc, i) => !i.optional ? acc + (i.qty*i.price) : acc, 0);
            const nextVer = state.version.version_number + 1;
            
            // Adiciona log na nova versão
            state.data.history.push({ date: new Date().toISOString(), action: 'created', user: 'provider', detail: `Revisão V${nextVer} criada.` });
            
            await db.from('versions').insert({
                project_id: state.project.id,
                version_number: nextVer,
                items: state.data,
                total_value: total,
                status: 'draft'
            });
            loadEditor(state.project.id);
        }

        async function cancelProject() {
            if(!confirm('Cancelar este orçamento?')) return;
            await db.from('versions').update({status:'canceled'}).eq('id', state.version.id);
            loadEditor(state.project.id);
        }

        function generatePayment() {
            const total = state.data.items.reduce((acc, i) => !i.optional ? acc + (i.qty*i.price) : acc, 0);
            if(total === 0) return alert('Adicione itens primeiro.');
            const mode = document.getElementById('pay-mode').value;
            let text = '';
            
            if(mode === 'single') {
                text = `Pagamento à vista de ${total.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}.`;
            } else {
                const p1 = total * 0.5; // Exemplo 50%
                text = `Entrada de ${p1.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}\n+ Saldo na entrega.`;
            }
            state.data.terms.paymentText = text;
            renderEditor();
        }

        // --- Compartilhamento ---
        async function openShareModal() {
            await save();
            const url = `${window.location.origin}${window.location.pathname}?view=public&id=${state.version.id}`;
            const msg = `Olá ${state.data.client.name || ''}. Segue o link do orçamento para aprovação: ${url}`;
            
            document.getElementById('btn-share-wa').onclick = () => {
                const phone = (state.data.client.phone || '').replace(/\D/g, '');
                window.open(`https://wa.me/${phone ? '55'+phone : ''}?text=${encodeURIComponent(msg)}`, '_blank');
            };
            
            document.getElementById('btn-share-copy').onclick = () => {
                navigator.clipboard.writeText(url);
                alert('Link copiado!');
            };
            
            document.getElementById('share-modal').classList.remove('hidden');
        }

        // --- Visão Pública (Cliente) ---
        async function loadPublicProposal(id) {
            safeShow('public-loading');
            const { data: v, error } = await db.from('versions').select('*, projects(name)').eq('id', id).single();
            if(error) throw new Error('Orçamento não encontrado.');
            
            state.version = v;
            state.data = normalizeData(v.items);
            const d = state.data;

            // Renderiza Dados
            if(d.settings.providerName) {
                document.getElementById('doc-provider-info').innerHTML = `
                    <h2 class="text-2xl font-bold">${d.settings.providerName}</h2>
                    <p class="opacity-80">${d.settings.providerDoc || ''}</p>
                `;
            }
            
            safeText('doc-title', v.projects.name);
            safeText('doc-id', `#${v.id.substr(0,4).toUpperCase()}`);
            safeText('doc-date', new Date(v.created_at).toLocaleDateString());
            
            safeText('doc-c-name', d.client.name);
            safeText('doc-c-doc', d.client.doc);
            safeText('doc-c-addr', d.location.sameAsClient ? d.client.address : d.location.address);

            // Itens
            let itemsHtml = '';
            let total = 0;
            const isFrozen = v.status !== 'draft' && v.status !== 'negotiating' && v.status !== 'sent';
            
            d.items.forEach((i, idx) => {
                let active = !i.optional || i.publicSelected;
                if(active) total += (i.qty * i.price);
                
                // Checkbox lógica para opcionais
                let checkHtml = '';
                if(i.optional) {
                    if(!isFrozen) checkHtml = `<input type="checkbox" onchange="togglePublicOpt(${idx})" ${i.publicSelected ? 'checked' : ''} class="mr-2">`;
                    else checkHtml = i.publicSelected ? '<i class="fas fa-check-square text-emerald-500 mr-2"></i>' : '<i class="far fa-square text-slate-300 mr-2"></i>';
                }

                itemsHtml += `
                <tr class="border-b border-slate-100 last:border-0">
                    <td class="py-3 pl-2">
                        <div class="flex items-start">
                            ${checkHtml}
                            <div>
                                <div class="font-bold text-slate-800">${i.name} ${i.optional ? '<span class="text-[10px] bg-slate-200 px-1 rounded">OPCIONAL</span>' : ''}</div>
                                <div class="text-xs text-slate-500">${i.description}</div>
                            </div>
                        </div>
                    </td>
                    <td class="text-center">${i.qty}</td>
                    <td class="text-right">${i.price.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</td>
                    <td class="text-right pr-2 font-bold ${!active ? 'line-through text-slate-300' : 'text-slate-800'}">
                        ${(i.qty*i.price).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}
                    </td>
                </tr>`;
            });
            document.getElementById('doc-items-body').innerHTML = itemsHtml;
            safeText('doc-total', total.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}));

            // Anexos Públicos
            let attachHtml = '';
            if(d.attachments.length > 0) {
                attachHtml = '<h4 class="font-bold text-xs uppercase text-slate-400 mb-3 mt-8">Anexos</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                d.attachments.forEach(att => {
                    attachHtml += `
                    <a href="${att.url}" target="_blank" class="flex items-center gap-3 p-3 bg-slate-50 border rounded-lg hover:bg-white hover:shadow transition-all">
                        <div class="w-10 h-10 bg-white rounded flex items-center justify-center border text-blue-500"><i class="fas fa-file-alt"></i></div>
                        <div>
                            <div class="text-sm font-bold text-slate-700 truncate w-48">${att.name}</div>
                            ${att.description ? `<div class="text-xs text-slate-500 italic">"${att.description}"</div>` : ''}
                        </div>
                    </a>`;
                });
                attachHtml += '</div>';
            }
            document.getElementById('doc-attachments-area').innerHTML = attachHtml;

            // Rodapé
            safeText('doc-payment', d.terms.paymentText);
            safeText('doc-deadline', d.terms.deadline);
            safeText('doc-validity', d.terms.validity);
            safeText('doc-obs', d.terms.obs);

            // Ações / Status
            const actionsDiv = document.getElementById('doc-actions');
            if(v.status === 'approved') {
                document.getElementById('stamp-approved').classList.remove('hidden');
                actionsDiv.innerHTML = '<div class="text-center text-emerald-600 font-bold p-4 bg-emerald-50 rounded-lg">Proposta Aprovada com Sucesso</div>';
            } else if(v.status === 'canceled') {
                actionsDiv.innerHTML = '<div class="text-center text-red-600 font-bold p-4 bg-red-50 rounded-lg">Proposta Recusada/Cancelada</div>';
            } else {
                actionsDiv.innerHTML = `
                    <button onclick="openModal('approve')" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-xl shadow-lg mb-3 text-lg">
                        <i class="fas fa-check-circle mr-2"></i> APROVAR PROPOSTA
                    </button>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="openModal('change')" class="py-3 bg-amber-100 text-amber-800 font-bold rounded-xl hover:bg-amber-200">Solicitar Ajuste</button>
                        <button onclick="openModal('cancel')" class="py-3 bg-slate-200 text-slate-600 font-bold rounded-xl hover:bg-slate-300">Recusar</button>
                    </div>`;
            }

            safeHide('public-loading'); safeShow('view-public'); safeShow('public-content');
        }

        function togglePublicOpt(idx) {
            state.data.items[idx].publicSelected = !state.data.items[idx].publicSelected;
            // Atualiza visualmente sem salvar no banco ainda (salva ao aprovar)
            loadPublicProposal(state.version.id).then(() => {
               // Re-renderiza localmente para refletir total
               // Nota: Idealmente separar render de fetch, mas para simplificar:
               // A função loadPublicProposal já faz o render.
               // Só precisamos garantir que state.data não seja sobrescrito pelo fetch se não salvamos.
               // Correção rápida: apenas recalcula DOM local.
            });
        }

        // --- Inicialização ---
        window.onload = init;
        window.onpopstate = init;

    </script>
</body>
</html>
